{% extends 'layouts/app_layout.html' %}

{% block title %}Orden {{ orden.codigo }} - Sistema Frozen{% endblock %}

{% block extra_css %}
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/vis/4.21.0/vis-network.min.css" />
<link rel="stylesheet" href="{{ url_for('static', filename='css/usuarios/listarUsuarios.css') }}">
{% endblock %}

{% block app_content %}
<div class="d-flex justify-content-between flex-wrap flex-md-nowrap align-items-center pb-2 mb-4 border-bottom">
    <div>
        <h1 class="h2 mb-1">
            Detalle de Orden <code class="text-muted">{{ orden.codigo }}</code>
        </h1>
        {# Mostrar Nombre y Unidad de Medida/Presentación si existen #}
        <p class="text-muted mb-0">
            {{ orden.producto_nombre or 'Producto no definido' }}
            {# Mostrar unidad de medida entre paréntesis si existe #}
            {% if orden.producto_unidad_medida %}
            <span class="fw-normal">({{ orden.producto_unidad_medida }})</span>
            {% elif orden.producto_presentacion %}
            <span class="fw-normal">({{ orden.producto_presentacion }})</span>
            {% endif %}
        </p>
    </div>
    <div class="btn-toolbar">
        <button class="btn btn-danger me-2 btn-crear-alerta" data-tipo-entidad="orden_produccion"
            data-id-entidad="{{ orden.id }}" data-nombre-entidad="Orden de Producción {{ orden.codigo }}">
            <i class="bi bi-exclamation-triangle-fill me-1"></i> Crear Alerta de Riesgo
        </button>
        <a href="#" onclick="history.back();" class="btn btn-outline-secondary me-2"
            title="Volver a la página anterior">
            <i class="bi bi-arrow-left"></i> Volver
        </a>
        <a href="{{ url_for('orden_produccion.listar') }}" class="btn btn-outline-secondary me-2">
            <i class="bi bi-arrow-left me-1"></i>Ordenes de Producción
        </a>
        {# --- BOTONES DE ACCIÓN (INICIAR/COMPLETAR) ELIMINADOS DE AQUÍ --- #}
    </div>
</div>

<ul class="nav nav-tabs-custom mb-3" id="loteDetailTab" role="tablist">
    <li class="nav-item" role="presentation">
        <button class="nav-link-custom active" id="info-tab" data-bs-toggle="tab" data-bs-target="#info-content"
            type="button" role="tab" aria-controls="info-content" aria-selected="true">
            <i class="bi bi-info-circle me-1"></i>Información General
        </button>
    </li>
    <li class="nav-item" role="presentation">
        <button class="nav-link-custom" id="trazabilidad-tab" data-bs-toggle="tab"
            data-bs-target="#trazabilidad-content" type="button" role="tab" aria-controls="trazabilidad-content"
            aria-selected="false">
            <i class="bi bi-diagram-3 me-1"></i>Trazabilidad
        </button>
    </li>
</ul>

<div class="tab-content" id="loteDetailTabContent">
    <div class="tab-pane fade show active" id="info-content" role="tabpanel" aria-labelledby="info-tab">
        <div class="row">
            <div class="col-lg-8">
                {# --- Tarjeta de Información General --- #}
                <div class="card mb-4">
                    <div class="card-header d-flex justify-content-between align-items-center">
                        <h5 class="mb-0">Información General</h5>
                        <div>
                            {# Badge de Estado #}
                            {% set estado_config = {
                            'PENDIENTE': {'class': 'bg-secondary-soft text-secondary', 'icon': 'calendar-check'},
                            'EN ESPERA': {'class': 'bg-warning-soft text-warning', 'icon': 'hourglass-split'},
                            'LISTA PARA PRODUCIR': {'class': 'bg-info-soft text-info', 'icon': 'check-lg'},
                            'EN_LINEA_1': {'class': 'bg-primary-soft text-primary', 'icon': 'diagram-3'},
                            'EN_LINEA_2': {'class': 'bg-primary-soft text-primary', 'icon': 'diagram-3-fill'},
                            'EN_EMPAQUETADO': {'class': 'bg-purple-soft text-purple', 'icon': 'box-seam'},
                            'CONTROL_DE_CALIDAD': {'class': 'bg-cyan-soft text-cyan', 'icon': 'clipboard-check'},
                            'CONSOLIDADA': {'class': 'bg-light text-muted', 'icon': 'link-45deg'},
                            'COMPLETADA': {'class': 'bg-success-soft text-success', 'icon': 'check-circle-fill'},
                            'CANCELADA': {'class': 'bg-danger-soft text-danger', 'icon': 'x-circle'}
                            } %}
                            {% set config = estado_config.get(orden.estado, {'class': 'bg-light text-dark',
                            'icon':'question-circle'}) %}
                                                        {% if orden.en_alerta %}
                            <span class="badge bg-danger fs-6" data-bs-toggle="tooltip" title="Alertado">
                                <i class="bi bi-exclamation-triangle-fill"></i> Alertado
                            </span>
                            {% endif %}
                            <span class="badge {{ config.class }} fs-6 me-2">
                                <i class="bi bi-{{ config.icon }} me-1"></i>{{ orden.estado.replace('_',' ') }}
                            </span>
                            {# Badge de Prioridad #}
                            {% if orden.prioridad and orden.prioridad != 'NORMAL' %}
                            {% set p_config = {'BAJA': {'class': 'bg-light text-dark', 'icon': 'arrow-down'}, 'ALTA':
                            {'class':
                            'bg-warning text-dark', 'icon': 'arrow-up'}, 'URGENTE': {'class': 'bg-danger text-white',
                            'icon':
                            'exclamation-triangle'}} %}
                            {% set pconfig = p_config.get(orden.prioridad, {'class': 'bg-secondary', 'icon': 'dash'}) %}
                            <span class="badge {{ pconfig.class }} fs-6"><i class="bi bi-{{ pconfig.icon }} me-1"></i>{{
                                orden.prioridad }}</span>
                            {% endif %}
                        </div>
                    </div>
                    <div class="card-body">
                        <div class="row g-4">
                            {# Columna Izquierda: Producción y Línea #}
                            <div class="col-md-6 border-end">
                                <h6 class="text-muted mb-3"><i class="bi bi-box me-1"></i>Detalles de Producción</h6>
                                <dl class="row mb-0"> {# Usar dl para listas descriptivas #}
                                    <dt class="col-sm-5"><i class="bi bi-box-seam me-1"></i>Producto:</dt>
                                    <dd class="col-sm-7">
                                        {{ orden.producto_nombre or 'N/A' }}
                                        {# Mostrar unidad de medida si existe #}
                                        {% if orden.producto_unidad_medida %}
                                        <span class="text-muted fw-normal ms-1">({{ orden.producto_unidad_medida
                                            }})</span>
                                        {% endif %}
                                    </dd>

                                    <dt class="col-sm-5"><i class="bi bi-hash me-1"></i>Cantidad:</dt>
                                    <dd class="col-sm-7">{{ orden.cantidad_planificada }}</dd> {# Unidad ya está arriba
                                    #}

                                    <dt class="col-sm-5"><i class="bi bi-diagram-3-fill me-1 text-primary"></i>Línea
                                        Asignada:
                                    </dt>
                                    <dd class="col-sm-7">{% if orden.linea_asignada %}Línea {{ orden.linea_asignada }}{%
                                        else %}
                                        <span class="text-muted">No asignada</span> {% endif %}
                                    </dd>

                                    <dt class="col-sm-5"><i class="bi bi-calendar-check-fill me-1 text-danger"></i>Fecha
                                        Meta:
                                    </dt>
                                    <dd class="col-sm-7">{% if orden.fecha_meta %}{{ orden.fecha_meta }}{% else %} <span
                                            class="text-muted">N/D</span> {% endif %}</dd>
                                </dl>
                            </div>

                            {# Columna Derecha: Personal y Fechas Originales #}
                            <div class="col-md-6">
                                <h6 class="text-muted mb-3"><i class="bi bi-people-fill me-1"></i>Asignaciones</h6>
                                <dl class="row mb-0">
                                    <dt class="col-sm-5"><i
                                            class="bi bi-person-badge-fill me-1 text-info"></i>Supervisor/es:</dt>
                                    <dd class="col-sm-7">{{ orden.supervisor_nombre or 'No asignado' }}</dd>

                                    <dt class="col-sm-5"><i
                                            class="bi bi-clipboard-check-fill me-1 text-cyan"></i>Supervisor/es de
                                        calidad:</dt>
                                    <dd class="col-sm-7">{{ orden.supervisor_calidad_nombre or 'No asignado' }}</dd>

                                    <dt class="col-sm-5"><i
                                            class="bi bi-person-fill me-1 text-secondary"></i>Operario/s:</dt>
                                    <dd class="col-sm-7">{{ orden.operario_nombre or 'No asignado' }}</dd> {# Usar
                                    operario_nombre #}

                                    <dt class="col-sm-5"><i class="bi bi-person-up me-1 text-muted"></i>Creado por:</dt>
                                    <dd class="col-sm-7">{{ orden.creador_nombre or 'N/A' }}</dd>

                                    <dt class="col-sm-5"><i class="bi bi-calendar-event me-1 text-muted"></i>Fecha
                                        Creación:
                                    </dt>
                                    <dd class="col-sm-7">{{ orden.fecha_planificada or 'N/A' }}</dd> {# Fecha creación
                                    original
                                    #}
                                </dl>
                            </div>

                            {# Sección Timeline (separada para claridad) #}
                            <div class="col-12 mt-3 pt-3 border-top">
                                <h6 class="text-muted mb-3"><i class="bi bi-clock-history me-1"></i>Timeline de
                                    Producción</h6>
                                <div class="row g-3">
                                    <div class="col-md-4">
                                        <div class="d-flex align-items-center">
                                            <i class="bi bi-calendar-play fs-4 text-primary me-2"></i>
                                            <div>
                                                <div class="small text-muted">Inicio Planificado</div>
                                                <div class="fw-bold">{{ orden.fecha_inicio_planificada or 'N/P' }}</div>
                                            </div>
                                        </div>
                                    </div>
                                    <div class="col-md-4">
                                        <div class="d-flex align-items-center">
                                            <i
                                                class="bi bi-play-circle text-{{ 'success' if orden.fecha_inicio else 'muted' }} me-2 fs-4"></i>
                                            <div>
                                                <div class="small text-muted">Inicio Real</div>
                                                <div class="fw-bold">{{ orden.fecha_inicio | format_datetime if
                                                    orden.fecha_inicio else 'No iniciado' }}</div>
                                            </div>
                                        </div>
                                    </div>
                                    <div class="col-md-4">
                                        <div class="d-flex align-items-center">
                                            <i
                                                class="bi bi-check-circle text-{{ 'success' if orden.fecha_fin else 'muted' }} me-2 fs-4"></i>
                                            <div>
                                                <div class="small text-muted">Finalización</div>
                                                <div class="fw-bold">{{ orden.fecha_fin | format_datetime if
                                                    orden.fecha_fin
                                                    else 'No finalizado' }}</div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>

                            {# Tiempo Total (si existe y tienes la lógica para calcularlo) #}
                            {% if orden.horas_produccion %}
                            <div class="col-12 mt-3 pt-3 border-top"> {# Separador visual #}
                                <div class="d-flex align-items-center">
                                    <i class="bi bi-stopwatch text-primary me-2 fs-4"></i>
                                    <div>
                                        <div class="small text-muted">Tiempo Total de Producción</div>
                                        <div class="fw-bold">{{ "%.2f"|format(orden.horas_produccion) }} horas</div>
                                    </div>
                                </div>
                            </div>
                            {% endif %}

                            {# Observaciones #}
                            {% if orden.observaciones %}
                            <div class="col-12 mt-3 pt-3 border-top">
                                <h6 class="text-muted mb-2"><i class="bi bi-chat-left-text me-1"></i>Observaciones</h6>
                                <div class="border-start border-3 border-warning ps-3">
                                    {% if 'Super OP consolidada desde las OPs:' in orden.observaciones %}
                                    {% set parts = orden.observaciones.split(': ') %}
                                    <p class="mb-0"> {{ parts[0] }}:
                                        {% set op_ids = parts[1].split(',') %}
                                        {% for op_id in op_ids %}
                                        <a href="{{ url_for('orden_produccion.detalle', id=op_id.strip()|int) }}">OP-{{
                                            op_id.strip() }}</a>{% if not loop.last %},{% endif %}
                                        {% endfor %}
                                    </p>
                                    {% else %} <p class="mb-0">{{ orden.observaciones }}</p> {% endif %}
                                </div>
                            </div>
                            {% endif %}

                            {% if orden.estado == 'EN ESPERA' and orden.orden_compra_id %}
                            <div class="col-12 mt-3">
                                <div class="alert alert-warning mb-0 d-flex justify-content-between align-items-center">
                                    <span> {# Texto a la izquierda #}
                                        <i class="bi bi-hourglass-split me-2"></i> Esta orden está <strong>EN
                                            ESPERA</strong> de
                                        insumos. Se generó automáticamente una Orden de Compra.
                                    </span>
                                    {# Botón/Enlace a la derecha #}
                                    <a href="{{ url_for('orden_compra.detalle', id=orden.orden_compra_id) }}"
                                        class="btn btn-sm btn-outline-dark ms-3"> {# Cambiado a botón para
                                        destacar #}
                                        Ver OC-{{ orden.orden_compra_id }} <i
                                            class="bi bi-box-arrow-up-right small"></i>
                                    </a>
                                </div>
                            </div>
                            {% endif %}
                        </div>
                    </div>
                </div> {# --- INICIO BLOQUE ELIMINADO --- #}
                {# --- El bloque duplicado que estaba aquí (líneas 229-390) ha sido eliminado --- #}
                {# --- FIN BLOQUE ELIMINADO --- #}

                {# Tabla Pedidos Asociados #}
                <div class="card mb-4 mt-4">
                    <div class="card-header">
                        <h5 class="mb-0"><i class="bi bi-link-45deg me-1"></i>Pedidos de Cliente Asociados</h5>
                    </div>
                    <div class="table-responsive">
                        <table class="table table-hover mb-0">
                            <thead class="table-light">
                                <tr>
                                    <th># Pedido</th>
                                    <th>Cliente</th>
                                    <th class="text-center">Estado</th>
                                    <th class="text-end">Monto Total</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% for pedido in pedidos_asociados %}
                                <tr>
                                    <td><a href="{{ url_for('orden_venta.detalle', id=pedido.id) }}"
                                            class="fw-bold">PED-{{
                                            pedido.id }}</a></td>
                                    <td>{{ pedido.nombre_cliente }}</td>
                                    <td class="text-center"><span
                                            class="badge {% if pedido.estado == 'PENDIENTE' %}bg-secondary{% elif pedido.estado == 'COMPLETADO' %}bg-success{% elif pedido.estado == 'CANCELADO' %}bg-danger{% else %}bg-primary{% endif %}">{{
                                            pedido.estado }}</span></td>
                                    <td class="text-end"><span class="fw-bold">{{ pedido.precio_orden |
                                            formato_moneda
                                            }}</span>
                                    </td>
                                </tr>
                                {% else %}
                                <tr>
                                    <td colspan="4" class="text-center text-muted py-4">No vinculada a pedidos
                                        de
                                        cliente.</td>
                                </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>
                </div>
                {# --- El {% endif %} huérfano que estaba aquí (línea 424) fue movido a la línea 227 --- #}

                {# Tabla Ingredientes #}
                <div class="card mb-4">
                    <div class="card-header">
                        <h5 class="mb-0"><i class="bi bi-journal-text me-1"></i>Ingredientes de la Receta</h5>
                    </div>
                    <div class="table-responsive">
                        <table class="table table-hover mb-0">
                            <thead class="table-light">
                                <tr>
                                    <th>Insumo</th>
                                    <th>Cantidad utilizada</th>
                                    <th>Descripción</th>
                                    <th>Código</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% for ingrediente in ingredientes %}
                                <tr>
                                    <td>
                                        <div class="fw-bold">{{ ingrediente.nombre_insumo or 'N/A' }}</div>
                                    </td>
                                    <td>{{ ingrediente.cantidad }} {{ ingrediente.unidad_medida or ''}}</td>
                                    <td>{{ ingrediente.descripcion_insumo or 'N/A' }}</td>
                                    <td> {% if ingrediente.id_insumo %} <a
                                            href="{{ url_for('insumos_api.obtener_insumo_por_id', id_insumo=ingrediente.id_insumo) }}"
                                            title="Ver Insumo"> {# Asumiendo que esta es la ruta correcta #}
                                            <i class="btn-sm btn-outline-primary bi bi-eye"></i>
                                        </a> {% else %} N/A {% endif %} </td>
                                </tr>
                                {% else %}
                                <tr>
                                    <td colspan="4" class="text-center text-muted py-4">No se encontraron
                                        ingredientes
                                        para la
                                        receta.</td>
                                </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>
                </div>

            </div>{# Fin col-lg-8 #}

            {# Columna Derecha (Trazabilidad) #}
            <div class="col-lg-4">
                <div class="card"> {# Eliminado mt-3 para alinear arriba #}
                    <div class="card-header">
                        <h6 class="mb-0"><i class="bi bi-diagram-2 me-1"></i>Trazabilidad de Lotes</h6>
                    </div>
                    <div class="card-body">
                        <div class="table-responsive">
                            <table class="table table-hover mb-0">
                                <thead class="table-light">
                                    <tr>
                                        <th># Lote</th>
                                        <th>Insumo</th>
                                        <th class="text-end">Cantidad Reservada</th>
                                        <th class="text-end">Acciones</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    {% for reserva in lotes_insumos_reservados %}
                                    <tr>
                                        <td><span class="fw-bold">{{
                                                reserva.lote_inventario.numero_lote_proveedor or
                                                'N/D'
                                                }}</span></td>
                                        <td>{{ reserva.lote_inventario.insumo.nombre or 'N/A' }}</td>
                                        <td class="text-end">{{ reserva.cantidad_reservada }}</td>
                                        <td class="text-end">
                                            <a href="{{ url_for('inventario_view.detalle_lote', id_lote=reserva.lote_inventario.id_lote) }}"
                                                class="btn btn-sm btn-outline-primary">
                                                Ver Detalle
                                            </a>
                                        </td>
                                    </tr>
                                    {% endfor %}
                                </tbody>
                            </table>
                        </div>

                    </div>
                </div>
            </div>{# Fin col-lg-4 #}
        </div>
    </div>
    <div class="tab-pane fade" id="trazabilidad-content" role="tabpanel" aria-labelledby="trazabilidad-tab">
        
        <!-- Selector de Nivel de Trazabilidad -->
        <div class="d-flex justify-content-end align-items-center mb-3">
            <div class="form-check form-switch">
                <input class="form-check-input" type="checkbox" role="switch" id="trazabilidad-nivel-switch">
                <label class="form-check-label" for="trazabilidad-nivel-switch">Ver Trazabilidad Completa</label>
            </div>
        </div>

        <div id="resumen-trazabilidad-contenedor">
            <!-- El contenido se generará dinámicamente por JS -->
        </div>

        <div class="accordion" id="accordionDiagrama">
            <div class="accordion-item">
                <h2 class="accordion-header" id="headingDiagrama">
                    <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse"
                        data-bs-target="#collapseDiagrama" aria-expanded="false"
                        aria-controls="collapseDiagrama">
                        <i class="bi bi-diagram-3 me-2"></i> Ver Diagrama de Red Completo
                    </button>
                </h2>
                <div id="collapseDiagrama" class="accordion-collapse collapse" aria-labelledby="headingDiagrama"
                    data-bs-parent="#accordionDiagrama">
                    <div class="accordion-body">
                        <p class="text-muted small">
                            El diagrama de red muestra el flujo completo del proceso productivo. Haga clic en un
                            nodo para navegar a su página de detalle.
                        </p>
                        <div id="vis_trazabilidad"
                            style="height: 500px; border: 1px solid #ddd; border-radius: 4px;">
                            <div class="d-flex justify-content-center align-items-center h-100">
                                <div class="spinner-border text-primary" role="status">
                                    <span class="visually-hidden">Cargando gráfico...</span>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
{% include "admin_riesgos/_modal_crear_alerta.html" %}
{% endblock %}

{% block extra_js %}
<script src="{{ url_for('static', filename='js/gestorAlertas.js') }}?v=1.1"></script>
<script>
    window.ORDEN_ID = "{{ orden.id }}";
</script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/vis/4.21.0/vis.min.js"></script>
<script src="{{ url_for('static', filename='js/trazabilidadOrdenProduccion.js') }}?v=1.0"></script>
{% endblock %}
