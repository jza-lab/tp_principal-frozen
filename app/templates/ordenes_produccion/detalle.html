{% extends 'layouts/app_layout.html' %}

{% block title %}Orden {{ orden.codigo }} - Sistema Frozen{% endblock %}

{% block app_content %}
<div class="d-flex justify-content-between flex-wrap flex-md-nowrap align-items-center pb-2 mb-4 border-bottom">
    <div>
        <h1 class="h2 mb-1">
            Detalle de Orden <code class="text-muted">{{ orden.codigo }}</code>
        </h1>
        {# Mostrar Nombre y Unidad de Medida/Presentación si existen #}
        <p class="text-muted mb-0">
            {{ orden.producto_nombre or 'Producto no definido' }}
            {# Mostrar unidad de medida entre paréntesis si existe #}
            {% if orden.producto_unidad_medida %}
            <span class="fw-normal">({{ orden.producto_unidad_medida }})</span>
            {% elif orden.producto_presentacion %}
            <span class="fw-normal">({{ orden.producto_presentacion }})</span>
            {% endif %}
        </p>
    </div>
    <div class="btn-toolbar">
        <a href="#" onclick="history.back();" class="btn btn-outline-secondary me-2"
            title="Volver a la página anterior">
            <i class="bi bi-arrow-left"></i> Volver
        </a>
        <a href="{{ url_for('orden_produccion.listar') }}" class="btn btn-outline-secondary me-2">
            <i class="bi bi-arrow-left me-1"></i>Ordenes de Producción
        </a>
        {# --- BOTONES DE ACCIÓN (INICIAR/COMPLETAR) ELIMINADOS DE AQUÍ --- #}
    </div>
</div>

<div class="row">
    <div class="col-lg-8">
        {# --- Tarjeta de Información General --- #}
        <div class="card mb-4">
            <div class="card-header d-flex justify-content-between align-items-center">
                <h5 class="mb-0">Información General</h5>
                <div>
                    {# Badge de Estado #}
                    {% set estado_config = {
                    'PENDIENTE': {'class': 'bg-secondary-soft text-secondary', 'icon': 'calendar-check'},
                    'EN ESPERA': {'class': 'bg-warning-soft text-warning', 'icon': 'hourglass-split'},
                    'LISTA PARA PRODUCIR': {'class': 'bg-info-soft text-info', 'icon': 'check-lg'},
                    'EN_LINEA_1': {'class': 'bg-primary-soft text-primary', 'icon': 'diagram-3'},
                    'EN_LINEA_2': {'class': 'bg-primary-soft text-primary', 'icon': 'diagram-3-fill'},
                    'EN_EMPAQUETADO': {'class': 'bg-purple-soft text-purple', 'icon': 'box-seam'},
                    'CONTROL_DE_CALIDAD': {'class': 'bg-cyan-soft text-cyan', 'icon': 'clipboard-check'},
                    'CONSOLIDADA': {'class': 'bg-light text-muted', 'icon': 'link-45deg'},
                    'COMPLETADA': {'class': 'bg-success-soft text-success', 'icon': 'check-circle-fill'},
                    'CANCELADA': {'class': 'bg-danger-soft text-danger', 'icon': 'x-circle'}
                    } %}
                    {% set config = estado_config.get(orden.estado, {'class': 'bg-light text-dark',
                    'icon':'question-circle'}) %}
                    <span class="badge {{ config.class }} fs-6 me-2">
                        <i class="bi bi-{{ config.icon }} me-1"></i>{{ orden.estado.replace('_',' ') }}
                    </span>
                    {# Badge de Prioridad #}
                    {% if orden.prioridad and orden.prioridad != 'NORMAL' %}
                    {% set p_config = {'BAJA': {'class': 'bg-light text-dark', 'icon': 'arrow-down'}, 'ALTA': {'class':
                    'bg-warning text-dark', 'icon': 'arrow-up'}, 'URGENTE': {'class': 'bg-danger text-white', 'icon':
                    'exclamation-triangle'}} %}
                    {% set pconfig = p_config.get(orden.prioridad, {'class': 'bg-secondary', 'icon': 'dash'}) %}
                    <span class="badge {{ pconfig.class }} fs-6"><i class="bi bi-{{ pconfig.icon }} me-1"></i>{{
                        orden.prioridad }}</span>
                    {% endif %}
                </div>
            </div>
            <div class="card-body">
                <div class="row g-4">
                    {# Columna Izquierda: Producción y Línea #}
                    <div class="col-md-6 border-end">
                        <h6 class="text-muted mb-3"><i class="bi bi-box me-1"></i>Detalles de Producción</h6>
                        <dl class="row mb-0"> {# Usar dl para listas descriptivas #}
                            <dt class="col-sm-5"><i class="bi bi-box-seam me-1"></i>Producto:</dt>
                            <dd class="col-sm-7">
                                {{ orden.producto_nombre or 'N/A' }}
                                {# Mostrar unidad de medida si existe #}
                                {% if orden.producto_unidad_medida %}
                                <span class="text-muted fw-normal ms-1">({{ orden.producto_unidad_medida }})</span>
                                {% endif %}
                            </dd>

                            <dt class="col-sm-5"><i class="bi bi-hash me-1"></i>Cantidad:</dt>
                            <dd class="col-sm-7">{{ orden.cantidad_planificada }}</dd> {# Unidad ya está arriba #}

                            <dt class="col-sm-5"><i class="bi bi-diagram-3-fill me-1 text-primary"></i>Línea Asignada:
                            </dt>
                            <dd class="col-sm-7">{% if orden.linea_asignada %}Línea {{ orden.linea_asignada }}{% else %}
                                <span class="text-muted">No asignada</span> {% endif %}</dd>

                            <dt class="col-sm-5"><i class="bi bi-calendar-check-fill me-1 text-danger"></i>Fecha Meta:
                            </dt>
                            <dd class="col-sm-7">{% if orden.fecha_meta %}{{ orden.fecha_meta }}{% else %} <span
                                    class="text-muted">N/D</span> {% endif %}</dd>
                        </dl>
                    </div>

                    {# Columna Derecha: Personal y Fechas Originales #}
                    <div class="col-md-6">
                        <h6 class="text-muted mb-3"><i class="bi bi-people-fill me-1"></i>Asignaciones</h6>
                        <dl class="row mb-0">
                            <dt class="col-sm-5"><i class="bi bi-person-badge-fill me-1 text-info"></i>Supervisor:</dt>
                            <dd class="col-sm-7">{{ orden.supervisor_nombre or 'No asignado' }}</dd>

                            <dt class="col-sm-5"><i class="bi bi-person-fill me-1 text-secondary"></i>Operario:</dt>
                            <dd class="col-sm-7">{{ orden.operario_nombre or 'No asignado' }}</dd> {# Usar
                            operario_nombre #}

                            <dt class="col-sm-5"><i class="bi bi-person-up me-1 text-muted"></i>Creado por:</dt>
                            <dd class="col-sm-7">{{ orden.creador_nombre or 'N/A' }}</dd>

                            <dt class="col-sm-5"><i class="bi bi-calendar-event me-1 text-muted"></i>Fecha Creación:
                            </dt>
                            <dd class="col-sm-7">{{ orden.fecha_planificada or 'N/A' }}</dd> {# Fecha creación original
                            #}
                        </dl>
                    </div>

                    {# Sección Timeline (separada para claridad) #}
                    <div class="col-12 mt-3 pt-3 border-top">
                        <h6 class="text-muted mb-3"><i class="bi bi-clock-history me-1"></i>Timeline de Producción</h6>
                        <div class="row g-3">
                            <div class="col-md-4">
                                <div class="d-flex align-items-center">
                                    <i class="bi bi-calendar-play fs-4 text-primary me-2"></i>
                                    <div>
                                        <div class="small text-muted">Inicio Planificado</div>
                                        <div class="fw-bold">{{ orden.fecha_inicio_planificada or 'N/P' }}</div>
                                    </div>
                                </div>
                            </div>
                            <div class="col-md-4">
                                <div class="d-flex align-items-center">
                                    <i
                                        class="bi bi-play-circle text-{{ 'success' if orden.fecha_inicio else 'muted' }} me-2 fs-4"></i>
                                    <div>
                                        <div class="small text-muted">Inicio Real</div>
                                        <div class="fw-bold">{{ orden.fecha_inicio | format_datetime if
                                            orden.fecha_inicio else 'No iniciado' }}</div>
                                    </div>
                                </div>
                            </div>
                            <div class="col-md-4">
                                <div class="d-flex align-items-center">
                                    <i
                                        class="bi bi-check-circle text-{{ 'success' if orden.fecha_fin else 'muted' }} me-2 fs-4"></i>
                                    <div>
                                        <div class="small text-muted">Finalización</div>
                                        <div class="fw-bold">{{ orden.fecha_fin | format_datetime if orden.fecha_fin
                                            else 'No finalizado' }}</div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    {# Tiempo Total (si existe y tienes la lógica para calcularlo) #}
                    {% if orden.horas_produccion %}
                    <div class="col-12 mt-3 pt-3 border-top"> {# Separador visual #}
                        <div class="d-flex align-items-center">
                            <i class="bi bi-stopwatch text-primary me-2 fs-4"></i>
                            <div>
                                <div class="small text-muted">Tiempo Total de Producción</div>
                                <div class="fw-bold">{{ "%.2f"|format(orden.horas_produccion) }} horas</div>
                            </div>
                        </div>
                    </div>
                    {% endif %}

                    {# Observaciones #}
                    {% if orden.observaciones %}
                    <div class="col-12 mt-3 pt-3 border-top">
                        <h6 class="text-muted mb-2"><i class="bi bi-chat-left-text me-1"></i>Observaciones</h6>
                        <div class="border-start border-3 border-warning ps-3">
                            {% if 'Super OP consolidada desde las OPs:' in orden.observaciones %}
                            {% set parts = orden.observaciones.split(': ') %}
                            <p class="mb-0"> {{ parts[0] }}:
                                {% set op_ids = parts[1].split(',') %}
                                {% for op_id in op_ids %}
                                <a href="{{ url_for('orden_produccion.detalle', id=op_id.strip()|int) }}">OP-{{
                                    op_id.strip() }}</a>{% if not loop.last %},{% endif %}
                                {% endfor %}
                            </p>
                            {% else %} <p class="mb-0">{{ orden.observaciones }}</p> {% endif %}
                        </div>
                    </div>
                    {% endif %}

                    {% if orden.estado == 'EN ESPERA' and orden.orden_compra_id %}
                    <div class="col-12 mt-3">
                        <div class="alert alert-warning mb-0 d-flex justify-content-between align-items-center">
                            <span> {# Texto a la izquierda #}
                                <i class="bi bi-hourglass-split me-2"></i> Esta orden está <strong>EN ESPERA</strong> de
                                insumos. Se generó automáticamente una Orden de Compra.
                            </span>
                            {# Botón/Enlace a la derecha #}
                            <a href="{{ url_for('orden_compra.detalle', id=orden.orden_compra_id) }}"
                                class="btn btn-sm btn-outline-dark ms-3"> {# Cambiado a botón para destacar #}
                                Ver OC-{{ orden.orden_compra_id }} <i class="bi bi-box-arrow-up-right small"></i>
                            </a>
                        </div>
                    </div>
                    {% endif %}
                </div>
            </div>
        </div>

        {# Tabla Pedidos Asociados #}
        <div class="card mb-4 mt-4">
            <div class="card-header">
                <h5 class="mb-0"><i class="bi bi-link-45deg me-1"></i>Pedidos de Cliente Asociados</h5>
            </div>
            <div class="table-responsive">
                <table class="table table-hover mb-0">
                    <thead class="table-light">
                        <tr>
                            <th># Pedido</th>
                            <th>Cliente</th>
                            <th class="text-center">Estado</th>
                            <th class="text-end">Monto Total</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for pedido in pedidos_asociados %}
                        <tr>
                            <td><a href="{{ url_for('orden_venta.detalle', id=pedido.id) }}" class="fw-bold">PED-{{
                                    pedido.id }}</a></td>
                            <td>{{ pedido.nombre_cliente }}</td>
                            <td class="text-center"><span
                                    class="badge {% if pedido.estado == 'PENDIENTE' %}bg-secondary{% elif pedido.estado == 'COMPLETADO' %}bg-success{% elif pedido.estado == 'CANCELADO' %}bg-danger{% else %}bg-primary{% endif %}">{{
                                    pedido.estado }}</span></td>
                            <td class="text-end"><span class="fw-bold">{{ pedido.precio_orden | formato_moneda }}</span>
                            </td>
                        </tr>
                        {% else %}
                        <tr>
                            <td colspan="4" class="text-center text-muted py-4">No vinculada a pedidos de cliente.</td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
        </div>

        {# Tabla Ingredientes #}
        <div class="card mb-4">
            <div class="card-header">
                <h5 class="mb-0"><i class="bi bi-journal-text me-1"></i>Ingredientes de la Receta</h5>
            </div>
            <div class="table-responsive">
                <table class="table table-hover mb-0">
                    <thead class="table-light">
                        <tr>
                            <th>Insumo</th>
                            <th>Cantidad utilizada</th>
                            <th>Descripción</th>
                            <th>Código</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for ingrediente in ingredientes %}
                        <tr>
                            <td>
                                <div class="fw-bold">{{ ingrediente.nombre_insumo or 'N/A' }}</div>
                            </td>
                            <td>{{ ingrediente.cantidad }} {{ ingrediente.unidad_medida or ''}}</td>
                            <td>{{ ingrediente.descripcion_insumo or 'N/A' }}</td>
                            <td> {% if ingrediente.id_insumo %} <a
                                    href="{{ url_for('insumos_api.obtener_insumo_por_id', id_insumo=ingrediente.id_insumo) }}"
                                    title="Ver Insumo"> {# Asumiendo que esta es la ruta correcta #}
                                    <i class="btn-sm btn-outline-primary bi bi-eye"></i>
                                </a> {% else %} N/A {% endif %} </td>
                        </tr>
                        {% else %}
                        <tr>
                            <td colspan="4" class="text-center text-muted py-4">No se encontraron ingredientes para la
                                receta.</td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
        </div>

    </div>{# Fin col-lg-8 #}

    {# Columna Derecha (Trazabilidad) #}
    <div class="col-lg-4">
        <div class="card"> {# Eliminado mt-3 para alinear arriba #}
            <div class="card-header">
                <h6 class="mb-0"><i class="bi bi-diagram-2 me-1"></i>Trazabilidad de Lotes</h6>
            </div>
            <div class="card-body">
                <p class="small text-muted">Aquí se mostrará el detalle de los lotes de insumos consumidos y el lote de
                    producto generado.</p>
                {# Podrías añadir lógica aquí para mostrar info básica del lote generado si la orden está COMPLETADA #}
                <button class="btn btn-sm btn-outline-secondary w-100" disabled>Ver Trazabilidad Completa
                    (Próximamente)</button>
            </div>
        </div>
    </div>{# Fin col-lg-4 #}
</div>
{% endblock %}

{% block extra_js %}
{# Asume que tienes un filtro Jinja global llamado 'format_datetime' #}
{# Si no, puedes formatear fechas en el backend o usar JS #}
{# {% filter date_format(orden.fecha_inicio, '%Y-%m-%d %H:%M') if orden.fecha_inicio else 'No iniciado' %} #}
{% endblock %}