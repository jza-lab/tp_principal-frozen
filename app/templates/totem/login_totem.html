{% extends "layouts/base.html" %}

{% block extra_css %}
    <link rel="stylesheet" href="{{ url_for('static', filename='css/totem.css') }}">
{% endblock %}

{% block content %}
<div class="totem-container">
    <div class="totem-card">
        <div class="totem-header">
            <h2>Tótem de Acceso</h2>
            <p id="guia" class="text-muted">Mire a la cámara y presione "Registrar".</p>
        </div>

        <div class="camaraVideo">
            <video id="video" autoplay playsinline></video>
        </div>

        <div id="result" class="mt-3"></div>

        <div class="d-flex mt-4">
            <button id="captureBtn" class="btn btn-success">Registrar</button>
            <button id="retryBtn" class="btn btn-danger" style="display:none;">Reintentar</button>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
class FaceLogin {
    constructor() {
        this.video = document.getElementById('video');
        this.captureBtn = document.getElementById('captureBtn');
        this.retryBtn = document.getElementById('retryBtn');
        this.resultDiv = document.getElementById('result');
        this.stream = null;
        
        this.init();
    }

    async init() {
        try {
            this.stream = await navigator.mediaDevices.getUserMedia({ 
                video: { width: 640, height: 480 } 
            });
            this.video.srcObject = this.stream;
        } catch (err) {
            this.showResult('Error al acceder a la cámara: ' + err.message, 'error');
        }

        this.captureBtn.addEventListener('click', () => this.captureFace());
        this.retryBtn.addEventListener('click', () => this.retryCapture());
    }

    captureFace() {
        const canvas = document.createElement('canvas');
        canvas.width = this.video.videoWidth;
        canvas.height = this.video.videoHeight;
        const ctx = canvas.getContext('2d');
        ctx.drawImage(this.video, 0, 0);
        
        const imageData = canvas.toDataURL('image/jpeg');
        this.sendFaceData(imageData);
        
        this.captureBtn.style.display = 'none';
        this.retryBtn.style.display = 'inline-block';
        this.showResult('Procesando rostro...', 'info');
    }

    async sendFaceData(imageData) {
        try {
            // CORREGIDO: Usar /auth/facial/login_face
            const response = await fetch('/auth/facial/login_face', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ image: imageData })
            });

            const result = await response.json();
            
            if (result.success) {
                this.showResult(`✅ ${result.message}`, 'success');
                setTimeout(() => {
                    // CORREGIDO: Usar la URL de redirección del resultado o la predeterminada
                    const redirectUrl = result.redirect_url || '/auth/facial/panel_totem';
                    window.location.href = redirectUrl;
                }, 1500);
            } else {
                this.showResult(`❌ ${result.message}`, 'error');
            }
        } catch (error) {
            this.showResult('Error de conexión: ' + error.message, 'error');
        }
    }

    retryCapture() {
        this.resultDiv.innerHTML = '';
        this.captureBtn.style.display = 'inline-block';
        this.retryBtn.style.display = 'none';
    }

    showResult(message, type) {
        const alertClass = type === 'success' ? 'alert-success' : 
                          type === 'error' ? 'alert-danger' : 'alert-info';
        this.resultDiv.innerHTML = `
            <div class="alert ${alertClass} alert-dismissible fade show">
                ${message}
            </div>
        `;
    }
}

document.addEventListener('DOMContentLoaded', () => {
    new FaceLogin();
});
</script>
{% endblock %}