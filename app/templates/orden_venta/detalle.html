{% extends 'layouts/app_layout.html' %}

{% block title %}Pedido PED-{{ pedido.id }} - Sistema Frozen{% endblock %}

{% block extra_css %}
{{ super() }}
<link href="https://cdnjs.cloudflare.com/ajax/libs/vis/4.21.0/vis.min.css" rel="stylesheet" type="text/css" />
<link rel="stylesheet" href="{{ url_for('static', filename='css/usuarios/listarUsuarios.css') }}">
{% endblock %}

{% block app_content %}
<div
    class="d-flex justify-content-between flex-wrap flex-md-nowrap align-items-center pb-2 mb-4 border-bottom page-content">
    <div>
        <h1 class="h2 mb-1">
            Pedido <code class="text-muted">PED-{{ pedido.id }}</code>
        </h1>
        <p class="text-muted mb-0">Cliente: <strong>{{ pedido.nombre_cliente }}</strong></p>
    </div>
    <div class="btn-toolbar">
        <button class="btn btn-danger me-2 btn-crear-alerta" data-tipo-entidad="pedido"
            data-id-entidad="{{ pedido.id }}" data-nombre-entidad="Pedido PED-{{ pedido.id }}">
            <i class="bi bi-exclamation-triangle-fill me-1"></i> Crear Alerta de Riesgo
        </button>
        <a href="{{ url_for('orden_venta.listar') }}" class="btn btn-outline-secondary me-2">
            <i class="bi bi-arrow-left me-1"></i>Lista de Órdenes de Venta
        </a>
        <a href="#" onclick="history.back();" class="btn btn-outline-secondary me-2"
            title="Volver a la página anterior">
            <i class="bi bi-arrow-left"></i> Volver
        </a>
    </div>
</div>

<div class="row page-content">
    <div class="col-lg-8">
        <!-- Pestañas de Navegación -->
        <ul class="nav nav-tabs-custom mb-3" id="myTab" role="tablist">
            <li class="nav-item" role="presentation">
                <button class="nav-link-custom active" id="info-tab" data-bs-toggle="tab" data-bs-target="#info-tab-pane" type="button" role="tab" aria-controls="info-tab-pane" aria-selected="true">
                    <i class="bi bi-info-circle me-1"></i>Información General
                </button>
            </li>
            <li class="nav-item" role="presentation">
                <button class="nav-link-custom" id="trazabilidad-tab" data-bs-toggle="tab" data-bs-target="#trazabilidad-tab-pane" type="button" role="tab" aria-controls="trazabilidad-tab-pane" aria-selected="false">
                    <i class="bi bi-diagram-3 me-1"></i>Trazabilidad
                </button>
            </li>
        </ul>

        <!-- Contenido de las Pestañas -->
        <div class="tab-content" id="myTabContent">
            <!-- Pestaña de Información General -->
            <div class="tab-pane fade show active" id="info-tab-pane" role="tabpanel" aria-labelledby="info-tab" tabindex="0">
                <div class="card mb-4">
                    <div class="card-header d-flex justify-content-between align-items-center">
                        <h5 class="mb-0">Información General del Pedido</h5>
                        {# Definición de badges de estado #}
                {% set estado_config = {
                'PENDIENTE': {'class': 'bg-secondary-soft text-secondary', 'icon': 'clock'},
                'EN_PROCESO': {'class': 'bg-primary-soft text-primary', 'icon': 'play-circle'},
                'LISTO_PARA_ENTREGA': {'class': 'bg-info-soft text-info', 'icon': 'box-seam'},
                'COMPLETADO': {'class': 'bg-success-soft text-success', 'icon': 'check-circle'},
                'CANCELADO': {'class': 'bg-danger-soft text-danger', 'icon': 'x-circle'}
                } %}
                {% set config = estado_config.get(pedido.estado, {'class': 'bg-light text-dark', 'icon':
                'question-circle'}) %}
                               <div>
                    {% if pedido.en_alerta %}
                    <span class="badge bg-danger fs-6" data-bs-toggle="tooltip" title="Alertado">
                        <i class="bi bi-exclamation-triangle-fill"></i> Alertado
                    </span>
                    {% endif %}
                <span class="badge {{ config.class }} fs-6">
                    <i class="bi bi-{{ config.icon }} me-1"></i>{{ pedido.estado.replace('_', ' ') }}
                </span>
                               </div>
            </div>
            <div class="card-body">
                <div class="col-md-12">
                    <label class="form-label-sm fw-bold mb-4"><i class="bi bi-info-circle me-1"></i>Información
                        General</label>
                    <div class="row g-2">
                        <div class="row">
                            <div class="col-md-6">
                                <label class="form-label-sm fw-bold"><i
                                        class="bi bi-person-circle me-1"></i>Cliente:</label>
                                <p class="form-control-plaintext mb-0">{{ pedido.nombre_cliente | default('N/A', true)
                                    }}</p>
                            </div>
                            <div class="col-md-6">
                                <label class="form-label-sm fw-bold"><i
                                        class="bi bi-person-circle me-1"></i>Cuil:</label>
                                <p class="form-control-plaintext mb-0">{{ pedido.cliente.cuit | default('N/A', true) }}
                                </p>
                            </div>
                        </div>
                        <div class="row">
                            <div class="col-md-6">
                                <label class="form-label-sm fw-bold"><i class="bi bi-calendar-event me-1"></i>Fecha de
                                    Solicitud:</label>
                                <p class="form-control-plaintext mb-0">{{ pedido.fecha_solicitud | default('N/A', true)
                                    }}</p>
                            </div>
                            <div class="col-md-6">
                                <label class="form-label-sm fw-bold"><i class="bi bi-calendar-event me-1"></i>Fecha de
                                    Entrega Requerida:</label>
                                <p class="form-control-plaintext mb-0">{{ pedido.fecha_requerido | default('N/A', true)
                                    }}</p>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <label class="form-label-sm fw-bold"><i class="bi bi-calendar-plus me-1"></i>Fecha de
                                Creación:</label>
                            <p class="form-control-plaintext mb-0">{{ pedido.created_at.strftime('%Y-%m-%d %H:%M') if
                                pedido.created_at else 'N/A' }}</p>
                        </div>
                        <div class="col-md-6">
                            <label class="form-label-sm fw-bold"><i class="bi bi-clock-history me-1"></i>Última
                                Actualización:</label>
                            <p class="form-control-plaintext mb-0">{{ pedido.updated_at.strftime('%Y-%m-%d %H:%M') if
                                pedido.updated_at else 'N/A' }}</p>
                        </div>
                    </div>
                </div>
                <hr>
                <div class="col-md-12">
                    <div class="mb-3">
                        <label class="form-label-sm fw-bold mb-3"><i class="bi bi-house me-1"></i>Dirección de
                            Entrega</label>
                        <div class="row g-2">
                            <div class="col-sm-6">
                                <label class="form-label-sm fw-bold"><i class="bi bi-signpost me-1"></i>Calle y
                                    Altura:</label>
                                <p class="form-control-plaintext">{{ pedido.direccion.calle | default('N/A', true) }} {{
                                    pedido.direccion.altura | default('N/A', true) }}</p>
                            </div>
                            <div class="col-sm-6">
                                <label class="form-label-sm fw-bold"><i class="bi bi-geo-alt me-1"></i>Localidad y
                                    Provincia:</label>
                                <p class="form-control-plaintext">{{ pedido.direccion.localidad | default('N/A', true)
                                    }}, {{ pedido.direccion.provincia | default('N/A', true) }}</p>
                            </div>
                            <div class="col-sm-6">
                                <label class="form-label-sm fw-bold"><i class="bi bi-building me-1"></i>Piso / Dto
                                    (Opcional):</label>
                                <p class="form-control-plaintext">Piso: {{ pedido.direccion.piso | default('N/A', true)
                                    }} | Dto: {{ pedido.direccion.depto | default('N/A', true) }}</p>
                            </div>
                            <div class="col-sm-6">
                                <label class="form-label-sm fw-bold"><i class="bi bi-mailbox2 me-1"></i>Código
                                    Postal:</label>
                                <p class="form-control-plaintext">{{ pedido.direccion.codigo_postal | default('N/A',
                                    true) }}</p>
                            </div>
                        </div>
                    </div>
                </div>
                <hr>
                <hr>
                <div class="col-md-12">
                    <div class="mb-3">
                        <label class="form-label-sm fw-bold mb-3"><i class="bi bi-truck me-1"></i>Información de Despacho</label>
                        {% if pedido.despacho %}
                        <div class="row g-2">
                            <div class="col-sm-6">
                                <label class="form-label-sm fw-bold"><i class="bi bi-person-badge me-1"></i>Nombre Transportista:</label>
                                <p class="form-control-plaintext">{{ pedido.despacho.nombre_transportista }}</p>
                            </div>
                            <div class="col-sm-6">
                                <label class="form-label-sm fw-bold"><i class="bi bi-person-vcard me-1"></i>DNI Transportista:</label>
                                <p class="form-control-plaintext">{{ pedido.despacho.dni_transportista }}</p>
                            </div>
                            <div class="col-sm-6">
                                <label class="form-label-sm fw-bold"><i class="bi bi-truck-front me-1"></i>Patente Vehículo:</label>
                                <p class="form-control-plaintext">{{ pedido.despacho.patente_vehiculo }}</p>
                            </div>
                            <div class="col-sm-6">
                                <label class="form-label-sm fw-bold"><i class="bi bi-telephone me-1"></i>Teléfono Transportista:</label>
                                <p class="form-control-plaintext">{{ pedido.despacho.telefono_transportista }}</p>
                            </div>
                            <div class="col-sm-12">
                                <label class="form-label-sm fw-bold"><i class="bi bi-chat-left-text me-1"></i>Observaciones:</label>
                                <p class="form-control-plaintext">{{ pedido.despacho.observaciones | default('Sin observaciones', true) }}</p>
                            </div>
                        </div>
                        {% else %}
                        <div class="alert alert-info bg-info-soft border-0" role="alert">
                            <i class="bi bi-info-circle me-2"></i>
                            Aún no se ha asignado un despacho para este pedido.
                        </div>
                        {% endif %}
                    </div>
                </div>
            </div>
        </div>

        {% if pedido.notas_credito %}
        <div class="card mb-4">
            <div class="card-header">
                <h5 class="mb-0"><i class="bi bi-receipt me-2"></i>Notas de Crédito Asociadas</h5>
            </div>
            <div class="accordion accordion-flush" id="accordionNotasCredito">
                {% for nc in pedido.notas_credito %}
                <div class="accordion-item">
                    <h2 class="accordion-header" id="heading-nc-{{ nc.id }}">
                        <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#collapse-nc-{{ nc.id }}" aria-expanded="false" aria-controls="collapse-nc-{{ nc.id }}">
                            <div class="row w-100 align-items-center">
                                <div class="col-md-4"><strong>Código:</strong> {{ nc.codigo_nc }}</div>
                                <div class="col-md-4"><strong>Monto:</strong> <span class="text-success">{{ nc.monto | formato_moneda }}</span></div>
                                <div class="col-md-4"><strong>Fecha:</strong> {{ nc.created_at | format_datetime }}</div>
                            </div>
                        </button>
                    </h2>
                    <div id="collapse-nc-{{ nc.id }}" class="accordion-collapse collapse" aria-labelledby="heading-nc-{{ nc.id }}" data-bs-parent="#accordionNotasCredito">
                        <div class="accordion-body bg-light">
                            {% include 'orden_venta/_nota_credito_cuerpo.html' with context %}
                            <div class="text-center mt-3">
                                <button class="btn btn-primary btn-sm download-nc-pdf" data-nc-id="{{ nc.id }}" data-nc-code="{{ nc.codigo_nc }}">
                                    <i class="bi bi-download me-1"></i> Descargar PDF
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
                {% endfor %}
            </div>
        </div>
        {% endif %}
        <div class="card mb-5">
            <div class="card-header">
                <h5 class="mb-0">Productos en este Pedido</h5>
            </div>
            <div class="table-responsive">
                <table class="table table-hover mb-0">
                    <thead class="table-light">
                        <tr>
                            <th>Producto</th>
                            <th>Cantidad</th>
                            <th>Estado Item</th> {# Cambiado Título #}
                            <th>Orden de Producción (Estado)</th> {# Cambiado Título #}
                        </tr>
                    </thead>
                    <tbody>
                        {% for item in pedido['items'] %}
                        <tr>
                            <td>
                                <div class="fw-bold">{{ item.producto_nombre.nombre or 'N/A' }}</div>
                            </td>
                            <td>{{ item.cantidad }} {{ item.producto_nombre.unidad_medida or 'u.' }}</td>
                            <td>
                                {# Badges de estado para items #}
                                {% set item_estado_config = {
                                'PENDIENTE': {'class': 'text-secondary', 'icon': 'clock'},
                                'EN_PRODUCCION': {'class': 'text-primary', 'icon': 'play-circle'},
                                'ALISTADO': {'class': 'text-info', 'icon': 'box-seam'},
                                'COMPLETADO': {'class': 'text-success', 'icon': 'check-circle'},
                                'CANCELADO': {'class': 'text-danger', 'icon': 'x-circle'}
                                } %}
                                {% set item_config = item_estado_config.get(item.estado, {'class': 'text-dark', 'icon':
                                'question-circle'}) %}
                                <span class="{{ item_config.class }}">
                                    <i class="bi bi-{{ item_config.icon }} me-1"></i>{{ item.estado.replace('_', ' ') }}
                                </span>
                            </td>
                            <td>
                                {% if item.orden_produccion_id %}
                                <a href="{{ url_for('orden_produccion.detalle', id=item.orden_produccion_id) }}">
                                    OP-{{ item.orden_produccion_id }}
                                </a>
                                {# Mostrar estado de la OP si está disponible #}
                                {% if item.op_estado %}
                                <span class="badge bg-light text-dark ms-1">{{ item.op_estado.replace('_',' ') }}</span>
                                {% endif %}
                                {% else %}
                                <span class="text-muted">N/A (Stock Directo)</span>
                                {% endif %}
                            </td>
                        </tr>
                        {% else %}
                        <tr>
                            <td colspan="4" class="text-center text-muted py-4">No hay productos.</td>
                        </tr>
                        {% endfor %}
                        <tr>
                            <td colspan="3" class="text-end fw-bold">Total del pedido:</td>
                            <td class="text-end fw-bold">{{( pedido.precio_orden | formato_moneda ) if
                                pedido.precio_orden else '$ 0,00'}}</td>
                        </tr>
                    </tbody>
                </table>
            </div>
                </div>
            </div>
            <!-- Pestaña de Trazabilidad -->
            <div class="tab-pane fade" id="trazabilidad-tab-pane" role="tabpanel" aria-labelledby="trazabilidad-tab" tabindex="0">
                <div class="card">
                    <div class="card-body">
                        <div class="d-flex justify-content-end align-items-center mb-3">
                            <div class="form-check form-switch">
                                <input class="form-check-input" type="checkbox" role="switch" id="trazabilidad-nivel-switch">
                                <label class="form-check-label" for="trazabilidad-nivel-switch">Ver Trazabilidad Completa</label>
                            </div>
                        </div>

                        <div id="resumen-trazabilidad-contenedor">
                            <!-- El contenido se generará dinámicamente por JS -->
                        </div>

                        <div class="accordion" id="accordionDiagrama">
                            <div class="accordion-item">
                                <h2 class="accordion-header" id="headingDiagrama">
                                    <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse"
                                        data-bs-target="#collapseDiagrama" aria-expanded="false"
                                        aria-controls="collapseDiagrama">
                                        <i class="bi bi-diagram-3 me-2"></i> Ver Diagrama de Red Completo
                                    </button>
                                </h2>
                                <div id="collapseDiagrama" class="accordion-collapse collapse" aria-labelledby="headingDiagrama"
                                    data-bs-parent="#accordionDiagrama">
                                    <div class="accordion-body">
                                        <p class="text-muted small">
                                            El diagrama de red muestra el flujo completo del proceso. Haga clic en un
                                            nodo para navegar a su página de detalle.
                                        </p>
                                        <div id="vis_trazabilidad"
                                            style="height: 500px; border: 1px solid #ddd; border-radius: 4px;">
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div class="col-lg-4">
        <div class="card">
            <div class="card-header">
                <h5 class="mb-0">Acciones</h5>
            </div>
            <div class="card-body">
                <div class="d-grid gap-2">
                    {# Botón Editar (Solo si PENDIENTE) #}
                    {% if pedido.estado == 'PENDIENTE' and 'modificar_ordenes_venta' is has_permission %}
                    <a href="{{ url_for('orden_venta.editar', id=pedido.id) }}" class="btn btn-outline-primary"><i
                            class="bi bi-pencil me-1"></i>Editar Pedido</a>
                    {% endif %}

                    {# 1. Botón "Planificar" (antes Iniciar Proceso) #}
                    {% if pedido.estado == 'PENDIENTE' and 'aprobar_ordenes_venta' is has_permission %}
                    <form method="POST" action="{{ url_for('orden_venta.iniciar_proceso', id=pedido.id) }}"
                        class="confirm-form d-grid" data-title="Confirmar Planificación"
                        data-message="Esta acción creará las Órdenes de Producción necesarias y pondrá el pedido 'En Proceso'. ¿Está seguro?"
                        data-button-type="success">
                        {{ csrf_form.csrf_token }}

                        <button type="submit" class="btn btn-success"><i class="bi bi-play-fill me-1"></i>Planificar y
                            Crear OPs</button>
                    </form>
                    {% endif %}

                    {# 3. Botón "Despachar" (si está LISTO_PARA_ENTREGA) #}
                    {% if pedido.estado == 'LISTO_PARA_ENTREGA' and 'modificar_ordenes_venta' is has_permission %}
                    <a href="{{ url_for('orden_venta.despachar', id=pedido.id) }}" class="btn btn-info w-100"
                        title="Despachar Pedido">
                        <i class="bi bi-truck me-1"></i> Despachar Pedido
                    </a>
                    {% endif %}

                    {# 4. Botón "Confirmar Entrega" (si está DESPACHADO) #}
                    {% if pedido.estado == 'DESPACHADO' and 'modificar_orden_de_venta' is has_permission %}
                    <button type="button" id="btn-confirmar-entrega" class="btn btn-success w-100">
                        <i class="bi bi-check2-all me-1"></i> Confirmar Entrega (Recepción OK)
                    </button>
                    {% endif %}
                    {# --- FIN NUEVO FLUJO DE ENTREGA --- #}

                    <hr>
                    {# Botón Imprimir Factura #}
                    <button type="button" id="btn-imprimir-factura" class="btn btn-info"> {# Cambiado a btn-info #}
                        <i class="bi bi-printer me-1"></i> {{ 'Imprimir Factura Final' if pedido.estado in
                        ['LISTO_PARA_ENTREGA', 'COMPLETADO'] else 'Imprimir Factura Proforma' }}
                    </button>

                    {# Botón Cancelar (si no está Completado o Cancelado) #}
                    {% if pedido.estado not in ['COMPLETADO', 'CANCELADO'] and 'cancelar_ordenes_venta' is
                    has_permission %}
                    <form method="POST" action="{{ url_for('orden_venta.cancelar', id=pedido.id) }}"
                        class="confirm-form d-grid" data-title="Confirmar Cancelación"
                        data-message="¿Está seguro? Esta acción no se puede deshacer." data-button-type="danger">
                        {{ csrf_form.csrf_token }}

                        <button type="submit" class="btn btn-outline-danger"><i class="bi bi-x-circle me-1"></i>Cancelar
                            Pedido</button>
                    </form>
                    {% endif %}
                </div>
            </div>
        </div>
    </div>
</div>
{% include "admin_riesgos/_modal_crear_alerta.html" %}
{% endblock %}

{% block extra_js %}
<script src="{{ url_for('static', filename='js/gestorAlertas.js') }}?v=1.1"></script>
<script>
    // URL de la API para obtener el HTML de la factura
    const FACTURA_API_URL = "{{ url_for('orden_venta.generar_factura_html', id=pedido.id) }}";

    // Función para imprimir el contenido HTML generado por el backend
    function printHtmlContent(htmlContent) {
        const iframe = document.createElement('iframe');
        iframe.style.display = 'none';
        iframe.id = 'factura-print-frame';
        document.body.appendChild(iframe);
        const iframeDocument = iframe.contentWindow.document;
        iframeDocument.open();
        iframeDocument.write(htmlContent);
        iframeDocument.close();
        iframe.contentWindow.focus();
        iframe.contentWindow.print();
        setTimeout(() => { document.body.removeChild(iframe); }, 500);
    }

    document.addEventListener('DOMContentLoaded', function () {
        const printButton = document.getElementById('btn-imprimir-factura');
        if (printButton) {
            printButton.addEventListener('click', async () => {
                printButton.disabled = true;
                const originalHtml = printButton.innerHTML;
                printButton.innerHTML = '<span class="spinner-border spinner-border-sm me-2"></span>Generando...';
                try {
                    const response = await fetch(FACTURA_API_URL);
                    const result = await response.json();
                    if (result.success) {
                        printHtmlContent(result.html);
                    } else {
                        showNotificationModal('Error de Factura', result.error || 'No se pudo generar el HTML.', 'error');
                    }
                } catch (error) {
                    console.error('Error AJAX al generar factura:', error);
                    showNotificationModal('Error de Conexión', 'Fallo al contactar al servidor.', 'error');
                } finally {
                    setTimeout(() => {
                        printButton.disabled = false;
                        printButton.innerHTML = originalHtml;
                    }, 500);
                }
            });
        }
    });
</script>
<script>
    document.addEventListener('DOMContentLoaded', function () {
        // Bloquear doble clic en TODOS los formularios de acción
        const forms = document.querySelectorAll('form');
        forms.forEach(form => {
            form.addEventListener('submit', function (e) {
                const submitButton = form.querySelector('button[type="submit"]');
                if (submitButton) {
                    submitButton.disabled = true;
                    // Mostrar spinner de carga
                    const originalHtml = submitButton.innerHTML;
                    submitButton.innerHTML = '<span class="spinner-border spinner-border-sm me-2"></span>Procesando...';
                    // Evitar reenviar el formulario si el usuario hace back o recarga
                    form.addEventListener('ajax:complete', () => {
                        submitButton.disabled = false;
                        submitButton.innerHTML = originalHtml;
                    });
                }
            });
        });
    });
</script>

<script>
    document.addEventListener('DOMContentLoaded', function () {
        const pedidoId = {{ pedido.id }}
    };
    const btnConfirmarEntrega = document.getElementById('btn-confirmar-entrega');

    // Función reutilizable para cambiar el estado del pedido
    async function cambiarEstadoPedido(nuevoEstado, button) {
        const originalHtml = button.innerHTML;
        button.disabled = true;
        button.innerHTML = `<span class="spinner-border spinner-border-sm me-2"></span>Procesando...`;

        try {
            const response = await fetch(`/orden-venta/api/${pedidoId}/cambiar-estado`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRFToken': document.querySelector('input[name="csrf_token"]').value
                },
                body: JSON.stringify({ estado: nuevoEstado })
            });

            const result = await response.json();

            if (response.ok && result.success) {
                showNotificationModal('Éxito', result.message || 'El estado del pedido fue actualizado.', 'success', () => {
                    window.location.reload();
                });
            } else {
                showNotificationModal('Error', result.error || 'No se pudo actualizar el estado.', 'error');
                button.disabled = false;
                button.innerHTML = originalHtml;
            }
        } catch (error) {
            console.error('Error al cambiar estado:', error);
            showNotificationModal('Error de Red', 'No se pudo conectar con el servidor.', 'error');
            button.disabled = false;
            button.innerHTML = originalHtml;
        }
    }

    // Event listener para el botón de confirmar entrega
    if (btnConfirmarEntrega) {
        btnConfirmarEntrega.addEventListener('click', () => {
            showConfirmationModal(
                'Confirmar Entrega',
                '¿Confirma que el cliente ha recibido el pedido? El estado cambiará a Entregado.',
                'success',
                () => { cambiarEstadoPedido('ENTREGADO', btnConfirmarEntrega); }
            );
        });
    }
});
</script>

<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
<script>
document.addEventListener('DOMContentLoaded', function () {
    const { jsPDF } = window.jspdf;

    document.querySelectorAll('.download-nc-pdf').forEach(button => {
        button.addEventListener('click', function () {
            const ncId = this.getAttribute('data-nc-id');
            const ncCode = this.getAttribute('data-nc-code');
            const contentToCapture = document.getElementById(`nc-container-${ncId}`);

            if (!contentToCapture) {
                console.error('No se encontró el contenido de la nota de crédito para el ID:', ncId);
                return;
            }

            // Deshabilitar botón para evitar clics múltiples
            this.disabled = true;
            const originalHtml = this.innerHTML;
            this.innerHTML = '<span class="spinner-border spinner-border-sm me-2"></span>Generando...';
            
            // Ocultar el botón ANTES de la captura
            const buttonContainer = this.parentElement;
            buttonContainer.style.display = 'none';

            html2canvas(contentToCapture, {
                scale: 2, // Mejorar calidad de la imagen
                useCORS: true 
            }).then(canvas => {
                const imgData = canvas.toDataURL('image/png');
                
                // Tamaño A4: 210x297 mm. Margen de 10mm a cada lado.
                const page_width = 210;
                const margin = 10;
                const content_width = page_width - (margin * 2);

                const pdf = new jsPDF('p', 'mm', 'a4');
                const pdfWidth = content_width;
                const pdfHeight = (canvas.height * pdfWidth) / canvas.width;
                
                // Controlar si la altura excede la página
                let heightLeft = pdfHeight;
                let position = 0;
                const pageHeight = pdf.internal.pageSize.getHeight();
                
                pdf.addImage(imgData, 'PNG', margin, position, pdfWidth, pdfHeight);
                heightLeft -= pageHeight;
                
                // Si el contenido es más largo que una página, añade páginas nuevas
                while (heightLeft > 0) {
                    position = heightLeft - pdfHeight;
                    pdf.addPage();
                    pdf.addImage(imgData, 'PNG', margin, position, pdfWidth, pdfHeight);
                    heightLeft -= pageHeight;
                }

                pdf.save(`Nota-de-Credito-${ncCode}.pdf`);
            }).catch(error => {
                console.error("Error al generar el PDF:", error);
                alert("Hubo un problema al generar el PDF. Por favor, intente de nuevo.");
            }).finally(() => {
                // Volver a mostrar el botón y rehabilitarlo
                buttonContainer.style.display = 'block';
                this.disabled = false;
                this.innerHTML = originalHtml;
            });
        });
    });
});
</script>

<script src="https://cdnjs.cloudflare.com/ajax/libs/vis/4.21.0/vis.min.js"></script>
<script>
    // Variable global para que el JS de trazabilidad pueda acceder al ID
    window.PEDIDO_ID = {{ pedido.id|tojson }};
</script>
<script src="{{ url_for('static', filename='js/trazabilidadPedido.js') }}?v=1.1"></script>

{% endblock %}