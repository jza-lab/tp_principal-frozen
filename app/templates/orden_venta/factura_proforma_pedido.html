{% set pedido = pedido %}
{% set TIPO_COMPROBANTE = "X" %}
{% set TIPO_COMPROBANTE_CODIGO = "99" %}
{% set PUNTO_VENTA = "0000" %}
{% set NRO_COMPROBANTE = "%08d"|format(pedido.id) %}

{% set EMISOR_NOMBRE = "FrozenProd S.A." %}
{% set EMISOR_CUIT = "30-71000000-8" %}
{% set EMISOR_DOMICILIO = "Juan María Gutiérrez 1150, Los Polvorines, Provincia de Buenos Aires" %}
{% set EMISOR_CONDICION_IVA = "Responsable Inscripto" %}
{% set EMISOR_ING_BRUTOS = pedido.emisor.ingresos_brutos or "20-12345678-3" %}
{% set EMISOR_INICIO_ACT = pedido.emisor.inicio_actividades or "2020-01-01" %}

{% set EMISOR_CAE = 'N/A' %}
{% set EMISOR_VTO_CAE = 'N/A' %}


<div style="font-family: Arial, sans-serif; font-size: 11pt; width: 100%; margin: 0 auto; padding: 5px;">

    <table style="width: 100%; border-collapse: collapse; margin-bottom: 15px;">
        <tr>
            <td style="vertical-align: top; padding-right: 5px;">
                <h3
                    style="margin-top: 0; margin-bottom: 5px; font-size: 18pt; font-weight: bold; display: flex; align-items: center;">
                    <span style="color: #66ccff; margin-right: 8px;">❄️</span>
                    FrozenProd S.A.
                </h3>

                <table style="width: 100%; border-collapse: collapse;">
                    <tr>
                        <td style="width: 30%; vertical-align: top; padding-top: 5px;">
                            <strong>Domicilio:</strong><br>
                            {{ EMISOR_DOMICILIO }}
                        </td>
                        <td style="width: 70%; vertical-align: top; padding-top: 5px;">
                            <strong>Condición IVA:</strong> {{ EMISOR_CONDICION_IVA }}
                        </td>
                    </tr>
                </table>
            </td>

            <td style="width: 25%; border: 1px solid #000; padding: 0; text-align: center;">
                <table style="width: 100%; height: 100%; border-collapse: collapse;">
                    <tr>
                        <td
                            style="width: 35%; background-color: #ddd; border-right: 1px solid #000; padding: 5px; text-align: center; vertical-align: middle;">
                            <span style="font-size: 16pt; font-weight: bold; color: #343a40;">{{ TIPO_COMPROBANTE
                                }}</span><br>
                            <span>COD. {{ TIPO_COMPROBANTE_CODIGO }}</span><br>
                            <span style="color: #343a40;">PROFORMA</span>
                        </td>
                        <td style="width: 65%; padding: 5px; text-align: left; vertical-align: middle;">
                            <span style="font-weight: bold;">FACTURA PROFORMA</span><br>
                            <span style="font-weight: bold;">N°:</span> PRO-{{ NRO_COMPROBANTE }}<br>
                            <span style="font-weight: bold;">Fecha de Emisión:</span> {{
                            pedido.created_at.strftime('%Y-%m-%d') if pedido.created_at else 'N/A' }}
                        </td>
                    </tr>
                </table>
            </td>
        </tr>
    </table>

    <div style="border: 1px solid #000; padding: 5px; margin-bottom: 15px;">
        <table style="width: 100%; border-collapse: collapse;">
            <tr>
                <td style="width: 50%;">
                    <strong>CUIT:</strong> {{ EMISOR_CUIT }}
                </td>
                <td style="width: 50%;">
                    <strong>Ingresos Brutos:</strong> {{ EMISOR_ING_BRUTOS }}
                </td>
            </tr>
            <tr>
                <td colspan="2">
                    <strong>Inicio de Actividades:</strong> {{ EMISOR_INICIO_ACT }}
                </td>
            </tr>
        </table>
    </div>

    <div style="border: 1px solid #000; padding: 5px; margin-bottom: 15px;">
        <table style="width: 100%; border-collapse: collapse;">
            <tr>
                <td style="width: 50%;">
                    <strong>Nombre:</strong> {{ pedido.nombre_cliente }}
                </td>
                <td style="width: 50%;">
                    <strong>CUIT/CUIL/DNI:</strong> {{ pedido.cliente.cuit or 'N/A' }}
                </td>
            </tr>
            <tr>
                <td>
                    <strong>Domicilio:</strong>
                    {% set d = pedido.direccion %}
                    {{ d.calle or 'N/A' }} {{ d.altura or 'N/A' }}
                </td>
                <td>
                    <strong>Localidad:</strong> {{ d.localidad or 'N/A' }}
                </td>
            </tr>
            <tr>
                <td colspan="2">
                    {% set condicion_iva_cliente = pedido.cliente.condicion_iva | string %}
                    {% set is_ri = 'X' if condicion_iva_cliente == '1' else '&#9633;' %}
                    {% set is_monotributo = 'X' if condicion_iva_cliente == '2' else '&#9633;' %}
                    {% set is_exento = 'X' if condicion_iva_cliente == '3' else '&#9633;' %}
                    {% set is_cf = 'X' if condicion_iva_cliente == '4' else '&#9633;' %}
                    {% set is_no_resp = '&#9633;' %}

                    <table style="width: 100%; font-size: 10pt; border: 1px solid #000; border-collapse: collapse;">
                        <tr style="background-color: #f0f0f0;">
                            <td style="width: 10%; padding: 4px 5px; text-align: center; border-right: 1px solid #000;">
                                <strong>I.V.A.</strong>
                            </td>
                            <td style="width: 20%; padding: 4px 5px;"><span style="font-family: monospace;">{{ is_ri |
                                    safe }}</span> R. Insc.</td>
                            <td style="width: 20%; padding: 4px 5px;"><span style="font-family: monospace;">{{
                                    is_monotributo | safe }}</span> Monotributo</td>
                            <td style="width: 20%; padding: 4px 5px;"><span style="font-family: monospace;">{{ is_exento
                                    | safe }}</span> IVA Exento</td>
                            <td style="width: 20%; padding: 4px 5px;"><span style="font-family: monospace;">{{ is_cf
                                    | safe }}</span> Cons. Final</td>
                            <td style="width: 10%; padding: 4px 5px;"><span style="font-family: monospace;">{{
                                    is_no_resp | safe }}</span> No Resp.</td>
                        </tr>
                    </table>
                </td>
            </tr>
            <tr>
                <td colspan="2">
                    <strong>Provincia:</strong> {{ d.provincia or 'N/A' }}
                </td>
            </tr>
        </table>
    </div>

    <table style="width: 100%; border-collapse: collapse; table-layout: fixed;">
        <thead>
            <tr style="background-color: #f0f0f0 !important; -webkit-print-color-adjust: exact; print-color-adjust: exact;">
                <th style="width: 10%; padding: 5px 3px; text-align: center; border: 1px solid #000;">CAJAS</th>
                <th style="width: 15%; padding: 5px 3px; text-align: left; border: 1px solid #000; border-left: none;">PESO NETO</th>
                <th style="width: 35%; padding: 5px 3px; text-align: left; border: 1px solid #000; border-left: none;">DESCRIPCION</th>
                <th style="width: 15%; padding: 5px 3px; text-align: right; border: 1px solid #000; border-left: none;">PRECIO</th>
                <th style="width: 25%; padding: 5px 3px; text-align: right; border: 1px solid #000; border-left: none;">IMPORTE</th>
            </tr>
        </thead>
        <tbody>
            {% set ns = namespace(base_imponible=0.0, total_iva=0.0, total_final=0.0, total_cantidad=0.0) %}
            {% set NETO_FACTOR = 1.21 %}

            {% for item in pedido['items'] %}
            {% set producto_nombre = item.producto_nombre.nombre if item.producto_nombre is mapping else item.producto_nombre %}
            {% set precio_con_iva = item.producto_nombre.get('precio_unitario', 0.0) | float %}
            {% set item_cantidad = item.get('cantidad', 0) | float %}
            {% set unidad_medida = item.producto_nombre.unidad_medida if item.producto_nombre is mapping and item.producto_nombre.unidad_medida else 'UNI' %}

            {% set precio_neto_unitario = precio_con_iva / NETO_FACTOR %}
            {% set subtotal_total_item = precio_con_iva * item_cantidad %}

            {% set ns.base_imponible = ns.base_imponible + (precio_neto_unitario * item_cantidad) %}
            {% set ns.total_iva = ns.total_iva + ((precio_neto_unitario * item_cantidad) * 0.21) %}
            {% set ns.total_final = ns.total_final + subtotal_total_item %}
            
            {% set ns.total_cantidad = ns.total_cantidad + item_cantidad %}

            <tr style="border-bottom: 1px dashed #000;">
                <td style="padding: 5px 3px; text-align: center; border: 1px solid #000; border-top: none; border-bottom: 1px dashed #ddd; border-right: none;">APROX.</td> 
                <td style="padding: 5px 3px; text-align: left; border: 1px solid #000; border-top: none; border-left: none; border-bottom: 1px dashed #ddd; border-right: none;">{{ "%.2f"|format(item_cantidad) | replace('.', ',') }} {{ unidad_medida }}</td> 
                <td style="padding: 5px 3px; border: 1px solid #000; border-top: none; border-left: none; border-bottom: 1px dashed #ddd; border-right: none;">{{ producto_nombre or 'Producto sin nombre' }}</td>
                <td style="padding: 5px 3px; text-align: right; border: 1px solid #000; border-top: none; border-left: none; border-bottom: 1px dashed #ddd; border-right: none;">$ {{ precio_neto_unitario | formato_moneda }}</td>
                <td style="padding: 5px 3px; text-align: right; border: 1px solid #000; border-top: none; border-left: none; border-bottom: 1px dashed #ddd;">$ {{ subtotal_total_item | formato_moneda }}</td>
            </tr>
            {% endfor %}

            {% set total_items = pedido['items']|length %}
            {% set max_rows = 8 %} 
            {% if total_items < max_rows %} 
                {% for i in range(max_rows - total_items) %} 
                <tr style="height: 25px;">
                    <td style="padding: 5px 3px; border: 1px solid #000; border-top: none; border-bottom: 1px dashed #ddd; border-right: none;">&nbsp;</td>
                    <td style="padding: 5px 3px; border: 1px solid #000; border-top: none; border-left: none; border-bottom: 1px dashed #ddd; border-right: none;">&nbsp;</td>
                    <td style="padding: 5px 3px; border: 1px solid #000; border-top: none; border-left: none; border-bottom: 1px dashed #ddd; border-right: none;">&nbsp;</td>
                    <td style="padding: 5px 3px; border: 1px solid #000; border-top: none; border-left: none; border-bottom: 1px dashed #ddd; border-right: none;">&nbsp;</td>
                    <td style="padding: 5px 3px; border: 1px solid #000; border-top: none; border-left: none; border-bottom: 1px dashed #ddd;">&nbsp;</td>
                </tr>
                {% endfor %}
            {% endif %}
        </tbody>
        <tfoot>
            <tr>
                <td style="padding: 5px 3px; text-align: center; border: 1px solid #000; border-top: 1px solid #000;">APROX.</td>
                <td style="padding: 5px 3px; text-align: left; border: 1px solid #000; border-left: none; border-top: 1px solid #000;">{{ "%.2f"|format(ns.total_cantidad) | replace('.', ',') }} UNI</td>
                
                <td style="padding: 5px 3px; text-align: center; font-weight: bold; border: 1px solid #000; border-left: none; border-top: 1px solid #000;">BASE IMPONIBLE</td>
                <td style="padding: 5px 3px; text-align: right; border: 1px solid #000; border-left: none; border-top: 1px solid #000;">$ {{ ns.base_imponible | formato_moneda }}</td>
                <td style="padding: 5px 3px; text-align: right; font-weight: bold; background-color: #f0f0f0; border: 1px solid #000; border-left: none; border-top: 1px solid #000;">TOTAL PROFORMA</td>
            </tr>
            <tr>
                <td style="padding: 5px 3px; border: 1px solid #000; border-top: none;">&nbsp;</td>
                <td style="padding: 5px 3px; border: 1px solid #000; border-top: none; border-left: none;">&nbsp;</td>
                <td style="padding: 5px 3px; text-align: center; font-weight: bold; border: 1px solid #000; border-top: none; border-left: none;">% IVA</td>
                <td style="padding: 5px 3px; text-align: right; border: 1px solid #000; border-top: none; border-left: none;">21,00%</td>
                <td style="padding: 5px 3px; text-align: right; font-weight: bold; background-color: #f0f0f0; border: 1px solid #000; border-top: none; border-left: none;">$ {{ ns.total_final | formato_moneda }}</td>
            </tr>
            <tr>
                <td colspan="3" style="padding: 5px 3px; text-align: center; font-weight: bold; border: 1px solid #000; border-top: none;">IMPORTE I.V.A.</td>
                <td style="padding: 5px 3px; text-align: right; border: 1px solid #000; border-top: none; border-left: none;">$ {{ ns.total_iva | formato_moneda }}</td>
                <td style="padding: 5px 3px; border: 1px solid #000; border-top: none; border-left: none;">&nbsp;</td>
            </tr>
        </tfoot>
    </table>

    <div style="border: 1px solid #000; padding: 5px; margin-top: 15px;">
        <table style="width: 100%; border-collapse: collapse;">
            <tr>
                <td style="width: 60%; vertical-align: top; padding-right: 5px; border: 0;">
                    <div style="border: 0; padding: 0;">
                        <strong>Condiciones de Venta:</strong> Contado / Transferencia Bancaria<br>
                        {% if pedido.comentarios_adicionales %}
                        <strong>Observaciones:</strong> {{ pedido.comentarios_adicionales }}<br>
                        {% endif %}
                        <strong>Fecha de Vencimiento:</strong> {{ pedido.fecha_requerido or 'A convenir' }}
                    </div>
                </td>
            </tr>
        </table>
    </div>


    <div style="border: 1px solid #000; margin-top: 10px; padding: 5px; text-align: center;">
        <p style="font-weight: bold; margin: 0; color: #dc3545;">ESTE DOCUMENTO NO ES UNA FACTURA. ES UNA COTIZACIÓN.</p>
        <p style="font-size: 9pt; margin: 5px 0 0;">La emisión de la Factura de Venta real está sujeta a la disponibilidad de stock en la fecha de entrega.</p>
    </div>
</div>