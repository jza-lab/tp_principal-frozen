{% set pedido = pedido %}
{% set TIPO_COMPROBANTE = "B" %}
{% set TIPO_COMPROBANTE_CODIGO = "06" %}
{% set PUNTO_VENTA = "0001" %}
{% set NRO_COMPROBANTE = "%08d"|format(pedido.id) %}

{% set EMISOR_NOMBRE = "FrozenProd S.A." %}
{% set EMISOR_CUIT = "30-71000000-8" %}
{% set EMISOR_DOMICILIO = "Juan María Gutiérrez 1150, Los Polvorines, Provincia de Buenos Aires" %}
{% set EMISOR_CONDICION_IVA = "Responsable Inscripto" %}
{% set EMISOR_ING_BRUTOS = pedido.emisor.ingresos_brutos or "20-12345678-3" %}
{% set EMISOR_INICIO_ACT = pedido.emisor.inicio_actividades or "2020-01-01" %}
{% set EMISOR_CAE = pedido.emisor.cae or '00000000000000' %}
{% set EMISOR_VTO_CAE = pedido.emisor.vencimiento_cae or '2025-10-31' %}


<div style="font-family: Arial, sans-serif; font-size: 11pt; width: 100%; margin: 0 auto; padding: 5px;">

    <table style="width: 100%; border-collapse: collapse; margin-bottom: 15px;">
        <tr>
            <td style="vertical-align: top; padding-right: 5px;">
                <h3
                    style="margin-top: 0; margin-bottom: 5px; font-size: 18pt; font-weight: bold; display: flex; align-items: center;">
                    <span style="color: #66ccff; margin-right: 8px;">❄️</span>
                    FrozenProd S.A.
                </h3>

                <table style="width: 100%; border-collapse: collapse;">
                    <tr>
                        <td style="width: 30%; vertical-align: top; padding-top: 5px;">
                            <strong>Domicilio:</strong><br>
                            {{ EMISOR_DOMICILIO }}
                        </td>
                        <td style="width: 70%; vertical-align: top; padding-top: 5px;">
                            <strong>Condición IVA:</strong> {{ EMISOR_CONDICION_IVA }}
                        </td>
                    </tr>
                </table>
            </td>

            <td style="width: 25%; border: 1px solid #000; padding: 0; text-align: center;">
                <table style="width: 100%; height: 100%; border-collapse: collapse;">
                    <tr>
                        <td
                            style="width: 35%; background-color: #ddd; border-right: 1px solid #000; padding: 5px; text-align: center; vertical-align: middle;">
                            <span style="font-size: 16pt; font-weight: bold; color: #dc3545;">{{ TIPO_COMPROBANTE
                                }}</span><br>
                            <span>COD. {{ TIPO_COMPROBANTE_CODIGO }}</span><br>
                            <span>ORIGINAL</span>
                        </td>
                        <td style="width: 65%; padding: 5px; text-align: left; vertical-align: middle;">
                            <span style="font-weight: bold;">FACTURA</span><br>
                            <span style="font-weight: bold;">N°:</span> {{ PUNTO_VENTA }}-{{ NRO_COMPROBANTE }}<br>
                            <span style="font-weight: bold;">Fecha de Emisión:</span> {{
                            pedido.created_at.strftime('%Y-%m-%d') if pedido.created_at else 'N/A' }}
                        </td>
                    </tr>
                </table>
            </td>
        </tr>
    </table>

    <div style="border: 1px solid #000; padding: 5px; margin-bottom: 15px;">
        <table style="width: 100%; border-collapse: collapse;">
            <tr>
                <td style="width: 50%;">
                    <strong>CUIT:</strong> {{ EMISOR_CUIT }}
                </td>
                <td style="width: 50%;">
                    <strong>Ingresos Brutos:</strong> {{ EMISOR_ING_BRUTOS }}
                </td>
            </tr>
            <tr>
                <td colspan="2">
                    <strong>Inicio de Actividades:</strong> {{ EMISOR_INICIO_ACT }}
                </td>
            </tr>
        </table>
    </div>

    <div style="border: 1px solid #000; padding: 5px; margin-bottom: 15px;">
        <table style="width: 100%; border-collapse: collapse;">
            <tr>
                <td style="width: 50%;">
                    <strong>Nombre:</strong> {{ pedido.nombre_cliente }}
                </td>
                <td style="width: 50%;">
                    <strong>CUIT/CUIL/DNI:</strong> {{ pedido.cliente.cuit or 'N/A' }}
                </td>
            </tr>
            <tr>
                <td>
                    <strong>Domicilio:</strong>
                    {% set d = pedido.direccion %}
                    {{ d.calle or 'N/A' }} {{ d.altura or 'N/A' }}
                </td>
                <td>
                    <strong>Localidad:</strong> {{ d.localidad or 'N/A' }}
                </td>
            </tr>

            <tr>
                <td colspan="2">
                    {% set condicion_iva_cliente = pedido.cliente.condicion_iva | string %}
                    {% set is_ri = 'X' if condicion_iva_cliente == '1' else '&#9633;' %}
                    {% set is_monotributo = 'X' if condicion_iva_cliente == '2' else '&#9633;' %}
                    {% set is_exento = 'X' if condicion_iva_cliente == '3' else '&#9633;' %}
                    {% set is_cf = 'X' if condicion_iva_cliente == '4' else '&#9633;' %}
                    {% set is_no_resp = '&#9633;' %}

                    <table style="width: 100%; font-size: 10pt; border: 1px solid #000; border-collapse: collapse;">
                        <tr style="background-color: #f0f0f0;">
                            <td style="width: 10%; padding: 4px 5px; text-align: center; border-right: 1px solid #000;">
                                <strong>I.V.A.</strong>
                            </td>
                            <td style="width: 20%; padding: 4px 5px;"><span style="font-family: monospace;">{{ is_ri |
                                    safe }}</span> R. Insc.</td>
                            <td style="width: 20%; padding: 4px 5px;"><span style="font-family: monospace;">{{
                                    is_monotributo | safe }}</span> Monotributo</td>
                            <td style="width: 20%; padding: 4px 5px;"><span style="font-family: monospace;">{{ is_exento
                                    | safe }}</span> IVA Exento</td>
                            <td style="width: 20%; padding: 4px 5px;"><span style="font-family: monospace;">{{ is_cf
                                    | safe }}</span> Cons. Final</td>
                            <td style="width: 10%; padding: 4px 5px;"><span style="font-family: monospace;">{{
                                    is_no_resp | safe }}</span> No Resp.</td>
                        </tr>
                    </table>
                </td>
            </tr>
            <tr>
                <td colspan="2">
                    <strong>Provincia:</strong> {{ d.provincia or 'N/A' }}
                </td>
            </tr>
        </table>
    </div>

    <table style="width: 100%; border-collapse: collapse; margin-bottom: 15px;">
        <thead>
            <tr
                style="background-color: #f0f0f0 !important; -webkit-print-color-adjust: exact; print-color-adjust: exact; border-top: 1px solid #000; border-bottom: 1px solid #000;">
                <th style="width: 8%; padding: 5px 3px; text-align: center;">Código</th>
                <th style="width: 40%; padding: 5px 3px; text-align: left;">Descripción</th>
                <th style="width: 10%; padding: 5px 3px; text-align: center;">Cantidad</th>
                <th style="width: 22%; padding: 5px 3px; text-align: right;">P. Unitario (IVA Incl.)</th>
                <th style="width: 20%; padding: 5px 3px; text-align: right;">Importe Total (IVA Incl.)</th>
            </tr>
        </thead>
        <tbody>
            {% set ns = namespace(base_imponible=0.0, total_iva=0.0, total_final=0.0, total_cantidad=0.0) %}

            {% for item in pedido['items'] %}

            {% set producto_id = item.producto_nombre.get('id', loop.index) if item.producto_nombre is mapping else loop.index %}
            {% set producto_nombre = item.producto_nombre.nombre if item.producto_nombre is mapping else item.producto_nombre %}

            {% set precio_con_iva = item.producto_nombre.get('precio_unitario', 0.0) | float %}
            {% set item_cantidad = item.get('cantidad', 0) | float %}

            {% set NETO_FACTOR = 1.21 %}

            {% set precio_neto_unitario = precio_con_iva / NETO_FACTOR %}
            {% set subtotal_neto = precio_neto_unitario * item_cantidad %}
            {% set iva_item = subtotal_neto * 0.21 %}
            {% set subtotal_total_item = precio_con_iva * item_cantidad %}

            {% set ns.base_imponible = ns.base_imponible + subtotal_neto %}
            {% set ns.total_iva = ns.total_iva + iva_item %}
            {% set ns.total_final = ns.total_final + subtotal_total_item %}
            {% set ns.total_cantidad = ns.total_cantidad + item_cantidad %}

            <tr style="border-bottom: 1px dashed #ddd;">
                <td style="padding: 5px 3px; text-align: center;">{{ producto_id }}</td>
                <td style="padding: 5px 3px;">{{ producto_nombre or 'Producto sin nombre' }}</td>
                <td style="padding: 5px 3px; text-align: center;">{{ "%.2f"|format(item_cantidad) | replace('.', ',') }}</td>
                <td style="padding: 5px 3px; text-align: right;">$ {{ precio_con_iva | formato_moneda }}</td>
                <td style="padding: 5px 3px; text-align: right;">$ {{ subtotal_total_item | formato_moneda }}</td>
            </tr>
            {% endfor %}

            {% set total_items = pedido['items']|length %}
            {% set max_rows = 5 %}
            {% if total_items < max_rows %} {% for i in range(max_rows - total_items) %} <tr
                style="border-bottom: 1px dashed #ddd;">
                <td style="padding: 5px 3px;">&nbsp;</td>
                <td style="padding: 5px 3px;">&nbsp;</td>
                <td style="padding: 5px 3px;">&nbsp;</td>
                <td style="padding: 5px 3px;">&nbsp;</td>
                <td style="padding: 5px 3px;">&nbsp;</td>
                </tr>
                {% endfor %}
                {% endif %}

                <tr style="border-bottom: none;">
                    <td colspan="5" style="padding: 0;"></td>
                </tr>
        </tbody>
    </table>

    <table style="width: 100%; border-collapse: collapse;">
        <tr>
            <td style="width: 60%; vertical-align: top; padding-right: 5px;">
                <div style="border: 1px solid #000; padding: 5px;">
                   <strong>Condiciones de Venta:</strong>
                    {% if pedido.condicion_venta == 'contado' %}
                        Contado / Transferencia Bancaria
                    {% elif pedido.condicion_venta == 'credito_30' %}
                        Crédito a 30 días
                    {% elif pedido.condicion_venta == 'credito_90' %}
                        Crédito a 90 días
                    {% else %}
                        A convenir
                    {% endif %}
                    <br>
                    {% if pedido.comentarios_adicionales %}
                    <strong>Observaciones:</strong> {{ pedido.comentarios_adicionales }}<br>
                    {% endif %}
                    <strong>Fecha de Vencimiento:</strong> {{ pedido.fecha_requerido or 'A convenir' }}
                </div>
            </td>

            <td style="width: 40%; vertical-align: top;">
                <table style="width: 100%; border-collapse: collapse;">

                    <tr>
                        <td style="padding: 2px 5px; text-align: right;">Dto/Recargo:</td>
                        <td style="width: 50%; padding: 2px 5px; text-align: right;">$ {{ 0 | formato_moneda }}</td>
                    </tr>
                    <tr style="border-top: 1px solid #000; background-color: #f0f0f0;">
                        <td style="padding: 5px; text-align: right; font-weight: bold;">Importe Total:</td>
                        <td style="padding: 5px; text-align: right; font-weight: bold;">$ {{ ns.total_final | formato_moneda }} </td>
                    </tr>
                </table>
            </td>
        </tr>
    </table>

    <div style="border: 1px solid #000; margin-top: 10px; padding: 5px;">
        <table style="width: 100%;">
            <tr>
                <td style="width: 70%; vertical-align: middle;">
                    <div
                        style="height: 40px; width: 100px; border: 1px solid #000; float: left; margin-right: 10px; text-align: center; line-height: 40px;">
                        [CAE QR]
                    </div>
                    <span style="font-weight: bold;">Comprobante Autorizado</span><br>
                    <span style="font-size: 9pt;">Esta Administración Federal no se responsabiliza por los datos
                        ingresados en el detalle de la operación</span>
                </td>
                <td style="width: 30%; text-align: right; vertical-align: top;">
                    <span style="font-weight: bold;">CAE N°:</span> {{ EMISOR_CAE }}<br>
                    <span style="font-weight: bold;">Fecha de Vto. de CAE:</span> {{ EMISOR_VTO_CAE }}
                </td>
            </tr>
        </table>
    </div>
</div>