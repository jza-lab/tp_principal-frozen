{% set pedido = pedido %}
{% set TIPO_COMPROBANTE = "B" %}
{% set PUNTO_VENTA = "0001" %}
{% set NRO_COMPROBANTE = "%08d"|format(pedido.id) %}

{% set EMISOR_NOMBRE = "FrozenProd S.A." %}
{% set EMISOR_CUIT = "30-71000000-8" %}
{% set EMISOR_DOMICILIO = "Calle Falsa 123, CABA" %}
{% set EMISOR_CONDICION_IVA = "Responsable Inscripto" %}
{% set EMISOR_ING_BRUTOS = pedido.emisor.ingresos_brutos or "20-12345678-3" %}
{% set EMISOR_INICIO_ACT = pedido.emisor.inicio_actividades or "2020-01-01" %}
{% set EMISOR_CAE = pedido.emisor.cae or '00000000000000' %}
{% set EMISOR_VTO_CAE = pedido.emisor.vencimiento_cae or '2025-10-31' %}

<div style="font-family: Arial, sans-serif; font-size: 11pt; width: 100%; margin: 0 auto; padding: 5px;"> 
    
    <table style="width: 100%; border-collapse: collapse; margin-bottom: 15px;">
        <tr>
            <td style="vertical-align: top; padding-right: 5px;">
                <h3
                    style="margin-top: 0; margin-bottom: 5px; font-size: 18pt; font-weight: bold; display: flex; align-items: center;">
                    <span style="color: #66ccff; margin-right: 8px;">❄️</span>
                    FrozenProd S.A.
                </h3>

                <table style="width: 100%; border-collapse: collapse;">
                    <tr>
                        <td style="width: 30%; vertical-align: top; padding-top: 5px;">
                            <strong>Domicilio:</strong><br>
                            {{ EMISOR_DOMICILIO }}
                        </td>
                        <td style="width: 70%; vertical-align: top; padding-top: 5px;">
                            <strong>Condición IVA:</strong> {{ EMISOR_CONDICION_IVA }}
                        </td>
                    </tr>
                </table>
            </td>
            
            <td style="width: 25%; border: 1px solid #000; padding: 0; text-align: center;">
                <table style="width: 100%; height: 100%; border-collapse: collapse;">
                    <tr>
                        <td style="width: 35%; background-color: #ddd; border-right: 1px solid #000; padding: 5px; text-align: center; vertical-align: middle;">
                            <span style="font-size: 16pt; font-weight: bold; color: #dc3545;">{{ TIPO_COMPROBANTE }}</span><br>
                            <span>COD. 06</span><br> 
                            <span>ORIGINAL</span>
                        </td>
                        <td style="width: 65%; padding: 5px; text-align: left; vertical-align: middle;">
                            <span style="font-weight: bold;">FACTURA</span><br>
                            <span style="font-weight: bold;">N°:</span> {{ PUNTO_VENTA }}-{{ NRO_COMPROBANTE }}<br>
                            <span style="font-weight: bold;">Fecha de Emisión:</span> {{ pedido.created_at.strftime('%Y-%m-%d') if pedido.created_at else 'N/A' }}
                        </td>
                    </tr>
                </table>
            </td>
        </tr>
    </table>
    
    <div style="border: 1px solid #000; padding: 5px; margin-bottom: 15px;">
        <table style="width: 100%; border-collapse: collapse;">
            <tr>
                <td style="width: 50%;">
                    <strong>CUIT:</strong> {{ EMISOR_CUIT }}
                </td>
                <td style="width: 50%;">
                    <strong>Ingresos Brutos:</strong> {{ EMISOR_ING_BRUTOS }}
                </td>
            </tr>
            <tr>
                <td colspan="2">
                    <strong>Inicio de Actividades:</strong> {{ EMISOR_INICIO_ACT }}
                </td>
            </tr>
        </table>
    </div>

    <div style="border: 1px solid #000; padding: 5px; margin-bottom: 15px;">
        <table style="width: 100%; border-collapse: collapse;">
            <tr>
                <td style="width: 50%;">
                    <strong>Nombre:</strong> {{ pedido.nombre_cliente }}
                </td>
                <td style="width: 50%;">
                    <strong>CUIT/CUIL/DNI:</strong> {{ pedido.cliente.cuit or 'N/A' }}
                </td>
            </tr>
            <tr>
                <td>
                    <strong>Domicilio:</strong> 
                    {% set d = pedido.direccion %}
                    {{ d.calle or 'N/A' }} {{ d.altura or 'N/A' }}
                </td>
                <td>
                    <strong>Localidad:</strong> {{ d.localidad or 'N/A' }}
                </td>
            </tr>
            <tr>
                <td>
                    <strong>Condición IVA:</strong> CONSUMIDOR FINAL (Asumido)
                </td>
                <td>
                    <strong>Provincia:</strong> {{ d.provincia or 'N/A' }}
                </td>
            </tr>
        </table>
    </div>

    <table style="width: 100%; border-collapse: collapse; margin-bottom: 15px;">
        <thead>
            <tr style="background-color: #f0f0f0 !important; -webkit-print-color-adjust: exact; print-color-adjust: exact; border-top: 1px solid #000; border-bottom: 1px solid #000;">
                <th style="width: 8%; padding: 5px 3px; text-align: center;">Código</th>
                <th style="width: 30%; padding: 5px 3px; text-align: left;">Descripción</th>
                <th style="width: 10%; padding: 5px 3px; text-align: center;">Cantidad</th>
                <th style="width: 15%; padding: 5px 3px; text-align: right;">P. Unitario</th>
                <th style="width: 17%; padding: 5px 3px; text-align: right;">IVA (21%)</th> 
                <th style="width: 20%; padding: 5px 3px; text-align: right;">Importe Total</th>
            </tr>
        </thead>
        <tbody>
            {% set ns = namespace(base_imponible=0.0, total_iva=0.0, total_final=0.0) %}
            
            {% for item in pedido['items'] %}
                
                {# Cálculos de totales #}
                {% set producto_id = item.producto_nombre.get('id', loop.index) if item.producto_nombre is mapping else loop.index %}
                {% set producto_nombre = item.producto_nombre.nombre if item.producto_nombre is mapping else item.producto_nombre %}
                
                {% set precio_con_iva = item.producto_nombre.get('precio_unitario', 0.0) | float %}
                {% set item_cantidad = item.get('cantidad', 0) | int %}
                
                {% set NETO_FACTOR = 1.21 %}
                
                {% set precio_neto_unitario = precio_con_iva / NETO_FACTOR %}
                {% set subtotal_neto = precio_neto_unitario * item_cantidad %}
                {% set iva_item = subtotal_neto * 0.21 %}
                {% set subtotal_total_item = precio_con_iva * item_cantidad %}

                {% set ns.base_imponible = ns.base_imponible + subtotal_neto %}
                {% set ns.total_iva = ns.total_iva + iva_item %}
                {% set ns.total_final = ns.total_final + subtotal_total_item %}

                <tr style="border-bottom: 1px dashed #ddd;">
                    <td style="padding: 5px 3px; text-align: center;">{{ producto_id }}</td>
                    <td style="padding: 5px 3px;">{{ producto_nombre or 'Producto sin nombre' }}</td>
                    <td style="padding: 5px 3px; text-align: center;">{{ item_cantidad }}</td>
                    <td style="padding: 5px 3px; text-align: right;">$ {{ "%.2f"|format(precio_con_iva) }}</td>
                    <td style="padding: 5px 3px; text-align: right;">$ {{ "%.2f"|format(iva_item) }}</td>
                    <td style="padding: 5px 3px; text-align: right;">$ {{ "%.2f"|format(subtotal_total_item) }}</td>
                </tr>
            {% endfor %}
            
            {# Rellenar filas vacías #}
            {% set total_items = pedido['items']|length %}
            {% set max_rows = 5 %}
            {% if total_items < max_rows %}
                {% for i in range(max_rows - total_items) %}
                <tr style="border-bottom: 1px dashed #ddd;">
                    <td style="padding: 5px 3px;">&nbsp;</td>
                    <td style="padding: 5px 3px;">&nbsp;</td>
                    <td style="padding: 5px 3px;">&nbsp;</td>
                    <td style="padding: 5px 3px;">&nbsp;</td>
                    <td style="padding: 5px 3px;">&nbsp;</td>
                    <td style="padding: 5px 3px;">&nbsp;</td>
                </tr>
                {% endfor %}
            {% endif %}
            
            <tr style="border-bottom: none;">
                <td colspan="6" style="padding: 0;"></td>
            </tr>
        </tbody>
    </table>
    
    <table style="width: 100%; border-collapse: collapse;">
        <tr>
            <td style="width: 60%; vertical-align: top; padding-right: 5px;">
                <div style="border: 1px solid #000; padding: 5px;">
                    <strong>Condiciones de Venta:</strong> Contado / Transferencia Bancaria<br>
                    {% if pedido.comentarios_adicionales %}
                    <strong>Observaciones:</strong> {{ pedido.comentarios_adicionales }}<br>
                    {% endif %}
                    <strong>Fecha de Vencimiento:</strong> {{ pedido.fecha_requerido or 'A convenir' }}
                </div>
            </td>
            
            <td style="width: 40%; vertical-align: top;">
                <table style="width: 100%; border-collapse: collapse;">
                    <tr>
                        <td style="width: 50%; padding: 2px 5px; text-align: right;">Subtotal Neto:</td>
                        <td style="width: 50%; padding: 2px 5px; text-align: right;">$ {{ "%.2f"|format(ns.base_imponible) }}</td>
                    </tr>
                    <tr>
                        <td style="padding: 2px 5px; text-align: right;">Impuestos (IVA 21%):</td>
                        <td style="width: 50%; padding: 2px 5px; text-align: right;">$ {{ "%.2f"|format(ns.total_iva) }}</td>
                    </tr>
                    <tr>
                        <td style="padding: 2px 5px; text-align: right;">Dto/Recargo:</td>
                        <td style="width: 50%; padding: 2px 5px; text-align: right;">$ 0.00</td>
                    </tr>
                    <tr style="border-top: 1px solid #000; background-color: #f0f0f0;">
                        <td style="padding: 5px; text-align: right; font-weight: bold;">Total:</td>
                        <td style="padding: 5px; text-align: right; font-weight: bold;">$ {{ "%.2f"|format(ns.total_final) }}</td>
                    </tr>
                </table>
            </td>
        </tr>
    </table>

    <div style="border: 1px solid #000; margin-top: 10px; padding: 5px;">
        <table style="width: 100%;">
            <tr>
                <td style="width: 70%; vertical-align: middle;">
                    <div style="height: 40px; width: 100px; border: 1px solid #000; float: left; margin-right: 10px; text-align: center; line-height: 40px;">
                        [CAE QR]
                    </div>
                    <span style="font-weight: bold;">Comprobante Autorizado</span><br>
                    <span style="font-size: 9pt;">Esta Administración Federal no se responsabiliza por los datos ingresados en el detalle de la operación</span>
                </td>
                <td style="width: 30%; text-align: right; vertical-align: top;">
                    <span style="font-weight: bold;">CAE N°:</span> {{ EMISOR_CAE }}<br>
                    <span style="font-weight: bold;">Fecha de Vto. de CAE:</span> {{ EMISOR_VTO_CAE }}
                </td>
            </tr>
        </table>
    </div>
</div>