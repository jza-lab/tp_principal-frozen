{% extends 'layouts/base.html' %}

{% block title %}
    {% if pedido %}Editar{% else %}Nuevo{% endif %} Pedido de Venta - Sistema Frozen
{% endblock %}

{% block content %}
<div class="d-flex justify-content-between flex-wrap flex-md-nowrap align-items-center pb-2 mb-4 border-bottom">
    <div>
        <h1 class="h2 mb-1">
            {% if pedido %}Editar Pedido de Venta{% else %}Nuevo Pedido de Venta{% endif %}
        </h1>
        <p class="text-muted mb-0">
            {% if pedido and pedido.id %}
                Modificar pedido <code>PED-{{ pedido.id }}</code> | Cliente: <strong>{{ pedido.nombre_cliente }}</strong>
            {% else %}
                Crear un nuevo pedido para un cliente
            {% endif %}
        </p>
    </div>
    <div class="btn-toolbar">
        <a href="{{ url_for('orden_venta.listar') }}" class="btn btn-outline-secondary">
            <i class="bi bi-arrow-left me-1"></i>Volver a la Lista
        </a>
        {% if pedido and pedido.id %}
        <!-- Botón de ejemplo para gestión de producción -->
        <a href="#" class="btn btn-outline-info ms-2">
            <i class="bi bi-gear-fill me-1"></i>Generar OP
        </a>
        {% endif %}
    </div>
</div>

<form method="POST" id="pedido-form">
    <div class="row">
        <!-- Columna principal del formulario -->
        <div class="col-lg-8">
            <div class="card shadow-sm">
                <div class="card-header bg-light">
                    <h5 class="mb-0">Información del Pedido</h5>
                </div>
                <div class="card-body">
                    <div class="row g-3">
                        <div class="col-md-6">
                            <label for="nombre_cliente" class="form-label">Nombre del Cliente <span class="text-danger">*</span></label>
                            <input type="text" class="form-control" id="nombre_cliente" name="nombre_cliente" 
                                   value="{{ pedido.nombre_cliente if pedido else '' }}" required>
                        </div>
                        
                        <div class="col-md-6">
                            <label for="fecha_solicitud" class="form-label">Fecha de Solicitud <span class="text-danger">*</span></label>
                            <!-- FIX PREVIO: Se usa la conversión a string y el slicing [0:10] para manejar de forma segura datetime/strings. -->
                            <input type="date" class="form-control" id="fecha_solicitud" name="fecha_solicitud" 
                                   value="{{ (pedido.fecha_solicitud | string)[:10] if pedido and pedido.fecha_solicitud else '' }}" required>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Items del Pedido -->
            <div class="card shadow-sm mt-4">
                <div class="card-header d-flex justify-content-between align-items-center bg-light">
                    <h5 class="mb-0">Productos del Pedido</h5>
                    <button type="button" class="btn btn-sm btn-outline-primary" id="add-item-btn">
                        <i class="bi bi-plus-circle me-1"></i>Añadir Producto
                    </button>
                </div>
                <div class="card-body p-0">
                    <table class="table table-sm align-middle mb-0">
                        <thead class="bg-light">
                            <tr>
                                <th style="width: 30%;">Producto <span class="text-danger">*</span></th>
                                <th style="width: 15%;">Cantidad <span class="text-danger">*</span></th>
                                <th style="width: 30%;">Estado Ítem</th> 
                                <th style="width: 15%;">Stock</th>
                                <th style="width: 10%;" class="text-center">Acción</th>
                            </tr>
                        </thead>
                        <tbody id="items-container">
                            <!-- Cálculo de TOTAL_FORMS, vital para formsets. Usa notación de diccionario para robustez. -->
                            <input type="hidden" name="items-TOTAL_FORMS" id="id_items-TOTAL_FORMS" 
                                   value="{{ pedido['items'] | length if pedido and pedido['items'] else 0 }}">

                            {% if pedido and pedido['items'] %}
                                {% for item in pedido['items'] %}
                                <tr class="item-row">
                                    <td>
                                        <!-- ESTE CAMPO 'id' es el que debe ser añadido a tu esquema de validación Python. -->
                                        <input type="hidden" name="items-{{ loop.index0 }}-id" value="{{ item.id if item.id else '' }}">
                                        <select class="form-select form-select-sm" name="items-{{ loop.index0 }}-producto_id" required>
                                            <option value="">Seleccione...</option>
                                            {% for producto in productos %}
                                                <option value="{{ producto.id }}" data-stock="{{ producto.stock_disponible or 0 }}" {% if item.producto_id == producto.id %}selected{% endif %}>
                                                    {{ producto.nombre }}
                                                </option>
                                            {% endfor %}
                                        </select>
                                    </td>
                                    <td>
                                        <input type="number" step="1" min="0" class="form-control form-control-sm" name="items-{{ loop.index0 }}-cantidad" 
                                               placeholder="Ej: 10" min="0.1" step="0.1" value="{{ item.cantidad }}" required>
                                    </td>
                                    <!-- NUEVO CAMPO: Estado del Ítem -->
                                    <td>
                                        <select class="form-select form-select-sm" name="items-{{ loop.index0 }}-estado">
                                            <option value="PENDIENTE" {% if item.estado == 'PENDIENTE' %}selected{% endif %}>Pendiente</option>
                                            <option value="EN_PRODUCCION" {% if item.estado == 'EN_PRODUCCION' %}selected{% endif %}>En Producción</option>
                                            <option value="ALISTADO" {% if item.estado == 'ALISTADO' %}selected{% endif %}>Alistado</option>
                                            <option value="CANCELADO_ITEM" {% if item.estado == 'CANCELADO_ITEM' %}selected{% endif %}>Cancelado (Ítem)</option>
                                        </select>
                                    </td>
                                    <td>
                                        <span class="badge bg-secondary text-white stock-display">--</span>
                                    </td>
                                    <td class="text-center">
                                        <button type="button" class="btn btn-sm btn-outline-danger remove-item-btn" title="Eliminar ítem"><i class="bi bi-trash"></i></button>
                                    </td>
                                </tr>
                                {% endfor %}
                            {% endif %}
                        </tbody>
                    </table>
                    <!-- FIX para usar la notación de diccionario para consistencia. -->
                    <div id="no-items-msg" class="text-center text-muted py-3 border-top" {% if pedido and pedido['items'] | length > 0 %}style="display: none;"{% endif %}>
                        <i class="bi bi-box-seam fs-3"></i>
                        <p class="mt-2">Añada productos al pedido.</p>
                    </div>
                </div>
            </div>
        </div>

        <!-- Columna lateral -->
        <div class="col-lg-4">
            <div class="card sticky-top shadow-sm" style="top: 20px;">
                <div class="card-header bg-primary text-white">
                    <h5 class="mb-0">Resumen y Acciones</h5>
                </div>
                <div class="card-body">
                    {% if pedido %}
                    <div class="mb-3">
                        <label for="estado" class="form-label">Estado del Pedido Global</label>
                        <select class="form-select" id="estado" name="estado">
                            <option value="PENDIENTE" {% if pedido.estado == 'PENDIENTE' %}selected{% endif %}>Pendiente</option>
                            <option value="EN_PROCESO" {% if pedido.estado == 'EN_PROCESO' %}selected{% endif %}>En Proceso</option>
                            <option value="LISTO_PARA_ENTREGA" {% if pedido.estado == 'LISTO_PARA_ENTREGA' %}selected{% endif %}>Listo para Entrega</option>
                            <option value="COMPLETADO" {% if pedido.estado == 'COMPLETADO' %}selected{% endif %}>Completado</option>
                            <option value="CANCELADO" {% if pedido.estado == 'CANCELADO' %}selected{% endif %}>Cancelado</option>
                        </select>
                    </div>
                    <hr>
                    {% endif %}
                    
                    <div class="alert alert-info border-0 rounded-3 bg-light p-3">
                        <i class="bi bi-info-circle me-1"></i>
                        Asegúrese de que todos los datos y cantidades son correctos antes de guardar.
                    </div>
                    
                    <div class="d-grid gap-2 mt-4">
                        <button type="submit" class="btn btn-primary btn-lg">
                            <i class="bi bi-save me-1"></i>
                            {% if pedido %}Actualizar Pedido{% else %}Guardar Pedido{% endif %}
                        </button>
                        <a href="{{ url_for('orden_venta.listar') }}" class="btn btn-outline-secondary">
                            Cancelar
                        </a>
                    </div>
                </div>
            </div>
        </div>
    </div>
</form>

<!-- Plantilla para nuevos items -->
<template id="item-template">
    <tr class="item-row">
        <td>
            <!-- Campo oculto para el ID del ítem (si se guarda) -->
            <input type="hidden" name="items-__prefix__-id" value=""> 
            <select class="form-select form-select-sm" name="items-__prefix__-producto_id" required>
                <option value="" selected>Seleccione un producto...</option>
                {% for producto in productos %}
                    <option value="{{ producto.id }}" data-stock="{{ producto.stock_disponible or 0 }}">{{ producto.nombre }}</option>
                {% endfor %}
            </select>
        </td>
        <td>
            <input type="number" class="form-control form-control-sm" name="items-__prefix__-cantidad" 
                   placeholder="Ej: 10" min="0.1" step="0.1" required>
        </td>
        <!-- NUEVO CAMPO EN LA PLANTILLA: Estado del Ítem para nuevos elementos -->
        <td>
            <select class="form-select form-select-sm" name="items-__prefix__-estado">
                <option value="PENDIENTE" selected>Pendiente</option>
                <option value="EN_PRODUCCION">En Producción</option>
                <option value="ALISTADO">Alistado</option>
                <option value="CANCELADO_ITEM">Cancelado (Ítem)</option>
            </select>
        </td>
        <td>
            <span class="badge bg-secondary text-white stock-display">--</span>
        </td>
        <td class="text-center">
            <button type="button" class="btn btn-sm btn-outline-danger remove-item-btn" title="Eliminar ítem"><i class="bi bi-trash"></i></button>
        </td>
    </tr>
</template>
{% endblock %}

{% block extra_js %}
<script src="{{ url_for('static', filename='js/formularioVenta.js') }}"></script>
{% endblock extra_js %}
