{% extends 'layouts/app_layout.html' %}
{% set is_edit = pedido and pedido.id %}

{% block title %}
{% if pedido %}Editar{% else %}Nuevo{% endif %} Pedido de Venta - Sistema Frozen
{% endblock %}

{% block app_content %}

<div class="d-flex justify-content-between flex-wrap flex-md-nowrap align-items-center pb-2 mb-4 border-bottom">
    <div>
        <h1 class="h2 mb-1">
            {% if pedido %}Editar Pedido de Venta{% else %}Nuevo Pedido de Venta{% endif %}
        </h1>
        <p class="text-muted mb-0">
            {% if pedido and pedido.id %}
            Modificar pedido <code>PED-{{ pedido.id }}</code> | Cliente: <strong>{{ pedido.nombre_cliente }}</strong>
            {% else %}
            Crear un nuevo pedido para un cliente
            {% endif %}
        </p>
    </div>
    <div class="btn-toolbar">
        <a href="{{ url_for('orden_venta.listar') }}" class="btn btn-outline-secondary">
            <i class="bi bi-arrow-left me-1"></i>Volver a la Lista
        </a>
        {% if pedido and pedido.id %}
        <a href="#" class="btn btn-outline-info ms-2">
            <i class="bi bi-gear-fill me-1"></i>Generar OP
        </a>
        {% endif %}
    </div>
</div>

<form method="POST" id="pedido-form">
    <input type="hidden" id="id_cliente" name="id_cliente" value="{{ cliente.id if cliente else ''}}">
    <input type="hidden" id="cuil" name="cuil" value="">
    {{ csrf_form.csrf_token }}

    <div class="row">
        <div class="col-lg-8">
            <div class="card shadow-sm">
                <div class="card-header bg-light">
                    <h5 class="mb-0">Información del Cliente</h5>
                </div>
                <div class="card-body">
                    <div class="row g-3">
                        <div class="col-md-6">
                            <div class="input-group">

                                <input type="text" class="form-control text-center" id="cuil_parte1" name="cuil_parte1"
                                    maxlength="2" pattern="\d{2}" placeholder="XX" required
                                    style="width: 3em; flex-grow: 0; padding-top: 0.5em; padding-bottom: 0.5em;"
                                    value="{{ cliente.cuit[:2] if cliente and cliente.cuit else '' }}"
                                    aria-label="Código de provincia" {% if is_edit %}readonly{% endif %}>

                                <span class="input-group-text">-</span>

                                <div class="form-floating" style="flex-grow: 4;">
                                    <input type="text" class="form-control text-center" id="cuil_parte2"
                                        name="cuil_parte2" maxlength="8" pattern="\d{8}" placeholder="XXXXXXXX"
                                        value="{{ cliente.cuit[2:10] if cliente and cliente.cuit else '' }}" required {%
                                        if is_edit %}readonly{% endif %}>
                                    <label for="cuil_parte2">
                                        <i class="bi bi-person-badge me-1"></i>CUIL
                                    </label>
                                </div>

                                <span class="input-group-text">-</span>

                                <input type="text" class="form-control text-center" id="cuil_parte3" name="cuil_parte3"
                                    value="{{ cliente.cuit[10:] if cliente and cliente.cuit else ''}}" maxlength="1"
                                    pattern="\d{1}" placeholder="X" required {% if is_edit %}readonly{% endif %}
                                    style="width: 3em; flex-grow: 0; padding-top: 0.5em; padding-bottom: 0.5em;"
                                    aria-label="Dígito verificador">
                            </div>
                        </div>


                        <div class="col-md-6">
                            <div class="form-floating">
                                <input type="text" class="form-control" id="nombre_cliente" name="nombre_cliente"
                                    placeholder="Nombre del Cliente"
                                    value="{{ pedido.nombre_cliente if pedido else '' }}" {% if is_edit %}readonly{%
                                    endif %}>
                                <label for="nombre_cliente">
                                    <i class="bi bi-person-circle me-1"></i>Nombre <span class="text-danger">*</span>
                                </label>
                            </div>
                        </div>

                        <div class="col-md-6">
                            <div class="form-floating">
                                <input type="text" class="form-control" name="telefono" id="telefono"
                                    placeholder="Teléfono" value="{{ cliente.telefono if cliente else '' }}" {% if
                                    is_edit %}readonly{% endif %}>
                                <label for="telefono">
                                    <i class="bi bi-phone me-1"></i>Teléfono <span class="text-danger">*</span>
                                </label>
                            </div>
                        </div>

                        <div class="col-md-6">
                            <div class="form-floating">
                                <input type="email" class="form-control" name="email" id="email" placeholder="Email"
                                    value="{{ cliente.email if cliente else '' }}" {% if is_edit %}readonly{% endif %}>
                                <label for="email">
                                    <i class="bi bi-envelope me-1"></i>Email <span class="text-danger">*</span>
                                </label>
                            </div>


                        </div>

                        <div class="form-subsection">
                            <label class="form-label">Dirección de Facturacion</label>
                            <div class="row g-3">
                                <div class="col-md-8">
                                    <div class="form-floating">
                                        <input type="text" class="form-control" id="calle_facturacion"
                                            name="calle_facturacion" placeholder="Calle"
                                            value="{{ cliente.direccion.calle if cliente and cliente.direccion else '' }}"
                                            {% if is_edit %}readonly{% endif %}>
                                        <label for="calle_facturacion">
                                            <i class="bi bi-signpost me-1"></i>Calle
                                        </label>
                                    </div>
                                    <div class="invalid-feedback"></div>
                                </div>

                                <div class="col-md-4">
                                    <div class="form-floating">
                                        <input type="number" class="form-control" id="altura_facturacion"
                                            value="{{ cliente.direccion.altura if cliente and cliente.direccion else '' }}"
                                            name="altura_facturacion" placeholder="Altura" value="" {% if is_edit
                                            %}readonly{% endif %}>
                                        <label for="altura_facturacion">
                                            <i class="bi bi-123 me-1"></i>Altura
                                        </label>
                                    </div>
                                    <div class="invalid-feedback"></div>
                                </div>

                                <div class="col-md-6">
                                    <div class="form-floating">
                                        <select class="form-select" id="provincia_facturacion"
                                            name="provincia_facturacion" {% if is_edit %}readonly{% endif %}>
                                            <option value="">Seleccionar provincia...</option>
                                            {% set provincias = ["Buenos Aires", "CABA", "Catamarca", "Chaco", "Chubut",
                                            "Córdoba", "Corrientes", "Entre Ríos", "Formosa", "Jujuy", "La Pampa", "La
                                            Rioja", "Mendoza", "Misiones", "Neuquén", "Río Negro", "Salta", "San Juan",
                                            "San Luis", "Santa Cruz", "Santa Fe", "Santiago del Estero", "Tierra del
                                            Fuego",
                                            "Tucumán"] %}
                                            {% for p in provincias %}
                                            <option value="{{ p }}" {% if cliente and cliente.direccion.provincia==p
                                                %}selected{% endif %}>{{ p }}</option>
                                            {% endfor %}
                                        </select>
                                        <label for="provincia">
                                            <i class="bi bi-map me-1"></i>Provincia
                                        </label>
                                    </div>
                                    <div class="invalid-feedback"></div>
                                </div>

                                <div class="col-md-6">
                                    <div class="form-floating">
                                        <input type="text" class="form-control" id="localidad_facturacion"
                                            value="{{ cliente.direccion.localidad if cliente and cliente.direccion else '' }}"
                                            name="localidad_facturacion" placeholder="Localidad" value="" {% if is_edit
                                            %}readonly{% endif %}>
                                        <label for="localidad_facturacion">
                                            <i class="bi bi-pin-map me-1"></i>Localidad
                                        </label>
                                    </div>
                                    <div class="invalid-feedback"></div>
                                </div>

                                <div class="col-md-4">
                                    <div class="form-floating">
                                        <input type="text" class="form-control" id="piso_facturacion" maxlength="3"
                                            value="{{ cliente.direccion.piso if cliente and cliente.direccion and cliente.direccion.piso else '' }}"
                                            name="piso_facturacion" placeholder="Piso (Opcional)" value="" {% if is_edit
                                            %}readonly{% endif %}>
                                        <label for="piso_facturacion">
                                            <i class="bi bi-building me-1"></i>Piso (Opcional)
                                        </label>
                                    </div>
                                </div>

                                <div class="col-md-4">
                                    <div class="form-floating">
                                        <input type="text" class="form-control" id="depto_facturacion"
                                            alue="{{ cliente.direccion.depto if cliente and cliente.direccion and cliente.direccion.depto else '' }}"
                                            name="depto_facturacion" placeholder="Dto (Opcional)" value="" {% if is_edit
                                            %}readonly{% endif %}>
                                        <label for="depto_facturacion">
                                            <i class="bi bi-door-closed me-1"></i>Dto (Opcional)
                                        </label>
                                    </div>
                                </div>

                                <div class="col-md-4">
                                    <div class="form-floating">
                                        <input type="text" class="form-control" id="codigo_postal_facturacion"
                                            value="{{ cliente.direccion.codigo_postal if cliente and cliente.direccion else '' }}"
                                            name="codigo_postal_facturacion" placeholder="Código Postal" {% if is_edit
                                            %}readonly{% endif %}>
                                        <label for="codigo_postal_facturacion">
                                            <i class="bi bi-mailbox me-1"></i>Código Postal
                                        </label>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <div class="card shadow-sm mt-2">
                <div class="card-header bg-light">
                    <h5 class="mb-0">Información del Pedido</h5>
                </div>
                <div class="card-body">
                    <div class="row g-3">
                        <div class="form-subsection">
                            <div class="form-check form-switch mb-3">
                                <input class="form-check-input" type="checkbox" id="usar_direccion_alternativa" {% if
                                    pedido and pedido.direccion %}checked{% endif %}>
                                <label class="form-check-label" for="usar_direccion_alternativa">
                                    Enviar a una dirección de entrega distinta
                                </label>
                            </div>

                            <div id="direccion-entrega-container" style="display: none;">
                                <label class="form-label">Dirección de Entrega</label>
                                <div class="row g-3">
                                    <div class="col-md-8">
                                        <div class="form-floating">
                                            <input type="text" class="form-control" id="calle" name="calle"
                                                minlength="3" maxlength="80" pattern="[A-Za-zÀ-ÿ0-9\s.'-]{3,}"
                                                placeholder="Calle"
                                                value="{{ pedido.direccion.calle if pedido else ''}}">
                                            <label for="calle">
                                                <i class="bi bi-signpost me-1"></i>Calle
                                            </label>
                                        </div>
                                        <div class="invalid-feedback"></div>
                                    </div>

                                    <div class="col-md-4">
                                        <div class="form-floating">
                                            <input type="number" class="form-control" id="altura" name="altura"
                                                pattern="\d{1,5}" maxlength="5" max="99999" min="1" placeholder="Altura"
                                                value="{{ pedido.direccion.altura if pedido else '' }}">
                                            <label for="altura">
                                                <i class="bi bi-123 me-1"></i>Altura
                                            </label>
                                        </div>
                                        <div class="invalid-feedback"></div>
                                    </div>

                                    <div class="col-md-6">
                                        <div class="form-floating">
                                            <select class="form-select" id="provincia" name="provincia">
                                                <option value="">Seleccionar provincia...</option>
                                                {% set provincias = ["Buenos Aires", "CABA", "Catamarca", "Chaco",
                                                "Chubut",
                                                "Córdoba", "Corrientes", "Entre Ríos", "Formosa", "Jujuy", "La Pampa",
                                                "La
                                                Rioja", "Mendoza", "Misiones", "Neuquén", "Río Negro", "Salta", "San
                                                Juan",
                                                "San Luis", "Santa Cruz", "Santa Fe", "Santiago del Estero", "Tierra del
                                                Fuego",
                                                "Tucumán"] %}

                                                {% for p in provincias %}
                                                <option value="{{ p }}" {% if pedido and pedido.direccion.provincia==p
                                                    %}selected{% endif %}>{{ p }}</option>
                                                {% endfor %}
                                            </select>
                                            <label for="provincia">
                                                <i class="bi bi-map me-1"></i>Provincia
                                            </label>
                                        </div>
                                        <div class="invalid-feedback"></div>
                                    </div>

                                    <div class="col-md-6">
                                        <div class="form-floating">
                                            <input type="text" class="form-control" id="localidad" name="localidad"
                                                minlength="3" maxlength="60" pattern="[A-Za-zÀ-ÿ0-9\s.'-]{3,}"
                                                title="Ingresá un nombre de localidad válido (solo letras y espacios)."
                                                placeholder="Localidad"
                                                value="{{ pedido.direccion.localidad if pedido else ''}}">
                                            <label for="localidad">
                                                <i class="bi bi-pin-map me-1"></i>Localidad
                                            </label>
                                        </div>
                                        <div class="invalid-feedback"></div>
                                    </div>

                                    <div class="col-md-4">
                                        <div class="form-floating">
                                            <input type="text" class="form-control" id="piso" name="piso" maxlength="3"
                                                pattern="[A-Za-z0-9\s]*"
                                                title="Solo se permiten letras, números y espacios."
                                                placeholder="Piso (Opcional)"
                                                value="{{ pedido.direccion.piso if pedido and pedido.direccion.piso and pedido.direccion.piso != 'None' else ''}}">
                                            <label for="piso">
                                                <i class="bi bi-building me-1"></i>Piso (Opcional)
                                            </label>
                                        </div>
                                    </div>

                                    <div class="col-md-4">
                                        <div class="form-floating">
                                            <input type="text" class="form-control" id="depto" name="depto"
                                                maxlength="5" pattern="[A-Za-z0-9\s]*"
                                                title="Solo se permiten letras, números y espacios."
                                                placeholder="Dto (Opcional)"
                                                value="{{ pedido.direccion.depto if pedido and pedido.direccion.depto else ''}}">
                                            <label for="depto">
                                                <i class="bi bi-door-closed me-1"></i>Dto (Opcional)
                                            </label>
                                        </div>
                                    </div>

                                    <div class="col-md-4">
                                        <div class="form-floating">
                                            <input type="text" class="form-control" id="codigo_postal"
                                                name="codigo_postal" minlength="4" maxlength="8"
                                                pattern="([A-Za-z]\d{4}[A-Za-z]{3})|\d{4}"
                                                title="Ingresá 4 números (ej: 1663) o el formato CPA de 8 caracteres (ej: C1425BUP)."
                                                placeholder="Código Postal"
                                                value="{{ pedido.direccion.codigo_postal if pedido else '' }}">
                                            <label for="codigo_postal">
                                                <i class="bi bi-mailbox me-1"></i>Código Postal
                                            </label>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <div class="col-md-6">
                            <label for="fecha_solicitud" class="form-label">Fecha de Solicitud <span
                                    class="text-danger">*</span></label>
                            <input type="date" class="form-control" id="fecha_solicitud" name="fecha_solicitud"
                                value="{{ pedido.fecha_solicitud[:10] if  pedido and pedido.fecha_solicitud else today }}"
                                required {% if pedido and pedido.estado !='PENDIENTE' %}readonly{% endif %}
                                min="2025-01-01" max="{{ today }}">
                        </div>

                        <div class="col-md-6">
                            <label for="fecha_requerido" class="form-label">Fecha requerida de Entrega <span
                                    class="text-danger">*</span></label>
                            <input type="date" class="form-control" id="fecha_requerido" name="fecha_requerido"
                                value="{{ pedido.fecha_requerido[:10] if pedido and pedido.fecha_requerido else today}}"
                                required {% if pedido and pedido.estado !='PENDIENTE' %}readonly{% endif %}
                                max="{{ fecha_limite }}" min="{{ today }}">
                        </div>

                        <div class="col-md-4">
                            <label for="condicion_venta" class="form-label">Condición de Venta <span
                                    class="text-danger">*</span></label>
                            <select class="form-select" id="condicion_venta" name="condicion_venta" required>
                                <option value="contado" {% if pedido and pedido.condicion_venta=='contado' %}selected{%
                                    endif %}>Al Contado
                                </option>
                                <option value="credito_30" {% if pedido and pedido.condicion_venta=='credito_30'
                                    %}selected{% endif %}>Crédito 30 días</option>
                                <option value="credito_90" {% if pedido and pedido.condicion_venta=='credito_90'
                                    %}selected{% endif %}>Crédito 90 días</option>
                            </select>
                        </div>

                        <div class="col-12">
                            <label for="comentarios_adicionales" class="form-label">Comentarios Adicionales</label>
                            <textarea class="form-control" name="comentarios_adicionales" id="comentarios_adicionales"
                                rows="3" maxlength="500" {% if pedido and pedido.estado !='PENDIENTE' %}readonly{% endif
                                %}> {{ pedido.comentarios_adicionales if pedido and pedido.comentarios_adicionales else ''}}</textarea>
                            <div class="form-text">Opcional - Ingrese comentarios adicionales sobre el pedido</div>
                        </div>
                    </div>
                </div>
            </div>

            {% set total_pedido = 0.0 %}
            {% if pedido and pedido['items'] %}
            {% for item in pedido['items'] %}
            {# CORRECCIÓN CRUCIAL: Usamos .get(key, 0) para manejar ítems sin precio o cantidad #}
            {% set item_precio = item.get('precio_unitario', 0) %}
            {% set item_cantidad = item.get('cantidad', 0) %}
            {% set total_pedido = total_pedido + (item_precio * item_cantidad) %}
            {% endfor %}
            {% endif %}

            <div class="card shadow-sm mt-4 mb-2">
                <div class="card-header d-flex justify-content-between align-items-center bg-light">
                    <h5 class="mb-0">Productos del Pedido</h5>
                    <button type="button" class="btn btn-sm btn-outline-primary" id="add-item-btn" {% if pedido and
                        pedido.estado !='PENDIENTE' %}disabled{% endif %}>
                        <i class="bi bi-plus-circle me-1"></i>Añadir Producto
                    </button>
                </div>
                <div class="card-body p-0">
                    <div class="table-responsive">
                        <table class="table table-sm align-middle mb-0">
                            <thead class="bg-light">
                                <tr>
                                    <th style="width: 35%;">Producto <span class="text-danger">*</span></th>
                                    <th style="width: 15%;">Cantidad <span class="text-danger">*</span></th>
                                    <th style="width: 15%;">Precio Unitario</th>
                                    <th style="width: 15%;">Subtotal</th>
                                    <th style="width: 10%;" class="text-center">Acción</th>
                                </tr>
                            </thead>
                            <tbody id="items-container">
                                <input type="hidden" name="items-TOTAL_FORMS" id="id_items-TOTAL_FORMS"
                                    value="{{ pedido['items'] | length if pedido and pedido['items'] else 0 }}">

                                {% if pedido and pedido['items'] %}
                                {% for item in pedido['items'] %}
                                {% set current_product = productos | selectattr('id', 'equalto', item.producto_id) |
                                list | first %}
                                {% set unidad_medida = current_product.unidad_medida if current_product else 'unidades'
                                %}

                                {% set is_integer = unidad_medida.startswith('paquete') or unidad_medida == 'unidades'
                                %}
                                {% set step_value = '1' if is_integer else '0.01' %}
                                {% set min_value = '1' if is_integer else '0.01' %}

                                <tr
                                    class="item-row {% if pedido and not pedido.estado=='PENDIENTE' %}table-light text-muted{% endif %}">
                                    <td>
                                        <input type="hidden" name="items-{{ loop.index0 }}-id"
                                            value="{{ item.id if item.id else '' }}">
                                        <select class="form-select form-select-sm producto-selector"
                                            name="items-{{ loop.index0 }}-producto_id" required {% if pedido and
                                            pedido.estado !='PENDIENTE' %}disabled{% endif %}>
                                            <option value="">Seleccione...</option>
                                            {% for producto in productos %}
                                            <option value="{{ producto.id }}"
                                                data-stock="{{ producto.stock_disponible or 0 }}"
                                                data-precio="{{ producto.precio_unitario | float or 0 }}"
                                                data-unidad="{{ producto.unidad_medida }}" {% if
                                                item.producto_id==producto.id %}selected{% endif %}>
                                                {{ producto.nombre }}
                                            </option>
                                            {% endfor %}
                                        </select>
                                    </td>
                                    <td>
                                        <div class="input-group input-group-sm">
                                            <input type="number" class="form-control item-quantity"
                                                style="min-width: 8ch;" oninput="limitarDigitos(this, 7)"
                                                name="items-{{ loop.index0 }}-cantidad" placeholder="Ej: 10" max="5000"
                                                min="{{ min_value }}" step="{{ step_value }}"
                                                value="{{ item.get('cantidad', 0) }}" required {% if pedido and
                                                pedido.estado !='PENDIENTE' %}disabled{% endif %}>
                                            <span class="input-group-text unidad-display">
                                                {{ unidad_medida if current_product else '--' }}
                                            </span>
                                        </div>
                                    </td>
                                    <td>
                                        {% set precio_u = item.get('precio_unitario', 0) | float %}
                                        {% set precio_u_formateado = '{:,.2f}'.format(precio_u).replace(',',
                                        'X').replace('.', ',').replace('X', '.') %}
                                        <input type="text" class="form-control form-control-sm price-display"
                                            value="$ {{ precio_u_formateado }}" readonly>
                                    </td>

                                    <td class="text-center">
                                        {% set subtotal_valor = item.get('cantidad', 0) * item.get('precio_unitario', 0)
                                        | float %}
                                        {% set subtotal_formateado = '{:,.2f}'.format(subtotal_valor).replace(',',
                                        'X').replace('.', ',').replace('X', '.') %}
                                        <input type="text" class="form-control subtotal-item"
                                            value="$ {{ subtotal_formateado }}" readonly>
                                    </td>
                                    <td class="text-center">
                                        <button type="button" class="btn btn-sm btn-outline-danger remove-item-btn"
                                            title="Eliminar ítem" {% if pedido and not pedido.estado=='PENDIENTE'
                                            %}disabled{% endif %}><i class="bi bi-trash"></i></button>
                                    </td>
                                </tr>
                                {% endfor %}
                                {% endif %}
                            </tbody>
                        </table>
                    </div>
                    <div id="no-items-msg" class="text-center text-muted py-3 border-top" {% if pedido and
                        pedido['items'] | length> 0 %}style="display: none;"{% endif %}>
                        <i class="bi bi-box-seam fs-3"></i>
                        <p class="mt-2">Añada productos al pedido.</p>
                    </div>
                </div>
            </div>
            <div class="card mb-4">
                <div class="card-body d-flex justify-content-end">
                    <div class="w-50">
                        <label for="total-final" class="form-label fw-bold">Total del Pedido</label>
                        <input type="text" class="form-control text-end fs-5" id="total-final" name="total"
                            value=" {{ total_pedido | formato_moneda }}" readonly>
                    </div>
                </div>
            </div>
        </div>

        <div class="col-lg-4">
            <div class="card fixed-side-panel" style="top: 10px;">
                <div class="card-header bg-primary text-black">
                    <h5 class="mb-0">Resumen y Acciones</h5>
                </div>
                <div class="card-body">
                    {% if pedido %}
                    <div class="mb-3">
                        <label for="estado" class="form-label">Estado del Pedido Global</label>
                        <select class="form-select" id="estado" name="estado">
                            <option value="PENDIENTE" {% if pedido.estado=='PENDIENTE' %}selected{% endif %}>Pendiente
                            </option>
                            <option value="APROBADO" {% if pedido.estado=='APROBADO' %}selected{% endif %}>Aprobado
                            </option>
                            <option value="EN_PROCESO" {% if pedido.estado=='EN_PROCESO' %}selected{% endif %}>En
                                Proceso</option>
                            <option value="LISTO_PARA_ENTREGA" {% if pedido.estado=='LISTO_PARA_ENTREGA' %}selected{%
                                endif %}>Listo para Entrega</option>
                            <option value="COMPLETADO" {% if pedido.estado=='COMPLETADO' %}selected{% endif %}>
                                Completado</option>
                            <option value="CANCELADO" {% if pedido.estado=='CANCELADO' %}selected{% endif %}>Cancelado
                            </option>
                        </select>
                    </div>
                    <hr>
                    {% endif %}

                    <div class="alert alert-info border-0 rounded-3 bg-light p-3">
                        <i class="bi bi-info-circle me-1"></i>
                        Asegúrese de que todos los datos y cantidades son correctos antes de guardar.
                    </div>

                    <div class="d-grid gap-2 mt-4">
                        <button type="submit" class="btn btn-primary btn-lg" form="pedido-form">
                            <i class="bi bi-save me-1"></i>
                            {% if pedido %}Actualizar Pedido{% else %}Guardar Pedido{% endif %}
                        </button>
                        <a href="{{ url_for('orden_venta.listar') }}" class="btn btn-outline-secondary">
                            Cancelar
                        </a>
                    </div>
                </div>
            </div>
        </div>
    </div>
</form>

<template id="item-template">
    <tr class="item-row">
        <td>
            <input type="hidden" name="items-__prefix__-id" value="">
            <select class="form-select form-select-sm producto-selector" name="items-__prefix__-producto_id" required>
                <option value="" selected data-id="">Seleccione un producto...</option>
                {% for producto in productos %}
                <option value="{{ producto.id }}" data-id="{{ producto.id }}"
                    data-precio="{{ producto.precio_unitario | float or 0 }}"
                    data-stock="{{ producto.stock_disponible or 0 }}" data-unidad="{{ producto.unidad_medida }}">{{
                    producto.nombre }} ({{ producto.unidad_medida }})</option>
                {% endfor %}
            </select>
        </td>
        <td>
            <div class="input-group input-group-sm">
                <input type="number" min="0.01" max="5000" step="0.01" class="form-control item-quantity"
                    style="min-width: 8ch;" oninput="limitarDigitos(this, 7)" name="items-__prefix__-cantidad"
                    placeholder="Ej: 10" required>
                <span class="input-group-text unidad-display">--</span>
            </div>
        </td>
        <td>
            <input type="text" class="form-control form-control-sm price-display" value="0.00" readonly>
        </td>
        <td class="text-end">
            <input type="text" class="form-control form-control-sm subtotal-item" value="0.00" readonly>
        </td>
        <td class="text-center">
            <button type="button" class="btn btn-sm btn-outline-danger remove-item-btn" title="Eliminar ítem"><i
                    class="bi bi-trash"></i></button>
        </td>
    </tr>
</template>
{% endblock %}

{% block extra_js %}


<script>
    window.CLIENTE_API_URL_BASE = "{{ url_for('clientes_proveedores.buscar_por_cuil', cliente_cuil='0') }}";
    const pedidoId = "{{ pedido.id }}"
    const isEditing = {{ is_edit | tojson }};

</script>

<script>

    function limitarDigitos(input, maxLength) {
        if (input.value.length > maxLength) {
            input.value = input.value.slice(0, maxLength);
        }
    }

</script>

<script src="{{ url_for('static', filename='js/gestionPanelLateral.js') }}"></script>

<script src="{{ url_for('static', filename='js/orden_venta/gestionClientes.js') }}"></script>

<script src="{{ url_for('static', filename='js/orden_venta/gestionCalculos.js') }}"></script>

<script src="{{ url_for('static', filename='js/orden_venta/formularioVenta.js') }}"></script>

<script>
    document.addEventListener('DOMContentLoaded', function () {
        const checkbox = document.getElementById('usar_direccion_alternativa');
        const container = document.getElementById('direccion-entrega-container');
        const fields = container.querySelectorAll('input, select');

        function toggleDireccionEntrega(show) {
            if (show) {
                container.style.display = 'block';
                fields.forEach(field => {
                    field.disabled = false;
                    // Solo hacer requeridos los campos principales
                    if (['calle', 'altura', 'provincia', 'localidad'].includes(field.name)) {
                        field.required = true;
                    }
                });
            } else {
                container.style.display = 'none';
                fields.forEach(field => {
                    field.disabled = true;
                    field.required = false;
                });
            }
        }

        checkbox.addEventListener('change', function () {
            toggleDireccionEntrega(this.checked);
        });

        // Estado inicial al cargar la página
        toggleDireccionEntrega(checkbox.checked);
    });
</script>
{% endblock extra_js %}