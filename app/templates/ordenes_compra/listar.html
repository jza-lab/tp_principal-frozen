{% extends 'layouts/app_layout.html' %}

{% block title %}Órdenes de Compra - Sistema Frozen{% endblock %}

{% block extra_css %}
    <link rel="stylesheet" href="{{ url_for('static', filename='css/ordenes_compra/filtros.css') }}">
{% endblock %}

{% block app_content %}
<div class="d-flex justify-content-between flex-wrap flex-md-nowrap align-items-center pb-2 mb-4 border-bottom">
    <div>
        <h1 class="h2 mb-1">{{ titulo | default('Órdenes de Compra') }}</h1>
        <p class="text-muted mb-0">Gestión y seguimiento de órdenes de compra a proveedores</p>
    </div>
    <div class="btn-toolbar">
        <a href="#" onclick="history.back();" class="btn btn-outline-secondary me-2"
            title="Volver a la página anterior">
            <i class="bi bi-arrow-left"></i> Volver
        </a>

        {% if has_permission('crear_orden_de_compra') and current_user.rol != 'ADMIN' %}
        <a href="{{ url_for('orden_compra.nueva') }}" class="btn btn-primary">
            <i class="bi bi-plus-circle me-1"></i>Crear Nueva Orden
        </a>
        {% endif %}
    </div>
</div>

<!-- Filtros -->
<div class="filter-card">
    <!-- Búsqueda por código -->
    <div class="filter-section">
        <label class="filter-label">
            <i class="bi bi-search me-1"></i>Buscar por Código de Orden
        </label>
        <div class="search-input-wrapper">
            <i class="bi bi-upc-scan"></i>
            <input 
                type="text" 
                id="searchInput" 
                class="search-input" 
                placeholder="Ingrese el código de orden (ej: OC-20251107...)">
        </div>
    </div>

    <!-- Filtro por OP -->
    <div class="filter-section">
        <label class="filter-label">
            <i class="bi bi-search me-1"></i>Buscar por Código de OP
        </label>
        <div class="search-input-wrapper">
            <i class="bi bi-box-fill"></i>
            <input 
                type="text" 
                id="opSearchInput" 
                class="search-input" 
                placeholder="Ingrese el código de la orden de producción (ej: OP-...)">
        </div>
    </div>

    <!-- Filtros rápidos -->
    <div class="filter-section">
        <label class="filter-label">
            <i class="bi bi-lightning-fill me-1"></i>Filtros Rápidos
        </label>
        <div class="filter-quick-actions">
            <button type="button" class="btn-quick-action" data-quick-filter="mis-ordenes">
                <i class="bi bi-person-fill me-1"></i>Mis Órdenes
            </button>
            <button type="button" class="btn-quick-action" data-quick-filter="hoy">
                <i class="bi bi-calendar-day me-1"></i>Hoy
            </button>
            <button type="button" class="btn-quick-action" data-quick-filter="ultimos-7">
                <i class="bi bi-calendar-week me-1"></i>Últimos 7 días
            </button>
            <button type="button" class="btn-quick-action" data-quick-filter="ultimos-30">
                <i class="bi bi-calendar-month me-1"></i>Últimos 30 días
            </button>
        </div>
    </div>

    <!-- Filtro por estado -->
    <div class="filter-section">
        <label class="filter-label">
            <i class="bi bi-funnel-fill me-1"></i>Filtrar por Estado
        </label>
        <div class="filter-buttons">
            <button type="button" class="btn-filter-estado active" data-estado="">
                <i class="bi bi-grid-3x3-gap-fill"></i>
                Todas
            </button>
            <button type="button" class="btn-filter-estado" data-estado="PENDIENTE">
                <i class="bi bi-clock"></i>
                Pendiente
            </button>
            <button type="button" class="btn-filter-estado" data-estado="APROBADA">
                <i class="bi bi-check-lg"></i>
                Aprobada
            </button>
            <button type="button" class="btn-filter-estado" data-estado="EN_TRANSITO">
                <i class="bi bi-truck"></i>
                En Tránsito
            </button>
            <button type="button" class="btn-filter-estado" data-estado="EN_RECEPCION">
                <i class="bi bi-box-arrow-in-right"></i>
                En Recepción
            </button>
            <button type="button" class="btn-filter-estado" data-estado="RECEPCION_INCOMPLETA">
                <i class="bi bi-box-seam"></i>
                Recepción Incompleta
            </button>
            <button type="button" class="btn-filter-estado" data-estado="RECEPCION_COMPLETA">
                <i class="bi bi-box-seam"></i>
                Recepción Completa
            </button>
            <button type="button" class="btn-filter-estado" data-estado="RECHAZADA">
                <i class="bi bi-x-circle"></i>
                Rechazada
            </button>
        </div>
    </div>

</div>

<!-- Resumen de resultados -->
<div class="results-info">
    <div class="results-count">
        <strong id="visibleCount">{{ ordenes|length }}</strong> de <span id="totalCount">{{ ordenes|length }}</span> órdenes
    </div>
    <button type="button" class="btn-clear-filters" id="btnClearAll" style="display: none;">
        <i class="bi bi-x-circle me-1"></i>Limpiar filtros
    </button>
</div>

<!-- Lista de órdenes -->
<div class="row" id="ordenesContainer">
    {% for orden in ordenes %}
    <div class="col-md-4 mb-4 orden-card" 
         data-estado="{{ orden.estado }}"
         data-codigo="{{ orden.codigo_oc }}"
         data-op-codigo="{{ orden.orden_produccion_codigo or '' }}"
         data-fecha="{{ orden.fecha_emision }}"
         data-creador="{{ orden.usuario_creador_nombre }}"
         data-aprobador="{{ orden.usuario_aprobador_nombre or '' }}"
         data-op-id="{{ orden.orden_produccion_id or '' }}">
        <div class="card h-100 {% if orden.estado in ['RECHAZADA', 'CERRADA', 'CANCELADA'] %}orden-rechazada{% endif %}">
            <div class="card-body d-flex flex-column">
                <div class="d-flex justify-content-between">
                    <h5 class="card-title">{{ orden.proveedor_nombre or 'Proveedor no definido' }}</h5>
                    {% set estado_config = {
                    'PENDIENTE': {'class': 'bg-secondary-soft text-secondary', 'icon': 'clock'},
                    'APROBADA': {'class': 'bg-info-soft text-info', 'icon': 'check-lg'},
                    'EN ESPERA DE INSUMO': {'class': 'bg-warning-soft text-warning', 'icon': 'hourglass-split'},
                    'EN_TRANSITO': {'class': 'bg-primary-soft text-primary', 'icon': 'truck'},
                    'EN_RECEPCION': {'class': 'bg-info-soft text-info', 'icon': 'box-arrow-in-right'},
                    'EN_CONTROL_CALIDAD': {'class': 'bg-info-soft text-info', 'icon': 'clipboard-check'},
                    'RECEPCION_COMPLETA': {'class': 'bg-success-soft text-success', 'icon': 'box-seam'},
                    'RECEPCION_INCOMPLETA': {'class': 'bg-danger-soft text-danger', 'icon': 'box-seam'},
                    'CERRADA': {'class': 'bg-dark-soft text-dark', 'icon': 'lock-fill'},
                    'RECHAZADA': {'class': 'bg-danger-soft text-danger', 'icon': 'x-circle'}
                    } %}
                    {% set config = estado_config.get(orden.estado, {'class': 'bg-light text-dark', 'icon':
                    'question-circle'}) %}
                    <span class="badge {{ config.class }}">
                        <i class="bi bi-{{ config.icon }} me-1"></i>{{ orden.estado.replace('_', ' ') }}
                    </span>
                </div>

                <div class="card-secondary-details mb-3">
                    <span><i class="bi bi-upc-scan"></i> <code>{{ orden.codigo_oc }}</code></span>
                    {% if orden.orden_produccion_codigo %}
                        <span><i class="bi bi-box-fill"></i> <code>{{ orden.orden_produccion_codigo }}</code></span>
                    {% endif %}
                    <span><i class="bi bi-currency-dollar"></i> <b>{{ orden.total | formato_moneda }}</b></span>
                    <span><i class="bi bi-calendar-event"></i> {{ orden.fecha_emision }}</span>
                </div>

                <div class="mt-auto">
                    <hr class="card-divider">
                    <div class="d-flex justify-content-between align-items-center mb-3 stock-info">
                        <div>
                            <span class="stock-label">Creado por</span>
                            <span class="stock-value">{{ orden.usuario_creador_nombre or 'N/A' }}</span>
                        </div>
                        <div>
                            {% if orden.prioridad and orden.prioridad != 'NORMAL' %}
                            {% set prioridad_config = {
                            'BAJA': {'class': 'bg-light text-dark', 'icon': 'arrow-down'},
                            'ALTA': {'class': 'bg-warning-soft text-warning', 'icon': 'arrow-up'},
                            'URGENTE': {'class': 'bg-danger-soft text-danger', 'icon': 'exclamation-triangle'}
                            } %}
                            {% set pconfig = prioridad_config.get(orden.prioridad, {'class': 'bg-secondary', 'icon':
                            'dash'}) %}
                            <span class="badge {{ pconfig.class }}">
                                <i class="bi bi-{{ pconfig.icon }} me-1"></i>{{ orden.prioridad }}
                            </span>
                            {% endif %}
                        </div>
                    </div>
                    <div class="d-grid gap-2 d-md-flex justify-content-md-end action-buttons">
                        <a href="{{ url_for('orden_compra.detalle', id=orden.id) }}"
                            class="btn btn-sm btn-outline-primary" title="Ver Detalle">
                            <i class="bi bi-eye"></i>
                        </a>

                {# Visible solo para Logística (NO Supervisor de Calidad) #}
                {% if orden.estado == 'PENDIENTE' and current_user.rol != 'SUPERVISOR_CALIDAD' %}
                    
                    {% if has_permission('aprobar_orden_de_compra') and current_user.rol != 'ADMIN' %}
                    <div>
                        <form method="POST"
                            action="{{ url_for('orden_compra.aprobar', id=orden.id, estado=request.args.get('estado', '')) }}"
                            class="confirm-form d-inline" data-title="Confirmar Aprobación"
                            data-message="¿Está seguro de que desea aprobar esta orden de compra?"
                            data-button-type="success">
                            {{ csrf_form.csrf_token }}
                            <button type="submit" class="btn btn-sm btn-outline-success" title="Aprobar Orden">
                                <i class="bi bi-check-lg"></i> Aprobar
                            </button>
                        </form>
                    </div>
                    {% endif %}
                    
                    {% if (has_permission('editar_orden_de_compra') or has_permission('aprobar_orden_de_compra')) and current_user.rol != 'ADMIN' %}
                    <button type="button" class="btn btn-sm btn-outline-danger" title="Rechazar Orden"
                        data-bs-toggle="modal" data-bs-target="#rechazarModal-{{ orden.id }}">
                        <i class="bi bi-x-lg"></i> Rechazar
                    </button>
                    {% endif %}

                {# --- ESTADO: APROBADA --- #}
                {# Visible solo para Logística (NO Supervisor de Calidad) #}
                {% elif orden.estado == 'APROBADA' and current_user.rol != 'SUPERVISOR_CALIDAD' %}
                    
                    {% if has_permission('logistica_recepcion_oc') and current_user.rol != 'GERENTE' %}
                    <div>
                        <form method="POST"
                            action="{{ url_for('orden_compra.marcar_en_transito', id=orden.id, estado=request.args.get('estado', '')) }}"
                            class="confirm-form d-inline" data-title="Marcar como 'En Tránsito'"
                            data-message="¿Está seguro de que desea marcar esta orden como 'En Tránsito'?"
                            data-button-type="primary">
                            {{ csrf_form.csrf_token }}
                            <button type="submit" class="btn btn-sm btn-primary" title="Marcar como En Tránsito">
                                <i class="bi bi-truck"></i> En Tránsito
                            </button>
                        </form>
                    </div>
                    {% endif %}

                {# --- ESTADO: EN TRANSITO --- #}
                {# Visible para Supervisor de Calidad O para Logística #}
                {% elif orden.estado == 'EN_TRANSITO' %}
                    
                    {% if (has_permission('logistica_recepcion_oc') or current_user.rol == 'SUPERVISOR_CALIDAD') and current_user.rol != 'GERENTE' %}
                    <div>
                        <form method="POST"
                            action="{{ url_for('orden_compra.marcar_en_recepcion', id=orden.id, estado=request.args.get('estado', '')) }}"
                            class="confirm-form d-inline" data-title="Marcar como 'En Recepción'"
                            data-message="¿Confirma que la mercadería ha llegado y está lista para ser inspeccionada?"
                            data-button-type="info">
                            {{ csrf_form.csrf_token }}
                            <button type="submit" class="btn btn-sm btn-info" title="Iniciar Recepción">
                                <i class="bi bi-box-arrow-in-right"></i> Iniciar Recepción
                            </button>
                        </form>
                    </div>
                    {% endif %}

                {# --- ESTADO: EN RECEPCION --- #}
                {% elif orden.estado == 'EN_RECEPCION' %}
                    
                    {% if (has_permission('logistica_recepcion_oc') and current_user.rol != 'ADMIN' and current_user.rol != 'GERENTE') or current_user.rol == 'SUPERVISOR_CALIDAD' %}
                        <a href="{{ url_for('orden_compra.detalle', id=orden.id) }}" class="btn btn-sm btn-success"
                            title="Procesar Mercadería">
                            <i class="bi bi-box-seam"></i> Procesar
                        </a>
                    {% endif %}

                {# --- ESTADO: RECEPCION COMPLETA --- #}
                 {% elif orden.estado == 'RECEPCION_COMPLETA' %}
                
                {% elif orden.estado == 'EN_CONTROL_CALIDAD' %}

                {% if has_permission('realizar_control_de_calidad_insumos') %}
                    <a href="{{ url_for('orden_compra.detalle', id=orden.id) }}" class="btn btn-info d-grid">
                        <i class="bi bi-clipboard-check me-1"></i>Inspeccionar
                    </a>
                {% endif %}
                {% endif %}

                    
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Modal de Rechazo -->
    <div class="modal fade" id="rechazarModal-{{ orden.id }}" tabindex="-1"
        aria-labelledby="rechazarModalLabel-{{ orden.id }}" aria-hidden="true">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="rechazarModalLabel-{{ orden.id }}">Rechazar Orden de Compra</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <form method="POST"
                    action="{{ url_for('orden_compra.rechazar', id=orden.id, estado=request.args.get('estado', '')) }}">
                    {{ csrf_form.csrf_token }}
                    <div class="modal-body">
                        <p>¿Está seguro de que desea rechazar la orden de compra <strong>{{ orden.codigo_oc }}</strong>?
                        </p>
                        <div class="mb-3">
                            <label for="motivo-{{ orden.id }}" class="form-label">Motivo del rechazo (opcional)</label>
                            <textarea class="form-control" id="motivo-{{ orden.id }}" name="motivo" rows="3"></textarea>
                        </div>
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
                        <button type="submit" class="btn btn-danger">Rechazar Orden</button>
                    </div>
                </form>
            </div>
        </div>
    </div>
    {% endfor %}
</div>

<!-- Mensaje cuando no hay resultados (controlado por JS) -->
{% if ordenes %}
<div id="noResultsMessage" class="no-results-message" style="display: none;">
    <i class="bi bi-search"></i>
    <h4>No se encontraron órdenes</h4>
</div>
{% endif %}

{% endblock %}

{% block extra_js %}
<script src="{{ url_for('static', filename='js/ordenes_compra/listar.js') }}"></script>
{% endblock %}