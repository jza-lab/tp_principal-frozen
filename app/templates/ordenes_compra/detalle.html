{% extends 'layouts/app_layout.html' %}

{% block title %}Orden de Compra {{ orden.codigo_oc }} - Sistema Frozen{% endblock %}

{% block extra_css %}
<link rel="stylesheet" href="{{ url_for('static', filename='css/usuarios/listarUsuarios.css') }}">
{% endblock %}

{% block app_content %}

{# #}
{% if orden.orden_produccion_id %}
<div id="opWarningModal" class="modal fade" tabindex="-1" aria-labelledby="opWarningModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content">
            <div class="modal-header bg-warning">
                <h5 class="modal-title text-dark" id="opWarningModalLabel"><i class="bi bi-exclamation-triangle-fill me-2"></i> Atención</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <p class="fs-6">Esta Orden de Compra está vinculada a la <strong>Orden de Producción #{{ orden.orden_produccion_id }}</strong>.</p>
                <p>Revise las fechas de entrega, ya que cualquier demora podría impactar directamente en el plan de producción.</p>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Entendido</button>
            </div>
        </div>
    </div>
</div>
{% endif %}

<div class="d-flex justify-content-between flex-wrap flex-md-nowrap align-items-center pb-2 mb-4 border-bottom">
    <div>
        <h1 class="h2 mb-1">
            Orden de Compra <code class="text-muted">{{ orden.codigo_oc }}</code>
        </h1>
        <p class="text-muted mb-0">Proveedor: {{ orden.proveedor_nombre or 'No definido' }}</p>
    </div>
    <div class="btn-toolbar">
        <button class="btn btn-danger me-2 btn-crear-alerta" data-tipo-entidad="orden_compra" data-id-entidad="{{ orden.id }}" data-nombre-entidad="Orden de Compra {{ orden.codigo_oc }}">
            <i class="bi bi-exclamation-triangle-fill me-1"></i> Crear Alerta de Riesgo
        </button>
        <a href="#" onclick="history.back();" class="btn btn-outline-secondary me-2">
            <i class="bi bi-arrow-left me-1"></i>Volver
        </a>
        {% if orden.estado == 'PENDIENTE' and 'modificar_ordenes_compra' is has_permission %}
        <a href="{{ url_for('orden_compra.editar', id=orden.id) }}" class="btn btn-primary">
            <i class="bi bi-pencil-square me-1"></i>Editar
        </a>
        {% elif orden.estado not in ['RECIBIDA', 'CANCELADA', 'RECHAZADA', 'EN ESPERA DE INSUMO'] %}
        {% elif orden.estado == 'APROBADA' %}
        <form action="{{ url_for('orden_compra.marcar_en_transito', id=orden.id) }}" method="POST" class="d-inline">
            {{ csrf_form.csrf_token }}

            <button type="submit" class="btn btn-info">
                <i class="bi bi-truck me-1"></i>Marcar como 'En Tránsito'
            </button>
        </form>
        {% endif %}
    </div>
</div>

<ul class="nav nav-tabs-custom mb-3" id="loteDetailTab" role="tablist">
    <li class="nav-item" role="presentation">
        <button class="nav-link-custom active" id="info-tab" data-bs-toggle="tab" data-bs-target="#info-content"
            type="button" role="tab" aria-controls="info-content" aria-selected="true">
            <i class="bi bi-info-circle me-1"></i>Información General
        </button>
    </li>
    <li class="nav-item" role="presentation">
        <button class="nav-link-custom" id="trazabilidad-tab" data-bs-toggle="tab"
            data-bs-target="#trazabilidad-content" type="button" role="tab" aria-controls="trazabilidad-content"
            aria-selected="false">
            <i class="bi bi-diagram-3 me-1"></i>Trazabilidad
        </button>
    </li>
</ul>

<div class="tab-content" id="loteDetailTabContent">
    <div class="tab-pane fade show active" id="info-content" role="tabpanel" aria-labelledby="info-tab">
        <div class="row">
            <div class="col-lg-8">
                <div class="card mb-4">
                    <div class="card-header d-flex justify-content-between align-items-center">
                        <h5 class="mb-0">Información General</h5>
                        <div>
                            {% set estado_config = {
                            'PENDIENTE': {'class': 'bg-secondary-soft text-secondary', 'icon': 'clock'},
                            'APROBADA': {'class': 'bg-info-soft text-info', 'icon': 'check-lg'},
                            'EN ESPERA DE INSUMO': {'class': 'bg-warning-soft text-warning', 'icon': 'hourglass-split'},
                            'EN_TRANSITO': {'class': 'bg-primary-soft text-primary', 'icon': 'truck'},
                            'EN_RECEPCION': {'class': 'bg-info-soft text-info', 'icon': 'box-arrow-in-right'},
                            'RECEPCION_COMPLETA': {'class': 'bg-success-soft text-success', 'icon': 'box-seam'},
                            'EN_CONTROL_CALIDAD': {'class': 'bg-info-soft text-info', 'icon': 'clipboard-check'},                    
                            'RECEPCION_INCOMPLETA': {'class': 'bg-danger-soft text-danger', 'icon': 'box-seam'},
                            'RECHAZADA': {'class': 'bg-danger-soft text-danger', 'icon': 'x-circle'},
                            'CERRADA': {'class': 'bg-dark-soft text-dark', 'icon': 'lock-fill'},
                            } %}
                            {% set config = estado_config.get(orden.estado, {'class': 'bg-light text-dark', 'icon':
                            'question-circle'}) %}
                            <span class="badge {{ config.class }} fs-6 me-2">
                                <i class="bi bi-{{ config.icon }} me-1"></i>{{ orden.estado.replace('_', ' ') }}
                            </span>

                            {% if orden.prioridad and orden.prioridad != 'NORMAL' %}
                            {% set prioridad_config = {
                            'BAJA': {'class': 'bg-light text-dark', 'icon': 'arrow-down'},
                            'ALTA': {'class': 'bg-warning text-dark', 'icon': 'arrow-up'},
                            'URGENTE': {'class': 'bg-danger', 'icon': 'exclamation-triangle'}
                            } %}
                            {% set pconfig = prioridad_config.get(orden.prioridad, {'class': 'bg-secondary', 'icon': 'dash'}) %}
                            <span class="badge {{ pconfig.class }} fs-6">
                                <i class="bi bi-{{ pconfig.icon }} me-1"></i>{{ orden.prioridad }}
                            </span>
                            {% endif %}
                        </div>
                    </div>
                    <div class="card-body">
                        <div class="row g-4">
                            <div class="col-md-6">
                                <h6 class="text-muted mb-3">Detalles de la Compra</h6>
                                <div class="row g-3">
                                    <div class="col-12">
                                        <div class="border-start border-3 border-primary ps-3">
                                            <div class="small text-muted">Proveedor</div>
                                            <div class="fw-bold">{{ orden.proveedor_nombre or 'N/A' }}</div>
                                        </div>
                                    </div>
                                    {% set is_received = orden.estado in ['RECEPCION_INCOMPLETA', 'RECEPCION_COMPLETA', 'EN_CONTROL_CALIDAD', 'CERRADA'] %}
                                    
                                    <div class="col-12">
                                        <h6 class="text-muted mb-2">Valores Originales</h6>
                                    </div>
                                    <div class="col-6">
                                        <div class="small text-muted">Subtotal Original</div>
                                        <div class="fw-bold">$ {{ orden.subtotal_original | formato_moneda }}</div>
                                    </div>
                                    <div class="col-6">
                                        <div class="small text-muted">IVA Original</div>
                                        <div class="fw-bold">$ {{ orden.iva_original | formato_moneda }}</div>
                                    </div>
                                    <div class="col-12">
                                        <div class="small text-muted">Total Original</div>
                                        <div class="fw-bold h5">$ {{ orden.total_original | formato_moneda }}</div>
                                    </div>

                                    {% if is_received %}
                                    <div class="col-12 mt-3">
                                        <h6 class="text-muted mb-2">Valores Recibidos</h6>
                                    </div>
                                    <div class="col-6">
                                        <div class="small text-muted">Subtotal Recibido</div>
                                        <div id="orden-subtotal" class="fw-bold">$ {{ orden.subtotal | formato_moneda }}</div>
                                    </div>
                                    <div class="col-6">
                                        <div class="small text-muted">IVA Recibido</div>
                                        <div id="orden-iva" class="fw-bold">$ {{ orden.iva | formato_moneda }}</div>
                                    </div>
                                    <div class="col-12">
                                        <div class="small text-muted">Total Recibido</div>
                                        <div id="orden-total" class="fw-bold h5 text-success">$ {{ orden.total | formato_moneda }}</div>
                                    </div>
                                    {% endif %}
                                </div>
                            </div>

                            <div class="col-md-6">
                                <h6 class="text-muted mb-3">Fechas y Personal</h6>
                                <div class="row g-3">
                                    <div class="col-12">
                                        <div class="border-start border-3 border-success ps-3">
                                            <div class="small text-muted">Creado por</div>
                                            <div class="fw-bold">{{ orden.usuario_creador_nombre or 'Sistema' }}</div>
                                        </div>
                                    </div>
                                    <div class="col-6">
                                        <div class="small text-muted">Aprobado por</div>
                                        <div class="fw-bold">{{ orden.usuario_aprobador_nombre or 'Pendiente' }}</div>
                                    </div>
                                    <div class="col-6">
                                        <div class="small text-muted">Fecha de Emisión</div>
                                        <div class="fw-bold">{{ orden.fecha_emision }}</div>
                                    </div>
                                </div>
                            </div>

                            <div class="col-12">
                                <h6 class="text-muted mb-3">Timeline de Entrega</h6>
                                <div class="row g-3">
                                    <div class="col-md-4">
                                        <div class="d-flex align-items-center">
                                            <i class="bi bi-calendar-event text-muted me-2"></i>
                                            <div>
                                                <div class="small text-muted">Fecha Estimada</div>
                                                <div class="fw-bold">{{ orden.fecha_estimada_entrega or 'No especificada' }}</div>
                                            </div>
                                        </div>
                                    </div>
                                    <div class="col-md-4">
                                        <div class="d-flex align-items-center">
                                            <i
                                                class="bi bi-check-circle text-{{ 'success' if orden.fecha_real_entrega else 'muted' }} me-2"></i>
                                            <div>
                                                <div class="small text-muted">Entrega Real</div>
                                                <div class="fw-bold">{{ orden.fecha_real_entrega or 'No recibido' }}</div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>

                            {% if orden.observaciones %}
                            {% if orden.orden_produccion_id %}
                            <div class="col-12 mt-3">
                                <h6 class="text-muted mb-2">Orden de Producción Vinculada</h6>
                                <div class="border-start border-3 border-info ps-3">
                                    <a href="{{ url_for('orden_produccion.detalle', id=orden.orden_produccion_id) }}"
                                        class="fw-bold">
                                        Ver OP-{{ orden.orden_produccion_id }} <i
                                            class="bi bi-box-arrow-up-right ms-1 small"></i>
                                    </a>
                                    <p class="small text-muted mb-0">Esta orden de compra fue generada para abastecer la OP
                                        indicada.</p>
                                </div>
                            </div>
                            {% endif %}
                            {% endif %}

                            {% if orden.complementa_a_orden or orden.continuada_por_orden %}
                            <div class="col-12 mt-3">
                                <h6 class="text-muted mb-2">Órdenes Vinculadas</h6>
                                {% if orden.complementa_a_orden %}
                                <div class="border-start border-3 border-secondary ps-3 mb-2">
                                    <span class="small text-muted">Esta orden complementa a</span>
                                    <a href="{{ url_for('orden_compra.detalle', id=orden.complementa_a_orden.id) }}"
                                        class="fw-bold d-block">
                                        {{ orden.complementa_a_orden.codigo_oc }} <i
                                            class="bi bi-box-arrow-up-right ms-1 small"></i>
                                    </a>
                                </div>
                                {% endif %}
                                {% if orden.continuada_por_orden %}
                                <div class="border-start border-3 border-secondary ps-3">
                                    <span class="small text-muted">Esta orden es continuada por</span>
                                    <a href="{{ url_for('orden_compra.detalle', id=orden.continuada_por_orden.id) }}"
                                        class="fw-bold d-block">
                                        {{ orden.continuada_por_orden.codigo_oc }} <i
                                            class="bi bi-box-arrow-up-right ms-1 small"></i>
                                    </a>
                                </div>
                                {% endif %}
                            </div>
                            {% endif %}
                        </div>
                    </div>
                </div>
                
                <!-- {# --- Bloque 'EN_CONTROL_CALIDAD' obsoleto (comentado) --- #}
                {% if orden.estado == 'EN_CONTROL_CALIDAD' %}
                ...
                {% endif %} -->


                {% if orden.estado == 'EN_RECEPCION' %}
                    {% if orden.paso_recepcion == 0 %}
                        {# PASO 1: Verificación de Cantidad #}
                        <form id="recepcionForm" action="{{ url_for('orden_compra.procesar_recepcion', orden_id=orden.id) }}" method="POST">
                            <input type="hidden" name="paso" value="1">
                            {{ csrf_form.csrf_token }}
                            <div class="card mt-4">
                                <div class="card-header bg-primary-soft">
                                    <h5 class="mb-0 text-primary"><i class="bi bi-1-circle-fill me-2"></i>Paso 1: Verificación de Cantidades</h5>
                                </div>
                                <div class="card-body p-0">
                                    <div class="table-responsive">
                                        <table class="table table-striped table-hover mb-0">
                                            <thead>
                                                <tr>
                                                    <th scope="col">Insumo</th>
                                                    <th scope="col" class="text-end">Cant. Solicitada</th>
                                                    <th scope="col" class="text-center">Cant. Recibida</th>
                                                </tr>
                                            </thead>
                                            <tbody>
                                                {% for item in orden['items'] %}
                                                <tr class="item-row">
                                                    <td>
                                                        <div class="fw-bold">{{ item.insumo_nombre or 'Insumo no encontrado' }}</div>
                                                        <input type="hidden" name="item_id[]" value="{{ item.id }}">
                                                    </td>
                                                    <td class="text-end">{{ item.cantidad_solicitada }}</td>
                                                    <td class="text-center" style="max-width: 150px;">
                                                        <input type="number" name="cantidad_recibida[]" class="form-control form-control-sm text-center" value="{{ item.cantidad_solicitada }}" min="0" step="any" required>
                                                    </td>
                                                </tr>
                                                {% endfor %}
                                            </tbody>
                                        </table>
                                    </div>
                                </div>
                                <div class="card-footer text-end">
                                    <button type="submit" class="btn btn-primary">
                                        Siguiente: Control de Calidad <i class="bi bi-arrow-right-circle-fill ms-1"></i>
                                    </button>
                                </div>
                            </div>
                        </form>
                    {% elif orden.paso_recepcion == 1 %}
                        {# --- INICIO DE LA MODIFICACIÓN: PASO 2 RE-ESTILIZADO CON TODOS LOS CAMPOS --- #}
                        <form id="calidadForm" action="{{ url_for('orden_compra.procesar_recepcion', orden_id=orden.id) }}" method="POST" enctype="multipart/form-data">
                            <input type="hidden" name="paso" value="2">
                             {{ csrf_form.csrf_token }}
                            <div class="card mt-4">
                                <div class="card-header bg-info-soft">
                                    <h4 class="card-title mb-0 text-info"><i class="bi bi-clipboard-check me-2"></i>Paso 2: Control de Calidad</h4>
                                </div>
                                <div class="card-body">
                                    <p>Inspeccione cada ítem recibido. Las cantidades aprobadas se ingresarán al stock, mientras que las de cuarentena o rechazadas generarán un reclamo.</p>
                                    
                                    {% for item in orden['items'] %}
                                    <div class="card mb-3 shadow-sm item-calidad-row" data-total-recibido="{{ item.cantidad_recibida | default(0) }}">
                                        <div class="card-body">
                                            <input type="hidden" name="item_id[]" value="{{ item.id }}">
                                            
                                            <div class="row mb-3">
                                                <div class="col">
                                                    <h5 class="card-title mb-1">{{ item.insumo_nombre }}</h5>
                                                    <p class="card-text mb-0">
                                                        <small class="text-muted">Total Recibido: 
                                                            <strong class="total-recibido-display text-dark">{{ item.cantidad_recibida | default(0) }}</strong> {{ item.unidad_medida or 'unidades' }}
                                                        </small>
                                                    </p>
                                                </div>
                                            </div>

                                            <div class="row g-3 mb-3">
                                                <div class="col-md-4">
                                                    <label for="cantidad_aprobada_{{ item.id }}" class="form-label small text-success">Cant. Aprobada</label>
                                                    <input type="number" name="cantidad_aprobada[]" id="cantidad_aprobada_{{ item.id }}" class="form-control form-control-sm cantidad-aprobada" value="{{ item.cantidad_recibida | default(0) }}" min="0" step="any" required>
                                                </div>
                                                <div class="col-md-4">
                                                    <label for="cantidad_cuarentena_{{ item.id }}" class="form-label small text-warning">Cant. en Cuarentena</label>
                                                    <input type="number" name="cantidad_cuarentena[]" id="cantidad_cuarentena_{{ item.id }}" class="form-control form-control-sm cantidad-cuarentena" value="0" min="0" step="any" required>
                                                </div>
                                                <div class="col-md-4">
                                                    <label for="cantidad_rechazada_{{ item.id }}" class="form-label small text-danger">Cant. Rechazada</label>
                                                    <input type="number" name="cantidad_rechazada[]" id="cantidad_rechazada_{{ item.id }}" class="form-control form-control-sm cantidad-rechazada" value="0" min="0" step="any" required>
                                                </div>
                                            </div>
                                            
                                            <div class="motivo-rechazo-group" style="display: none;">
                                                <div class="row g-3">
                                                    <div class="col-md-6">
                                                        <label for="resultado_inspeccion_{{ item.id }}" class="form-label small text-danger">Resultado de Inspección (Motivo)</label>
                                                        <select class="form-select form-select-sm motivo-select" id="resultado_inspeccion_{{ item.id }}" name="resultado_inspeccion[]" disabled>
                                                            <option value="" selected>Seleccione un motivo...</option>
                                                            {% for estado in estados_inspeccion %}
                                                            <option value="{{ estado }}">{{ estado }}</option>
                                                            {% endfor %}
                                                        </select>
                                                    </div>
                                                    <div class="col-md-6">
                                                        <label for="foto_item_{{ item.id }}" class="form-label small">Foto (Opcional)</label>
                                                        <input class="form-control form-control-sm foto-input" type="file" id="foto_item_{{ item.id }}" name="foto_item_{{ item.id }}" accept=".jpg, .jpeg, .png" disabled>
                                                    </div>
                                                    <div class="col-12">
                                                        <label for="comentarios_{{ item.id }}" class="form-label small">Comentarios</label>
                                                        <textarea name="comentarios[]" id="comentarios_{{ item.id }}" class="form-control form-control-sm comentarios-input" rows="2" disabled></textarea>
                                                    </div>
                                                </div>
                                            </div>
                                            
                                            <select name="resultado_inspeccion[]" class="motivo-select-hidden" style="display: none;">
                                                <option value="" selected></option>
                                            </select>
                                            <textarea name="comentarios[]" class="comentarios-input-hidden" style="display: none;"></textarea>
                                            
                                        </div> </div> {% endfor %}
                                </div>
                                <div class="card-footer text-end">
                                     <button type="submit" class="btn btn-success">
                                        <i class="bi bi-check-circle-fill me-1"></i> Finalizar Recepción
                                    </button>
                                </div>
                            </div>
                        </form>
                        {# --- FIN DE LA MODIFICACIÓN --- #}
                    {% endif %}
                {% else %}
                <div class="card mt-4">
                    <div class="card-header">
                        <h5 class="mb-0">Ítems de la Orden</h5>
                    </div>
                    <div class="card-body p-0">
                        <div class="table-responsive">
                            <table class="table table-striped table-hover mb-0">
                                <thead>
                                    <tr>
                                        <th scope="col">Insumo</th>
                                        <th scope="col" class="text-end">Cant. Solicitada</th>
                                        <th scope="col" class="text-end">Cant. Recibida</th>
                                        <th scope="col" class="text-end">Precio Unitario</th>
                                        <th scope="col" class="text-end">Subtotal</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    {% for item in orden['items'] %}
                                    <tr>
                                        <td>{{ item.insumo_nombre or 'Insumo no encontrado' }}</td>
                                        <td class="text-end">{{ item.cantidad_solicitada }}</td>
                                        <td class="text-end">{{ item.cantidad_recibida | default(0) }}</td>
                                        <td class="text-end">$ {{ item.precio_unitario | formato_moneda }}</td>
                                        <td class="text-end fw-bold">
                                            {% if item.cantidad_recibida is not none %}
                                                $ {{ (item.cantidad_recibida * item.precio_unitario) | formato_moneda }}
                                            {% else %}
                                                $ {{ item.subtotal | formato_moneda }}
                                            {% endif %}
                                        </td>
                                    </tr>
                                    {% else %}
                                    <tr>
                                        <td colspan="5" class="text-center text-muted py-4">No hay ítems en esta orden.</td>
                                    </tr>
                                    {% endfor %}
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
                {% endif %}

                {% if orden.orden_produccion_id %}
                <div id="alerta-retraso-produccion" class="alert alert-warning mt-3 d-none" role="alert">
                    <i class="bi bi-exclamation-triangle-fill me-2"></i>
                    <strong>Atención:</strong> Esta OC está relacionada con la <strong>OP-{{ orden.orden_produccion_id }}</strong>. Una recepción incompleta puede causar retrasos en la producción.
                </div>
                {% endif %}
                </div>
            <div class="col-lg-4">
                <div class="card">
                    <div class="card-header">
                        <h6 class="mb-0">
                            <i class="bi bi-gear me-1"></i>
                            Acciones Rápidas
                        </h6>
                    </div>
                    <div class_=""card-body"">
                        <div class="d-grid gap-2">
                            <button class="btn btn-outline-secondary" disabled>
                                <i class="bi bi-file-earmark-text me-2"></i>Visualizar factura
                            </button>
                            <button class="btn btn-outline-secondary" disabled>
                                <i class="bi folder-open me-2"></i>Cargar imagen de factura
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    <div class="tab-pane fade" id="trazabilidad-content" role="tabpanel" aria-labelledby="trazabilidad-tab">
        <div class="d-flex justify-content-between align-items-center mb-3">
            <h5 class="mb-0">Cadena de Trazabilidad</h5>
            <div class="form-check form-switch">
                <input class="form-check-input" type="checkbox" role="switch" id="trazabilidad-nivel-switch">
                <label class="form-check-label" for="trazabilidad-nivel-switch">Ver Trazabilidad Completa</label>
            </div>
        </div>
        <div class="row">
            <div class="col-lg-4">
                <div class="card mb-3">
                    <div class="card-header">
                        <i class="bi bi-file-text-fill me-1"></i> Resumen de Trazabilidad
                    </div>
                    <div class="card-body">
                        <div id="resumen-trazabilidad-origen"></div>
                        <div id="resumen-trazabilidad-destino"></div>
                    </div>
                </div>
            </div>
            <div class="col-lg-8">
                <div class="card">
                    <div class="card-header">
                       <i class="bi bi-diagram-3-fill me-1"></i> Diagrama de Flujo (Sankey)
                    </div>
                    <div class="card-body p-0" style="overflow-y: auto; height: 600px;">
                         <div id="sankey_trazabilidad" style="width: 100%; min-height: 600px;"></div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

{# --- Modal 'modal-inspeccion-accion' eliminado --- #}

<div class="modal fade" id="modalCrearOcHija" tabindex="-1" aria-labelledby="modalOcHijaLabel" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content">
            <form action="{{ url_for('orden_compra.crear_oc_hija', id_padre=orden.id) }}" method="POST">
                {{ csrf_form.csrf_token }}
                <div class="modal-header bg-warning">
                    <h5 class="modal-title text-dark" id="modalOcHijaLabel"><i class="bi bi-exclamation-triangle-fill me-2"></i> Acción Requerida: Items Faltantes</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <p>La recepción de esta orden (<code class="text-muted">{{ orden.codigo_oc }}</code>) se completó, pero <strong>faltaron insumos</strong>.</p>
                    <p>Los lotes de los insumos recibidos ya fueron creados y la OP asociada está "En Espera".</p>
                    <p class="fw-bold">¿Desea crear una nueva Orden de Compra (OC Hija) para reponer los items faltantes?</p>
                    
                    <div class="alert alert-info small">
                        <strong>Nota:</strong> Si no crea una OC Hija ahora, la Orden de Producción seguirá "En Espera" y deberá gestionar la compra de los insumos faltantes manualmente.
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">No, gestionar manualmente</button>
                    <button type="submit" class="btn btn-primary">Sí, crear OC Hija ahora</button>
                </div>
            </form>
        </div>
    </div>
</div>

<div class="modal fade" id="confirmacionRecepcionParcialModal" tabindex="-1" aria-labelledby="modalLabel" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="modalLabel">Confirmar Recepción Parcial</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <p>Ha ingresado una cantidad diferente a la solicitada para al menos un ítem.</p>
                <div class="form-check">
                    <input class="form-check-input" type="checkbox" value="" id="crearOcHijaCheckbox" checked>
                    <label class="form-check-label" for="crearOcHijaCheckbox">
                        Crear automáticamente una nueva orden de compra (OC Hija) con los insumos restantes/faltantes.
                    </label>
                </div>
                <p class="mt-3">¿Desea continuar con la recepción?</p>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
                <button type="button" class="btn btn-primary" id="confirmarRecepcionBtn">Sí, continuar</button>
            </div>
        </div>
    </div>
</div>
{% include "admin_riesgos/_modal_crear_alerta.html" %}
{% endblock %}
{% block extra_js %}
<script src="{{ url_for('static', filename='js/gestorAlertas.js') }}?v=1.1"></script>
<script>
document.addEventListener('DOMContentLoaded', function () {
    // Variable global para que el JS de trazabilidad pueda acceder al ID
    window.ORDEN_COMPRA_ID = {{ orden.id|tojson }};
    
    const form = document.getElementById('recepcionForm');
    
    var opWarningModal = document.getElementById('opWarningModal');
    if (opWarningModal) {
        var modal = new bootstrap.Modal(opWarningModal);
        modal.show();
    }

    if (form) {
        {% if orden.estado == 'EN_RECEPCION' and orden.orden_produccion_id %}
        // --- Lógica para Alerta de Retraso en Producción (Solo Paso 1) ---
        const alertaProduccion = document.getElementById('alerta-retraso-produccion');
        const itemRows = form.querySelectorAll('.item-row');

        const verificarCantidades = () => {
            if (!alertaProduccion) return; // Salir si no existe
            let mostrarAlerta = false;
            itemRows.forEach(row => {
                const requestedQtyText = row.cells[1] ? row.cells[1].textContent.trim() : '0';
                const requestedQty = parseFloat(requestedQtyText);
                
                const receivedQtyInput = row.querySelector('input[name="cantidad_recibida[]"]');
                const receivedQty = receivedQtyInput ? (parseFloat(receivedQtyInput.value) || 0) : 0;

                if (receivedQty < requestedQty) {
                    mostrarAlerta = true;
                }
            });

            if (mostrarAlerta) {
                alertaProduccion.classList.remove('d-none');
            } else {
                alertaProduccion.classList.add('d-none');
            }
        };

        form.addEventListener('input', (e) => {
            if (e.target.matches('input[name="cantidad_recibida[]"]')) {
                verificarCantidades();
            }
        });
        
        verificarCantidades(); // Correr al inicio
        {% endif %}
    }
    
    // --- INICIO MODIFICACIÓN: Lógica JS para Formulario de Calidad (Paso 2) ---
    document.querySelectorAll('.item-calidad-row').forEach(row => {
        const totalRecibido = parseFloat(row.dataset.totalRecibido) || 0;
        const aprobadaInput = row.querySelector('.cantidad-aprobada');
        const cuarentenaInput = row.querySelector('.cantidad-cuarentena');
        const rechazadaInput = row.querySelector('.cantidad-rechazada');
        
        const motivoGroup = row.querySelector('.motivo-rechazo-group');
        const motivoSelect = row.querySelector('select.motivo-select');
        const comentariosInput = row.querySelector('textarea.comentarios-input');
        const fotoInput = row.querySelector('input.foto-input');
        
        // Campos ocultos para alineación
        const motivoHidden = row.querySelector('select.motivo-select-hidden');
        const comentariosHidden = row.querySelector('textarea.comentarios-input-hidden');
        
        const getPrecision = (numStr) => {
            if (!numStr) return 0;
            const s = String(numStr);
            if (s.indexOf('.') >= 0) { return s.split('.')[1].length; }
            return 0;
        };
        // Usar precisión 2 como base, o la máxima precisión de los inputs
        const precision = Math.max(2, getPrecision(aprobadaInput.step), getPrecision(cuarentenaInput.step), getPrecision(rechazadaInput.step));
        const roundedTotal = parseFloat(totalRecibido.toFixed(precision));

        const toggleMotivo = () => {
            const cuarentenaVal = parseFloat(cuarentenaInput.value) || 0;
            const rechazadaVal = parseFloat(rechazadaInput.value) || 0;
            
            if (cuarentenaVal > 0 || rechazadaVal > 0) {
                motivoGroup.style.display = 'block';
                // Habilitar campos visibles
                motivoSelect.disabled = false;
                motivoSelect.required = true;
                comentariosInput.disabled = false;
                fotoInput.disabled = false;
                // Deshabilitar campos ocultos
                motivoHidden.disabled = true;
                comentariosHidden.disabled = true;
            } else {
                motivoGroup.style.display = 'none';
                // Deshabilitar campos visibles y limpiar
                motivoSelect.disabled = true;
                motivoSelect.required = false;
                motivoSelect.value = '';
                comentariosInput.disabled = true;
                comentariosInput.value = '';
                fotoInput.disabled = true;
                fotoInput.value = '';
                // Habilitar campos ocultos
                motivoHidden.disabled = false;
                comentariosHidden.disabled = false;
            }
        };

        // Función genérica para validar el valor de un input
        const checkAndFixValue = (input) => {
            let val = parseFloat(input.value);
            if (isNaN(val) || val < 0) val = 0;
            if (val > roundedTotal) val = roundedTotal;
            return val;
        };

        // --- Lógica de Listeners Diferenciados ---
        
        // Si edito CUARENTENA o RECHAZADA, se ajusta APROBADA
        const onProblemaInput = (e) => {
            let cuarentenaVal = checkAndFixValue(cuarentenaInput);
            let rechazadaVal = checkAndFixValue(rechazadaInput);
            
            // Validar que la suma de problemas no supere el total
            if (cuarentenaVal + rechazadaVal > roundedTotal) {
                if (e.target === cuarentenaInput) {
                    cuarentenaVal = roundedTotal - rechazadaVal;
                } else {
                    rechazadaVal = roundedTotal - cuarentenaVal;
                }
                // Actualizar el valor del input que se estaba editando
                e.target.value = (e.target === cuarentenaInput ? cuarentenaVal : rechazadaVal).toFixed(precision);
            }

            let aprobadoRestante = roundedTotal - cuarentenaVal - rechazadaVal;
            aprobadaInput.value = aprobadoRestante.toFixed(precision);
            toggleMotivo();
        };

        // Si edito APROBADA, se ajusta RECHAZADA (asumiendo que cuarentena es prioritaria)
        const onAprobadaInput = (e) => {
            let aprobadaVal = checkAndFixValue(aprobadaInput);
            let cuarentenaVal = checkAndFixValue(cuarentenaInput);

            // Validar que aprobada + cuarentena no supere el total
            if (aprobadaVal + cuarentenaVal > roundedTotal) {
                aprobadaVal = roundedTotal - cuarentenaVal;
                aprobadaInput.value = aprobadaVal.toFixed(precision);
            }
            
            let rechazadaRestante = roundedTotal - aprobadaVal - cuarentenaVal;
            rechazadaInput.value = rechazadaRestante.toFixed(precision);
            toggleMotivo();
        };
        
        cuarentenaInput.addEventListener('input', onProblemaInput);
        rechazadaInput.addEventListener('input', onProblemaInput);
        aprobadaInput.addEventListener('input', onAprobadaInput);

        // Correr al inicio
        toggleMotivo();
    });
    // --- FIN MODIFICACIÓN JS ---


    // --- Lógica para Modal OC Hija (sin cambios) ---
    {% if orden.estado == 'RECEPCION_INCOMPLETA' and not orden.continuada_por_orden %}
        setTimeout(() => {
            var ocHijaModal = new bootstrap.Modal(document.getElementById('modalCrearOcHija'), {
                keyboard: false, 
                backdrop: 'static'
            });
            ocHijaModal.show();
        }, 1000);
        
    {% endif %}

});
</script>
{# --- Se elimina 'controlCalidad.js' --- #}
<script src="https://www.gstatic.com/charts/loader.js"></script>
<script src="{{ url_for('static', filename='js/trazabilidadOrdenCompra.js') }}?v=1.1"></script>
{% endblock %}