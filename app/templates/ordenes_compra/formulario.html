{% extends 'layouts/base.html' %}

{% block title %}
    {% if orden %}Editar Orden de Compra {{ orden.codigo_oc }}{% else %}Nueva Orden de Compra{% endif %}
{% endblock %}

{% block content %}
<div class="d-flex justify-content-between flex-wrap flex-md-nowrap align-items-center pb-2 mb-4 border-bottom">
    <div>
        <h1 class="h2 mb-1">
            {% if orden %}Editar Orden de Compra{% else %}Nueva Orden de Compra{% endif %}
        </h1>
        <p class="text-muted mb-0">
            {% if orden %}
                Modificar orden {{ orden.codigo_oc }}
            {% else %}
                Crear nueva orden de compra para un proveedor
            {% endif %}
        </p>
    </div>
    <div class="btn-toolbar">
        <a href="{{ url_for('orden_compra.listar') }}" class="btn btn-outline-secondary">
            <i class="bi bi-arrow-left me-1"></i>Volver
        </a>
    </div>
</div>


<form method="POST">
<div class="row">
    <!-- DATOS GENERALES -->
    <div class="col-lg-8">
        <div class="card mb-4">
            <div class="card-header"><h5 class="mb-0">Información de la Orden</h5></div>
            <div class="card-body">
                <div class="row g-3">
                    <div class="col-md-6">
                        <label for="proveedor_id" class="form-label">Proveedor <span class="text-danger">*</span></label>
                        <select class="form-select" id="proveedor_id" name="proveedor_id" required>
                            <option value="">Seleccione un proveedor...</option>
                            {% for proveedor in proveedores %}
                                <option value="{{ proveedor.id }}" {% if orden and orden.proveedor_id == proveedor.id %}selected{% endif %}>
                                    {{ proveedor.nombre }}
                                </option>
                            {% endfor %}
                        </select>
                    </div>

                    <div class="col-md-3">
                        <label for="fecha_emision" class="form-label">Fecha Emisión <span class="text-danger">*</span></label>
                        <input type="date" class="form-control" id="fecha_emision" name="fecha_emision"
                               value="{{ orden.fecha_emision if orden else '' }}" required>
                    </div>

                    <div class="col-md-3">
                        <label for="fecha_estimada_entrega" class="form-label">Fecha Estimada Entrega <span class="text-danger">*</span></label>
                        <input type="date" class="form-control" id="fecha_estimada_entrega" name="fecha_estimada_entrega"
                               value="{{ orden.fecha_estimada_entrega if orden else '' }}" required>
                    </div>

                    <div class="col-md-6">
                        <label for="prioridad" class="form-label">Prioridad</label>
                        <select class="form-select" id="prioridad" name="prioridad">
                            <option value="NORMAL" {% if not orden or orden.prioridad == 'NORMAL' %}selected{% endif %}>Normal</option>
                            <option value="BAJA" {% if orden and orden.prioridad == 'BAJA' %}selected{% endif %}>Baja</option>
                            <option value="ALTA" {% if orden and orden.prioridad == 'ALTA' %}selected{% endif %}>Alta</option>
                            <option value="URGENTE" {% if orden and orden.prioridad == 'URGENTE' %}selected{% endif %}>Urgente</option>
                        </select>
                    </div>

                    <div class="col-md-6">
                        <label for="observaciones" class="form-label">Observaciones</label>
                        <textarea class="form-control" id="observaciones" name="observaciones" rows="2">{{ orden.observaciones if orden else '' }}</textarea>
                    </div>
                </div>
            </div>
        </div>

        <!-- ITEMS DE LA ORDEN -->
        <div class="card mb-4">
            <div class="card-header d-flex justify-content-between align-items-center">
                <h5 class="mb-0">Ítems de la Orden</h5>
                <button type="button" class="btn btn-sm btn-outline-primary" id="addItemBtn">Añadir Ítem</button>
            </div>
            <div class="card-body">
                <div id="itemsContainer">
                    {% if orden and orden['items'] %}
                        {% for item in orden['items'] %}
                            <div class="row g-3 align-items-end item-row mb-2">
                                <div class="col-md-4">
                                    <label class="form-label">Insumo</label>
                                    <select class="form-select" name="insumo_id[]">
                                        <option value="">Seleccione un insumo...</option>
                                        {% for insumo in insumos %}
                                            <option value="{{ insumo.id }}" {% if item.insumo_id == insumo.id %}selected{% endif %}>
                                                {{ insumo.nombre }}
                                            </option>
                                        {% endfor %}
                                    </select>
                                </div>
                                <div class="col-md-2">
                                    <label class="form-label">Cantidad</label>
                                    <input  type="number" step="1" min="1"  class="form-control cantidad" name="cantidad_solicitada[]" value="{{ item.cantidad_solicitada }}">
                                </div>
                                <div class="col-md-2">
                                    <label class="form-label">Precio Unitario</label>
                                    <input type="number" step="0.01" class="form-control precio_unitario" name="precio_unitario[]" value="{{ item.precio_unitario }}">
                                </div>
                                <div class="col-md-2">
                                    <label class="form-label">Subtotal</label>
                                    <input type="number" step="0.01" class="form-control subtotal-item" value="{{ item.subtotal }}" readonly>
                                </div>
                                <div class="col-md-2">
                                    <button type="button" class="btn btn-outline-danger removeItemBtn">Eliminar</button>
                                </div>
                            </div>
                        {% endfor %}
                    {% endif %}
                </div>
            </div>
        </div>

        <!-- TOTAL GENERAL -->
        <div class="card mb-4">
            <div class="card-body d-flex justify-content-end gap-3">
                <div class="w-25">
                    <label class="form-label">Subtotal</label>
                    <input type="number" step="0.01" class="form-control" id="subtotal" name="subtotal" value="{{ orden.subtotal if orden else 0 }}" readonly>
                </div>

                <div class="w-25 d-flex flex-column justify-content-center">
                    <div class="form-check mt-4">
                        <input class="form-check-input" type="checkbox" id="iva" name="iva" 
                            {% if orden and orden.iva > 0 %}checked{% endif %}>
                        <label class="form-check-label" for="iva">
                            Aplicar IVA 21%
                        </label>
                    </div>
                </div>

                <div class="w-25">
                    <label class="form-label">Total</label>
                    <input type="number" step="0.01" class="form-control" id="total" name="total" value="{{ orden.total if orden else 0 }}" readonly>
                </div>
            </div>
        </div>


        <div class="d-flex justify-content-end gap-2 mb-4">
            <a href="{{ url_for('orden_compra.listar') }}" class="btn btn-outline-secondary">Cancelar</a>
            <button type="submit" class="btn btn-primary">
                <i class="bi bi-check-circle me-1"></i>
                {% if orden %}Actualizar{% else %}Crear{% endif %} Orden
            </button>
        </div>
    </div>
        <div class="col-lg-4">
        <div class="card">
            <div class="card-header">
                <h6 class="mb-0">
                    <i class="bi bi-info-circle me-1"></i>
                    Instrucciones
                </h6>
            </div>
            <div class="card-body">
                <p class="small text-muted">
                    Complete los campos obligatorios (<span class="text-danger">*</span>) para crear una nueva orden de compra.
                </p>
                <p class="small text-muted">
                    El campo <strong>Total</strong> se calcula automáticamente a partir del <strong>Subtotal</strong> y el <strong>IVA</strong>.
                </p>
            </div>
        </div>
    </div>
</div>
</form>


{% endblock %}

{% block extra_js %}
<script>
    const INSUMOS_DATA = {{ insumos | tojson | safe }};
</script>
<script src="{{ url_for('static', filename='js/formularioCompra.js') }}"></script>
{% endblock extra_js %}


