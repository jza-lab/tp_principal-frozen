{% extends 'layouts/app_layout.html' %}

{% block title %}
{% if orden %}Editar Orden de Compra {{ orden.codigo_oc }}{% else %}Nueva Orden de Compra{% endif %}
{% endblock %}

{% block app_content %}
<div class="d-flex justify-content-between flex-wrap flex-md-nowrap align-items-center pb-2 mb-4 border-bottom">
    <div>
        <h1 class="h2 mb-1">
            {% if orden %}Editar Orden de Compra{% else %}Nueva Orden de Compra{% endif %}
        </h1>
        <p class="text-muted mb-0">
            {% if orden %}
            Modificar orden {{ orden.codigo_oc }}
            {% else %}
            Crear una o más órdenes de compra seleccionando insumos
            {% endif %}
        </p>
    </div>
    <div class="btn-toolbar">
        <a href="#" onclick="history.back();" class="btn btn-outline-secondary">
            <i class="bi bi-arrow-left me-1"></i>Volver
        </a>
    </div>
</div>

<form method="POST" id="ordenCompraForm">
    {{ csrf_form.csrf_token }}

    <div class="row">
        <div class="col-lg-8">
            <div class="card mb-4">
                <div class="card-header">
                    <h5 class="mb-0">Ítems de la Orden</h5>
                </div>
                <div class="card-body">
                    {% if not orden %}
                    <div class="row">
                        <div class="col-md-12">
                            <div class="input-group mb-3">
                                <span class="input-group-text"><i class="bi bi-search"></i></span>
                                <input type="text" id="insumo-search-filter" class="form-control" placeholder="Buscar insumo...">
                            </div>
                            <select id="insumo-select" class="form-select" size="8">
                                <option value="">Seleccione un insumo...</option>
                                {% for insumo in insumos %}
                                    {% set proveedor_rating = proveedores|selectattr('id', 'equalto', insumo.proveedor.id)|first %}
                                    {% set rating_stars = ('★' * proveedor_rating.rating + '☆' * (5 - proveedor_rating.rating)) if proveedor_rating else '' %}
                                    <option value="{{ insumo.id_insumo }}" 
                                            data-nombre="{{ insumo.nombre }}" 
                                            data-precio="{{ insumo.precio_unitario }}" 
                                            data-proveedor-id="{{ insumo.proveedor.id }}" 
                                            data-proveedor-nombre="{{ insumo.proveedor.nombre }}"
                                            data-stock-actual="{{ insumo.stock_actual|default(0) }}"
                                            data-stock-max="{{ insumo.stock_max|default(999999) }}">
                                        {{ insumo.nombre }} - {{ insumo.proveedor.nombre }} {{ rating_stars }}
                                    </option>
                                {% endfor %}
                            </select>
                        </div>
                    </div>
                    {% endif %}
                    <div class="table-responsive mt-3">
                        <table class="table table-sm align-middle">
                            <thead class="bg-light">
                                <tr>
                                    <th style="width: 35%;">Insumo</th>
                                    <th style="width: 25%;">Proveedor</th>
                                    <th style="width: 15%;">Cantidad</th>
                                    <th style="width: 15%;">Precio Unitario</th>
                                    <th style="width: 10%;" class="text-center">Acción</th>
                                </tr>
                            </thead>
                            <tbody id="itemsContainer">
                                {% if orden %}
                                    {% for item in orden.items %}
                                    <tr class="item-row">
                                        <td>
                                            <input type="hidden" name="insumo_id[]" class="insumo-id" value="{{ item.insumo_id }}">
                                            <input type="text" class="form-control form-control-sm insumo-nombre" value="{{ item.insumo.nombre }}" readonly>
                                        </td>
                                        <td>
                                            <input type="text" class="form-control form-control-sm proveedor-nombre" value="{{ orden.proveedor.nombre }}" readonly>
                                        </td>
                                        <td>
                                            <input type="number" step="0.01" min="0.01" max="99999.99" class="form-control form-control-sm cantidad" name="cantidad_solicitada[]" value="{{ item.cantidad_solicitada }}" required {% if orden.estado != 'PENDIENTE' %}readonly{% endif %}>
                                        </td>
                                        <td>
                                            <input type="text" class="form-control form-control-sm precio_unitario" name="precio_unitario[]" value="${{ '%.2f'|format(item.precio_unitario|float) }}" readonly>
                                        </td>
                                        <td class="text-center">
                                            {% if orden.estado == 'PENDIENTE' %}
                                            <button type="button" class="btn btn-sm btn-outline-danger removeItemBtn" title="Eliminar ítem"><i class="bi bi-trash"></i></button>
                                            {% endif %}
                                        </td>
                                    </tr>
                                    {% endfor %}
                                {% endif %}
                            </tbody>
                        </table>
                    </div>
                    <div id="no-items-msg" class="text-center text-muted py-3 border-top">
                        <i class="bi bi-box-seam fs-3"></i>
                        <p class="mt-2">Añada ítems a la orden.</p>
                    </div>
                </div>
            </div>
            <div class="card mb-4">
                <div class="card-header">
                    <h5 class="mb-0">Información de la Orden</h5>
                </div>
                <div class="card-body">
                    <div class="row g-3">
                        {% if orden %}
                        <div class="col-md-12">
                            <label for="proveedor_nombre" class="form-label">Proveedor</label>
                            <div class="input-group">
                                <span class="input-group-text"><i class="bi bi-truck-flatbed"></i></span>
                                <input type="text" class="form-control" id="proveedor_nombre" name="proveedor_nombre" value="{{ orden.proveedor.nombre }}" readonly>
                                <input type="hidden" id="proveedor_id" name="proveedor_id" value="{{ orden.proveedor_id }}">
                            </div>
                        </div>
                        {% endif %}
                        <div class="col-md-6">
                            <label for="fecha_emision" class="form-label">Fecha Emisión <span class="text-danger">*</span></label>
                            <div class="input-group">
                                <span class="input-group-text"><i class="bi bi-calendar-event"></i></span>
                                <input type="date" class="form-control" id="fecha_emision" name="fecha_emision"
                                    value="{{ orden.fecha_emision if orden else today }}" required {{ 'readonly' if is_edit }}
                                    min="2025-01-01" max="{{ today }}">
                            </div>
                        </div>

                        <div class="col-md-6">
                            <label for="fecha_estimada_entrega" class="form-label">Fecha Estimada Entrega <span class="text-danger">*</span></label>
                            <div class="input-group">
                                <span class="input-group-text"><i class="bi bi-calendar-range"></i></span>
                                <input type="date" class="form-control" id="fecha_estimada_entrega"
                                    name="fecha_estimada_entrega"
                                    value="{{ orden.fecha_estimada_entrega if orden else today }}" required {{ 'readonly' if is_edit }} min="{{ today }}">
                            </div>
                        </div>
                        
                        <div class="col-md-12">
                            <label for="observaciones" class="form-label">Observaciones</label>
                            <div class="input-group">
                                <span class="input-group-text"><i class="bi bi-sticky"></i></span>
                                <textarea class="form-control" id="observaciones" name="observaciones"
                                    rows="2">{{ orden.observaciones if orden else '' }}</textarea>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            
            <template id="item-template">
                <tr class="item-row">
                    <td>
                        <input type="hidden" name="insumo_id[]" class="insumo-id">
                        <input type="text" class="form-control form-control-sm insumo-nombre" readonly>
                    </td>
                    <td>
                        <input type="text" class="form-control form-control-sm proveedor-nombre" readonly>
                    </td>
                    <td>
                        <input type="number" step="0.01" min="0.01" max="99999.99" class="form-control form-control-sm cantidad" name="cantidad_solicitada[]" value="1" required>
                    </td>
                    <td>
                         <input type="text" class="form-control form-control-sm precio_unitario" name="precio_unitario[]" readonly>
                    </td>
                    <td class="text-center">
                        <button type="button" class="btn btn-sm btn-outline-danger removeItemBtn" title="Eliminar ítem"><i class="bi bi-trash"></i></button>
                    </td>
                </tr>
            </template>


            <div class="card mb-4">
                <div class="card-body d-flex justify-content-end gap-3">
                    <div class="w-25">
                        <label class="form-label">Subtotal</label>
                        <input type="text" class="form-control" id="subtotal" name="subtotal" value="${{ '%.2f'|format(orden.subtotal|float) if orden else '0.00' }}" readonly>
                    </div>
                    <div class="w-25 d-flex flex-column justify-content-center">
                        <div class="form-check mt-4">
                            <input class="form-check-input" type="checkbox" id="iva" name="incluir_iva" value="true" {% if orden and orden.iva > 0 %}checked{% endif %}>
                            <label class="form-check-label" for="iva">Aplicar IVA 21%</label>
                        </div>
                    </div>
                    <div class="w-25">
                        <label class="form-label">Total</label>
                        <input type="text" class="form-control" id="total" name="total" value="${{ '%.2f'|format(orden.total|float) if orden else '0.00' }}" readonly>
                    </div>
                </div>
            </div>

            <div class="d-flex justify-content-end gap-2 mb-4">
                <a href="{{ url_for('orden_compra.listar') }}" class="btn btn-outline-secondary">Cancelar</a>
                <button type="submit" id="submitBtn" class="btn btn-primary">
                    <i class="bi bi-check-circle me-1"></i>
                    {% if orden %}Actualizar{% else %}Crear{% endif %} Orden
                </button>
            </div>
        </div>
    </div>
</form>
{% endblock %}

{% block extra_js %}
<script>
document.addEventListener('DOMContentLoaded', function () {
    const searchFilter = document.getElementById('insumo-search-filter');
    const insumoSelect = document.getElementById('insumo-select');
    const itemsContainer = document.getElementById('itemsContainer');
    const itemTemplate = document.getElementById('item-template');
    const subtotalInput = document.getElementById('subtotal');
    const ivaCheckbox = document.getElementById('iva');
    const totalInput = document.getElementById('total');
    const form = document.getElementById('ordenCompraForm');
    const submitButton = document.getElementById('submitBtn');

    // Funcionalidad de búsqueda de insumos (solo para el modo de creación)
    if (searchFilter && insumoSelect) {
        const options = Array.from(insumoSelect.options);
        searchFilter.addEventListener('input', function () {
            const searchTerm = this.value.toLowerCase();
            insumoSelect.innerHTML = ''; 
            
            options.forEach(option => {
                if (option.text.toLowerCase().includes(searchTerm)) {
                    insumoSelect.appendChild(option);
                }
            });
        });

        insumoSelect.addEventListener('dblclick', function () {
            const selectedOption = this.options[this.selectedIndex];
            if (!selectedOption || !selectedOption.value) return;

            const insumoId = selectedOption.value;
            
            const templateContent = itemTemplate.content.cloneNode(true);
            const newRow = templateContent.querySelector('.item-row');
            
            newRow.dataset.stockActual = selectedOption.dataset.stockActual;
            newRow.dataset.stockMax = selectedOption.dataset.stockMax;
            newRow.querySelector('.insumo-id').value = insumoId;
            newRow.querySelector('.insumo-nombre').value = selectedOption.dataset.nombre;
            newRow.querySelector('.proveedor-nombre').value = selectedOption.dataset.proveedorNombre;
            newRow.querySelector('.precio_unitario').value = `$${parseFloat(selectedOption.dataset.precio).toFixed(2)}`;
            
            itemsContainer.appendChild(newRow);
            updateUI();
            calcularSubtotales();
        });
    }

    // Eventos para el contenedor de ítems (eliminar, cambiar cantidad)
    if (itemsContainer) {
        itemsContainer.addEventListener('click', function (e) {
            if (e.target.closest('.removeItemBtn')) {
                e.target.closest('.item-row').remove();
                updateUI();
                calcularSubtotales();
            }
        });

        itemsContainer.addEventListener('input', function (e) {
            if (e.target.classList.contains('cantidad')) {
                const currentRow = e.target.closest('.item-row');
                const cantidadInput = e.target;
                const stockActual = parseFloat(currentRow.dataset.stockActual);
                const stockMax = parseFloat(currentRow.dataset.stockMax);
                const cantidadComprar = parseFloat(cantidadInput.value);

                if (isNaN(cantidadComprar) || cantidadComprar <= 0) {
                     cantidadInput.classList.add('is-invalid');
                } else if (stockActual + cantidadComprar > stockMax) {
                    cantidadInput.classList.add('is-invalid');
                    const insumoNombre = currentRow.querySelector('.insumo-nombre').value;
                    showNotificationModal(
                        "Error de Stock",
                        `La cantidad para "${insumoNombre}" supera el stock máximo permitido (${stockMax} unidades).`
                    );
                } else {
                    cantidadInput.classList.remove('is-invalid');
                }
                
                validarTodasLasFilas();
                calcularSubtotales();
            }
        });
    }

    // Evento de cambio de IVA
    if (ivaCheckbox) {
        ivaCheckbox.addEventListener('change', calcularSubtotales);
    }
    
    // Función para validar todas las filas
    function validarTodasLasFilas() {
        let todasValidas = true;
        document.querySelectorAll('.item-row .cantidad').forEach(input => {
            if (input.classList.contains('is-invalid') || input.value.trim() === '' || parseFloat(input.value) <= 0) {
                todasValidas = false;
            }
        });
        if (submitButton) {
            submitButton.disabled = !todasValidas;
        }
    }

    // Función para calcular subtotales
    function calcularSubtotales() {
        let subtotal = 0;
        document.querySelectorAll('.item-row').forEach(row => {
            const cantidad = parseFloat(row.querySelector('.cantidad').value) || 0;
            const precioStr = row.querySelector('.precio_unitario').value.replace('$', '').trim();
            const precio = parseFloat(precioStr) || 0;
            subtotal += cantidad * precio;
        });

        if (subtotalInput) {
            subtotalInput.value = `$${subtotal.toFixed(2)}`;
        }

        let total = subtotal;
        if (ivaCheckbox && ivaCheckbox.checked) {
            total += subtotal * 0.21;
        }
        if (totalInput) {
            totalInput.value = `$${total.toFixed(2)}`;
        }
    }

    // Función para actualizar la UI (mensaje de "sin ítems")
    function updateUI() {
        const noItemsMsg = document.getElementById('no-items-msg');
        if (noItemsMsg) {
            noItemsMsg.style.display = itemsContainer.children.length > 0 ? 'none' : 'block';
        }
    }

    // Adjuntar el event listener para el envío del formulario
    if (form && submitButton) {
        form.addEventListener('submit', function(event) {
            // Deshabilitar el botón inmediatamente para evitar clics múltiples
            submitButton.disabled = true;
            submitButton.innerHTML = `<span class="spinner-border spinner-border-sm" role="status" aria-hidden="true"></span> Guardando...`;

            // Prevenir el envío si no hay ítems
            if (itemsContainer.children.length === 0) {
                event.preventDefault(); 
                showNotificationModal('Error', 'Debe añadir al menos un ítem a la orden.', 'error');
                // Rehabilitar el botón si el envío se cancela
                submitButton.disabled = false;
                submitButton.innerHTML = `<i class="bi bi-check-circle me-1"></i> Crear Orden`;
            }
        });
    }

    // Llamadas iniciales al cargar la página
    updateUI();
    calcularSubtotales();
});
</script>
{% endblock extra_js %}