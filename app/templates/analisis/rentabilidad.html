{% extends "layouts/app_layout.html" %}

{% block app_content %}
<div class="container-fluid px-4 py-4" id="rentabilidad-content">
    
    <!-- Header / Command Center Card -->
    <div id="dashboard-header-card" class="card border-0 shadow rounded-4 overflow-hidden mb-4" style="background: linear-gradient(135deg, #ffffff 0%, #f8f9fa 100%); transition: all 0.5s ease; border-left: 4px solid #198754 !important;">
        <div class="card-header border-bottom-0 pt-4 pb-0 px-4 position-relative" style="background: transparent; z-index: 1;">
            
            <div class="d-flex flex-column flex-md-row justify-content-between align-items-md-center mb-3 position-relative z-2">
                <div class="d-flex align-items-center mb-3 mb-md-0">
                    <div class="icon-box bg-white text-success rounded-4 p-3 me-3 shadow-sm border hover-lift transition-transform" style="color: #198754 !important;">
                        <i class="bi bi-graph-up-arrow fs-3"></i>
                    </div>
                    <div>
                        <h4 class="fw-bold text-dark mb-1 tracking-tight">Análisis de Rentabilidad Global</h4>
                        <p class="text-muted small mb-0 d-flex align-items-center">
                            <span class="badge bg-success-subtle text-success rounded-pill me-2 px-2 pulse-badge">En vivo</span>
                            Monitoreo de márgenes, costos y contribución
                        </p>
                    </div>
                </div>
                <!-- Breadcrumb / Info Area -->
                <div class="d-none d-md-block text-end">
                   <nav aria-label="breadcrumb">
                      <ol class="breadcrumb mb-0 justify-content-end small">
                        <li class="breadcrumb-item"><a href="{{ url_for('admin_dashboard.index') }}" class="text-decoration-none text-muted">Inicio</a></li>
                        <li class="breadcrumb-item active fw-semibold text-success" aria-current="page">Rentabilidad</li>
                      </ol>
                   </nav>
                   <div class="d-flex align-items-center justify-content-end mt-1">
                       <button onclick="exportToPDF()" class="btn btn-sm btn-outline-dark rounded-pill me-3 d-print-none">
                            <i class="bi bi-file-earmark-pdf me-1"></i> Guardar Reporte (PDF)
                       </button>
                       <small class="text-muted font-monospace" style="font-size: 0.75rem;">
                           <i class="bi bi-clock me-1"></i>Actualizado: <span id="last-updated" class="fw-bold">Hoy</span>
                       </small>
                   </div>
                </div>
            </div>

            <!-- Disclaimer and Filters -->
            <div class="row align-items-center mb-3 position-relative z-2">
                <div class="col-md-8">
                     <div class="alert alert-warning border-0 bg-warning-subtle text-warning-emphasis rounded-3 py-2 px-3 small mb-0 d-flex align-items-center shadow-sm">
                        <i class="bi bi-exclamation-triangle-fill me-2"></i>
                        <span><strong>Nota:</strong> Este análisis aplica la <u>estructura de costos actual</u> sobre el volumen de ventas del período seleccionado. Sirve como simulador de rentabilidad presente.</span>
                    </div>
                </div>
                <div class="col-md-4 d-flex justify-content-end">
                    <div id="filter-buttons" class="btn-group shadow-sm rounded-pill" role="group" aria-label="Filtros de fecha">
                        <button type="button" class="btn btn-sm btn-outline-success active rounded-start-pill px-3" data-period="30">Vol. Mes</button>
                        <button type="button" class="btn btn-sm btn-outline-success px-3" data-period="90">Vol. Trimestre</button>
                        <button type="button" class="btn btn-sm btn-outline-success rounded-end-pill px-3" data-period="365">Vol. Anual</button>
                    </div>
                </div>
            </div>
        </div>

        <!-- Main Content Area -->
        <div class="card-body p-4" style="background-color: #f4f6f9;">
            
            <!-- Fila de KPIs Globales -->
            <div class="row align-items-center mb-4">
                <div class="col-md-12">
                    <div class="row g-3">
                        <!-- 1. KPI: Facturación Total -->
                        <div class="col-12 col-md-3">
                            <div class="card text-center h-100 border-0 shadow-sm rounded-4">
                                <div class="card-body p-3">
                                    <h6 class="text-muted text-uppercase small fw-bold mb-2">
                                        Facturación Total
                                        <i class="bi bi-info-circle ms-1 text-muted opacity-50" data-bs-toggle="tooltip" title="Total facturado por ventas realizadas (cobrado o por cobrar) en el período."></i>
                                    </h6>
                                    <p class="fw-bold text-primary mb-0 display-6" style="font-size: 1.3rem;" id="global-facturacion">$0</p>
                                </div>
                            </div>
                        </div>
                        <!-- 2. KPI: Costos Variables -->
                        <div class="col-12 col-md-3">
                            <div class="card text-center h-100 border-0 shadow-sm rounded-4">
                                <div class="card-body p-3">
                                    <h6 class="text-muted text-uppercase small fw-bold mb-2">
                                        Costos Variables
                                        <i class="bi bi-info-circle ms-1 text-muted opacity-50" data-bs-toggle="tooltip" title="Costos directos asociados a la producción (Materia Prima + Mano de Obra)."></i>
                                    </h6>
                                    <p class="fw-bold text-warning mb-0 display-6" style="font-size: 1.3rem;" id="global-costo-variable">$0</p>
                                </div>
                            </div>
                        </div>
                        <!-- 3. KPI: Margen Contribución -->
                        <div class="col-12 col-md-3">
                            <div class="card text-center h-100 border-0 shadow-sm rounded-4">
                                <div class="card-body p-3">
                                    <h6 class="text-muted text-uppercase small fw-bold mb-2">
                                        Margen Contrib.
                                        <i class="bi bi-info-circle ms-1 text-muted opacity-50" data-bs-toggle="tooltip" title="Dinero disponible para cubrir costos fijos tras restar los costos variables."></i>
                                    </h6>
                                    <p class="fw-bold text-info mb-0 display-6" style="font-size: 1.3rem;" id="global-margen-contribucion">$0</p>
                                </div>
                            </div>
                        </div>
                        <!-- 4. KPI: Costos Fijos -->
                        <div class="col-12 col-md-3">
                            <div class="card text-center h-100 border-0 shadow-sm rounded-4">
                                <div class="card-body p-3">
                                    <h6 class="text-muted text-uppercase small fw-bold mb-2">
                                        Costos Fijos
                                        <i class="bi bi-info-circle ms-1 text-muted opacity-50" data-bs-toggle="tooltip" title="Gastos operativos recurrentes (alquiler, salarios fijos, servicios) que no dependen del volumen."></i>
                                    </h6>
                                    <p class="fw-bold text-danger mb-0 display-6" style="font-size: 1.3rem;" id="global-costos-fijos">$0</p>
                                    <small class="d-block text-muted mt-1" style="font-size: 0.7rem;" id="global-costos-fijos-desglose">
                                        Dir: $0 | Ind: $0
                                    </small>
                                </div>
                            </div>
                        </div>
                        <!-- 5. KPI: Costos de Envío -->
                        <div class="col-12 col-md-3">
                            <div class="card text-center h-100 border-0 shadow-sm rounded-4">
                                <div class="card-body p-3">
                                    <h6 class="text-muted text-uppercase small fw-bold mb-2">
                                        Costos Envío
                                        <i class="bi bi-info-circle ms-1 text-muted opacity-50" data-bs-toggle="tooltip" title="Gastos de logística y transporte asumidos por la empresa (no cobrados al cliente)."></i>
                                    </h6>
                                    <p class="fw-bold text-secondary mb-0 display-6" style="font-size: 1.3rem;" id="global-costos-envio">$0</p>
                                    <small class="text-muted" style="font-size: 0.65rem;">Recargos asumidos</small>
                                </div>
                            </div>
                        </div>
                        <!-- 6. KPI: Rentabilidad Neta (MOVIDO AQUI) -->
                        <div class="col-12 col-md-3">
                            <div class="card text-center h-100 border-0 shadow rounded-4 bg-white position-relative overflow-hidden">
                                <div class="card-body p-3 position-relative z-1">
                                    <h6 class="text-muted text-uppercase small fw-bold mb-2">
                                        Rentabilidad Neta
                                        <i class="bi bi-info-circle ms-1 text-muted opacity-50" data-bs-toggle="tooltip" title="Ganancia final real de la empresa tras descontar todos los costos (variables, fijos y envío)."></i>
                                    </h6>
                                    <p class="fw-bold text-success display-6 mb-0" style="font-size: 1.5rem;" id="global-rentabilidad-neta">$0</p>
                                    <small id="global-rentabilidad-porcentaje" class="text-success fw-bold">0%</small>
                                </div>
                                <div class="position-absolute top-0 start-0 w-100 h-100 opacity-10 bg-success-subtle"></div>
                            </div>
                        </div>
                         <!-- 7. KPI: Punto de Equilibrio -->
                        <div class="col-12 col-md-3">
                            <div class="card text-center h-100 border-0 shadow-sm rounded-4">
                                <div class="card-body p-3">
                                    <h6 class="text-muted text-uppercase small fw-bold mb-2">
                                        Punto de Equilibrio
                                        <i class="bi bi-info-circle ms-1 text-muted opacity-50" data-bs-toggle="tooltip" title="Facturación mínima necesaria para cubrir todos los costos y no perder dinero (Ganancia = 0)."></i>
                                    </h6>
                                    <p class="fw-bold text-dark mb-0 display-6" style="font-size: 1.3rem;" id="global-punto-equilibrio">$0</p>
                                    <small class="text-muted" style="font-size: 0.65rem;">Meta Mínima</small>
                                </div>
                            </div>
                        </div>
                        <!-- 8. KPI: Próximo a Facturar -->
                        <div class="col-12 col-md-3">
                            <div class="card text-center h-100 border-0 shadow-sm rounded-4 bg-white position-relative overflow-hidden">
                                <div class="card-body p-3 position-relative z-1">
                                    <h6 class="text-muted text-uppercase small fw-bold mb-2">
                                        Próximo a Facturar
                                        <i class="bi bi-info-circle ms-1 text-muted opacity-50" data-bs-toggle="tooltip" title="Ventas pendientes o en proceso que aún no se han completado/entregado. Ingreso futuro proyectado."></i>
                                    </h6>
                                    <p class="fw-bold text-secondary mb-0 display-6" style="font-size: 1.3rem;" id="global-proximo-facturar">$0</p>
                                    <small class="text-muted" style="font-size: 0.65rem;">Pendiente + En Proceso</small>
                                </div>
                                <!-- Subtle background to distinguish it -->
                                <div class="position-absolute top-0 start-0 w-100 h-100 opacity-10" style="background-color: rgba(108, 117, 125, 0.1);"></div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Fila de Gráficos Principales -->
            <div class="row g-4">
                <!-- Gráfico de Burbujas (Matriz BCG - Margen Contribución) -->
                <div class="col-lg-7">
                    <div class="card shadow border-0 h-100 rounded-4">
                        <div class="card-header bg-white border-bottom-0 pt-4 px-4 d-flex justify-content-between align-items-center">
                            <h6 class="fw-bold mb-0 text-dark h5">Matriz de Contribución (BCG)</h6>
                            <button class="btn btn-sm btn-light text-muted rounded-pill px-3" type="button" data-bs-toggle="collapse" data-bs-target="#bcgInfo" aria-expanded="false" aria-controls="bcgInfo">
                                <i class="bi bi-info-circle me-2"></i>¿Cómo leer esto?
                            </button>
                        </div>
                        <div class="card-body px-4 pb-4">
                            <!-- Collapsible Explanation -->
                            <div class="collapse mb-3" id="bcgInfo">
                                <div class="card card-body bg-light-subtle border-0 small text-muted rounded-4">
                                    <div class="d-flex align-items-start">
                                        <i class="bi bi-grid-1x2-fill text-primary me-3 mt-1 fs-5"></i>
                                        <div>
                                            <strong class="text-dark d-block mb-2">Matriz BCG adaptada: Clasificación por Ventas vs. Margen</strong>
                                            <div class="row g-2">
                                                <div class="col-md-6">
                                                    <div class="d-flex align-items-center">
                                                        <span class="badge bg-success rounded-pill me-2">Estrellas</span>
                                                        <span><strong>Alto Vol. / Alto Margen:</strong> Productos líderes. Potenciar.</span>
                                                    </div>
                                                </div>
                                                <div class="col-md-6">
                                                     <div class="d-flex align-items-center">
                                                        <span class="badge bg-primary rounded-pill me-2">Vacas</span>
                                                        <span><strong>Alto Vol. / Bajo Margen:</strong> Generan flujo constante. Mantener.</span>
                                                    </div>
                                                </div>
                                                <div class="col-md-6">
                                                     <div class="d-flex align-items-center">
                                                        <span class="badge bg-warning text-dark rounded-pill me-2">Interrogantes</span>
                                                        <span><strong>Bajo Vol. / Alto Margen:</strong> Potenciales. Evaluar estrategia.</span>
                                                    </div>
                                                </div>
                                                <div class="col-md-6">
                                                     <div class="d-flex align-items-center">
                                                        <span class="badge bg-danger rounded-pill me-2">Perros</span>
                                                        <span><strong>Bajo Vol. / Bajo Margen:</strong> Baja rentabilidad. Considerar descartar.</span>
                                                    </div>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            <div id="rentabilidad-chart-container" style="width: 100%; height: 450px;"></div>
                            <div id="dynamic-chart-description" class="alert alert-light border-0 bg-light-subtle rounded-3 mt-3 py-2 px-3 d-flex align-items-start small text-muted">
                                <i class="bi bi-lightbulb-fill text-warning me-2 mt-1"></i>
                                <span>Calculando análisis...</span>
                            </div>
                        </div>
                    </div>
                </div>
                <!-- Leyenda y Gráficos Secundarios -->
                <div class="col-lg-5">
                    <div class="card shadow border-0 rounded-4 mb-4">
                        <div class="card-header bg-white border-bottom-0 pt-4 px-4">
                            <h6 class="fw-bold mb-0 text-dark h6">Top 5: Mayor Margen Total</h6>
                        </div>
                        <div class="card-body px-4 pb-4">
                            <div id="top-rentables-chart-container" style="width: 100%; height: 220px;"></div>
                        </div>
                    </div>
                     <div class="card shadow border-0 rounded-4">
                        <div class="card-header bg-white border-bottom-0 pt-4 px-4">
                            <h6 class="fw-bold mb-0 text-dark h6">Desglose Costos Variables (Top 5)</h6>
                        </div>
                        <div class="card-body px-4 pb-4">
                            <div id="costos-chart-container" style="width: 100%; height: 250px;"></div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Tabla de Datos Detallada -->
            <div class="card shadow border-0 rounded-4 mt-4">
                <div class="card-header bg-white border-bottom-0 py-4 px-4 d-flex justify-content-between align-items-center">
                    <h6 class="fw-bold mb-0 text-dark h5">Análisis Detallado por Producto</h6>
                    <input type="text" id="searchInput" class="form-control w-25 form-control-sm rounded-pill bg-light border-0 px-3" placeholder="Buscar producto...">
                </div>
                <div class="card-body px-0 pb-4 pt-0">
                    <div class="table-responsive">
                        <table class="table table-hover align-middle mb-0" id="tabla-rentabilidad">
                            <thead class="bg-light">
                                <tr>
                                    <th scope="col" class="ps-4 border-0 text-muted small fw-bold text-uppercase"></th>
                                    <th scope="col" data-sort="nombre" style="cursor: pointer;" class="border-0 text-muted small fw-bold text-uppercase">Producto ⇅</th>
                                    <th scope="col" data-sort="volumen_ventas" class="text-end border-0 text-muted small fw-bold text-uppercase" style="cursor: pointer;">Vol. ⇅</th>
                                    <th scope="col" data-sort="costo_variable_total" class="text-end border-0 text-muted small fw-bold text-uppercase" style="cursor: pointer;">Gastos ⇅</th>
                                    <th scope="col" data-sort="facturacion_total" class="text-end border-0 text-muted small fw-bold text-uppercase" style="cursor: pointer;">Ingresos ⇅</th>
                                    <th scope="col" data-sort="margen_contribucion_total" class="text-end border-0 text-muted small fw-bold text-uppercase" style="cursor: pointer;">Ganancia ⇅</th>
                                    <th scope="col" data-sort="margen_porcentual" class="text-end border-0 text-muted small fw-bold text-uppercase" style="cursor: pointer;">Margen % ⇅</th>
                                    <th scope="col" class="pe-4 border-0 text-muted small fw-bold text-uppercase">Clasificación</th>
                                </tr>
                            </thead>
                            <tbody id="tabla-rentabilidad-body" class="border-top-0">
                                <!-- Las filas se insertarán aquí dinámicamente -->
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Modal para Detalles del Producto -->
<div class="modal fade" id="productoModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-xl modal-dialog-centered">
        <div class="modal-content border-0 shadow-lg rounded-4">
            <div class="modal-header border-bottom-0 pb-0">
                <h5 class="modal-title fw-bold text-dark">Detalles del Producto</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body p-4" id="modal-body-content">
                <!-- Dinámico -->
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_css %}
<style>
    @media print {
        /* Global Reset */
        body {
            background-color: white !important;
            color: black !important;
            font-size: 10pt; /* Slightly smaller for more data */
        }
        
        /* Hide Navigation and Interactive Elements */
        #dashboard-sidebar, .navbar, .btn, #searchInput, .modal, footer, 
        .breadcrumb, #filter-buttons, .tooltip, .toast {
            display: none !important;
        }

        /* Full Width Layout */
        #layoutSidenav_content {
            margin-left: 0 !important;
            padding: 0 !important;
            width: 100% !important;
        }
        .container-fluid {
            padding: 0 !important;
            max-width: 100% !important;
            width: 100% !important;
        }
        
        /* Card Improvements */
        .card {
            border: 1px solid #ddd !important;
            box-shadow: none !important;
            break-inside: avoid; /* Prevent splitting cards across pages */
            margin-bottom: 15px !important;
            page-break-inside: avoid;
        }
        .card-header {
            background-color: #f8f9fa !important;
            border-bottom: 1px solid #ddd !important;
            padding: 10px !important;
        }
        .card-body {
            padding: 10px !important;
        }

        /* Specific Page Break Management */
        /* Force page break before the detailed table if necessary */
        .card:last-child {
            page-break-before: auto; 
        }

        /* Ensure Charts fit horizontally */
        canvas {
            max-width: 100% !important;
            width: 100% !important;
            height: auto !important;
        }
        /* Override fixed heights for charts to be responsive to print width */
        #rentabilidad-chart-container, 
        #top-rentables-chart-container, 
        #costos-chart-container {
            width: 100% !important;
        }
        
        /* Table Optimization */
        .table-responsive {
            overflow: visible !important; /* Show full table */
        }
        table {
            width: 100% !important;
            border-collapse: collapse !important;
        }
        th, td {
            border: 1px solid #ddd !important;
            padding: 4px !important;
        }
        
        /* Typography */
        h4, h5, h6 {
            color: black !important;
            margin-top: 0 !important;
        }
        .text-muted {
            color: #666 !important;
        }
        
        /* KPI Cards Compactness */
        .row.g-3 {
            display: flex;
            flex-wrap: wrap;
            justify-content: space-between;
        }
        .col-md-2 {
            flex: 0 0 16%; /* Fit 6 cards in one row */
            max-width: 16%;
        }
    }

    /* Styles copied/adapted from indicators dashboard for consistency */
    .icon-box {
        width: 60px; 
        height: 60px; 
        display: flex; 
        align-items: center; 
        justify-content: center;
    }
    .hover-lift:hover {
        transform: translateY(-5px);
        box-shadow: 0 .5rem 1rem rgba(0,0,0,.15)!important;
    }
    .transition-transform {
        transition: transform .3s ease;
    }
    @keyframes pulse-glow {
        0% { box-shadow: 0 0 0 0 rgba(25, 135, 84, 0.4); }
        70% { box-shadow: 0 0 0 6px rgba(25, 135, 84, 0); }
        100% { box-shadow: 0 0 0 0 rgba(25, 135, 84, 0); }
    }
    .pulse-badge {
        animation: pulse-glow 2s infinite;
    }
    .table-hover tbody tr:hover {
        background-color: rgba(0,0,0,.02);
    }
    .nav-tabs .nav-link {
        color: #6c757d;
        font-weight: 500;
    }
    .nav-tabs .nav-link.active {
        color: #198754;
        font-weight: 600;
        border-bottom: 2px solid #198754;
    }
</style>
{% endblock %}

{% block extra_js %}
<!-- ECharts CDN -->
<script src="https://cdn.jsdelivr.net/npm/echarts@5.4.3/dist/echarts.min.js"></script>
<!-- HTML2Canvas & jsPDF -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>

<script>
    // PDF Export Function
    window.exportToPDF = function() {
        const { jsPDF } = window.jspdf;
        const btn = document.querySelector('.btn-outline-dark');
        const originalText = btn.innerHTML;
        
        // Visual feedback
        btn.disabled = true;
        btn.innerHTML = '<span class="spinner-border spinner-border-sm me-2"></span>Generando...';

        // Target the specific container
        const element = document.getElementById('rentabilidad-content');

        // Force a specific desktop capture width
        const captureWidth = 1920;

        html2canvas(element, {
            scale: 2, 
            useCORS: true,
            logging: true,
            scrollY: -window.scrollY, 
            windowWidth: captureWidth, // Force the browser window width simulation
            width: captureWidth,       // Force the canvas capture width
            x: 0,                      // Start from left
            backgroundColor: '#ffffff'
        }).then(canvas => {
            if (canvas.height === 0 || canvas.width === 0) {
                alert("Error: El contenido capturado está vacío.");
                btn.innerHTML = originalText;
                btn.disabled = false;
                return;
            }

            const imgData = canvas.toDataURL('image/png');
            
            // Initialize jsPDF in Landscape ('l'), unit: mm, format: a4
            const pdf = new jsPDF('l', 'mm', 'a4');
            const pageWidth = 297; 
            const pageHeight = 210;
            
            // Add a small margin (e.g., 5mm each side)
            const margin = 5;
            const pdfContentWidth = pageWidth - (margin * 2);

            const imgProps = pdf.getImageProperties(imgData);
            
            // Scale content to fit the PDF content width
            const pdfImgWidth = pdfContentWidth;
            const pdfImgHeight = (imgProps.height * pdfImgWidth) / imgProps.width;
            
            // Single page logic if it fits, else split
            if (pdfImgHeight <= (pageHeight - (margin * 2))) {
                pdf.addImage(imgData, 'PNG', margin, margin, pdfImgWidth, pdfImgHeight);
            } else {
                // Multi-page logic
                let heightLeft = pdfImgHeight;
                let position = margin;
                
                // First page
                pdf.addImage(imgData, 'PNG', margin, position, pdfImgWidth, pdfImgHeight);
                heightLeft -= (pageHeight - (margin * 2));
                
                // Subsequent pages
                while (heightLeft > 0) {
                    // Start next page content at top margin, offset by how much we've already shown
                    // Position needs to move up by the full page content height
                    position = position - pageHeight; 
                    
                    pdf.addPage();
                    // We paste the same huge image, but shifted up
                    pdf.addImage(imgData, 'PNG', margin, position, pdfImgWidth, pdfImgHeight);
                    heightLeft -= pageHeight;
                }
            }

            const dateStr = new Date().toISOString().split('T')[0];
            pdf.save(`Reporte_Rentabilidad_${dateStr}.pdf`);

            // Restore button
            btn.innerHTML = originalText;
            btn.disabled = false;
        }).catch(err => {
            console.error("PDF generation failed:", err);
            alert("Hubo un error generando el PDF. Por favor intente nuevamente.");
            btn.innerHTML = originalText;
            btn.disabled = false;
        });
    };

document.addEventListener('DOMContentLoaded', function () {
    // Inicializar tooltips de Bootstrap
    var tooltipTriggerList = [].slice.call(document.querySelectorAll('[data-bs-toggle="tooltip"]'))
    var tooltipList = tooltipTriggerList.map(function (tooltipTriggerEl) {
        return new bootstrap.Tooltip(tooltipTriggerEl)
    })
    
    // Update last updated time
    const now = new Date();
    document.getElementById('last-updated').textContent = now.toLocaleDateString() + ' ' + now.toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'});

    // Instancias de ECharts
    const bubbleChartInstance = echarts.init(document.getElementById('rentabilidad-chart-container'));
    const topRentablesChartInstance = echarts.init(document.getElementById('top-rentables-chart-container'));
    const costosChartInstance = echarts.init(document.getElementById('costos-chart-container'));

    // Resize responsive
    window.addEventListener('resize', function() {
        bubbleChartInstance.resize();
        topRentablesChartInstance.resize();
        costosChartInstance.resize();
    });

    // Estado de la aplicación
    let fullData = { productos: [], totales_globales: {}, promedios: {} };
    let sortConfig = { key: 'margen_contribucion_total', direction: 'desc' };
    let currentFilter = '30'; // Default a Mes (30 días)

    // --- UTILS ---
    const formatCurrency = (value) => {
        value = value || 0;
        const absValue = Math.abs(value);
        if (absValue >= 1000000) {
            return `$${(value / 1000000).toLocaleString('es-AR', {minimumFractionDigits: 1, maximumFractionDigits: 2})}M`;
        } else if (absValue >= 1000) {
            return `$${(value / 1000).toLocaleString('es-AR', {minimumFractionDigits: 1, maximumFractionDigits: 2})}K`;
        }
        return `$${value.toLocaleString('es-AR', {minimumFractionDigits: 2, maximumFractionDigits: 2})}`;
    };

    const getQuadrantInfo = (producto, promedios) => {
        const { volumen_ventas, margen_porcentual } = producto;
        const avgVentas = promedios.volumen_ventas || 0;
        const avgMargen = promedios.margen_ganancia || 0;

        if (volumen_ventas >= avgVentas && margen_porcentual >= avgMargen) {
            return { name: 'Estrella', color: '#4CAF50' };
        } else if (volumen_ventas >= avgVentas && margen_porcentual < avgMargen) {
            return { name: 'Vaca', color: '#2196F3' };
        } else if (volumen_ventas < avgVentas && margen_porcentual >= avgMargen) {
            return { name: 'Interrogante', color: '#FFC107' };
        } else {
            return { name: 'Perro', color: '#F44336' };
        }
    };

    // --- LÓGICA DE CARGA DE DATOS ---
    function loadData(period = '30') {
        let url = '/analisis/api/rentabilidad/datos';
        if (period !== 'all') {
            const endDate = new Date();
            const startDate = new Date();
            startDate.setDate(endDate.getDate() - parseInt(period, 10));
            const formatDate = (date) => date.toISOString().split('T')[0];
            url += `?fecha_inicio=${formatDate(startDate)}&fecha_fin=${formatDate(endDate)}`;
        }

        bubbleChartInstance.showLoading();
        fetch(url)
            .then(response => response.json())
            .then(result => {
                if (result.success) {
                    fullData = result.data;
                    updateDashboard();
                } else {
                    console.error('Error al cargar datos:', result.error);
                }
            }).finally(() => {
                bubbleChartInstance.hideLoading();
            });
    }

    // --- LÓGICA DE RENDERIZADO ---
    function updateDashboard(filteredProducts = null) {
        const productsToRender = filteredProducts || fullData.productos;
        
        // Actualizar KPIs Globales
        const g = fullData.totales_globales;
        if (g) {
            document.getElementById('global-facturacion').textContent = formatCurrency(g.facturacion_total);
            document.getElementById('global-costo-variable').textContent = formatCurrency(g.costo_variable_total);
            document.getElementById('global-margen-contribucion').textContent = formatCurrency(g.margen_contribucion_total);
            document.getElementById('global-costos-fijos').textContent = formatCurrency(g.costos_fijos_total);
            
            // Actualizar desglose de costos fijos
            const desElem = document.getElementById('global-costos-fijos-desglose');
            if (desElem) {
                desElem.innerHTML = `Dir: ${formatCurrency(g.costos_fijos_directos)} | Ind: ${formatCurrency(g.costos_fijos_indirectos)}`;
            }

            const envioElem = document.getElementById('global-costos-envio');
            if (envioElem) {
                envioElem.textContent = formatCurrency(g.costos_envio_total);
            }
            
            const eqElem = document.getElementById('global-punto-equilibrio');
            if (eqElem) {
                eqElem.textContent = formatCurrency(g.punto_equilibrio);
            }

            document.getElementById('global-rentabilidad-neta').textContent = formatCurrency(g.rentabilidad_neta);
            
            // Update New KPI: Próximo a Facturar
            const proximoElem = document.getElementById('global-proximo-facturar');
            if(proximoElem && g.proximo_a_facturar !== undefined) {
                proximoElem.textContent = formatCurrency(g.proximo_a_facturar);
            } else if (proximoElem) {
                // Fallback for safety if undefined
                proximoElem.textContent = formatCurrency(0);
            }

            const rentElem = document.getElementById('global-rentabilidad-porcentaje');
            rentElem.textContent = `${g.rentabilidad_porcentual}%`;
            rentElem.className = g.rentabilidad_porcentual >= 0 ? 'text-success fw-bold' : 'text-danger fw-bold';
        }

        renderBubbleChart(productsToRender, fullData.promedios);
        renderTopCharts(fullData.productos);
        renderCostosChart(fullData.productos);
        renderTable(productsToRender);
        updateDynamicDescription(productsToRender, fullData.promedios);
    }
    
    function renderBubbleChart(data, promedios) {
        const filteredData = data.filter(p => p.volumen_ventas > 0);
        
        if (filteredData.length === 0) {
            bubbleChartInstance.clear();
            bubbleChartInstance.setOption({
                title: { text: 'No hay datos de ventas en este período.', left: 'center', top: 'center' }
            });
            return;
        }

        const maxVenta = Math.max(...filteredData.map(p => p.volumen_ventas), 0);
        const minRadius = 10, maxRadius = 60;
        
        const seriesData = filteredData.map(p => {
            const quadrant = getQuadrantInfo(p, promedios);
            // Eje X: Ventas, Eje Y: Margen Unitario %
            return {
                name: p.nombre,
                value: [p.volumen_ventas, p.margen_porcentual, p.margen_contribucion_total, p.id],
                itemStyle: { color: quadrant.color },
                symbolSize: maxVenta > 0 ? ((p.volumen_ventas / maxVenta) * (maxRadius - minRadius)) + minRadius : minRadius,
            };
        });

        const option = {
            tooltip: {
                trigger: 'item',
                formatter: (params) => {
                    return `<b>${params.name}</b><br/>Ventas: ${params.value[0]} u.<br/>Margen Unit: ${params.value[1]}%<br/>Contrib. Total: ${formatCurrency(params.value[2])}`;
                }
            },
            xAxis: { name: 'Volumen de Ventas', splitLine: { show: false } },
            yAxis: { name: 'Margen Contribución (%)', splitLine: { show: true } },
            series: [{
                type: 'scatter', data: seriesData, z: 2,
                markLine: {
                    z: 1, silent: false, symbol: 'none', lineStyle: { type: 'dashed' },
                    data: [
                        { xAxis: promedios.volumen_ventas, name: `Prom. Ventas: ${promedios.volumen_ventas.toFixed(0)}` },
                        { yAxis: promedios.margen_ganancia, name: `Prom. Margen: ${promedios.margen_ganancia.toFixed(1)}%` }
                    ]
                },
                markArea: {
                    silent: true, itemStyle: { opacity: 0.05 },
                    data: [
                         [
                            { name: 'Estrellas', xAxis: promedios.volumen_ventas, yAxis: promedios.margen_ganancia }, 
                            { xAxis: 'max', yAxis: 'max' }
                        ],
                        [
                            { name: 'Vacas', xAxis: promedios.volumen_ventas, yAxis: promedios.margen_ganancia }, 
                            { xAxis: 'max', yAxis: 'min' }
                        ],
                        [
                            { name: 'Interrogantes', xAxis: promedios.volumen_ventas, yAxis: promedios.margen_ganancia }, 
                            { xAxis: 'min', yAxis: 'max' }
                        ],
                        [
                            { name: 'Perros', xAxis: promedios.volumen_ventas, yAxis: promedios.margen_ganancia }, 
                            { xAxis: 'min', yAxis: 'min' }
                        ]
                    ]
                }
            }]
        };
        bubbleChartInstance.setOption(option);
    }

    function renderTopCharts(data) {
        // Top 5 por Margen de Contribución Total Absoluto
        const sortedByContrib = [...data].sort((a, b) => b.margen_contribucion_total - a.margen_contribucion_total).slice(0, 5);

        const rentablesOption = {
            tooltip: { 
                trigger: 'axis',
                formatter: function(params) {
                    let result = params[0].name + '<br/>';
                    params.forEach(item => {
                        result += item.marker + item.seriesName + ': ' + formatCurrency(item.value) + '<br/>';
                    });
                    return result;
                }
            },
            xAxis: { 
                type: 'value',
                axisLabel: {
                    formatter: (value) => formatCurrency(value)
                }
            },
            yAxis: { type: 'category', data: sortedByContrib.map(p => p.nombre).reverse(), axisLabel: { interval: 0, rotate: 0, fontSize: 10 } },
            series: [{ 
                name: 'Margen Contribución',
                type: 'bar', 
                data: sortedByContrib.map(p => p.margen_contribucion_total).reverse(),
                itemStyle: { color: '#2196F3' }
            }],
            grid: { left: '30%', right: '5%', bottom: '10%' }
        };

        topRentablesChartInstance.setOption(rentablesOption);
    }

    function renderCostosChart(data) {
        // Usamos los mismos Top 5 por contribución para mostrar sus costos
        const sortedByContrib = [...data].sort((a, b) => b.margen_contribucion_total - a.margen_contribucion_total).slice(0, 5);

        const option = {
            tooltip: { 
                trigger: 'axis', 
                axisPointer: { type: 'shadow' },
                formatter: function(params) {
                    let result = params[0].name + '<br/>';
                    params.forEach(item => {
                        result += item.marker + item.seriesName + ': ' + formatCurrency(item.value) + '<br/>';
                    });
                    return result;
                }
            },
            legend: { data: ['Materia Prima', 'Mano de Obra'] },
            grid: { left: '3%', right: '4%', bottom: '3%', containLabel: true },
            xAxis: { 
                type: 'value',
                axisLabel: {
                    formatter: (value) => formatCurrency(value)
                }
            },
            yAxis: {
                type: 'category',
                data: sortedByContrib.map(p => p.nombre).reverse(),
                axisLabel: { interval: 0, rotate: 0, fontSize: 10 }
            },
            series: [
                {
                    name: 'Materia Prima',
                    type: 'bar',
                    stack: 'total',
                    label: { show: true, formatter: (p) => `$${Math.round(p.value)}` },
                    data: sortedByContrib.map(p => p.detalles_costo.costo_materia_prima).reverse()
                },
                {
                    name: 'Mano de Obra',
                    type: 'bar',
                    stack: 'total',
                    label: { show: true, formatter: (p) => `$${Math.round(p.value)}` },
                    data: sortedByContrib.map(p => p.detalles_costo.costo_mano_obra).reverse()
                }
            ]
        };
        costosChartInstance.setOption(option);
    }
    
    function renderTable(data) {
        const tbody = document.getElementById('tabla-rentabilidad-body');
        tbody.innerHTML = '';

        data.sort((a, b) => {
            let valA = a[sortConfig.key];
            let valB = b[sortConfig.key];
            if (typeof valA === 'string') {
                valA = valA.toLowerCase();
                valB = valB.toLowerCase();
            }
            if (valA < valB) return sortConfig.direction === 'asc' ? -1 : 1;
            if (valA > valB) return sortConfig.direction === 'asc' ? 1 : -1;
            return 0;
        });

        data.forEach(p => {
            const quadrant = getQuadrantInfo(p, fullData.promedios);
            const row = document.createElement('tr');
            row.innerHTML = `
                <td class="ps-4"><button class="btn btn-sm btn-light rounded-circle shadow-sm btn-detail" data-id="${p.id}"><i class="bi bi-eye text-muted"></i></button></td>
                <td class="fw-bold text-dark">${p.nombre}</td>
                <td class="text-end">${p.volumen_ventas}</td>
                <td class="text-end text-danger">${formatCurrency(p.costo_variable_total)}</td>
                <td class="text-end text-primary">${formatCurrency(p.facturacion_total)}</td>
                <td class="text-end fw-bold text-success">${formatCurrency(p.margen_contribucion_total)}</td>
                <td class="text-end fw-bold ${p.margen_porcentual < 20 ? 'text-danger' : 'text-success'}">${p.margen_porcentual}%</td>
                <td class="pe-4"><span style="color:${quadrant.color}">●</span> ${quadrant.name}</td>
            `;
            tbody.appendChild(row);
        });

        // Re-attach event listeners for details
        document.querySelectorAll('.btn-detail').forEach(btn => {
            btn.addEventListener('click', (e) => {
                const id = e.currentTarget.dataset.id;
                cargarDetallesProducto(id);
            });
        });
    }

    function updateDynamicDescription(data, promedios) {
        const descriptionEl = document.getElementById('dynamic-chart-description');
        const productsWithSales = data.filter(p => p.volumen_ventas > 0);
        if (productsWithSales.length === 0) {
            descriptionEl.textContent = 'No hay suficientes datos de ventas en este período para un análisis detallado.';
            return;
        }

        const quadrantCounts = { 'Estrella': 0, 'Vaca': 0, 'Interrogante': 0, 'Perro': 0 };
        const quadrantContrib = { 'Estrella': 0, 'Vaca': 0, 'Interrogante': 0, 'Perro': 0 };
        let totalContrib = 0;

        productsWithSales.forEach(p => {
            const quadrant = getQuadrantInfo(p, promedios);
            quadrantCounts[quadrant.name]++;
            quadrantContrib[quadrant.name] += p.margen_contribucion_total;
            totalContrib += p.margen_contribucion_total;
        });

        let analysisText = '<strong class="text-dark">Análisis del Período:</strong> ';
        const topQuadrant = Object.entries(quadrantContrib).sort((a, b) => b[1] - a[1])[0];
        
        if (topQuadrant && totalContrib > 0) {
            const topName = topQuadrant[0];
            const topVal = topQuadrant[1];
            const topCount = quadrantCounts[topName];
            const percentage = ((topVal / totalContrib) * 100).toFixed(1);
            analysisText += `Los ${topCount} productos clasificados como '<strong class="text-dark">${topName}</strong>' son los más significativos, generando el <strong class="text-dark">${percentage}%</strong> del Margen de Contribución Total.`;
        } else {
             analysisText += "No se pudo generar un análisis concluyente con los datos actuales."
        }
        descriptionEl.innerHTML = `<i class="bi bi-lightbulb-fill text-warning me-2 mt-1"></i><span>${analysisText}</span>`;
    }

    // --- MANEJADORES DE EVENTOS ---
    document.getElementById('filter-buttons').addEventListener('click', (e) => {
        if (e.target.tagName === 'BUTTON') {
            currentFilter = e.target.dataset.period;
            document.querySelectorAll('#filter-buttons button').forEach(btn => btn.classList.remove('active'));
            e.target.classList.add('active');
            loadData(currentFilter);
        }
    });

    document.querySelectorAll('#tabla-rentabilidad th[data-sort]').forEach(header => {
        header.addEventListener('click', () => {
            const sortKey = header.getAttribute('data-sort');
            if (sortConfig.key === sortKey) {
                sortConfig.direction = sortConfig.direction === 'asc' ? 'desc' : 'asc';
            } else {
                sortConfig.key = sortKey;
                sortConfig.direction = 'desc';
            }
            renderTable(fullData.productos);
        });
    });

    document.getElementById('searchInput').addEventListener('input', (e) => {
        const searchTerm = e.target.value.toLowerCase();
        const filtered = fullData.productos.filter(p => p.nombre.toLowerCase().includes(searchTerm));
        renderTable(filtered);
    });

    function cargarDetallesProducto(productoId) {
        const modalBody = document.getElementById('modal-body-content');
        modalBody.innerHTML = '<div class="text-center py-5"><div class="spinner-border text-primary" role="status"></div></div>';
        const productoModal = new bootstrap.Modal(document.getElementById('productoModal'));
        productoModal.show();

        // Buscar datos locales primero (ya tenemos costos calculados)
        const localProductData = fullData.productos.find(p => p.id == productoId);

        // CORRECCIÓN: Usar el endpoint general de producto para obtener pedidos relacionados
        fetch(`/analisis/api/rentabilidad/producto/${productoId}`)
            .then(res => res.json())
            .then(detallesResult => { // Renombrado para claridad
                const result = detallesResult.data;
                let content = '';
                
                if (localProductData) {
                     content += `
                        <div class="row mb-4">
                            <div class="col-md-6">
                                <h4 class="fw-bold text-dark">${localProductData.nombre}</h4>
                                <p class="text-muted small">Precio Venta (Prom): ${formatCurrency(localProductData.precio_venta)}</p>
                            </div>
                            <div class="col-md-6 text-end">
                                <h2 class="text-success fw-bold mb-0">${formatCurrency(localProductData.margen_contribucion_unitario)}</h2>
                                <small class="text-muted text-uppercase fw-bold" style="font-size: 0.7rem;">Margen Contribución Unitario (Prom)</small>
                            </div>
                        </div>
                        
                        <ul class="nav nav-tabs mb-3" id="myTab" role="tablist">
                            <li class="nav-item" role="presentation">
                                <button class="nav-link active" id="evolucion-tab" data-bs-toggle="tab" data-bs-target="#evolucion" type="button" role="tab">Evolución</button>
                            </li>
                            <li class="nav-item" role="presentation">
                                <button class="nav-link" id="pedidos-tab" data-bs-toggle="tab" data-bs-target="#pedidos" type="button" role="tab">Pedidos Relacionados</button>
                            </li>
                        </ul>
                        
                        <div class="tab-content" id="myTabContent">
                            <!-- Pestaña Gráfico -->
                            <div class="tab-pane fade show active" id="evolucion" role="tabpanel">
                                <h6 class="fw-bold mb-3 text-dark mt-3">Evolución de Ventas (Últimos 12 Meses)</h6>
                                <div id="evolucion-chart-container" style="width: 100%; height: 300px;"></div>
                            </div>
                            
                            <!-- Pestaña Tabla Pedidos -->
                            <div class="tab-pane fade" id="pedidos" role="tabpanel">
                                <div class="table-responsive mt-3" style="max-height: 400px; overflow-y: auto;">
                                    <table class="table table-sm table-hover">
                                        <thead>
                                            <tr>
                                                <th>Fecha</th>
                                                <th>Pedido</th>
                                                <th>Cliente</th>
                                                <th class="text-end">Cant.</th>
                                                <th class="text-end">Precio U.</th>
                                                <th class="text-end">Costo U.</th>
                                                <th class="text-end">Ganancia</th>
                                            </tr>
                                        </thead>
                                        <tbody>
                                            ${(result.pedidos_relacionados || []).map(p => `
                                                <tr>
                                                    <td>${p.fecha}</td>
                                                    <td><a href="/orden-venta/${p.id}/detalle" target="_blank" class="text-decoration-none fw-bold">${p.codigo}</a></td>
                                                    <td>${p.cliente}</td>
                                                    <td class="text-end">${p.cantidad}</td>
                                                    <td class="text-end text-primary">${formatCurrency(p.precio_unitario)}</td>
                                                    <td class="text-end text-muted">${formatCurrency(p.costo_unitario)}</td>
                                                    <td class="text-end fw-bold ${p.ganancia > 0 ? 'text-success' : 'text-danger'}">${formatCurrency(p.ganancia)}</td>
                                                </tr>
                                            `).join('') || '<tr><td colspan="7" class="text-center text-muted">No se encontraron pedidos.</td></tr>'}
                                        </tbody>
                                    </table>
                                </div>
                            </div>
                        </div>
                    `;
                }
                
                modalBody.innerHTML = content;
                
                // Inicializar gráfico solo si está activo el tab
                if (detallesResult.success && result && result.historial_ventas && result.historial_ventas.length > 0) {
                    setTimeout(() => {
                        const evolucionChart = echarts.init(document.getElementById('evolucion-chart-container'));
                        const option = {
                            tooltip: { trigger: 'axis' },
                            grid: { left: '5%', right: '5%', bottom: '10%', top: '10%', containLabel: true },
                            xAxis: { type: 'category', data: result.historial_ventas.map(item => item.fecha ? item.fecha.split('T')[0] : '') },
                            yAxis: { type: 'value' },
                            series: [{
                                name: 'Unidades',
                                data: result.historial_ventas.map(item => item.cantidad),
                                type: 'line',
                                smooth: true,
                                areaStyle: { opacity: 0.2, color: '#198754' },
                                lineStyle: { color: '#198754' },
                                itemStyle: { color: '#198754' }
                            }]
                        };
                        evolucionChart.setOption(option);
                        
                        // Fix chart resize on tab switch
                        const tabEl = document.querySelector('button[data-bs-target="#evolucion"]');
                        if(tabEl){
                            tabEl.addEventListener('shown.bs.tab', function (event) {
                                evolucionChart.resize();
                            });
                        }
                    }, 200);
                } 

            }).catch(err => {
                console.error(err);
                modalBody.innerHTML = '<div class="alert alert-danger border-0 rounded-3">Error cargando detalles.</div>';
            });
    }

    // Carga inicial
    loadData(currentFilter);
});
</script>
{% endblock %}
