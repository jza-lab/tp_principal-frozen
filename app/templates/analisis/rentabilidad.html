{% extends "layouts/app_layout.html" %}

{% block app_content %}
<div class="container-fluid">
    <div class="d-flex justify-content-between flex-wrap flex-md-nowrap align-items-center pt-3 pb-2 mb-3 border-bottom">
        <h1 class="h2">Análisis de Rentabilidad de Productos</h1>
    </div>

    <!-- Filtros -->
    <div class="row mb-4">
        <div class="col-md-4">
            <div class="card">
                <div class="card-body">
                    <h5 class="card-title">Filtros de Crecimiento</h5>
                    <div class="mb-3">
                        <label for="periodo" class="form-label">Comparar por:</label>
                        <select id="periodo" class="form-select">
                            <option value="mes" selected>Mes</option>
                            <option value="trimestre">Trimestre</option>
                            <option value="año">Año</option>
                        </select>
                    </div>
                    <div class="mb-3">
                        <label for="metrica" class="form-label">Métrica:</label>
                        <select id="metrica" class="form-select">
                            <option value="facturacion" selected>Facturación</option>
                            <option value="unidades">Unidades</option>
                        </select>
                    </div>
                    <button id="btn-actualizar-crecimiento" class="btn btn-primary">Actualizar</button>
                    <div id="resultado-crecimiento" class="mt-3"></div>
                </div>
            </div>
        </div>
        <div class="col-md-8">
            <div class="card">
                 <div class="card-body">
                    <h5 class="card-title">Leyenda del Gráfico</h5>
                    <ul class="list-unstyled">
                        <li><strong>Eje X:</strong> Volumen de Ventas (unidades)</li>
                        <li><strong>Eje Y:</strong> Margen de Ganancia (%)</li>
                        <li><strong>Tamaño de Burbuja:</strong> Facturación Total ($)</li>
                    </ul>
                    <p class="text-muted">Pase el cursor sobre una burbuja para ver el nombre del producto y haga clic para ver detalles.</p>
                </div>
            </div>
        </div>
    </div>

    <!-- Gráfico de Burbujas -->
    <div class="card">
        <div class="card-header">
            Matriz de Rentabilidad
        </div>
        <div class="card-body">
            <div style="position: relative; height: 400px; width: 100%;">
                <canvas id="rentabilidadChart"></canvas>
            </div>
        </div>
    </div>
</div>

<!-- Modal para Detalles del Producto -->
<div class="modal fade" id="productoModal" tabindex="-1" aria-labelledby="productoModalLabel" aria-hidden="true">
  <div class="modal-dialog modal-lg">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="productoModalLabel">Detalles del Producto</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body" id="modal-body-content">
        Cargando...
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cerrar</button>
      </div>
    </div>
  </div>
</div>
{% endblock %}

{% block extra_js %}
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script>
document.addEventListener('DOMContentLoaded', function () {
    const ctx = document.getElementById('rentabilidadChart').getContext('2d');
    let rentabilidadChart;

    function renderizarGrafico(data) {
        if (rentabilidadChart) {
            rentabilidadChart.destroy();
        }

        const maxFacturacion = Math.max(...data.map(p => p.facturacion_total), 0);
        const maxRadius = 40; // Radio máximo en píxeles para la burbuja más grande

        rentabilidadChart = new Chart(ctx, {
            type: 'bubble',
            data: {
                datasets: data.map(p => ({
                    label: p.nombre,
                    data: [{
                        x: p.volumen_ventas,
                        y: p.margen_ganancia,
                        r: maxFacturacion > 0 ? (Math.sqrt(p.facturacion_total) / Math.sqrt(maxFacturacion)) * maxRadius : 5
                    }],
                    backgroundColor: `rgba(${Math.floor(Math.random() * 255)}, ${Math.floor(Math.random() * 255)}, ${Math.floor(Math.random() * 255)}, 0.6)`
                }))
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                    legend: {
                        display: false // La leyenda por producto es demasiado larga
                    },
                    tooltip: {
                        callbacks: {
                            label: function(context) {
                                let label = context.dataset.label || '';
                                if (label) {
                                    label += ': ';
                                }
                                const dataPoint = context.dataset.data[0];
                                label += `(${dataPoint.x} unidades, ${dataPoint.y}%)`;
                                return label;
                            }
                        }
                    }
                },
                scales: {
                    x: {
                        title: {
                            display: true,
                            text: 'Volumen de Ventas (unidades)'
                        }
                    },
                    y: {
                        title: {
                            display: true,
                            text: 'Margen de Ganancia (%)'
                        }
                    }
                },
                onClick: (event, elements) => {
                    if (elements.length > 0) {
                        const element = elements[0];
                        const dataset = rentabilidadChart.data.datasets[element.datasetIndex];
                        const productoId = data.find(p => p.nombre === dataset.label).id;
                        cargarDetallesProducto(productoId);
                    }
                }
            }
        });
    }

    function cargarDatosGrafico() {
        fetch('/analisis/api/rentabilidad/datos')
            .then(response => response.json())
            .then(result => {
                if (result.success) {
                    renderizarGrafico(result.data);
                } else {
                    console.error('Error al cargar datos del gráfico:', result.error);
                }
            });
    }

    function cargarDetallesProducto(productoId) {
        const modalBody = document.getElementById('modal-body-content');
        modalBody.innerHTML = 'Cargando...';
        const productoModal = new bootstrap.Modal(document.getElementById('productoModal'));
        productoModal.show();

        fetch(`/analisis/api/rentabilidad/producto/${productoId}`)
            .then(response => response.json())
            .then(result => {
                if (result.success) {
                    const detalles = result.data;
                    let content = `<h4>${detalles.nombre_producto || 'Producto'}</h4>`;
                    
                    content += '<h5>Clientes Principales</h5>';
                    if(detalles.clientes_principales.length > 0) {
                        content += '<ul class="list-group mb-3">';
                        detalles.clientes_principales.forEach(c => {
                            content += `<li class="list-group-item d-flex justify-content-between align-items-center">${c[0]} <span class="badge bg-primary rounded-pill">$${c[1].facturacion.toFixed(2)}</span></li>`;
                        });
                        content += '</ul>';
                    } else {
                        content += '<p>No hay datos de clientes.</p>';
                    }

                    content += '<h5>Historial de Precios (inferido de ventas)</h5>';
                    if(detalles.historial_precios.length > 0) {
                        content += '<ul class="list-group mb-3">';
                        detalles.historial_precios.forEach(h => {
                             content += `<li class="list-group-item">${h[0]}: $${h[1]}</li>`;
                        });
                        content += '</ul>';
                    } else {
                        content += '<p>No hay historial de precios.</p>';
                    }
                    
                    modalBody.innerHTML = content;
                } else {
                    modalBody.innerHTML = 'Error al cargar los detalles.';
                }
            });
    }

    function actualizarCrecimiento() {
        const periodo = document.getElementById('periodo').value;
        const metrica = document.getElementById('metrica').value;
        const resultadoDiv = document.getElementById('resultado-crecimiento');
        resultadoDiv.innerHTML = 'Calculando...';

        fetch(`/analisis/api/rentabilidad/crecimiento?periodo=${periodo}&metrica=${metrica}`)
            .then(response => response.json())
            .then(result => {
                if (result.success) {
                    const data = result.data;
                    const color = data.crecimiento >= 0 ? 'success' : 'danger';
                    resultadoDiv.innerHTML = `<div class="alert alert-${color}">Crecimiento: <strong>${data.crecimiento}%</strong> (Actual: ${data.periodo_actual} vs Anterior: ${data.periodo_anterior})</div>`;
                } else {
                    resultadoDiv.innerHTML = '<div class="alert alert-danger">Error al calcular.</div>';
                }
            });
    }

    document.getElementById('btn-actualizar-crecimiento').addEventListener('click', actualizarCrecimiento);

    // Carga inicial
    cargarDatosGrafico();
    actualizarCrecimiento();
});
</script>
{% endblock %}
