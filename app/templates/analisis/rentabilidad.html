{% extends "layouts/app_layout.html" %}

{% block app_content %}
<div class="container-fluid">
    <div class="d-flex justify-content-between flex-wrap flex-md-nowrap align-items-center pt-3 pb-2 mb-3 border-bottom">
        <h1 class="h2">Análisis de Rentabilidad de Productos</h1>
    </div>

    <!-- Filtros -->
    <div class="row mb-4">
        <div class="col-md-4">
            <div class="card">
                <div class="card-body">
                    <h5 class="card-title">Filtros de Crecimiento</h5>
                    <div class="mb-3">
                        <label for="periodo" class="form-label">Comparar por:</label>
                        <select id="periodo" class="form-select">
                            <option value="mes" selected>Mes</option>
                            <option value="trimestre">Trimestre</option>
                            <option value="año">Año</option>
                        </select>
                    </div>
                    <button id="btn-actualizar-crecimiento" class="btn btn-primary">Actualizar</button>
                    <div id="resultado-crecimiento" class="mt-3"></div>
                </div>
            </div>
        </div>
        <div class="col-md-8">
            <div class="card">
                <div class="card-body">
                    <h5 class="card-title">Matriz de Rentabilidad y Ventas</h5>
                    <div class="row">
                        <div class="col-6">
                            <p><span style="height: 15px; width: 15px; background-color: rgba(75, 192, 192, 0.7); border-radius: 50%; display: inline-block;"></span> <strong>Estrellas:</strong> Alto margen, altas ventas.</p>
                            <p><span style="height: 15px; width: 15px; background-color: rgba(255, 206, 86, 0.7); border-radius: 50%; display: inline-block;"></span> <strong>Interrogantes:</strong> Alto margen, bajas ventas.</p>
                        </div>
                        <div class="col-6">
                            <p><span style="height: 15px; width: 15px; background-color: rgba(54, 162, 235, 0.7); border-radius: 50%; display: inline-block;"></span> <strong>Vacas Lecheras:</strong> Bajo margen, altas ventas.</p>
                            <p><span style="height: 15px; width: 15px; background-color: rgba(255, 99, 132, 0.7); border-radius: 50%; display: inline-block;"></span> <strong>Perros:</strong> Bajo margen, bajas ventas.</p>
                        </div>
                    </div>
                    <p class="text-muted small mt-2">Las líneas discontinuas representan el promedio de ventas y rentabilidad de todos los productos.</p>
                </div>
            </div>
        </div>
    </div>

    <!-- Gráfico de Burbujas -->
    <div class="card">
        <div class="card-header">
            Matriz de Rentabilidad
        </div>
        <div class="card-body">
            <div style="position: relative; height: 400px; width: 100%;">
                <canvas id="rentabilidadChart"></canvas>
            </div>
        </div>
    </div>

    <!-- Tabla de Datos Detallada -->
    <div class="card mt-4">
        <div class="card-header">
            Análisis Detallado de Productos
        </div>
        <div class="card-body">
            <div class="table-responsive">
                <table class="table table-striped table-hover" id="tabla-rentabilidad">
                    <thead>
                        <tr>
                            <th scope="col" data-sort="nombre" style="cursor: pointer;">Producto ⇅</th>
                            <th scope="col" data-sort="volumen_ventas" style="cursor: pointer;">Volumen Ventas ⇅</th>
                            <th scope="col" data-sort="facturacion_total" style="cursor: pointer;">Facturación Total ⇅</th>
                            <th scope="col" data-sort="costo_total" style="cursor: pointer;">Costo Total ⇅</th>
                            <th scope="col" data-sort="ganancia_bruta" style="cursor: pointer;">Ganancia Bruta ⇅</th>
                            <th scope="col" data-sort="margen_ganancia" style="cursor: pointer;">Margen (%) ⇅</th>
                        </tr>
                    </thead>
                    <tbody id="tabla-rentabilidad-body">
                        <!-- Las filas se insertarán aquí dinámicamente -->
                    </tbody>
                </table>
            </div>
        </div>
    </div>
</div>

<!-- Modal para Detalles del Producto -->
<div class="modal fade" id="productoModal" tabindex="-1" aria-labelledby="productoModalLabel" aria-hidden="true">
  <div class="modal-dialog modal-lg">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="productoModalLabel">Detalles del Producto</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body" id="modal-body-content">
        Cargando...
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cerrar</button>
      </div>
    </div>
  </div>
</div>
{% endblock %}

{% block extra_js %}
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-annotation@1.4.0"></script>
<script>
document.addEventListener('DOMContentLoaded', function () {
    const ctx = document.getElementById('rentabilidadChart').getContext('2d');
    let rentabilidadChart;
    let datosRentabilidad = []; // Almacenar los datos globalmente para re-ordenar
    let sortConfig = { key: 'ganancia_bruta', direction: 'desc' };

    // --- Funciones de formato y color ---
    const formatCurrency = (value) => `$${(value || 0).toFixed(2).replace(/\d(?=(\d{3})+\.)/g, '$&,')}`;
    
    function getQuadrantColor(producto, promedios) {
        const { volumen_ventas, margen_ganancia } = producto;
        if (volumen_ventas >= promedios.volumen_ventas && margen_ganancia >= promedios.margen_ganancia) {
            return 'rgba(75, 192, 192, 0.7)'; // Estrellas (verde-azulado)
        } else if (volumen_ventas >= promedios.volumen_ventas && margen_ganancia < promedios.margen_ganancia) {
            return 'rgba(54, 162, 235, 0.7)'; // Vacas Lecheras (azul)
        } else if (volumen_ventas < promedios.volumen_ventas && margen_ganancia >= promedios.margen_ganancia) {
            return 'rgba(255, 206, 86, 0.7)'; // Interrogantes (amarillo)
        } else {
            return 'rgba(255, 99, 132, 0.7)'; // Perros (rojo)
        }
    }

    // --- Lógica de la Tabla ---
    function renderizarTabla() {
        const tbody = document.getElementById('tabla-rentabilidad-body');
        tbody.innerHTML = ''; // Limpiar tabla

        // Ordenar los datos
        datosRentabilidad.sort((a, b) => {
            let valA = a[sortConfig.key];
            let valB = b[sortConfig.key];
            if (typeof valA === 'string') {
                valA = valA.toLowerCase();
                valB = valB.toLowerCase();
            }
            if (valA < valB) return sortConfig.direction === 'asc' ? -1 : 1;
            if (valA > valB) return sortConfig.direction === 'asc' ? 1 : -1;
            return 0;
        });

        datosRentabilidad.forEach(p => {
            const row = document.createElement('tr');
            row.innerHTML = `
                <td>${p.nombre}</td>
                <td>${p.volumen_ventas}</td>
                <td>${formatCurrency(p.facturacion_total)}</td>
                <td>${formatCurrency(p.costo_total)}</td>
                <td>${formatCurrency(p.ganancia_bruta)}</td>
                <td>${p.margen_ganancia}%</td>
            `;
            tbody.appendChild(row);
        });
    }

    document.querySelectorAll('#tabla-rentabilidad th').forEach(header => {
        header.addEventListener('click', () => {
            const sortKey = header.getAttribute('data-sort');
            if (sortConfig.key === sortKey) {
                sortConfig.direction = sortConfig.direction === 'asc' ? 'desc' : 'asc';
            } else {
                sortConfig.key = sortKey;
                sortConfig.direction = 'desc'; // Default a desc para nuevas columnas
            }
            renderizarTabla();
        });
    });

    // --- Lógica del Gráfico ---
    function renderizarGrafico(responseData) {
        if (rentabilidadChart) {
            rentabilidadChart.destroy();
        }
        
        const data = responseData.productos;
        const promedios = responseData.promedios;
        
        const maxFacturacion = Math.max(...data.map(p => p.facturacion_total), 0);
        const maxRadius = 40;
        const minRadius = 8; // Radio mínimo para garantizar visibilidad

        rentabilidadChart = new Chart(ctx, {
            type: 'bubble',
            data: {
                datasets: data.map(p => ({
                    label: p.nombre,
                    data: [{
                        x: p.volumen_ventas,
                        y: p.margen_ganancia,
                        // Nueva fórmula: escala el radio entre minRadius y maxRadius
                        r: maxFacturacion > 0 ? ((Math.sqrt(p.facturacion_total) / Math.sqrt(maxFacturacion)) * (maxRadius - minRadius)) + minRadius : minRadius
                    }],
                    backgroundColor: getQuadrantColor(p, promedios)
                }))
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                    legend: { display: false },
                    tooltip: {
                         callbacks: {
                            label: function(context) {
                                const producto = data.find(p => p.nombre === context.dataset.label);
                                if (!producto) return '';
                                let label = producto.nombre || '';
                                if (label) label += ': ';
                                label += `(${producto.volumen_ventas} unid., ${producto.margen_ganancia}%)`;
                                return label;
                            }
                        }
                    },
                    annotation: {
                        annotations: {
                            lineaVentas: {
                                type: 'line',
                                xMin: promedios.volumen_ventas,
                                xMax: promedios.volumen_ventas,
                                borderColor: 'rgba(255, 99, 132, 0.8)',
                                borderWidth: 2,
                                borderDash: [6, 6]
                            },
                            lineaMargen: {
                                type: 'line',
                                yMin: promedios.margen_ganancia,
                                yMax: promedios.margen_ganancia,
                                borderColor: 'rgba(255, 99, 132, 0.8)',
                                borderWidth: 2,
                                borderDash: [6, 6]
                            },
                            // Etiquetas de Cuadrantes
                            estrellas: {
                                type: 'label',
                                xValue: promedios.volumen_ventas * 1.5,
                                yValue: promedios.margen_ganancia * 1.5,
                                content: 'Estrellas',
                                font: { size: 18, weight: 'bold' },
                                color: 'rgba(0,0,0,0.15)'
                            },
                             vacas: {
                                type: 'label',
                                xValue: promedios.volumen_ventas * 1.5,
                                yValue: promedios.margen_ganancia * 0.5,
                                content: 'Vacas Lecheras',
                                font: { size: 18, weight: 'bold' },
                                color: 'rgba(0,0,0,0.15)'
                            },
                            interrogantes: {
                                type: 'label',
                                xValue: promedios.volumen_ventas * 0.5,
                                yValue: promedios.margen_ganancia * 1.5,
                                content: 'Interrogantes',
                                font: { size: 18, weight: 'bold' },
                                color: 'rgba(0,0,0,0.15)'
                            },
                            perros: {
                                type: 'label',
                                xValue: promedios.volumen_ventas * 0.5,
                                yValue: promedios.margen_ganancia * 0.5,
                                content: 'Perros',
                                font: { size: 18, weight: 'bold' },
                                color: 'rgba(0,0,0,0.15)'
                            }
                        }
                    }
                },
                scales: {
                    x: { 
                        type: 'logarithmic',
                        title: { display: true, text: 'Volumen de Ventas (unidades) - Escala Logarítmica' } 
                    },
                    y: { 
                        title: { display: true, text: 'Margen de Ganancia (%)' } 
                    }
                },
                onClick: (event, elements) => {
                    if (elements.length > 0) {
                        const element = elements[0];
                        const dataset = rentabilidadChart.data.datasets[element.datasetIndex];
                        const producto = data.find(p => p.nombre === dataset.label);
                        if (producto) {
                           cargarDetallesProducto(producto.id);
                        }
                    }
                }
            }
        });
    }

    function cargarDatos() {
        fetch('/analisis/api/rentabilidad/datos')
            .then(response => response.json())
            .then(result => {
                if (result.success) {
                    datosRentabilidad = result.data.productos; // Guardar solo la lista de productos para la tabla
                    renderizarGrafico(result.data); // Pasar el objeto completo al gráfico
                    renderizarTabla();
                } else {
                    console.error('Error al cargar datos:', result.error);
                }
            });
    }

    function cargarDetallesProducto(productoId) {
        const modalBody = document.getElementById('modal-body-content');
        modalBody.innerHTML = 'Cargando...';
        const productoModal = new bootstrap.Modal(document.getElementById('productoModal'));
        productoModal.show();

        fetch(`/analisis/api/rentabilidad/producto/${productoId}`)
            .then(response => response.json())
            .then(result => {
                if (result.success) {
                    const detalles = result.data;
                    let content = `<h4>${detalles.nombre_producto || 'Producto'}</h4>`;

                    // --- Nueva Sección de Desglose de Costos ---
                    if (detalles.costos) {
                        content += `
                            <div class="card bg-light mb-3">
                                <div class="card-body">
                                    <h5 class="card-title mb-3">Desglose de Costo Unitario</h5>
                                    <div class="d-flex justify-content-around text-center">
                                        <div>
                                            <p class="mb-0 text-muted">Materia Prima</p>
                                            <p class="h5">${formatCurrency(detalles.costos.costo_materia_prima)}</p>
                                        </div>
                                        <div>
                                            <p class="mb-0 text-muted">Mano de Obra</p>
                                            <p class="h5">${formatCurrency(detalles.costos.costo_mano_obra)}</p>
                                        </div>
                                        <div>
                                            <p class="mb-0 text-muted">Costo Total</p>
                                            <p class="h5"><strong>${formatCurrency(detalles.costos.costo_total)}</strong></p>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        `;
                    }
                    
                    content += '<h5>Clientes Principales</h5>';
                    if(detalles.clientes_principales.length > 0) {
                        content += '<ul class="list-group mb-3">';
                        detalles.clientes_principales.forEach(c => {
                            content += `<li class="list-group-item d-flex justify-content-between align-items-center">${c[0]} <span class="badge bg-primary rounded-pill">${formatCurrency(c[1].facturacion)}</span></li>`;
                        });
                        content += '</ul>';
                    } else {
                        content += '<p>No hay datos de clientes.</p>';
                    }

                    content += '<h5>Historial de Precios (inferido de ventas)</h5>';
                    if(detalles.historial_precios.length > 0) {
                        content += '<ul class="list-group mb-3">';
                        detalles.historial_precios.forEach(h => {
                             content += `<li class="list-group-item">${h[0]}: $${h[1]}</li>`;
                        });
                        content += '</ul>';
                    } else {
                        content += '<p>No hay historial de precios.</p>';
                    }
                    
                    modalBody.innerHTML = content;
                } else {
                    modalBody.innerHTML = 'Error al cargar los detalles.';
                }
            });
    }

    function actualizarCrecimiento() {
        const periodo = document.getElementById('periodo').value;
        const resultadoDiv = document.getElementById('resultado-crecimiento');
        resultadoDiv.innerHTML = 'Calculando...';

        // El parámetro 'metrica' se ha eliminado del frontend. El backend usará el valor por defecto.
        fetch(`/analisis/api/rentabilidad/crecimiento?periodo=${periodo}`)
            .then(response => response.json())
            .then(result => {
                if (result.success) {
                    const data = result.data;
                    const color = data.crecimiento >= 0 ? 'success' : 'danger';
                    resultadoDiv.innerHTML = `<div class="alert alert-${color}">Crecimiento: <strong>${data.crecimiento}%</strong> (Actual: ${data.periodo_actual} vs Anterior: ${data.periodo_anterior})</div>`;
                } else {
                    resultadoDiv.innerHTML = '<div class="alert alert-danger">Error al calcular.</div>';
                }
            });
    }

    document.getElementById('btn-actualizar-crecimiento').addEventListener('click', actualizarCrecimiento);

    // Carga inicial
    cargarDatos();
    actualizarCrecimiento();
});
</script>
{% endblock %}
