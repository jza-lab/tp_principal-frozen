{% extends "layouts/app_layout.html" %}

{% block app_content %}
<div class="container-fluid">
    <!-- Fila del Título y Filtros -->
    <div class="d-flex justify-content-between flex-wrap flex-md-nowrap align-items-center pt-3 pb-2 mb-3 border-bottom">
        <h1 class="h2">Dashboard de Rentabilidad Global</h1>
        <!-- Toolbar de Filtros (Arriba a la derecha) -->
        <div class="btn-toolbar mb-2 mb-md-0">
            <div id="filter-buttons" class="btn-group me-2" role="group" aria-label="Filtros de fecha">
                <button type="button" class="btn btn-outline-primary active" data-period="30">Mes</button>
                <button type="button" class="btn btn-outline-primary" data-period="90">Trimestre</button>
                <button type="button" class="btn btn-outline-primary" data-period="365">Anual</button>
            </div>
        </div>
    </div>

    <!-- Fila de KPIs Globales -->
    <div class="row align-items-center mb-4">
        <div class="col-md-12">
            <div class="row g-2">
                <!-- KPI: Facturación Total -->
                <div class="col-md-2">
                    <div class="card text-center h-100 border-start border-primary border-4 shadow-sm">
                        <div class="card-body p-2">
                            <h6 class="card-subtitle mb-1 text-muted" style="font-size: 0.8rem;">Facturación Total</h6>
                            <p class="card-text fw-bold text-primary" style="font-size: 1.1rem;" id="global-facturacion">$0</p>
                        </div>
                    </div>
                </div>
                <!-- KPI: Costos Variables -->
                <div class="col-md-2">
                    <div class="card text-center h-100 border-start border-warning border-4 shadow-sm">
                        <div class="card-body p-2">
                            <h6 class="card-subtitle mb-1 text-muted" style="font-size: 0.8rem;">Costos Variables</h6>
                            <p class="card-text fw-bold text-warning" style="font-size: 1.1rem;" id="global-costo-variable">$0</p>
                        </div>
                    </div>
                </div>
                <!-- KPI: Margen Contribución -->
                <div class="col-md-2">
                    <div class="card text-center h-100 border-start border-info border-4 shadow-sm">
                        <div class="card-body p-2">
                            <h6 class="card-subtitle mb-1 text-muted" style="font-size: 0.8rem;">Margen Contribución Global</h6>
                            <p class="card-text fw-bold text-info" style="font-size: 1.2rem;" id="global-margen-contribucion">$0</p>
                        </div>
                    </div>
                </div>
                <!-- KPI: Costos Fijos -->
                <div class="col-md-2">
                    <div class="card text-center h-100 border-start border-danger border-4 shadow-sm">
                        <div class="card-body p-2">
                            <h6 class="card-subtitle mb-1 text-muted" style="font-size: 0.8rem;">Costos Fijos Totales</h6>
                            <p class="card-text fw-bold text-danger" style="font-size: 1.1rem;" id="global-costos-fijos">$0</p>
                        </div>
                    </div>
                </div>
                <!-- KPI: Gastos de Envío -->
                <div class="col-md-2">
                    <div class="card text-center h-100 border-start border-secondary border-4 shadow-sm">
                        <div class="card-body p-2">
                            <h6 class="card-subtitle mb-1 text-muted" style="font-size: 0.8rem;">Gastos de Envío</h6>
                            <p class="card-text fw-bold text-secondary" style="font-size: 1.1rem;" id="global-costos-envio">$0</p>
                        </div>
                    </div>
                </div>
                <!-- KPI: Rentabilidad Neta -->
                <div class="col-md-2">
                    <div class="card text-center h-100 border-start border-success border-4 shadow-sm bg-light">
                        <div class="card-body p-2">
                            <h6 class="card-subtitle mb-1 text-muted" style="font-size: 0.8rem;">Rentabilidad Neta</h6>
                            <p class="card-text fw-bold text-success display-6" style="font-size: 1.4rem;" id="global-rentabilidad-neta">$0</p>
                            <small id="global-rentabilidad-porcentaje" class="text-success fw-bold">0%</small>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Fila de Gráficos Principales -->
    <div class="row">
        <!-- Gráfico de Burbujas (Matriz BCG - Margen Contribución) -->
        <div class="col-lg-7 mb-4">
            <div class="card h-100 shadow-sm">
                <div class="card-header d-flex justify-content-between align-items-center bg-white">
                    <span class="fw-bold">Matriz de Contribución (Ventas vs Margen Unitario)</span>
                    <span class="info-tooltip text-muted" data-bs-toggle="tooltip" data-bs-placement="top" 
                          title="Clasificación de productos según su Margen de Contribución Unitario y Volumen de Ventas.">
                        <i class="bi bi-info-circle"></i>
                    </span>
                </div>
                <div class="card-body">
                    <div id="rentabilidad-chart-container" style="width: 100%; height: 450px;"></div>
                    <div id="dynamic-chart-description" class="alert alert-light mt-3 border" role="alert">
                        Calculando análisis...
                    </div>
                </div>
            </div>
        </div>
        <!-- Leyenda y Gráficos Secundarios -->
        <div class="col-lg-5 mb-4">
             <!-- Leyenda Descriptiva -->
             <div class="card mb-4 shadow-sm">
                 <div class="card-body">
                    <div class="row">
                        <div class="col-6 mb-3">
                            <div class="d-flex align-items-start"><span style="color:#4CAF50; font-size: 1.5rem; margin-right: 8px;">●</span><div><strong>Estrellas</strong><br><small class="text-muted d-block">Alto margen, altas ventas.</small><small class="text-primary d-block fw-bold" style="font-size: 0.75rem;">(> Prom. Ventas, > Prom. Margen)</small></div></div>
                        </div>
                        <div class="col-6 mb-3">
                            <div class="d-flex align-items-start"><span style="color:#FFC107; font-size: 1.5rem; margin-right: 8px;">●</span><div><strong>Interrogantes</strong><br><small class="text-muted d-block">Alto margen, bajas ventas.</small><small class="text-primary d-block fw-bold" style="font-size: 0.75rem;">(< Prom. Ventas, > Prom. Margen)</small></div></div>
                        </div>
                        <div class="col-6">
                            <div class="d-flex align-items-start"><span style="color:#2196F3; font-size: 1.5rem; margin-right: 8px;">●</span><div><strong>Vacas</strong><br><small class="text-muted d-block">Bajo margen, altas ventas.</small><small class="text-primary d-block fw-bold" style="font-size: 0.75rem;">(> Prom. Ventas, < Prom. Margen)</small></div></div>
                        </div>
                        <div class="col-6">
                             <div class="d-flex align-items-start"><span style="color:#F44336; font-size: 1.5rem; margin-right: 8px;">●</span><div><strong>Perros</strong><br><small class="text-muted d-block">Bajo margen, bajas ventas.</small><small class="text-primary d-block fw-bold" style="font-size: 0.75rem;">(< Prom. Ventas, < Prom. Margen)</small></div></div>
                        </div>
                    </div>
                </div>
            </div>
            <div class="card mb-4 shadow-sm">
                <div class="card-header bg-white fw-bold">Top 5: Mayor Margen de Contribución Total</div>
                <div class="card-body">
                    <div id="top-rentables-chart-container" style="width: 100%; height: 220px;"></div>
                </div>
            </div>
             <div class="card shadow-sm">
                <div class="card-header bg-white fw-bold">Desglose Costos Variables (Top 5)</div>
                <div class="card-body">
                    <div id="costos-chart-container" style="width: 100%; height: 250px;"></div>
                </div>
            </div>
        </div>
    </div>

    <!-- Tabla de Datos Detallada -->
    <div class="card mt-4 shadow-sm">
        <div class="card-header d-flex justify-content-between align-items-center bg-white">
            <span class="fw-bold">Análisis Detallado por Producto</span>
            <input type="text" id="searchInput" class="form-control w-25" placeholder="Buscar producto...">
        </div>
        <div class="card-body">
            <div class="table-responsive">
                <table class="table table-hover align-middle" id="tabla-rentabilidad">
                    <thead class="table-light">
                        <tr>
                            <th scope="col" style="width: 5%;"></th>
                            <th scope="col" data-sort="nombre" style="cursor: pointer;">Producto ⇅</th>
                            <th scope="col" data-sort="volumen_ventas" class="text-end" style="cursor: pointer;">Vol. Ventas ⇅</th>
                            <th scope="col" data-sort="costo_variable_total" class="text-end" style="cursor: pointer;">Gasto Total (Var.) ⇅</th>
                            <th scope="col" data-sort="facturacion_total" class="text-end" style="cursor: pointer;">Lo que se ganó (Ingresos) ⇅</th>
                            <th scope="col" data-sort="margen_contribucion_total" class="text-end" style="cursor: pointer;">Ganancia Bruta Total ⇅</th>
                            <th scope="col" data-sort="margen_porcentual" class="text-end" style="cursor: pointer;">Margen % ⇅</th>
                            <th scope="col">Clasificación</th>
                        </tr>
                    </thead>
                    <tbody id="tabla-rentabilidad-body">
                        <!-- Las filas se insertarán aquí dinámicamente -->
                    </tbody>
                </table>
            </div>
        </div>
    </div>
</div>

<!-- Modal para Detalles del Producto -->
<div class="modal fade" id="productoModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Detalles del Producto</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body" id="modal-body-content">
                <!-- Dinámico -->
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<!-- ECharts CDN -->
<script src="https://cdn.jsdelivr.net/npm/echarts@5.4.3/dist/echarts.min.js"></script>

<script>
document.addEventListener('DOMContentLoaded', function () {
    // Inicializar tooltips de Bootstrap
    var tooltipTriggerList = [].slice.call(document.querySelectorAll('[data-bs-toggle="tooltip"]'))
    var tooltipList = tooltipTriggerList.map(function (tooltipTriggerEl) {
        return new bootstrap.Tooltip(tooltipTriggerEl)
    })

    // Instancias de ECharts
    const bubbleChartInstance = echarts.init(document.getElementById('rentabilidad-chart-container'));
    const topRentablesChartInstance = echarts.init(document.getElementById('top-rentables-chart-container'));
    const costosChartInstance = echarts.init(document.getElementById('costos-chart-container'));

    // Estado de la aplicación
    let fullData = { productos: [], totales_globales: {}, promedios: {} };
    let sortConfig = { key: 'margen_contribucion_total', direction: 'desc' };
    let currentFilter = '30'; // Default a Mes (30 días)

    // --- UTILS ---
    const formatCurrency = (value) => `$${(value || 0).toLocaleString('es-AR', {minimumFractionDigits: 2, maximumFractionDigits: 2})}`;
    const getQuadrantInfo = (producto, promedios) => {
        const { volumen_ventas, margen_porcentual } = producto;
        const avgVentas = promedios.volumen_ventas || 0;
        const avgMargen = promedios.margen_ganancia || 0;

        if (volumen_ventas >= avgVentas && margen_porcentual >= avgMargen) {
            return { name: 'Estrella', color: '#4CAF50' };
        } else if (volumen_ventas >= avgVentas && margen_porcentual < avgMargen) {
            return { name: 'Vaca', color: '#2196F3' };
        } else if (volumen_ventas < avgVentas && margen_porcentual >= avgMargen) {
            return { name: 'Interrogante', color: '#FFC107' };
        } else {
            return { name: 'Perro', color: '#F44336' };
        }
    };

    // --- LÓGICA DE CARGA DE DATOS ---
    function loadData(period = '30') {
        let url = '/analisis/api/rentabilidad/datos';
        if (period !== 'all') {
            const endDate = new Date();
            const startDate = new Date();
            startDate.setDate(endDate.getDate() - parseInt(period, 10));
            const formatDate = (date) => date.toISOString().split('T')[0];
            url += `?fecha_inicio=${formatDate(startDate)}&fecha_fin=${formatDate(endDate)}`;
        }

        bubbleChartInstance.showLoading();
        fetch(url)
            .then(response => response.json())
            .then(result => {
                if (result.success) {
                    fullData = result.data;
                    updateDashboard();
                } else {
                    console.error('Error al cargar datos:', result.error);
                }
            }).finally(() => {
                bubbleChartInstance.hideLoading();
            });
    }

    // --- LÓGICA DE RENDERIZADO ---
    function updateDashboard(filteredProducts = null) {
        const productsToRender = filteredProducts || fullData.productos;
        
        // Actualizar KPIs Globales
        const g = fullData.totales_globales;
        if (g) {
            document.getElementById('global-facturacion').textContent = formatCurrency(g.facturacion_total);
            document.getElementById('global-costo-variable').textContent = formatCurrency(g.costo_variable_total);
            document.getElementById('global-margen-contribucion').textContent = formatCurrency(g.margen_contribucion_total);
            document.getElementById('global-costos-fijos').textContent = formatCurrency(g.costos_fijos_total);
            document.getElementById('global-costos-envio').textContent = formatCurrency(g.costos_envio_total);
            document.getElementById('global-rentabilidad-neta').textContent = formatCurrency(g.rentabilidad_neta);
            
            const rentElem = document.getElementById('global-rentabilidad-porcentaje');
            rentElem.textContent = `${g.rentabilidad_porcentual}%`;
            rentElem.className = g.rentabilidad_porcentual >= 0 ? 'text-success fw-bold' : 'text-danger fw-bold';
        }

        renderBubbleChart(productsToRender, fullData.promedios);
        renderTopCharts(fullData.productos);
        renderCostosChart(fullData.productos);
        renderTable(productsToRender);
        updateDynamicDescription(productsToRender, fullData.promedios);
    }
    
    function renderBubbleChart(data, promedios) {
        const filteredData = data.filter(p => p.volumen_ventas > 0);
        
        if (filteredData.length === 0) {
            bubbleChartInstance.clear();
            bubbleChartInstance.setOption({
                title: { text: 'No hay datos de ventas en este período.', left: 'center', top: 'center' }
            });
            return;
        }

        const maxVenta = Math.max(...filteredData.map(p => p.volumen_ventas), 0);
        const minRadius = 10, maxRadius = 60;
        
        const seriesData = filteredData.map(p => {
            const quadrant = getQuadrantInfo(p, promedios);
            // Eje X: Ventas, Eje Y: Margen Unitario %
            return {
                name: p.nombre,
                value: [p.volumen_ventas, p.margen_porcentual, p.margen_contribucion_total, p.id],
                itemStyle: { color: quadrant.color },
                symbolSize: maxVenta > 0 ? ((p.volumen_ventas / maxVenta) * (maxRadius - minRadius)) + minRadius : minRadius,
            };
        });

        const option = {
            tooltip: {
                trigger: 'item',
                formatter: (params) => {
                    return `<b>${params.name}</b><br/>Ventas: ${params.value[0]} u.<br/>Margen Unit: ${params.value[1]}%<br/>Contrib. Total: ${formatCurrency(params.value[2])}`;
                }
            },
            xAxis: { name: 'Volumen de Ventas', splitLine: { show: false } },
            yAxis: { name: 'Margen Contribución (%)', splitLine: { show: true } },
            series: [{
                type: 'scatter', data: seriesData, z: 2,
                markLine: {
                    z: 1, silent: false, symbol: 'none', lineStyle: { type: 'dashed' },
                    data: [
                        { xAxis: promedios.volumen_ventas, name: `Prom. Ventas: ${promedios.volumen_ventas.toFixed(0)}` },
                        { yAxis: promedios.margen_ganancia, name: `Prom. Margen: ${promedios.margen_ganancia.toFixed(1)}%` }
                    ]
                },
                markArea: {
                    silent: true, itemStyle: { opacity: 0.05 },
                    data: [
                         [
                            { name: 'Estrellas', xAxis: promedios.volumen_ventas, yAxis: promedios.margen_ganancia }, 
                            { xAxis: 'max', yAxis: 'max' }
                        ],
                        [
                            { name: 'Vacas', xAxis: promedios.volumen_ventas, yAxis: promedios.margen_ganancia }, 
                            { xAxis: 'max', yAxis: 'min' }
                        ],
                        [
                            { name: 'Interrogantes', xAxis: promedios.volumen_ventas, yAxis: promedios.margen_ganancia }, 
                            { xAxis: 'min', yAxis: 'max' }
                        ],
                        [
                            { name: 'Perros', xAxis: promedios.volumen_ventas, yAxis: promedios.margen_ganancia }, 
                            { xAxis: 'min', yAxis: 'min' }
                        ]
                    ]
                }
            }]
        };
        bubbleChartInstance.setOption(option);
    }

    function renderTopCharts(data) {
        // Top 5 por Margen de Contribución Total Absoluto
        const sortedByContrib = [...data].sort((a, b) => b.margen_contribucion_total - a.margen_contribucion_total).slice(0, 5);

        const rentablesOption = {
            tooltip: { trigger: 'axis' },
            xAxis: { type: 'value' },
            yAxis: { type: 'category', data: sortedByContrib.map(p => p.nombre).reverse(), axisLabel: { interval: 0, rotate: 0, fontSize: 10 } },
            series: [{ 
                type: 'bar', 
                data: sortedByContrib.map(p => p.margen_contribucion_total).reverse(),
                itemStyle: { color: '#2196F3' }
            }],
            grid: { left: '30%', right: '5%', bottom: '10%' }
        };

        topRentablesChartInstance.setOption(rentablesOption);
    }

    function renderCostosChart(data) {
        // Usamos los mismos Top 5 por contribución para mostrar sus costos
        const sortedByContrib = [...data].sort((a, b) => b.margen_contribucion_total - a.margen_contribucion_total).slice(0, 5);

        const option = {
            tooltip: { trigger: 'axis', axisPointer: { type: 'shadow' } },
            legend: { data: ['Materia Prima', 'Mano de Obra'] },
            grid: { left: '3%', right: '4%', bottom: '3%', containLabel: true },
            xAxis: { type: 'value' },
            yAxis: {
                type: 'category',
                data: sortedByContrib.map(p => p.nombre).reverse(),
                axisLabel: { interval: 0, rotate: 0, fontSize: 10 }
            },
            series: [
                {
                    name: 'Materia Prima',
                    type: 'bar',
                    stack: 'total',
                    label: { show: true, formatter: (p) => `$${Math.round(p.value)}` },
                    data: sortedByContrib.map(p => p.detalles_costo.costo_materia_prima).reverse()
                },
                {
                    name: 'Mano de Obra',
                    type: 'bar',
                    stack: 'total',
                    label: { show: true, formatter: (p) => `$${Math.round(p.value)}` },
                    data: sortedByContrib.map(p => p.detalles_costo.costo_mano_obra).reverse()
                }
            ]
        };
        costosChartInstance.setOption(option);
    }
    
    function renderTable(data) {
        const tbody = document.getElementById('tabla-rentabilidad-body');
        tbody.innerHTML = '';

        data.sort((a, b) => {
            let valA = a[sortConfig.key];
            let valB = b[sortConfig.key];
            if (typeof valA === 'string') {
                valA = valA.toLowerCase();
                valB = valB.toLowerCase();
            }
            if (valA < valB) return sortConfig.direction === 'asc' ? -1 : 1;
            if (valA > valB) return sortConfig.direction === 'asc' ? 1 : -1;
            return 0;
        });

        data.forEach(p => {
            const quadrant = getQuadrantInfo(p, fullData.promedios);
            const row = document.createElement('tr');
            row.innerHTML = `
                <td><button class="btn btn-sm btn-outline-secondary btn-detail" data-id="${p.id}"><i class="bi bi-eye"></i></button></td>
                <td class="fw-bold">${p.nombre}</td>
                <td class="text-end">${p.volumen_ventas}</td>
                <td class="text-end text-danger">${formatCurrency(p.costo_variable_total)}</td>
                <td class="text-end text-primary">${formatCurrency(p.facturacion_total)}</td>
                <td class="text-end fw-bold text-success">${formatCurrency(p.margen_contribucion_total)}</td>
                <td class="text-end fw-bold ${p.margen_porcentual < 20 ? 'text-danger' : 'text-success'}">${p.margen_porcentual}%</td>
                <td><span style="color:${quadrant.color}">●</span> ${quadrant.name}</td>
            `;
            tbody.appendChild(row);
        });

        // Re-attach event listeners for details
        document.querySelectorAll('.btn-detail').forEach(btn => {
            btn.addEventListener('click', (e) => {
                const id = e.currentTarget.dataset.id;
                cargarDetallesProducto(id);
            });
        });
    }

    function updateDynamicDescription(data, promedios) {
        const descriptionEl = document.getElementById('dynamic-chart-description');
        const productsWithSales = data.filter(p => p.volumen_ventas > 0);
        if (productsWithSales.length === 0) {
            descriptionEl.textContent = 'No hay suficientes datos de ventas en este período para un análisis detallado.';
            return;
        }

        const quadrantCounts = { 'Estrella': 0, 'Vaca': 0, 'Interrogante': 0, 'Perro': 0 };
        const quadrantContrib = { 'Estrella': 0, 'Vaca': 0, 'Interrogante': 0, 'Perro': 0 };
        let totalContrib = 0;

        productsWithSales.forEach(p => {
            const quadrant = getQuadrantInfo(p, promedios);
            quadrantCounts[quadrant.name]++;
            quadrantContrib[quadrant.name] += p.margen_contribucion_total;
            totalContrib += p.margen_contribucion_total;
        });

        let analysisText = '<strong>Análisis del Período:</strong> ';
        const topQuadrant = Object.entries(quadrantContrib).sort((a, b) => b[1] - a[1])[0];
        
        if (topQuadrant && totalContrib > 0) {
            const topName = topQuadrant[0];
            const topVal = topQuadrant[1];
            const topCount = quadrantCounts[topName];
            const percentage = ((topVal / totalContrib) * 100).toFixed(1);
            analysisText += `Los ${topCount} productos clasificados como '<strong>${topName}</strong>' son los más significativos, generando el <strong>${percentage}%</strong> del Margen de Contribución Total.`;
        } else {
             analysisText += "No se pudo generar un análisis concluyente con los datos actuales."
        }
        descriptionEl.innerHTML = analysisText;
    }

    // --- MANEJADORES DE EVENTOS ---
    document.getElementById('filter-buttons').addEventListener('click', (e) => {
        if (e.target.tagName === 'BUTTON') {
            currentFilter = e.target.dataset.period;
            document.querySelectorAll('#filter-buttons button').forEach(btn => btn.classList.remove('active'));
            e.target.classList.add('active');
            loadData(currentFilter);
        }
    });

    document.querySelectorAll('#tabla-rentabilidad th[data-sort]').forEach(header => {
        header.addEventListener('click', () => {
            const sortKey = header.getAttribute('data-sort');
            if (sortConfig.key === sortKey) {
                sortConfig.direction = sortConfig.direction === 'asc' ? 'desc' : 'asc';
            } else {
                sortConfig.key = sortKey;
                sortConfig.direction = 'desc';
            }
            renderTable(fullData.productos);
        });
    });

    document.getElementById('searchInput').addEventListener('input', (e) => {
        const searchTerm = e.target.value.toLowerCase();
        const filtered = fullData.productos.filter(p => p.nombre.toLowerCase().includes(searchTerm));
        renderTable(filtered);
    });

    function cargarDetallesProducto(productoId) {
        const modalBody = document.getElementById('modal-body-content');
        modalBody.innerHTML = '<div class="text-center py-5"><div class="spinner-border text-primary" role="status"></div></div>';
        const productoModal = new bootstrap.Modal(document.getElementById('productoModal'));
        productoModal.show();

        // Buscar datos locales primero (ya tenemos costos calculados)
        const localProductData = fullData.productos.find(p => p.id == productoId);

        fetch(`/analisis/api/rentabilidad/producto/${productoId}/evolucion`)
            .then(res => res.json())
            .then(evolucionResult => {
                let content = '';
                if (localProductData) {
                     content += `
                        <div class="row mb-4">
                            <div class="col-md-6">
                                <h4>${localProductData.nombre}</h4>
                                <p class="text-muted">Precio Venta: ${formatCurrency(localProductData.precio_venta)}</p>
                            </div>
                            <div class="col-md-6 text-end">
                                <h2 class="text-success">${formatCurrency(localProductData.margen_contribucion_unitario)}</h2>
                                <small>Margen Contribución Unitario</small>
                            </div>
                        </div>
                        <div class="card bg-light mb-4">
                            <div class="card-body">
                                <h6 class="card-subtitle mb-3 text-muted">Estructura de Costos Variables</h6>
                                <div class="progress" style="height: 25px;">
                                    <div class="progress-bar bg-secondary" role="progressbar" style="width: ${(localProductData.detalles_costo.costo_materia_prima / localProductData.costo_variable_unitario * 100) || 0}%">MP</div>
                                    <div class="progress-bar bg-warning" role="progressbar" style="width: ${(localProductData.detalles_costo.costo_mano_obra / localProductData.costo_variable_unitario * 100) || 0}%">MO</div>
                                </div>
                                <div class="d-flex justify-content-between mt-2 small">
                                    <span>Materia Prima: <strong>${formatCurrency(localProductData.detalles_costo.costo_materia_prima)}</strong></span>
                                    <span>Mano de Obra: <strong>${formatCurrency(localProductData.detalles_costo.costo_mano_obra)}</strong></span>
                                </div>
                            </div>
                        </div>
                    `;
                }

                content += '<h5>Evolución de Ventas (Últimos 12 Meses)</h5>';
                content += '<div id="evolucion-chart-container" style="width: 100%; height: 300px;"></div>';
                
                modalBody.innerHTML = content;
                
                if (evolucionResult.success && evolucionResult.data.length > 0) {
                    setTimeout(() => {
                        const evolucionChart = echarts.init(document.getElementById('evolucion-chart-container'));
                        const option = {
                            tooltip: { trigger: 'axis' },
                            grid: { left: '5%', right: '5%', bottom: '10%', top: '10%', containLabel: true },
                            xAxis: { type: 'category', data: evolucionResult.data.map(item => item.mes) },
                            yAxis: { type: 'value' },
                            series: [{
                                name: 'Unidades',
                                data: evolucionResult.data.map(item => item.unidades_vendidas),
                                type: 'line',
                                smooth: true,
                                areaStyle: { opacity: 0.2 }
                            }]
                        };
                        evolucionChart.setOption(option);
                    }, 200); // Pequeño delay para asegurar render en modal
                } else {
                    modalBody.innerHTML += '<p class="text-center text-muted mt-3">No hay datos históricos suficientes.</p>';
                }

            }).catch(err => {
                console.error(err);
                modalBody.innerHTML = '<div class="alert alert-danger">Error cargando detalles.</div>';
            });
    }

    // Carga inicial
    loadData(currentFilter);
});
</script>
{% endblock %}
