{% extends 'public/base.html' %}
{% block title %}Mi Perfil - {{ cliente.nombre }}{% endblock %}

{% block extra_css %}
<style>
    .profile-container { max-width: 1200px; margin: 2rem auto; }
    .card-header { background-color: #f8f9fa; font-weight: 600; }
    /* Clases de estado para los badges (usadas en perfil.html y reclamo_detalle.html) */
    .state-pendiente { background-color: #dc3545 !important; color: white !important; }
    .state-respondida { background-color: #ffc107 !important; color: #343a40 !important; }
    .state-solucionada { background-color: #198754 !important; color: white !important; }
    .state-cancelado { background-color: #6c757d !important; color: white !important; }
</style>
{% endblock %}

{% block content %}
<div class="profile-container">
    <div class="profile-header mb-4">
        <h1>Mi Perfil</h1>
    </div>

    <div class="profile-details card">
        <div class="card-header">
            <h2>Datos Personales</h2>
        </div>
        <div class="card-body">
            <div class="row">
                <div class="col-md-6">
                    <p><strong>Nombre:</strong> {{ cliente.nombre }}</p>
                    {% if cliente.razon_social %}
                    <p><strong>Razón Social:</strong> {{ cliente.razon_social }}</p>
                    {% endif %}
                    <p><strong>CUIT/CUIL:</strong> {{ cliente.cuit }}</p>
                </div>
                <div class="col-md-6">
                    <p><strong>Email:</strong> {{ cliente.email }}</p>
                    <p><strong>Teléfono:</strong> {{ cliente.telefono }}</p>
                    <p><strong>Fecha de Alta:</strong> {{ cliente.created_at | format_datetime('%d/%m/%Y') }}</p>
                </div>
            </div>
            <hr>
            <div class="row">
                <div class="col-md-6">
                    <p><strong>Condición IVA:</strong> {{ cliente.condicion_iva | format_condicion_iva }}</p>
                </div>
                <div class="col-md-6">
                    <p><strong>Estado de Verificación:</strong>
                        {% if cliente.estado_aprobacion == 'aprobado' %}
                        <span class="badge bg-success">Verificado</span>
                        {% elif cliente.estado_aprobacion == 'pendiente' %}
                        <span class="badge bg-warning">Aprobación Pendiente</span>
                        {% else %}
                        <span class="badge bg-danger">Rechazado</span>
                        {% endif %}
                    </p>
                </div>
            </div>
        </div>
    </div>
    <div class="card mt-4">
        <div class="card-body text-center">
            <h5 class="card-title">¿Tienes alguna duda sobre nuestros productos o servicios?</h5>
            <p class="card-text">Revisa tus consultas anteriores o realiza una nueva.</p>
            <a href="{{ url_for('cliente.ver_consultas') }}" class="btn btn-primary">
                <i class="bi bi-patch-question-fill me-2"></i> Ir a Mis Consultas
            </a>
        </div>
    </div>

    <div class="profile-orders card mt-4">
        <div class="card-header">
            <h2>Mis Pedidos</h2>
        </div>
        <div class="card-body">
            {% if cliente.pedidos %}
            <div class="table-responsive">
                <table class="table table-striped table-hover">
                    <thead>
                        <tr>
                            <th>Código</th>
                            <th>Productos</th>
                            <th>Total</th>
                            <th>Estado Pedido</th>
                            <th>Estado Pago</th>
                            <th>Fecha Solicitud</th>
                            <th>Acciones</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for pedido in cliente.pedidos %}
                        <tr>
                            <td><strong>PED-{{ pedido.id }}</strong></td>
                            <td>
                                <ul class="list-unstyled mb-0">
                                    {% for item in pedido['items'] %}
                                    <li class="small">{{ item.producto_nombre.nombre }} (x{{ item.cantidad }})</li>
                                    {% endfor %}
                                </ul>
                            </td>
                            <td>${{ pedido.precio_orden | formato_moneda }}</td>
                            <td><span class="badge state-{{ pedido.estado | lower }}">{{ pedido.estado.replace('_', ' ') | title }}</span></td>
                            <td>
                                {% if pedido.estado_pago == 'Pagado' %}
                                    <span class="badge bg-success">Pagado</span>
                                {% else %}
                                    <span class="badge bg-warning text-dark">Pendiente</span>
                                {% endif %}
                            </td>
                            <td>{{ pedido.fecha_solicitud }}</td>
                            <td>
                                {% if pedido.estado_pago != 'Pagado' and pedido.estado != 'CANCELADO' %}
                                <button class="btn btn-success btn-sm mb-1 btn-pagar" 
                                        data-id="{{ pedido.id }}" 
                                        data-monto="{{ pedido.precio_orden }}">
                                    <i class="bi bi-credit-card"></i> Pagar
                                </button>
                                {% endif %}
                                <a href="{{ url_for('public.crear_reclamo_page', pedido_id=pedido.id) }}"
                                    class="btn btn-warning btn-sm mb-1">
                                    <i class="bi bi-exclamation-triangle"></i> Reportar Problema
                                </a>
                            </td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
            {% else %}
            <p class="text-center">Aún no has realizado ningún pedido.</p>
            {% endif %}
        </div>
    </div>

    <div class="profile-claims card mt-4">
        <div class="card-header">
            <h2>Mis Reclamos</h2>
        </div>
        <div class="card-body">
            {% if cliente.reclamos %}
            <div class="table-responsive">
                <table class="table table-striped table-hover">
                    <thead>
                        <tr>
                            <th>ID Reclamo</th>
                            <th>Pedido</th>
                            <th>Categoría</th>
                            <th>Fecha</th>
                            <th>Estado</th>
                            <th>Acciones</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% set estado_config = {
                            'pendiente': {'class': 'state-pendiente', 'text': 'Pendiente (Admin)'},
                            'respondida': {'class': 'state-respondida', 'text': 'Respondido (Cliente)'},
                            'solucionada': {'class': 'state-solucionada', 'text': 'Solucionado'},
                            'cancelado': {'class': 'state-cancelado', 'text': 'Cancelado'}
                        } %}
                        {% for reclamo in cliente.reclamos %}
                        <tr>
                            <td><strong>#{{ reclamo.id }}</strong></td>
                            <td>PED-{{ reclamo.pedido_id }}</td>
                            <td>{{ reclamo.categoria.replace('_', ' ') | title }}</td>
                            <td>{{ reclamo.created_at | format_datetime('%d/%m/%Y') }}</td>
                            <td>
                                {% set config = estado_config.get(reclamo.estado, {'class': 'bg-light', 'text': reclamo.estado}) %}
                                <span class="badge {{ config.class }}">{{ config.text }}</span>
                            </td>
                            <td>
                                <a href="{{ url_for('reclamo.obtener_detalle_reclamo', reclamo_id=reclamo.id) }}"
                                    class="btn btn-primary btn-sm">
                                    <i class="bi bi-chat-dots"></i> Ver / Responder
                                </a>
                            </td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
            {% else %}
            <p class="text-center">No tienes reclamos registrados.</p>
            {% endif %}
        </div>
    </div>
</div>

<!-- Modal Simulación de Pago -->
<div class="modal fade" id="paymentModal" tabindex="-1" aria-labelledby="paymentModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content">
            <div class="modal-header bg-primary text-white">
                <h5 class="modal-title" id="paymentModalLabel"><i class="bi bi-credit-card-2-front me-2"></i>Simulación de Pago</h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <form id="paymentForm">
                    <input type="hidden" id="pago_pedido_id" name="pedido_id">
                    <input type="hidden" id="pago_monto_hidden" name="monto">
                    
                    <div class="mb-3 text-center">
                        <h3 class="text-primary" id="pago_monto_display">$0.00</h3>
                        <p class="text-muted">Total a Pagar</p>
                    </div>

                    <div class="mb-3">
                        <label class="form-label">Número de Tarjeta</label>
                        <div class="input-group">
                            <span class="input-group-text"><i class="bi bi-credit-card"></i></span>
                            <input type="text" class="form-control" placeholder="0000 0000 0000 0000" required maxlength="19">
                        </div>
                    </div>

                    <div class="row">
                        <div class="col-6 mb-3">
                            <label class="form-label">Vencimiento</label>
                            <input type="text" class="form-control" placeholder="MM/AA" required maxlength="5">
                        </div>
                        <div class="col-6 mb-3">
                            <label class="form-label">CVC</label>
                            <input type="text" class="form-control" placeholder="123" required maxlength="3">
                        </div>
                    </div>

                    <div class="mb-3">
                        <label class="form-label">Nombre del Titular</label>
                        <input type="text" class="form-control" placeholder="Como aparece en la tarjeta" required>
                    </div>

                    <div class="d-grid">
                        <button type="submit" class="btn btn-primary btn-lg" id="btnConfirmarPago">
                            <i class="bi bi-lock-fill me-2"></i>Pagar Ahora
                        </button>
                    </div>
                </form>
            </div>
            <div class="modal-footer bg-light">
                <small class="text-muted w-100 text-center"><i class="bi bi-shield-lock me-1"></i> Transacción Segura (Simulación)</small>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
{{ super() }}
<script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
<script>
    document.addEventListener('DOMContentLoaded', function() {
        const paymentModal = new bootstrap.Modal(document.getElementById('paymentModal'));
        const paymentForm = document.getElementById('paymentForm');
        
        // Abrir modal al hacer click en Pagar
        document.querySelectorAll('.btn-pagar').forEach(btn => {
            btn.addEventListener('click', function() {
                const pedidoId = this.dataset.id;
                const monto = this.dataset.monto;
                
                document.getElementById('pago_pedido_id').value = pedidoId;
                document.getElementById('pago_monto_hidden').value = monto;
                document.getElementById('pago_monto_display').textContent = `$${parseFloat(monto).toLocaleString('es-AR', {minimumFractionDigits: 2})}`;
                
                paymentModal.show();
            });
        });

        // Procesar el pago
        paymentForm.addEventListener('submit', async function(e) {
            e.preventDefault();
            
            const btn = document.getElementById('btnConfirmarPago');
            const originalText = btn.innerHTML;
            btn.disabled = true;
            btn.innerHTML = '<span class="spinner-border spinner-border-sm me-2"></span>Procesando...';

            // Simular delay de red
            await new Promise(r => setTimeout(r, 2000));

            try {
                const pedidoId = document.getElementById('pago_pedido_id').value;
                const monto = document.getElementById('pago_monto_hidden').value;

                const response = await fetch('/public/api/pagar-pedido', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'X-CSRFToken': "{{ csrf_token() }}" // Asumiendo que tienes csrf_token disponible globalmente o necesitas inyectarlo
                    },
                    body: JSON.stringify({
                        pedido_id: pedidoId,
                        monto: monto,
                        metodo_pago: 'tarjeta_credito',
                        datos_adicionales: 'Pago simulado desde perfil público'
                    })
                });

                const result = await response.json();

                if (result.success) {
                    paymentModal.hide();
                    Swal.fire({
                        icon: 'success',
                        title: '¡Pago Exitoso!',
                        text: 'Tu pago ha sido procesado correctamente.',
                        confirmButtonColor: '#0d6efd'
                    }).then(() => {
                        window.location.reload();
                    });
                } else {
                    throw new Error(result.message || 'Error al procesar el pago');
                }

            } catch (error) {
                console.error(error);
                Swal.fire({
                    icon: 'error',
                    title: 'Error',
                    text: error.message || 'Hubo un problema al procesar el pago.',
                    confirmButtonColor: '#dc3545'
                });
            } finally {
                btn.disabled = false;
                btn.innerHTML = originalText;
            }
        });
    });
</script>
{% endblock %}