{% extends "public/base.html" %} 
{% block title %}Seguimiento de tu Pedido{% endblock %} 
{% block extra_css %}
<style>
  .estado-pasado {
    opacity: 0.7;
  }
  
  .estado-futuro {
    opacity: 0.6;
  }
</style>
{% endblock %} 
{% block content %}
<div class="container my-5">
  <div class="card shadow-sm">
    <div class="card-header bg-primary text-white">
      <h2 class="mb-0">Seguimiento de tu Pedido</h2>
    </div>
    <div class="card-body">
      <div class="row mb-4">
        <div class="col-md-4">
          <h5>Número de Pedido</h5>
          <p class="lead">#{{ pedido.codigo_pedido or pedido.id }}</p>
        </div>
        <div class="col-md-4">
          <h5>Fecha Estimada de Entrega</h5>
          <p class="lead">{{ pedido.fecha_requerido | format_date }}</p>
        </div>
        <div class="col-md-4">
          <h5>Destino</h5>
          <p class="lead">{{ pedido.direccion.localidad }}, {{ pedido.direccion.provincia }}</p>
        </div>
      </div>

      <h4 class="mb-3">Estado Actual</h4>
      <ul class="list-unstyled">
        {% for hito in hitos %}
        {% set clase_estado = '' %}
        {% set badge_text = '' %}
        {% set badge_class = '' %}
        
        {% if hito.estado == 'activo' %}
          {# Estado actual #}
          {% set badge_text = 'Actualmente' %}
          {% set badge_class = 'bg-warning text-dark' %}
        {% elif hito.estado == 'inactivo' %}
          {# Estado futuro #}
          {% set clase_estado = 'estado-futuro' %}
          {% set badge_text = 'Próximamente' %}
          {% set badge_class = 'bg-danger' %}
        {% else %}
          {# Estado pasado (completado) #}
          {% set clase_estado = 'estado-pasado' %}
          {% set badge_text = 'Hecho' %}
          {% set badge_class = 'bg-success' %}
        {% endif %}
        
        <li class="mb-4 {{ clase_estado }}">
          <div class="d-flex align-items-start">
            <div class="me-3">
              <i class="bi bi-circle-fill" style="font-size: 12px;"></i>
            </div>
            <div class="flex-grow-1">
              <h5 class="mb-1">
                {{ hito.titulo }}
                {% if badge_text %}
                <span class="badge {{ badge_class }}">{{ badge_text }}</span>
                {% endif %}
              </h5>
              <p class="mb-1">{{ hito.descripcion }}</p>
              {% if hito.fecha %}
              <small class="text-muted">
                <i class="bi bi-clock"></i> {{ hito.fecha | format_datetime }}
              </small>
              {% endif %}
            </div>
          </div>
        </li>
        {% endfor %}
      </ul>

      <hr class="my-4">

      <h4 class="mb-3">Resumen de tu Compra</h4>
      <div class="table-responsive">
        <table class="table table-hover">
          <thead>
            <tr>
              <th>Producto</th>
              <th>Cantidad</th>
              <th>Lote</th>
              <th>Elaboración</th>
              <th>Vencimiento</th>
            </tr>
          </thead>
          <tbody>
            {% for item in pedido['items'] %}
            <tr>
              <td>{{ item.producto_nombre.nombre or 'Producto Desconocido' }}</td>
              <td>{{ item.cantidad }}</td>
              <td>{{ lotes_por_item[item.id].numero_lote if lotes_por_item.get(item.id) else 'N/A' }}</td>
              <td>{{ lotes_por_item[item.id].fecha_produccion | format_date if lotes_por_item.get(item.id) else 'N/A' }}</td>
              <td>{{ lotes_por_item[item.id].fecha_vencimiento | format_date if lotes_por_item.get(item.id) else 'N/A' }}</td>
            </tr>
            {% endfor %}
          </tbody>
        </table>
      </div>

      <div class="alert alert-info mt-4" role="alert">
        <i class="bi bi-info-circle"></i> Gracias por confiar en Frozen.
      </div>
    </div>
  </div>
</div>
{% endblock %}