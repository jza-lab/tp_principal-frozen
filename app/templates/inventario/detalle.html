{% extends 'layouts/app_layout.html' %}

{% block title %}Detalle del Lote - {{ lote.numero_lote_proveedor or 'N/A' }}{% endblock %}

{% block extra_css %}
<link rel="stylesheet" href="{{ url_for('static', filename='css/usuarios/listarUsuarios.css') }}">
<style>
    #sankey_trazabilidad svg g {
        cursor: pointer;
    }
</style>
{% endblock %}


{% block app_content %}

<div class="d-flex justify-content-between flex-wrap flex-md-nowrap align-items-center pb-2 mb-4 border-bottom">
    <div>
        <h1 class="h2 mb-1">
            Detalle del Lote
        </h1>
        <p class="text-muted mb-0">Insumo: <strong>{{ lote.insumo_nombre or 'N/A' }}</strong></p>
    </div>
    <div class="btn-toolbar">
        <button class="btn btn-danger me-2 btn-crear-alerta" data-tipo-entidad="lote_insumo"
            data-id-entidad="{{ lote.id_lote }}" data-nombre-entidad="Lote de Insumo {{ lote.numero_lote_proveedor }}">
            <i class="bi bi-exclamation-triangle-fill me-1"></i> Crear Alerta de Riesgo
        </button>
        <a href="#" onclick="history.back();" class="btn btn-outline-secondary me-2"
            title="Volver a la página anterior">
            <i class="bi bi-arrow-left"></i> Volver
        </a>
        <a href="{{ url_for('inventario_view.listar_lotes') }}" class="btn btn-outline-secondary me-2">
            <i class="bi bi-arrow-left me-1"></i>Ir al Inventario de Insumos
        </a>
        {% if lote.url_imagen %}
        <button type="button" class="btn btn-info" data-bs-toggle="modal" data-bs-target="#imageModal">
            <i class="bi bi-camera me-1"></i>Ver Foto
        </button>
        {% endif %}
        {% set can_edit = 'modificar_materias_primas' is has_permission %}
        <a href="{{ url_for('insumos_api.editar_lote', id_insumo=lote.id_insumo, id_lote=lote.id_lote) if can_edit else '#' }}"
            class="btn btn-primary {% if not can_edit %}disabled{% endif %}">
            <i class="bi bi-pencil-square me-1"></i>Editar Lote
        </a>
    </div>
</div>

<ul class="nav nav-tabs-custom mb-3" id="loteDetailTab" role="tablist">
    <li class="nav-item" role="presentation">
        <button class="nav-link-custom active" id="info-tab" data-bs-toggle="tab" data-bs-target="#info-content"
            type="button" role="tab" aria-controls="info-content" aria-selected="true">
            <i class="bi bi-info-circle me-1"></i>Información General
        </button>
    </li>
    <li class="nav-item" role="presentation">
        <button class="nav-link-custom" id="trazabilidad-tab" data-bs-toggle="tab"
            data-bs-target="#trazabilidad-content" type="button" role="tab" aria-controls="trazabilidad-content"
            aria-selected="false">
            <i class="bi bi-diagram-3 me-1"></i>Trazabilidad
        </button>
    </li>
</ul>

<div class="tab-content" id="loteDetailTabContent">

    <div class="tab-pane fade show active" id="info-content" role="tabpanel" aria-labelledby="info-tab">
        <div class="card">
            <div class="card-header d-flex justify-content-between align-items-center">
                <h5 class="mb-0">Información del Lote <code
                        class="text-muted ms-2">{{ lote.numero_lote_proveedor or 'N/A' }}</code></h5>
                <div>
                    {% if lote.en_alerta %}
                    <span class="badge bg-danger fs-6" data-bs-toggle="tooltip" title="Alertado">
                        <i class="bi bi-exclamation-triangle-fill"></i> Alertado
                    </span>
                    {% endif %}
                    {% if lote.estado == 'disponible' %}
                    <span class="badge bg-success fs-6">{{ lote.estado | title }}</span>
                    {% elif lote.estado == 'cuarentena' %}
                    <span class="badge bg-warning text-dark fs-6"
                        title="Motivo: {{ lote.motivo_cuarentena or 'Sin motivo' }}" data-bs-toggle="tooltip"> <i
                            class="bi bi-shield-lock me-1"></i>{{ lote.estado | title }}
                    </span>
                    {% elif lote.estado == 'RECHAZADO' %}
                    <span class="badge bg-danger fs-6">{{ lote.estado | title }}</span>
                    {% endif %}
                </div>
            </div>
            <div class="card-body">
                <div class="row g-4">
                    <div class="col-md-6">
                        <h6 class="text-muted mb-3"><i class="bi bi-box-seam me-1"></i>Detalles del Insumo</h6>
                        <div class="d-grid gap-3">
                            <div class="d-flex align-items-center border-start border-3 border-primary ps-3">
                                <i class="bi bi-tag-fill text-muted me-2 fs-4"></i>
                                <div>
                                    <div class="small text-muted">Insumo</div>
                                    <div class="fw-bold">{{ lote.insumo_nombre or 'No disponible' }} ({{
                                        lote.insumo_unidad_medida }})</div>
                                </div>
                            </div>
                            <div class="d-flex align-items-center border-start border-3 border-secondary ps-3">
                                <i class="bi bi-truck-flatbed text-muted me-2 fs-4"></i>
                                <div>
                                    <div class="small text-muted">Proveedor</div>
                                    <div class="fw-bold">{{ lote.proveedor_nombre or 'No especificado' }}</div>
                                </div>
                            </div>
                            <div class="d-flex align-items-center border-start border-3 border-secondary ps-3">
                                <i class="bi bi-file-earmark-text text-muted me-2 fs-4"></i>
                                <div>
                                    <div class="small text-muted">Documento de Ingreso</div>
                                    <div class="fw-bold">{{ lote.documento_ingreso or 'N/A' }}</div>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-6">
                        <h6 class="text-muted mb-3"><i class="bi bi-currency-dollar me-1"></i>Stock y Costos</h6>
                        <div class="row g-3">
                            <div class="col-6">
                                <label class="small text-muted">Cantidad Inicial</label>
                                <div class="fw-bold h5">{{ lote.cantidad_inicial | round(2) }}
                                    <small class="text-muted">{{ lote.insumo_unidad_medida }}</small>
                                </div>
                            </div>
                            <div class="col-6">
                                <label class="small text-muted">Cantidad Actual</label>
                                <div class="fw-bold h5 text-primary">{{ lote.cantidad_actual | round(2) }}
                                    <small class="text-muted">{{ lote.insumo_unidad_medida }}</small>
                                </div>
                            </div>
                            <div class="col-6">
                                <label class="small text-muted">Precio Unitario</label>
                                <div class="fw-bold"> {{ lote.precio_unitario | formato_moneda if
                                    lote.precio_unitario
                                    else 'N/A' }}</div>
                            </div>
                            <div class="col-6">
                                <label class="small text-muted">Costo Total Ingreso</label>
                                <div class="fw-bold"> {{ lote.costo_total | formato_moneda if lote.costo_total
                                    else
                                    'N/A' }}</div>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-6">
                        <h6 class="text-muted mb-3"><i class="bi bi-geo-alt me-1"></i>Fechas y Ubicación</h6>
                        <div class="d-grid gap-3">
                            <div class="d-flex align-items-center">
                                <i class="bi bi-calendar-plus text-success me-2 fs-4"></i>
                                <div>
                                    <div class="small text-muted">Fecha de Ingreso</div>
                                    <div class="fw-bold">{{ lote.f_ingreso }}</div>
                                </div>
                            </div>
                            <div class="d-flex align-items-center">
                                <i class="bi bi-calendar-x text-danger me-2 fs-4"></i>
                                <div>
                                    <div class="small text-muted">Fecha de Vencimiento</div>
                                    <div class="fw-bold">{{ lote.f_vencimiento or 'No aplica' }}</div>
                                </div>
                            </div>
                        </div>
                    </div>
                    {% if lote.observaciones %}
                    <div class="col-12">
                        <h6 class="text-muted mb-2"><i class="bi bi-sticky me-1"></i>Observaciones del Lote</h6>
                        <div class="border-start border-3 border-warning ps-3">
                            <p class="mb-0">{{ lote.observaciones }}</p>
                        </div>
                    </div>
                    {% endif %}
                </div>
            </div>
        </div>

        <!-- Historial de Calidad -->
        <div class="card mt-4">
            <div class="card-header">
                <h5 class="mb-0"><i class="bi bi-shield-check me-2"></i>Historial de Control de Calidad y Cuarentena
                </h5>
            </div>
            <div class="card-body">
                {% if lote.historial_calidad %}
                {% for evento in lote.historial_calidad %}
                <div class="row mb-4 pb-3 border-bottom">
                    <div class="col-md-8">
                        <p class="mb-1"><strong>Fecha:</strong> {{ evento.created_at.strftime('%Y-%m-%d %H:%M') if
                            evento.created_at else 'N/A' }}</p>
                        <p class="mb-1"><strong>Decisión:</strong> <span class="fw-bold">{{
                                evento.decision_final.replace('_', ' ') | title }}</span></p>
                        <p class="mb-1"><strong>Motivo:</strong> {{ evento.resultado_inspeccion or 'No especificado' }}
                        </p>
                        {% if evento.comentarios %}
                        <p class="mb-1"><strong>Comentarios:</strong> {{ evento.comentarios }}</p>
                        {% endif %}
                    </div>
                    <div class="col-md-4 text-center">
                        {% if evento.foto_url %}
                        <a href="{{ evento.foto_url }}" target="_blank">
                            <img src="{{ evento.foto_url }}" alt="Foto de control de calidad" class="img-fluid rounded"
                                style="max-height: 150px;">
                        </a>
                        <small class="text-muted d-block mt-1">Clic para ampliar</small>
                        {% else %}
                        <div class="text-muted fst-italic mt-3">Sin foto adjunta</div>
                        {% endif %}
                    </div>
                </div>
                {% endfor %}
                {% else %}
                <p class="text-muted">Este lote no tiene eventos de control de calidad o cuarentena registrados.</p>
                {% endif %}
            </div>
        </div>
    </div>

    <div class="tab-pane fade" id="trazabilidad-content" role="tabpanel" aria-labelledby="trazabilidad-tab">

        <!-- Selector de Nivel de Trazabilidad -->
        <div class="d-flex justify-content-end align-items-center mb-3">
            <div class="form-check form-switch">
                <input class="form-check-input" type="checkbox" role="switch" id="trazabilidad-nivel-switch">
                <label class="form-check-label" for="trazabilidad-nivel-switch">Ver Trazabilidad Completa</label>
            </div>
        </div>

        <div class="row">
            <div class="col-lg-8">
                <div id="resumen-trazabilidad-contenedor" class="card mb-4">
                    <div class="card-header">
                        <i class="bi bi-list-ul me-1"></i> Resumen de Trazabilidad
                    </div>
                    <div class="card-body">
                        <div class="text-center p-3">
                            <div class="spinner-border text-primary" role="status">
                                <span class="visually-hidden">Cargando resumen...</span>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            <div class="col-lg-4">
                <div class="card mb-4">
                    <div class="card-header">
                        <i class="bi bi-shield-exclamation me-1"></i> Historial del Proveedor
                    </div>
                    <div class="card-body" id="panel-riesgo-proveedor">
                        <div class="text-center p-3">
                            <div class="spinner-border spinner-border-sm text-secondary" role="status">
                                <span class="visually-hidden">Cargando...</span>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <div class="accordion" id="accordionDiagrama">
            <div class="accordion-item">
                <h2 class="accordion-header" id="headingOne">
                    <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse"
                        data-bs-target="#collapseDiagrama" aria-expanded="false" aria-controls="collapseDiagrama">
                        <i class="bi bi-diagram-3 me-2"></i> Ver Diagrama de Flujo Completo
                    </button>
                </h2>
                <div id="collapseDiagrama" class="accordion-collapse collapse" aria-labelledby="headingOne"
                    data-bs-parent="#accordionDiagrama">
                    <div class="accordion-body">
                        <ul class="list-unstyled text-muted small mb-3">
                            <li><i class="bi bi-square-fill me-2" style="color: #a6cee3;"></i> <strong>Nodos:</strong>
                                Entidades (OC, Lotes, OPs, Pedidos).</li>
                            <li><i class="bi bi-arrow-right-short me-2" style="color: #1f78b4;"></i>
                                <strong>Flujos:</strong> Movimiento del material (ancho proporcional a la cantidad).
                            </li>
                            <li><i class="bi bi-mouse me-2"></i> <strong>Interactividad:</strong> Clic en un nodo para
                                ver su detalle.</li>
                        </ul>
                        <div id="sankey_trazabilidad" style="width: 100%; min-height: 400px;">
                            <div class="d-flex justify-content-center align-items-center h-100">
                                <div class="spinner-border text-primary" role="status">
                                    <span class="visually-hidden">Cargando gráfico...</span>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
{% include "admin_riesgos/_modal_crear_alerta.html" %}
{% endblock %}


{% block extra_js %}
<script type="text/javascript" src="https://www.gstatic.com/charts/loader.js"></script>

<script>
    window.LOTE_ID = "{{ lote.id_lote | safe }}";
</script>
<script src="{{ url_for('static', filename='js/trazabilidadInsumo.js') }}?v=1.1"></script>
<script src="{{ url_for('static', filename='js/gestorAlertas.js') }}?v=1.1"></script>
{% endblock %}