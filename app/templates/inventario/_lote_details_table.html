<table class="table table-sm table-bordered bg-white mb-0">
    <thead>
        <tr>
            <th>N° Lote</th>
            <th class="text-end">Cantidad</th>
            <th>Proveedor</th>
            <th>Fecha Ingreso</th>
            <th>Fecha Vencimiento</th>
            <th>Estado</th>
            <th>Acciones</th>
        </tr>
    </thead>
    <tbody>
        {% for lote in insumo.lotes %}
        <tr class="align-middle">
            <td>{{ lote.numero_lote_proveedor or 'N/A' }}</td>
            
            <td class="text-end fw-bold">
                {% if lote.cantidad_en_cuarentena > 0 or lote.cantidad_reservada > 0 %}
                    <div class="d-flex flex-column text-end" style="font-size: 0.9em; line-height: 1.4;">
                        {% if lote.cantidad_reservada > 0 %}
                            <span class="text-info">{{ lote.cantidad_reservada | round(2) }} <small>(Res)</small></span>
                        {% endif %}
                        {% if lote.cantidad_en_cuarentena > 0 %}
                            <span class="text-warning">{{ lote.cantidad_en_cuarentena | round(2) }} <small>(Cuar)</small></span>
                        {% endif %}
                        <span class="text-muted">{{ lote.cantidad_actual | round(2) }} <small>(Disp)</small></span>
                    </div>
                {% else %}
                    {{ lote.cantidad_actual | round(2) }} <small class="text-muted" style="font-size: 0.8em;">{{ lote.insumo_unidad_medida or '' }}</small>
                {% endif %}
            </td>
            
            <td>{{ lote.proveedor_nombre or 'No especificado' }}</td>
            <td>{{ lote.f_ingreso }}</td>
            <td>
                {% if lote.f_vencimiento %}
                {{ lote.f_vencimiento }}
                {% else %}
                <span class="text-muted">No aplica</span>
                {% endif %}
            </td>

            <td>
                {% set estado_config = {
                    'disponible': {'icon': 'bi-check-circle-fill', 'color': 'success', 'title': 'Disponible'},
                    'agotado': {'icon': 'bi-x-circle-fill', 'color': 'danger', 'title': 'Agotado'},
                    'reservado': {'icon': 'bi-bookmark-fill', 'color': 'secondary', 'title': 'Reservado'},
                    'vencido': {'icon': 'bi-calendar-x-fill', 'color': 'danger', 'title': 'Vencido'},
                    'retirado': {'icon': 'bi-trash-fill', 'color': 'dark', 'title': 'Retirado'},
                    'cuarentena': {'icon': 'bi-shield-lock-fill', 'color': 'warning', 'title': 'En Cuarentena'},
                    'EN REVISION': {'icon': 'bi-search', 'color': 'info', 'title': 'En Revisión'},
                    'RECHAZADO': {'icon': 'bi-slash-circle-fill', 'color': 'danger', 'title': 'Rechazado'}
                } %}

                {% set config = estado_config.get(lote.estado, {'icon': 'bi-question-circle', 'color': 'secondary', 'title': lote.estado}) %}
                {% if lote.en_alerta %}
                <span class="badge bg-danger" data-bs-toggle="tooltip" title="Alertado">
                    <i class="bi bi-exclamation-triangle-fill"></i> Alertado
                </span>
                {% endif %}
                <span class="badge bg-{{ config.color }}-subtle text-{{ config.color }} fs-6"
                      data-bs-toggle="tooltip" 
                      title="{{ config.title }}">
                    <i class="bi {{ config.icon }}"></i>
                    {% if lote.estado == 'cuarentena' and (lote.cantidad_actual | float) <= 0 and (lote.cantidad_en_cuarentena | float) <= 0 %}
                        <i class="bi bi-exclamation-triangle-fill text-danger" title="Cuarentena por trazabilidad (lote agotado)"></i>
                    {% endif %}
                </span>
            </td>

            <td>
                <a href="{{ url_for('inventario_view.detalle_lote', id_lote=lote.id_lote) }}" class="btn btn-sm btn-outline-primary" title="Ver Detalle">
                    <i class="bi bi-eye"></i>
                </a>

                {% if lote.estado not in ['agotado', 'retirado', 'cuarentena'] %}
                <a href="{{ url_for('inventario_view.editar_lote', id_lote=lote.id_lote) }}" class="btn btn-sm btn-outline-secondary"
                    title="Editar Lote">
                    <i class="bi bi-pencil-square"></i>
                </a>
                {% endif %}

                {% if lote.estado == 'cuarentena' or 0 < lote.cantidad_en_cuarentena %}
                <button type="button" class="btn btn-sm btn-outline-success"
                        title="Liberar de Cuarentena"
                        data-bs-toggle="modal"
                        data-bs-target="#modalLiberar"
                        data-lote-id="{{ lote.id_lote }}"
                        data-lote-numero="{{ lote.numero_lote_proveedor }}"
                        data-lote-cantidad="{{ lote.get('cantidad_actual', 0) }}"
                        data-lote-cantidad-cuarentena="{{ lote.cantidad_en_cuarentena }}">
                    <i class="bi bi-shield-check"></i>
                </button>
                <button type="button" class="btn btn-sm btn-outline-danger"
                        title="Marcar como No Apto"
                        data-bs-toggle="modal"
                        data-bs-target="#modalNoApto"
                        data-lote-id="{{ lote.id_lote }}"
                        data-lote-numero="{{ lote.numero_lote_proveedor }}"
                        data-lote-cantidad-total="{{ (lote.cantidad_actual | float) + (lote.cantidad_en_cuarentena | float) + (lote.cantidad_reservada | default(0) | float) }}"
                        data-lote-cantidad-cuarentena="{{ lote.cantidad_en_cuarentena }}">
                    <i class="bi bi-trash"></i>
                </button>
                {% endif %}

                {% if lote.estado != 'cuarentena' or lote.cantidad_en_cuarentena == 0 %}
                <button type="button" class="btn btn-sm btn-outline-warning"
                        title="Poner en Cuarentena"
                        data-bs-toggle="modal"
                        data-bs-target="#modalCuarentena"
                        data-lote-id="{{ lote.id_lote }}"
                        data-lote-numero="{{ lote.numero_lote_proveedor }}"
                        data-lote-cantidad="{{ lote.cantidad_actual }}"
                        data-lote-cantidad-cuarentena="{{ lote.cantidad_en_cuarentena }}"
                        
                        data-lote-cantidad-reservada="{{ lote.cantidad_reservada }}" > <i class="bi bi-shield-lock"></i>
                </button>
                {% endif %}

                
            </td>
        </tr>
        {% else %}
        <tr>
            <td colspan="7" class="text-center text-muted py-3">
                Este insumo no tiene lotes asociados.
            </td>
        </tr>
        {% endfor %}
    </tbody>
</table>
