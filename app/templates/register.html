{% extends "base.html" %}

{% block content %}
<div class="row justify-content-center">
  <div class="col-md-6">
    <div class="card shadow-lg">
      <div class="card-body">
        <h2 class="card-title text-center mb-4">Registro de Usuario</h2>

        <form method="POST" action="/register">
          <div class="mb-3">
            <label for="username" class="form-label">Usuario</label>
            <input type="text" id="username" name="username" class="form-control" required>
          </div>

          <div class="mb-3">
            <label for="password" class="form-label">Contraseña</label>
            <input type="password" id="password" name="password" class="form-control" required>
          </div>

          <div class="mb-3">
            <label for="confirm_password" class="form-label">Confirmar contraseña</label>
            <input type="password" id="confirm_password" name="confirm_password" class="form-control" required>
          </div>

          <div class="mb-3">
            <label for="email" class="form-label">Correo electrónico</label>
            <input type="email" id="email" name="email" class="form-control" required>
          </div>

          <div class="mb-3">
            <label for="role" class="form-label">Rol</label>
            <select name="role" id="role" class="form-select" required>
              <option value="operador" selected>Operador</option>
              <option value="ADMIN">ADMIN</option>
            </select>
          </div>

          <button type="submit" class="btn btn-primary w-100">Registrarse</button>

          {% if error %}
            <div class="alert alert-danger mt-3">{{ error }}</div>
          {% endif %}
          {% if rejected %}
            <div class="alert alert-danger mt-3">
              ❌ El registro no se pudo completar ya que se rechazó el registro del rostro.
            </div>
          {% endif %}
          {% if success and not require_face %}
            <div class="alert alert-success mt-3">{{ success }}</div>
          {% endif %}
        </form>
      </div>
    </div>
  </div>
</div>

<!-- Modal de Registro Facial -->
<div class="modal fade" id="faceModal" tabindex="-1" aria-hidden="true">
  <div class="modal-dialog modal-dialog-centered">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title">Registro facial requerido</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
      </div>
      <div class="modal-body text-center">
        <p>Para finalizar tu registro, necesitamos capturar tu rostro.</p>
        <video id="video" width="320" height="240" autoplay class="d-none"></video>
        <canvas id="canvas" width="320" height="240" class="d-none"></canvas>
        <div id="face-message" class="mt-3 text-danger"></div>
      </div>
      <div class="modal-footer">
        <button id="rejectBtn" class="btn btn-secondary">Rechazar</button>
        <button id="acceptBtn" class="btn btn-primary">Aceptar</button>
      </div>
    </div>
  </div>
</div>

<script>
  document.addEventListener("DOMContentLoaded", function() {
    const video = document.getElementById("video");
    const canvas = document.getElementById("canvas");
    const context = canvas.getContext("2d");
    const faceMessage = document.getElementById("face-message");
    const acceptBtn = document.getElementById("acceptBtn");
    const rejectBtn = document.getElementById("rejectBtn");

    {% if require_face %}
      const modal = new bootstrap.Modal(document.getElementById("faceModal"));
      modal.show();
    {% endif %}

    async function startCamera() {
      try {
        const stream = await navigator.mediaDevices.getUserMedia({ video: true });
        video.srcObject = stream;
        video.classList.remove("d-none");
      } catch (err) {
        faceMessage.textContent = "❌ No se pudo acceder a la cámara.";
      }
    }

    function captureAndSend() {
      context.drawImage(video, 0, 0, canvas.width, canvas.height);
      const imageData = canvas.toDataURL("image/png");

      fetch("/register_face", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ image: imageData })
      })
      .then(res => res.json())
      .then(data => {
        if (data.success) {
          document.querySelector(".modal-body").innerHTML = `
            <div class="alert alert-success">${data.success}<br>
            <small>Este mensaje se cerrará automáticamente en 5 segundos.</small></div>
          `;
          document.querySelector(".modal-footer").remove();

          setTimeout(() => {
            window.location.href = data.redirect;
          }, 5000);
        } else if (data.error) {
          faceMessage.textContent = data.error;

          const footer = document.querySelector(".modal-footer");
          if (data.error.toLowerCase().includes("rostro ya está registrado")) {
            // Caso especial: se eliminó el usuario temporal, no tiene sentido reintentar
            footer.innerHTML = `
              <button class="btn btn-secondary" onclick="window.location.href='{{ url_for('register') }}'">Volver al registro</button>
            `;
          } else {
            // Otros errores: ofrecer reintento
            footer.innerHTML = `
              <button class="btn btn-secondary" id="retryBtn">Volver a intentar</button>
            `;
            document.getElementById("retryBtn").addEventListener("click", () => {
              faceMessage.textContent = "";
              startCamera();
              setTimeout(captureAndSend, 2000);
            });
          }
        }
      })
      .catch(() => {
        faceMessage.textContent = "❌ Error en el registro facial.";
      });
    }

    if (acceptBtn) {
      acceptBtn.addEventListener("click", () => {
        faceMessage.textContent = "";
        startCamera();
        setTimeout(captureAndSend, 2000);
      });
    }

    if (rejectBtn) {
      rejectBtn.addEventListener("click", () => {
        fetch("/register_face_reject", { method: "POST" })
          .then(res => res.text())
          .then(html => {
            document.body.innerHTML = html;
          });
      });
    }
  });
</script>
{% endblock %}