{% extends "layouts/app_layout.html" %}

{% block title %}Reportes de Stock{% endblock %}

{% block app_content %}
<div class="container-fluid mt-4">
    <div class="d-flex justify-content-between align-items-center mb-3">
        <h1><i class="bi bi-bar-chart-line-fill me-2"></i>Reportes de Stock</h1>
        <button id="download-pdf" class="btn btn-primary" disabled>
            <i class="bi bi-download me-2"></i>Descargar Reporte
        </button>
    </div>

    <ul class="nav nav-tabs" id="stockTab" role="tablist">
        <li class="nav-item" role="presentation">
            <button class="nav-link active" id="insumos-tab" data-bs-toggle="tab" data-bs-target="#insumos" type="button" role="tab" aria-controls="insumos" aria-selected="true">
                <i class="bi bi-box-seam me-1"></i>Insumos
            </button>
        </li>
        <li class="nav-item" role="presentation">
            <button class="nav-link" id="productos-tab" data-bs-toggle="tab" data-bs-target="#productos" type="button" role="tab" aria-controls="productos" aria-selected="false">
                <i class="bi bi-box me-1"></i>Productos Terminados
            </button>
        </li>
    </ul>

    <div class="tab-content" id="stockTabContent">
        <!-- Pestaña de Insumos -->
        <div class="tab-pane fade show active" id="insumos" role="tabpanel" aria-labelledby="insumos-tab">
            <div class="row mt-3 g-3">
                <div class="col-lg-6">
                    <div class="card h-100">
                        <div class="card-body">
                            <h5 class="card-title">Composición del Stock de Insumos</h5>
                            <p class="text-muted small">Este gráfico de torta muestra la proporción de cada categoría de insumo sobre el total del stock disponible, permitiendo identificar rápidamente las categorías más predominantes.</p>
                            <div id="insumos-composicion-chart" style="height: 400px;"></div>
                            <div id="insumos-composicion-summary" class="dynamic-summary mt-2 small p-2 bg-light rounded border"></div>
                        </div>
                    </div>
                </div>
                <div class="col-lg-6">
                    <div class="card h-100">
                        <div class="card-body">
                            <div class="d-flex justify-content-between align-items-center">
                                <h5 class="card-title mb-0">Valor del Stock de Insumos</h5>
                                <div class="d-flex align-items-center">
                                    <label for="top-n-insumos" class="form-label me-2 mb-0">Mostrar Top:</label>
                                    <select id="top-n-insumos" class="form-select form-select-sm" style="width: 70px;">
                                        <option value="5">5</option>
                                        <option value="10" selected>10</option>
                                        <option value="15">15</option>
                                    </select>
                                </div>
                            </div>
                             <p class="text-muted small">Este gráfico de barras presenta los insumos más valiosos en inventario, multiplicando el stock actual por su costo unitario para priorizar la gestión.</p>
                            <div id="insumos-valor-chart" style="height: 400px;"></div>
                            <div id="insumos-valor-summary" class="dynamic-summary mt-2 small p-2 bg-light rounded border"></div>
                        </div>
                    </div>
                </div>
                 <div class="col-lg-6">
                    <div class="card h-100">
                        <div class="card-body">
                            <h5 class="card-title">Insumos con Stock Crítico</h5>
                             <p class="text-muted small">Esta lista resalta los insumos cuyo nivel de stock actual ha caído por debajo del mínimo definido, requiriendo atención inmediata para evitar quiebres de stock.</p>
                            <div id="insumos-critico-table" class="mt-3" style="max-height: 350px; overflow-y: auto;"></div>
                            <div id="insumos-critico-summary" class="dynamic-summary mt-2 small p-2 bg-light rounded border"></div>
                        </div>
                    </div>
                </div>
                <div class="col-lg-6">
                    <div class="card h-100">
                        <div class="card-body">
                            <h5 class="card-title">Lotes de Insumos Próximos a Vencer</h5>
                            <p class="text-muted small">Esta tabla muestra los lotes de insumos que están a punto de vencer, ayudando a planificar su uso prioritario para minimizar pérdidas por caducidad.</p>
                            <div id="insumos-vencimiento-table" class="mt-3" style="max-height: 350px; overflow-y: auto;"></div>
                            <div id="insumos-vencimiento-summary" class="dynamic-summary mt-2 small p-2 bg-light rounded border"></div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Pestaña de Productos Terminados -->
        <div class="tab-pane fade" id="productos" role="tabpanel" aria-labelledby="productos-tab">
            <div class="row mt-3 g-3">
                 <div class="col-lg-6">
                    <div class="card h-100">
                        <div class="card-body">
                            <h5 class="card-title">Composición del Stock por Producto</h5>
                            <p class="text-muted small">Este gráfico de torta muestra la proporción de cada producto sobre el total del stock terminado, identificando los artículos con mayor presencia en el inventario.</p>
                            <div id="productos-composicion-chart" style="height: 400px;"></div>
                            <div id="productos-composicion-summary" class="dynamic-summary mt-2 small p-2 bg-light rounded border"></div>
                        </div>
                    </div>
                </div>
                <div class="col-lg-6">
                    <div class="card h-100">
                        <div class="card-body">
                            <div class="d-flex justify-content-between align-items-center">
                                <h5 class="card-title mb-0">Top Productos por Valor en Stock</h5>
                                <div class="d-flex align-items-center">
                                    <label for="top-n-productos" class="form-label me-2 mb-0">Mostrar Top:</label>
                                    <select id="top-n-productos" class="form-select form-select-sm" style="width: 70px;">
                                        <option value="5">5</option>
                                        <option value="10" selected>10</option>
                                        <option value="15">15</option>
                                    </select>
                                </div>
                            </div>
                            <p class="text-muted small">Presenta los productos terminados más valiosos en el inventario, ayudando a enfocar la atención en los activos más significativos.</p>
                            <div id="productos-valor-chart" style="height: 400px;"></div>
                            <div id="productos-valor-summary" class="dynamic-summary mt-2 small p-2 bg-light rounded border"></div>
                        </div>
                    </div>
                </div>
                <div class="col-lg-4">
                    <div class="card h-100">
                        <div class="card-body">
                            <h5 class="card-title">Distribución por Estado</h5>
                             <p class="text-muted small">Visualiza cómo se distribuye el stock de productos terminados entre los diferentes estados (Disponible, Reservado, etc.), ofreciendo una vista clara de la disponibilidad real.</p>
                            <div id="productos-distribucion-estado-chart" style="height: 400px;"></div>
                            <div id="productos-distribucion-summary" class="dynamic-summary mt-2 small p-2 bg-light rounded border"></div>
                        </div>
                    </div>
                </div>
                <div class="col-lg-8">
                    <div class="card h-100">
                        <div class="card-body">
                            <h5 class="card-title">Valor del Stock por Categoría</h5>
                             <p class="text-muted small">Este gráfico compara el valor monetario total del inventario para cada categoría de producto, ayudando a entender qué líneas de productos concentran mayor capital.</p>
                            <div id="productos-valor-categoria-chart" style="height: 400px;"></div>
                            <div id="productos-valor-categoria-summary" class="dynamic-summary mt-2 small p-2 bg-light rounded border"></div>
                        </div>
                    </div>
                </div>
                <div class="col-lg-6">
                    <div class="card h-100">
                        <div class="card-body">
                            <h5 class="card-title">Rotación de Productos (Últimos 30 días)</h5>
                            <p class="text-muted small">Muestra los productos más vendidos en el último mes, permitiendo identificar los artículos de alta demanda y optimizar las estrategias de producción y venta.</p>
                            <div id="productos-rotacion-chart" style="height: 400px;"></div>
                            <div id="productos-rotacion-summary" class="dynamic-summary mt-2 small p-2 bg-light rounded border"></div>
                        </div>
                    </div>
                </div>
                <div class="col-lg-6">
                    <div class="card h-100">
                        <div class="card-body">
                            <h5 class="card-title">Cobertura de Stock</h5>
                            <p class="text-muted small">Estima cuántos días de venta puede cubrir el stock actual de cada producto basándose en la demanda reciente, una métrica clave para la planificación de inventario.</p>
                            <div id="productos-cobertura-chart" style="height: 400px;"></div>
                            <div id="productos-cobertura-summary" class="dynamic-summary mt-2 small p-2 bg-light rounded border"></div>
                        </div>
                    </div>
                </div>
                <div class="col-lg-6">
                    <div class="card h-100">
                        <div class="card-body">
                            <h5 class="card-title">Productos con Bajo Stock</h5>
                            <p class="text-muted small">Enumera los productos cuyo inventario ha alcanzado su nivel mínimo o se ha agotado, alertando sobre la necesidad de reponer o producir más.</p>
                            <div id="productos-bajo-stock-table" class="mt-3" style="max-height: 350px; overflow-y: auto;"></div>
                            <div id="productos-bajo-stock-summary" class="dynamic-summary mt-2 small p-2 bg-light rounded border"></div>
                        </div>
                    </div>
                </div>
                <div class="col-lg-6">
                    <div class="card h-100">
                        <div class="card-body">
                            <h5 class="card-title">Lotes de Productos Próximos a Vencer</h5>
                            <p class="text-muted small">Identifica los lotes de productos terminados cercanos a su fecha de vencimiento para facilitar acciones comerciales que eviten su pérdida.</p>
                            <div id="productos-vencimiento-table" class="mt-3" style="max-height: 350px; overflow-y: auto;"></div>
                            <div id="productos-vencimiento-summary" class="dynamic-summary mt-2 small p-2 bg-light rounded border"></div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script src="https://cdn.jsdelivr.net/npm/echarts@5.4.0/dist/echarts.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
<script src="{{ url_for('static', filename='js/reportes/stock.js') }}?v=1.4"></script>
{% endblock %}
