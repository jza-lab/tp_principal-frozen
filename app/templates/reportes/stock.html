{% extends 'layouts/app_layout.html' %}

{% block title %}Reportes de Stock{% endblock %}

{% block extra_css %}
<style>
    @media print {
        .scrollable-table.printable-full-height {
            max-height: none !important;
            overflow-y: visible !important;
        }
    }
</style>
{% endblock %}

{% block app_content %}
<div class="container-fluid">
    <!-- Page Heading -->
    <div class="d-sm-flex align-items-center justify-content-between mb-4">
        <h1 class="h3 mb-0 text-gray-800">Reportes de Stock</h1>
        <button id="download-pdf" class="btn btn-primary shadow-sm" disabled><i
                class="fas fa-download fa-sm text-white-50"></i> Generar Reporte</button>
    </div>

    <!-- Nav Tabs -->
    <ul class="nav nav-tabs" id="stockTab" role="tablist">
        <li class="nav-item" role="presentation">
            <button class="nav-link active" id="insumos-tab" data-bs-toggle="tab" data-bs-target="#insumos" type="button"
                role="tab" aria-controls="insumos" aria-selected="true">Stock de Insumos</button>
        </li>
        <li class="nav-item" role="presentation">
            <button class="nav-link" id="productos-tab" data-bs-toggle="tab" data-bs-target="#productos" type="button"
                role="tab" aria-controls="productos" aria-selected="false">Stock de Productos</button>
        </li>
    </ul>

    <!-- Tab Content -->
    <div class="tab-content" id="stockTabContent">
        <!-- Insumos Tab Pane -->
        <div class="tab-pane fade show active" id="insumos" role="tabpanel" aria-labelledby="insumos-tab">
            <div class="row mt-4">
                <!-- Composición por Categoría -->
                <div class="col-xl-6 col-lg-12 mb-4">
                    <div class="card shadow">
                        <div class="card-header py-3">
                            <h6 class="m-0 font-weight-bold text-primary">Composición del Stock por Categoría</h6>
                        </div>
                        <div class="card-body">
                            <div id="insumos-composicion-chart" style="height: 350px;"></div>
                        </div>
                    </div>
                </div>
                <!-- Top N Insumos por Valor -->
                <div class="col-xl-6 col-lg-12 mb-4">
                    <div class="card shadow">
                        <div class="card-header py-3 d-flex flex-row align-items-center justify-content-between">
                            <h6 class="m-0 font-weight-bold text-primary">Top Insumos por Valor Total</h6>
                            <div class="form-group mb-0">
                                <select id="top-n-insumos" class="form-control form-control-sm">
                                    <option value="5">Top 5</option>
                                    <option value="10" selected>Top 10</option>
                                    <option value="15">Top 15</option>
                                    <option value="20">Top 20</option>
                                </select>
                            </div>
                        </div>
                        <div class="card-body">
                            <div id="insumos-valor-chart" style="height: 350px;"></div>
                        </div>
                    </div>
                </div>
            </div>
            <div class="row">
                <!-- Insumos con Stock Crítico -->
                <div class="col-lg-6 mb-4">
                    <div class="card shadow">
                        <div class="card-header py-3">
                            <h6 class="m-0 font-weight-bold text-danger">Insumos con Stock Crítico</h6>
                        </div>
                        <div class="card-body">
                            <p class="small text-muted">
                                Este gráfico muestra los insumos cuyo stock actual está por debajo del umbral mínimo definido. Las barras indican visualmente el nivel actual (azul) en relación con el mínimo (amarillo).
                            </p>
                            <div class="scrollable-table printable-full-height" style="max-height: 300px; overflow-y: auto;">
                                <div id="insumos-critico-table"></div>
                            </div>
                            <p class="small text-muted mt-2" id="insumos-critico-description"></p>
                        </div>
                    </div>
                </div>
                <!-- Lotes Próximos a Vencer -->
                <div class="col-lg-6 mb-4">
                    <div class="card shadow">
                        <div class="card-header py-3">
                            <h6 class="m-0 font-weight-bold text-warning">Lotes de Insumos Próximos a Vencer</h6>
                        </div>
                        <div class="card-body">
                            <div id="insumos-vencimiento-table"></div>
                        </div>
                    </div>
                </div>
            </div>
            <div class="row">
                <!-- Valor por Categoría de Producto -->
                <div class="col-lg-6 mb-4">
                    <div class="card shadow">
                        <div class="card-header py-3">
                            <h6 class="m-0 font-weight-bold text-info">Valor de Stock por Categoría de Producto</h6>
                        </div>
                        <div class="card-body">
                            <p class="small text-muted">Este gráfico muestra el valor monetario total del stock para cada categoría de producto terminado.</p>
                            <div id="productos-valor-categoria-chart" style="height: 350px;"></div>
                            <p class="small text-muted mt-2" id="productos-valor-categoria-description"></p>
                        </div>
                    </div>
                </div>
                <!-- Distribución por Estado -->
                <div class="col-lg-6 mb-4">
                    <div class="card shadow">
                        <div class="card-header py-3">
                            <h6 class="m-0 font-weight-bold text-success">Distribución de Stock por Estado</h6>
                        </div>
                        <div class="card-body">
                            <p class="small text-muted">Este gráfico de torta muestra la proporción del stock de productos según su estado actual (Disponible, Reservado, etc.).</p>
                            <div id="productos-distribucion-estado-chart" style="height: 350px;"></div>
                            <p class="small text-muted mt-2" id="productos-distribucion-estado-description"></p>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Productos Tab Pane -->
        <div class="tab-pane fade" id="productos" role="tabpanel" aria-labelledby="productos-tab">
            <div class="row mt-4">
                <!-- Composición por Producto -->
                <div class="col-xl-6 col-lg-12 mb-4">
                    <div class="card shadow">
                        <div class="card-header py-3">
                            <h6 class="m-0 font-weight-bold text-primary">Composición del Stock por Producto</h6>
                        </div>
                        <div class="card-body">
                            <div id="productos-composicion-chart" style="height: 350px;"></div>
                        </div>
                    </div>
                </div>
                <!-- Top N Productos por Valor -->
                <div class="col-xl-6 col-lg-12 mb-4">
                    <div class="card shadow">
                        <div class="card-header py-3 d-flex flex-row align-items-center justify-content-between">
                            <h6 class="m-0 font-weight-bold text-primary">Top Productos por Valor en Stock</h6>
                            <div class="form-group mb-0">
                                <select id="top-n-productos" class="form-control form-control-sm">
                                    <option value="5">Top 5</option>
                                    <option value="10" selected>Top 10</option>
                                    <option value="15">Top 15</option>
                                    <option value="20">Top 20</option>
                                </select>
                            </div>
                        </div>
                        <div class="card-body">
                            <div id="productos-valor-chart" style="height: 350px;"></div>
                        </div>
                    </div>
                </div>
            </div>
             <div class="row">
                <!-- Productos con Bajo Stock -->
                <div class="col-lg-6 mb-4">
                    <div class="card shadow">
                        <div class="card-header py-3">
                            <h6 class="m-0 font-weight-bold text-danger">Productos con Bajo Stock</h6>
                        </div>
                        <div class="card-body">
                            <div id="productos-bajo-stock-table"></div>
                        </div>
                    </div>
                </div>
                <!-- Lotes Próximos a Vencer -->
                <div class="col-lg-6 mb-4">
                    <div class="card shadow">
                        <div class="card-header py-3">
                            <h6 class="m-0 font-weight-bold text-warning">Lotes de Productos Próximos a Vencer</h6>
                        </div>
                        <div class="card-body">
                            <div id="productos-vencimiento-table"></div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script src="https://cdn.jsdelivr.net/npm/echarts@5.3.2/dist/echarts.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
<script src="{{ url_for('static', filename='js/reportes/stock.js') }}?v=1.1"></script>
{% endblock %}
