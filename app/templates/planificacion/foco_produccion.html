{% extends "layouts/app_layout.html" %}

{% block title %}Producción Activa: {{ orden.codigo }}{% endblock %}

{% block extra_css %}
    <link rel="stylesheet" href="{{ url_for('static', filename='css/planificacion/foco_produccion.css') }}">
{% endblock %}

{% block app_content %}
<div class="foco-container" id="foco-container" data-op-id="{{ orden.id }}">

    <!-- Banner de Traspaso Pendiente (colocado aquí) -->
    {% if traspaso_pendiente %}
    <div class="traspaso-banner" id="traspaso-banner">
        <div class="traspaso-banner-icon">
            <i class="bi bi-info-circle-fill"></i>
        </div>
        <div class="traspaso-banner-content">
            <h5 class="traspaso-banner-title">Traspaso de Turno Pendiente</h5>
            <p class="traspaso-banner-text">
                El operario <strong>{{ traspaso_pendiente.usuario_saliente.nombre }} {{ traspaso_pendiente.usuario_saliente.apellido }}</strong> ha dejado el siguiente reporte del turno anterior. Por favor, revísalo antes de continuar.
            </p>
            <div class="traspaso-detalles">
                <p><strong>Novedades/Problemas:</strong> {{ traspaso_pendiente.notas_novedades }}</p>
                <p><strong>Estado de Insumos:</strong> {{ traspaso_pendiente.notas_insumos or 'Sin notas.' }}</p>
            </div>
        </div>
        <div class="traspaso-banner-action">
            <button class="btn btn-success btn-lg" id="btn-aceptar-traspaso" data-traspaso-id="{{ traspaso_pendiente.id }}">
                <i class="bi bi-check-lg"></i> Aceptar Traspaso y Reanudar
            </button>
        </div>
    </div>
    {% endif %}
    
    <div class="pause-overlay" id="pause-overlay" style="display: none;">
        <div class="pause-overlay-content">
            <div class="pause-icon-container">
                <i class="bi bi-pause-circle-fill pause-icon-main"></i>
                <div class="pulse-ring"></div>
            </div>
            <h1 class="pause-title">PRODUCCIÓN PAUSADA</h1>
            <p class="pause-subtitle">El cronómetro está detenido</p>
            <div class="pause-info-card">
                <div class="pause-info-row">
                    <span class="pause-info-label">Motivo:</span>
                    <span class="pause-info-value" id="motivo-pausa-actual">Esperando reanudar...</span>
                </div>
                <div class="pause-info-row">
                    <span class="pause-info-label">Tiempo en pausa:</span>
                    <span class="pause-info-value" id="tiempo-pausa">00:00:00</span>
                </div>
            </div>
            <button class="btn btn-action btn-reanudar mt-4" id="btn-reanudar">
                <i class="bi bi-play-fill"></i>
                <span>Reanudar Producción</span>
            </button>
        </div>
    </div>

    <div class="foco-header">
        <div class="header-left">
            <a href="{{ url_for('produccion_kanban.tablero_produccion') }}" class="btn btn-back">
                <i class="bi bi-arrow-left"></i> Volver al Tablero
            </a>
        </div>
        
        <div class="header-center">
            <h2 class="header-title">Orden de Producción Activa</h2>
            <div class="header-badges">
                <span class="badge-status badge-active" id="status-badge">
                    <i class="bi bi-play-circle-fill"></i> EN PRODUCCIÓN
                </span>
                <span class="badge-line">
                    <i class="bi bi-diagram-3"></i> Línea {{ orden.linea_asignada or 'N/D' }}
                </span>
            </div>
        </div>

<!----        <div class="header-right">
            <button class="btn btn-help" title="Llamar al supervisor">
                <i class="bi bi-headset"></i>
            </button>
        </div> -->
    </div>

    <div class="foco-body">
        
        {#  Columna izquierda informacion de la orden #}
        <div class="foco-col foco-col-left">
            
            {# Card: Información del Producto #}
            <div class="card card-product">
                <div class="card-header-custom">
                    <i class="bi bi-box-seam"></i> INFORMACIÓN DEL PRODUCTO
                </div>
                <div class="card-body">
                    <h3 class="product-name">{{ orden.producto_nombre }}</h3>
                    <div class="product-code">
                        <i class="bi bi-upc-scan"></i> {{ orden.codigo }}
                    </div>
                    <div class="product-meta">
                        <div class="meta-item">
                            <span class="meta-label">Lote:</span>
                            <span class="meta-value">{{ orden.lote or 'AUTO' }}</span>
                        </div>
                        <div class="meta-item">
                            <span class="meta-label">Fecha Meta:</span>
                            <span class="meta-value">{{ orden.fecha_meta or 'N/D' }}</span>
                        </div>
                    </div>
                </div>
            </div>

            {# Card: Materiales / Receta #}
            <div class="card card-materials">
                <div class="card-header-custom">
                    <i class="bi bi-list-check"></i> MATERIALES CLAVE
                </div>
                <div class="card-body">
                    <div class="materials-list">
                        {% for ing in ingredientes %}
                        <div class="material-item">
                            <div class="material-icon">
                                <i class="bi bi-check-circle-fill"></i>
                            </div>
                            <div class="material-info">
                                <span class="material-name">{{ ing.nombre_insumo }}</span>
                                <span class="material-qty">{{ ing.cantidad }} {{ ing.unidad_medida }}</span>
                            </div>
                        </div>
                        {% else %}
                        <p class="text-muted text-center">Sin materiales definidos</p>
                        {% endfor %}
                    </div>
                </div>
            </div>

        </div>

        {#  Columna central: métricas y progreso #}
        <div class="foco-col foco-col-center">
            
            {# Panel: Objetivo de Producción #}
            <div class="objetivo-panel">
                <div class="objetivo-label">OBJETIVO DE PRODUCCIÓN</div>
                <div class="objetivo-cantidad">
                    {{ orden.cantidad_planificada }} <span class="objetivo-unidad">{{ orden.producto_unidad_medida }}</span>
                </div>
            </div>

            {# Panel: Progreso Actual (Grid 2x2) #}
            <div class="progreso-grid">
                <div class="progreso-card progreso-producido">
                    <div class="progreso-icon">
                        <i class="bi bi-check-circle-fill"></i>
                    </div>
                    <div class="progreso-content">
                        <div class="progreso-label">Producido (OK)</div>
                        <div class="progreso-value" id="cantidad-producida">
                            {{ orden.cantidad_producida or 0 }} <span class="progreso-unit">{{ orden.producto_unidad_medida }}</span>
                        </div>
                    </div>
                </div>

                <div class="progreso-card progreso-desperdicio">
                    <div class="progreso-icon">
                        <i class="bi bi-x-circle-fill"></i>
                    </div>
                    <div class="progreso-content">
                        <div class="progreso-label">Desperdicio</div>
                        <div class="progreso-value" id="cantidad-desperdicio">
                            0 <span class="progreso-unit">{{ orden.producto_unidad_medida }}</span>
                        </div>
                    </div>
                </div>

                <div class="progreso-card progreso-ritmo">
                    <div class="progreso-icon">
                        <i class="bi bi-speedometer2"></i>
                    </div>
                    <div class="progreso-content">
                        <div class="progreso-label">Ritmo Actual</div>
                        <div class="progreso-value" id="ritmo-actual">
                            0 <span class="progreso-unit">{{ orden.producto_unidad_medida }}/h</span>
                        </div>
                    </div>
                </div>

                <div class="progreso-card progreso-objetivo-ritmo">
                    <div class="progreso-icon">
                        <i class="bi bi-bullseye"></i>
                    </div>
                    <div class="progreso-content">
                        <div class="progreso-label">Ritmo Objetivo</div>
                        <div class="progreso-value">
                            {{ orden.ritmo_objetivo or 5 }} <span class="progreso-unit">{{ orden.producto_unidad_medida }}/h</span>
                        </div>
                    </div>
                </div>
            </div>

            {# Barra de Progreso Visual #}
            <div class="progress-container">
                <div class="progress-label-row">
                    <span>Progreso de la Orden</span>
                    <span id="porcentaje-progreso">0%</span>
                </div>
                <div class="progress-bar-custom">
                    <div class="progress-fill-custom" id="progress-bar" style="width: {% if orden.cantidad_planificada > 0 %}{{ ((orden.cantidad_producida or 0) / orden.cantidad_planificada) * 100 }}{% else %}0{% endif %}%;">
                        <div class="progress-shine"></div>
                    </div>
                </div>
            </div>

            {# Cronómetro Grande #}
            <div class="timer-panel">
                <div class="timer-label">TIEMPO DE TRABAJO</div>
                <div class="timer-display" id="timer">00:00:00</div>
                <div class="timer-sublabel">
                    <span id="timer-status">Cronómetro activo</span>
                </div>
            </div>

            {# Botones de Acción Principales #}
            {% if 'produccion_ejecucion' is has_permission %}
            <div class="action-buttons">
                <button class="btn btn-action btn-reportar" id="btn-reportar-avance" data-bs-toggle="modal" data-bs-target="#modalReportarAvance">
                    <i class="bi bi-clipboard-check-fill"></i>
                    <span>Reportar Avance</span>
                </button>
                <button class="btn btn-action btn-pausar" id="btn-pausar-reanudar" data-bs-toggle="modal" data-bs-target="#modalPausarProduccion">
                    <i class="bi bi-pause-fill"></i>
                    <span>Pausar Trabajo</span>
                </button>
                <button class="btn btn-action btn-warning text-dark" id="btn-reportar-merma" data-bs-toggle="modal" data-bs-target="#modalReportarMerma">
                    <i class="bi bi-trash-fill"></i>
                    <span>Reportar Merma</span>
                </button>
            </div>
            {% endif %}

        </div>

        {#  Columna derecha: métricas OEE y alertas #}
        <div class="foco-col foco-col-right">
            
            {# Card: OEE en Tiempo Real #}
            <div class="card card-oee">
                <div class="card-header-custom">
                    <i class="bi bi-graph-up-arrow"></i> MÉTRICAS OEE
                </div>
                <div class="card-body">
                    <div class="oee-main">
                        <div class="oee-label">OEE ACTUAL</div>
                        <div class="oee-value" id="oee-value">95<span class="oee-percent">%</span></div>
                    </div>
                    <div class="oee-components">
                        <div class="oee-component">
                            <div class="oee-comp-label">Disponibilidad</div>
                            <div class="oee-comp-bar">
                                <div class="oee-comp-fill" style="width: 98%; background: #10b981;"></div>
                            </div>
                            <div class="oee-comp-value">98%</div>
                        </div>
                        <div class="oee-component">
                            <div class="oee-comp-label">Rendimiento</div>
                            <div class="oee-comp-bar">
                                <div class="oee-comp-fill" style="width: 95%; background: #3b82f6;"></div>
                            </div>
                            <div class="oee-comp-value">95%</div>
                        </div>
                        <div class="oee-component">
                            <div class="oee-comp-label">Calidad</div>
                            <div class="oee-comp-bar">
                                <div class="oee-comp-fill" style="width: 100%; background: #8b5cf6;"></div>
                            </div>
                            <div class="oee-comp-value">100%</div>
                        </div>
                    </div>
                </div>
            </div>

            {# Card: Estado del Turno #}
            <div class="card card-shift">
                <div class="card-header-custom">
                    <i class="bi bi-clock-history"></i> INFORMACIÓN DEL TURNO
                </div>
                <div class="card-body">
                    <div class="shift-info">
                        <div class="shift-row">
                            <span class="shift-label">Turno Actual:</span>
                            <span class="shift-value">{{ turno_actual.nombre }} ({{ turno_actual.hora_inicio | format_time }} - {{ turno_actual.hora_fin | format_time }})</span>
                        </div>
                        <div class="shift-row">
                            <span class="shift-label">Operario:</span>
                            <span class="shift-value">{{ orden.operario_nombre or 'No asignado' }}</span>
                        </div>
                        <div class="shift-row">
                            <span class="shift-label">Tiempo restante:</span>
                            <span class="shift-value" id="tiempo-restante-turno">4h 32min</span>
                        </div>
                    </div>
                </div>
            </div>

            {# Card: Últimas Actividades / Log #}
            <div class="card card-activity">
                <div class="card-header-custom">
                    <i class="bi bi-activity"></i> REGISTRO DE ACTIVIDAD
                </div>
                <div class="card-body">
                    <div class="activity-list" id="activity-log">
                        <div class="activity-item">
                            <div class="activity-time">13:45</div>
                            <div class="activity-desc">
                                <i class="bi bi-play-fill text-success"></i>
                                Producción iniciada
                            </div>
                        </div>
                        <!-- Más actividades se agregarán dinámicamente -->
                    </div>
                </div>
            </div>

        </div>

    </div>
</div>

{% include 'planificacion/modals/modal_reportar_avance.html' %}
{% include 'planificacion/modals/modal_pausar_produccion.html' %}
{% include 'planificacion/modals/modal_traspaso_turno.html' %}

<!-- Modal Reportar Merma -->
<div class="modal fade" id="modalReportarMerma" tabindex="-1" aria-labelledby="modalReportarMermaLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header bg-warning text-dark">
                <h5 class="modal-title" id="modalReportarMermaLabel"><i class="bi bi-exclamation-triangle-fill me-2"></i>Reportar Merma de Insumo</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <p class="text-muted small mb-3">
                    Reporte la pérdida de insumos. El sistema ajustará el stock y la orden automáticamente.
                    <br>
                    <i class="bi bi-info-circle me-1"></i> Desperdicios guardados en tabla: <code>registros_desperdicio_lote_insumo</code>
                </p>
                
                <div class="table-responsive mb-3">
                    <table class="table table-sm table-bordered" id="tablaMermas">
                        <thead class="table-light">
                            <tr>
                                <th style="width: 35%;">Insumo</th>
                                <th style="width: 20%;">Cantidad Perdida</th>
                                <th style="width: 20%;">Motivo</th>
                                <th style="width: 20%;">Observación</th>
                                <th style="width: 5%;"></th>
                            </tr>
                        </thead>
                        <tbody id="tbodyMermas">
                            <!-- Filas dinámicas -->
                        </tbody>
                    </table>
                </div>
                
                <button type="button" class="btn btn-sm btn-outline-secondary mb-3" id="btnAgregarFilaMerma">
                    <i class="bi bi-plus-lg"></i> Agregar Insumo
                </button>

                <div id="mermaResultAlert" class="alert d-none mt-3" role="alert"></div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
                <button type="button" class="btn btn-warning" id="btnConfirmarMerma">Confirmar Reporte</button>
            </div>
        </div>
    </div>
</div>

<!-- Modal de Confirmación Genérico para OP Hija -->
<div class="modal fade" id="modalConfirmacionHija" tabindex="-1" aria-labelledby="modalConfirmacionHijaLabel" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="modalConfirmacionHijaLabel"><i class="bi bi-info-circle-fill me-2"></i>Aviso de Producción</h5>
            </div>
            <div class="modal-body" id="modalConfirmacionHijaBody" style="font-size: 1.1rem; text-align: center; padding: 2rem 1.5rem;">
                <!-- Mensaje se insertará dinámicamente -->
            </div>
            <div class="modal-footer" style="justify-content: center;">
                <button type="button" class="btn btn-primary btn-lg" id="btnConfirmacionHijaOk">Aceptar</button>
            </div>
        </div>
    </div>
</div>

{% endblock %}

{% block extra_js %}
    <script>
        // Pasar datos del backend al script de JS
        const ORDEN_ID = {{ orden.id | tojson }};
        const ORDEN_FECHA_INICIO = {{ orden.fecha_inicio | tojson }};
        const ORDEN_CANTIDAD_PLANIFICADA = {{ orden.cantidad_planificada | tojson }};
        const ORDEN_TOTAL_DESPERDICIO = {{ orden.total_desperdicio | tojson }};
        const ORDEN_RITMO_OBJETIVO = {{ orden.ritmo_objetivo or 5 | tojson }};
        const MOTIVOS_PARO = {{ motivos_paro | tojson }};
        const MOTIVOS_DESPERDICIO = {{ motivos_desperdicio | tojson }};
        const TOLERANCIA_SOBREPRODUCCION = {{ tolerancia_sobreproduccion | tojson }};
        const TURNO_ACTUAL = {{ turno_actual | tojson }};
        const INGREDIENTES_DATA = {{ ingredientes | tojson }}; // Nuevo: Ingredientes con cantidades totales
        const MOTIVOS_MERMA_DATA = {{ motivos_merma | tojson }}; // Nuevo: Motivos para el JS

        document.addEventListener('DOMContentLoaded', function() {
            const tbodyMermas = document.getElementById('tbodyMermas');
            const btnAgregarFila = document.getElementById('btnAgregarFilaMerma');
            const btnConfirmarMerma = document.getElementById('btnConfirmarMerma');
            const alertBox = document.getElementById('mermaResultAlert');

            // Función para crear una fila vacía
            function agregarFila() {
                const tr = document.createElement('tr');
                
                // Opciones de Insumos
                let insumoOptions = '<option value="" selected disabled>Seleccione...</option>';
                INGREDIENTES_DATA.forEach(ing => {
                    if (ing.id_insumo) {
                        // Guardamos el total requerido en data attribute
                        insumoOptions += `<option value="${ing.id_insumo}" data-max="${ing.cantidad_total_requerida || 999999}" data-unit="${ing.unidad_medida}">${ing.nombre_insumo}</option>`;
                    }
                });

                // Opciones de Motivos
                let motivoOptions = '<option value="" selected disabled>Seleccione...</option>';
                MOTIVOS_MERMA_DATA.forEach(m => {
                    motivoOptions += `<option value="${m.id}">${m.descripcion}</option>`;
                });

                tr.innerHTML = `
                    <td>
                        <select class="form-select form-select-sm insumo-select" required onchange="updateMaxQuantity(this)">
                            ${insumoOptions}
                        </select>
                        <small class="text-muted max-helper" style="font-size: 0.75rem;"></small>
                    </td>
                    <td>
                        <div class="input-group input-group-sm">
                            <input type="number" class="form-control cantidad-input" step="0.01" min="0.01" required>
                            <span class="input-group-text unit-text">-</span>
                        </div>
                    </td>
                    <td>
                        <select class="form-select form-select-sm motivo-select" required>
                            ${motivoOptions}
                        </select>
                    </td>
                    <td>
                        <input type="text" class="form-control form-select-sm observacion-input" placeholder="...">
                    </td>
                    <td class="text-center align-middle">
                        <button type="button" class="btn btn-outline-danger btn-sm border-0" onclick="this.closest('tr').remove()">
                            <i class="bi bi-trash"></i>
                        </button>
                    </td>
                `;
                tbodyMermas.appendChild(tr);
            }

            // Evento para actualizar visualmente el máximo y la unidad
            window.updateMaxQuantity = function(selectElement) {
                const selectedOption = selectElement.options[selectElement.selectedIndex];
                const maxQty = selectedOption.getAttribute('data-max');
                const unit = selectedOption.getAttribute('data-unit');
                const row = selectElement.closest('tr');
                
                const inputQty = row.querySelector('.cantidad-input');
                const unitText = row.querySelector('.unit-text');
                const helperText = row.querySelector('.max-helper');

                if (maxQty) {
                    inputQty.max = maxQty;
                    unitText.innerText = unit || 'u';
                    helperText.innerText = `Max desperdiciable: ${maxQty} ${unit || ''}`;
                } else {
                    inputQty.removeAttribute('max');
                    unitText.innerText = '-';
                    helperText.innerText = '';
                }
            };

            // Agregar primera fila al cargar modal (opcional, o dejar vacío)
            // agregarFila(); 

            if (btnAgregarFila) {
                btnAgregarFila.addEventListener('click', agregarFila);
            }

            // Inicializar con una fila al abrir el modal si está vacío
            const modalElement = document.getElementById('modalReportarMerma');
            modalElement.addEventListener('shown.bs.modal', function () {
                if (tbodyMermas.children.length === 0) {
                    agregarFila();
                }
            });

            if (btnConfirmarMerma) {
                btnConfirmarMerma.addEventListener('click', function() {
                    const rows = tbodyMermas.querySelectorAll('tr');
                    const mermas = [];
                    let valid = true;

                    if (rows.length === 0) {
                        alert("Debe agregar al menos un insumo.");
                        return;
                    }

                    rows.forEach(row => {
                        const insumoId = row.querySelector('.insumo-select').value;
                        const cantidad = parseFloat(row.querySelector('.cantidad-input').value);
                        const motivoId = row.querySelector('.motivo-select').value;
                        const observacion = row.querySelector('.observacion-input').value;
                        const maxQty = parseFloat(row.querySelector('.cantidad-input').max);

                        if (!insumoId || !cantidad || !motivoId) {
                            valid = false;
                            row.classList.add('table-danger'); // Highlight error
                        } else {
                            row.classList.remove('table-danger');
                        }

                        if (cantidad > maxQty) {
                            alert(`La cantidad para un insumo excede el máximo permitido (${maxQty}).`);
                            valid = false;
                            return;
                        }

                        mermas.push({
                            insumo_id: insumoId,
                            cantidad_perdida: cantidad,
                            motivo_id: motivoId,
                            observacion: observacion
                        });
                    });

                    if (!valid) {
                        alert('Por favor complete todos los campos obligatorios correctamente.');
                        return;
                    }

                    btnConfirmarMerma.disabled = true;
                    btnConfirmarMerma.innerHTML = '<span class="spinner-border spinner-border-sm" role="status" aria-hidden="true"></span> Procesando...';
                    alertBox.classList.add('d-none');
                    alertBox.className = 'alert d-none mt-3';

                    fetch(`/ordenes/${ORDEN_ID}/reportar-merma`, {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                            'X-CSRFToken': "{{ csrf_token() }}"
                        },
                        body: JSON.stringify({ mermas: mermas }) // Enviar array dentro de objeto
                    })
                    .then(response => response.json())
                    .then(data => {
                        alertBox.classList.remove('d-none');
                        if (data.success) {
                            alertBox.classList.add('alert-success');
                            alertBox.innerText = data.message;
                            
                            if (data.data && data.data.escenario) {
                                const escenario = data.data.escenario;
                                let badgeClass = 'bg-info';
                                if (escenario === 'RESET') badgeClass = 'bg-danger';
                                if (escenario === 'PARCIAL') badgeClass = 'bg-warning text-dark';
                                alertBox.innerHTML += `<br><span class="badge ${badgeClass} mt-2">Escenario Global: ${escenario}</span>`;
                            }

                            setTimeout(() => {
                                window.location.reload();
                            }, 3000);
                        } else {
                            alertBox.classList.add('alert-danger');
                            alertBox.innerText = data.error || 'Error al reportar merma.';
                            btnConfirmarMerma.disabled = false;
                            btnConfirmarMerma.innerText = 'Confirmar Reporte';
                        }
                    })
                    .catch(error => {
                        console.error('Error:', error);
                        alertBox.classList.remove('d-none');
                        alertBox.classList.add('alert-danger');
                        alertBox.innerText = 'Error de conexión al servidor.';
                        btnConfirmarMerma.disabled = false;
                        btnConfirmarMerma.innerText = 'Confirmar Reporte';
                    });
                });
            }
        });
    </script>
    <script src="{{ url_for('static', filename='js/planificacion/foco_produccion.js', v='1.2') }}"></script>
    <script src="{{ url_for('static', filename='js/planificacion/traspaso_turno.js') }}?v=1.0"></script>
{% endblock %}