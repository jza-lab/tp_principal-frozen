{% extends 'layouts/base.html' %}

{% block title %}Tablero de Planificación - Sistema Frozen{% endblock %}

{% block extra_css %}
<style>
    /* Estilos básicos para el tablero Kanban */
    .kanban-board {
        display: flex;
        gap: 1.5rem;
        overflow-x: auto;
        padding-bottom: 1.5rem;
    }
    .kanban-column {
        flex: 1 1 320px;
        min-width: 320px;
        background-color: #f8f9fa;
        border-radius: 0.75rem;
        border: 1px solid #dee2e6;
    }
    .column-header {
        padding: 1rem;
        border-bottom: 1px solid #dee2e6;
        font-weight: 600;
        display: flex;
        justify-content: space-between;
        align-items: center;
    }
    .kanban-cards {
        padding: 1rem;
        min-height: 400px; /* Espacio para arrastrar tarjetas */
        display: flex;
        flex-direction: column;
        gap: 1rem;
    }
    .kanban-card {
        cursor: grab;
        position: relative; /* Necesario para posicionar el checkbox */
    }

    /* --- ESTILOS PARA LA CONSOLIDACIÓN (FASE 2) --- */
    .card-checkbox {
        position: absolute;
        top: 0.5rem;
        right: 0.5rem;
        z-index: 10;
    }
    .card-checkbox .form-check-input {
        transform: scale(1.4); /* Hace el checkbox más grande y fácil de clickear */
        cursor: pointer;
    }
    #btn-consolidar {
        transition: all 0.2s ease-in-out;
    }

    /* --- ESTILOS PARA DRAG-AND-DROP (FASE 4) --- */
    .kanban-card:hover {
        box-shadow: 0 4px 8px rgba(0,0,0,0.1);
        transform: translateY(-2px);
        transition: all 0.2s ease;
    }
    .bg-primary-soft { /* Clase para el "fantasma" de la tarjeta al arrastrar */
        background-color: rgba(13, 110, 253, 0.1);
        border: 2px dashed rgba(13, 110, 253, 0.5);
    }
</style>
{% endblock %}

{% block content %}
<div class="d-flex justify-content-between flex-wrap flex-md-nowrap align-items-center pb-2 mb-4 border-bottom">
    <div>
        <h1 class="h2 mb-1">Tablero de Planificación</h1>
        <p class="text-muted mb-0">Vista en tiempo real del estado de la producción.</p>
    </div>
</div>

<div class="kanban-board">
    {% for estado_key, titulo_columna in columnas.items() %}
    <div class="kanban-column" data-estado="{{ estado_key }}">
        <div class="column-header">
            <span>{{ titulo_columna }}</span>
            <span class="badge bg-secondary rounded-pill">{{ ordenes_por_estado.get(estado_key, [])|length }}</span>
        </div>
        <div class="kanban-cards">

            {% if estado_key == 'LISTA PARA PRODUCIR' %}
            <div class="d-grid">
                <button id="btn-consolidar" class="btn btn-success mb-2" disabled>
                    <i class="bi bi-plus-slash-minus"></i> Consolidar Seleccionadas
                </button>
            </div>
            {% endif %}

            {% for orden in ordenes_por_estado.get(estado_key, []) %}
            <div class="card insumo-card kanban-card" data-op-id="{{ orden.id }}" data-producto-id="{{ orden.producto_id }}">

                {% if estado_key == 'LISTA PARA PRODUCIR' %}
                <div class="form-check card-checkbox">
                    <input class="form-check-input op-checkbox" type="checkbox" value="{{ orden.id }}">
                </div>
                {% endif %}

                <div class="card-body">
                    <div class="d-flex justify-content-between">
                        <h5 class="card-title mb-1">{{ orden.producto_nombre or 'N/A' }}</h5>
                        {% if orden.prioridad and orden.prioridad != 'NORMAL' %}
                            {% set p_config = {'ALTA': 'warning', 'URGENTE': 'danger'}.get(orden.prioridad, 'secondary') %}
                            <span class="badge bg-{{ p_config }}-soft text-{{ p_config }}">{{ orden.prioridad }}</span>
                        {% endif %}
                    </div>
                    <div class="card-secondary-details">
                        <span><i class="bi bi-upc-scan"></i> <code>{{ orden.codigo }}</code></span>
                        <span><i class="bi bi-box-seam"></i> <b>{{ orden.cantidad_planificada }}</b> unidades</span>
                        <span><i class="bi bi-calendar-event"></i> {{ orden.fecha_planificada }}</span>
                    </div>
                </div>
            </div>
            {% endfor %}
        </div>
    </div>
    {% endfor %}
</div>
{% endblock %}

{% block extra_js %}
<script src="https://cdn.jsdelivr.net/npm/sortablejs@latest/Sortable.min.js"></script>

<script>
    // --- FUNCIÓN HELPER (FASE 3 y 4) ---
    // Actualiza el estado de una OP. Usada por la recomendación y el drag-and-drop.
    async function moverOp(opId, nuevoEstado) {
        try {
            const response = await fetch(`/planificacion/api/mover-op/${opId}`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ nuevo_estado: nuevoEstado })
            });
            const result = await response.json();
            if (!result.success) {
                alert(`Hubo un error al mover la OP: ${result.error}`);
            }
            return result.success;
        } catch (error) {
            console.error('Error de red al mover la OP:', error);
            alert('Error de conexión. No se pudo guardar el cambio.');
            return false;
        }
    }

    document.addEventListener('DOMContentLoaded', function () {
        
        // --- LÓGICA DE CONSOLIDACIÓN Y RECOMENDACIÓN (FASE 2 y 3) ---
        const consolidarBtn = document.getElementById('btn-consolidar');
        if (consolidarBtn) {
            const checkboxes = document.querySelectorAll('.op-checkbox');

            function checkSelection() {
                const seleccionados = document.querySelectorAll('.op-checkbox:checked');
                if (seleccionados.length < 2) {
                    consolidarBtn.disabled = true;
                    return;
                }
                const primerProductoId = seleccionados[0].closest('.kanban-card').dataset.productoId;
                const sonMismoProducto = Array.from(seleccionados).every(cb => 
                    cb.closest('.kanban-card').dataset.productoId === primerProductoId
                );
                consolidarBtn.disabled = !sonMismoProducto;
            }

            checkboxes.forEach(cb => cb.addEventListener('change', checkSelection));

            consolidarBtn.addEventListener('click', async () => {
                const seleccionados = document.querySelectorAll('.op-checkbox:checked');
                const opIds = Array.from(seleccionados).map(cb => cb.value);

                if (!confirm(`¿Estás seguro de que quieres consolidar ${opIds.length} órdenes?`)) return;

                consolidarBtn.disabled = true;
                consolidarBtn.innerHTML = `<span class="spinner-border spinner-border-sm"></span> Consolidando...`;

                try {
                    const responseConsolidacion = await fetch('/planificacion/api/consolidar', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ op_ids: opIds })
                    });
                    const resultConsolidacion = await responseConsolidacion.json();
                    if (!resultConsolidacion.success) throw new Error(resultConsolidacion.error);

                    const nuevaSuperOP = resultConsolidacion.data;
                    alert(`¡Éxito! Super OP creada: ${nuevaSuperOP.codigo}`);

                    const responseRecomendacion = await fetch(`/planificacion/api/recomendar-linea/${nuevaSuperOP.id}`);
                    const resultRecomendacion = await responseRecomendacion.json();
                    if (resultRecomendacion.success) {
                        const rec = resultRecomendacion.data;
                        const msg = `RECOMENDACIÓN:\nLínea: ${rec.nombre_linea}\nMotivo: ${rec.motivo}\n\nPresiona "Aceptar" para usarla o "Cancelar" para la otra.`;
                        if (confirm(msg)) {
                            await moverOp(nuevaSuperOP.id, `EN LINEA ${rec.linea_sugerida}`);
                        } else {
                            await moverOp(nuevaSuperOP.id, `EN LINEA ${rec.linea_sugerida === 1 ? 2 : 1}`);
                        }
                    } else {
                         alert('Super OP creada, pero no se pudo obtener recomendación.');
                    }
                } catch (error) {
                    console.error('Error en el proceso:', error);
                    alert('Error: ' + error.message);
                } finally {
                    window.location.reload();
                }
            });
        }
        
        // --- LÓGICA DE DRAG-AND-DROP (FASE 4) ---
        const columns = document.querySelectorAll('.kanban-column');
        columns.forEach(column => {
            new Sortable(column.querySelector('.kanban-cards'), {
                group: 'kanban',
                animation: 150,
                ghostClass: 'bg-primary-soft',
                onEnd: async function (evt) {
                    const item = evt.item;
                    const toColumn = evt.to.closest('.kanban-column');
                    const opId = item.dataset.opId;
                    const nuevoEstado = toColumn.dataset.estado;

                    console.log(`Moviendo OP #${opId} a estado: ${nuevoEstado}`);
                    const success = await moverOp(opId, nuevoEstado);

                    if (!success) {
                        // Si la API falla, devolvemos la tarjeta a su columna original
                        evt.from.appendChild(item); 
                    }
                }
            });
        });
    });
</script>
{% endblock %}