{% extends 'layouts/app_layout.html' %}

{% block title %}Centro de Planificaci√≥n - Sistema Frozen{% endblock %}

{% block extra_css %}
    <link rel="stylesheet" href="{{ url_for('static', filename='css/planificacion/planificacion.css') }}">
    
    {# --- ESTILOS MOVIDOS DE VUELTA AQU√ç --- #}
    <style>
        /* Estilos generales (navegaci√≥n, cards, etc.) */
        .navegacion-semanal-separada { display: flex; justify-content: space-between; align-items: center; margin-bottom: 0; padding: 0.5rem 1rem; background-color: #f8f9fa; border: 1px solid #dee2e6; border-bottom: none; border-top-left-radius: 0.75rem; border-top-right-radius: 0.75rem; }
        #accordionSemanal .accordion-item:first-of-type .accordion-button,
        #accordionCRP .accordion-item:first-of-type .accordion-button { border-top-left-radius: 0; border-top-right-radius: 0; }
        #accordionSemanal .accordion-header,
        #accordionCRP .accordion-header { margin-top: 0; }
        .card-assignment-details { font-size: 0.8rem; }
        .card-assignment-details span { display: inline-block; margin-right: 0.5rem; }
        .celda-sugerencia-agregada { white-space: normal; line-height: 1.4; }
        .tabla-detalle-op-revision { font-size: 0.9em; background-color: #fdfdfd; }

        /* --- NUEVOS ESTILOS PARA PESTA√ëAS --- */
        /* Estilo para que las pesta√±as se parezcan a tus im√°genes de ejemplo */
        .nav-tabs .nav-link {
            border: 1px solid #dee2e6;
            border-bottom: none;
            background-color: #f8f9fa;
            color: #6c757d; /* Color de texto gris */
            margin-bottom: -1px; /* Solapamiento ligero */
        }
        .nav-tabs .nav-link.active {
            background-color: #ffffff; /* Fondo blanco para la activa */
            color: #0d6efd; /* Color primario para la activa */
            border-bottom: 1px solid #ffffff; /* Ocultar el borde inferior */
            position: relative;
        }
        .tab-content {
            border: 1px solid #dee2e6;
            border-top: none; /* El borde superior lo maneja la pesta√±a */
            padding: 1.5rem; /* A√±adir padding interno */
            background-color: #ffffff;
            border-bottom-left-radius: 0.5rem;
            border-bottom-right-radius: 0.5rem;
        }
        /* --- FIN NUEVOS ESTILOS --- */
    </style>
{% endblock %}

{% block app_content %}
<div class="btn-toolbar mb-2">
    <a href="#" onclick="history.back();" class="btn btn-outline-secondary me-2" title="Volver a la p√°gina anterior">
        <i class="bi bi-arrow-left"></i> Volver
    </a>
    {# --- INICIO: BOT√ìN A√ëADIDO --- #}
    {# Asumimos un permiso 'forzar_auto_planificacion'. Si es otro, aj√∫stalo. #}
    {# --- ¬°NUEVO BOT√ìN DE NOTIFICACIONES! --- #}
    <button class="btn btn-outline-secondary position-relative ms-auto" type="button" 
            data-bs-toggle="offcanvas" data-bs-target="#notificationOffcanvas" 
            aria-controls="notificationOffcanvas" title="Ver notificaciones del sistema">
        <i class="bi bi-bell-fill"></i>
        
        {# El contador solo aparece si hay notificaciones #}
        {% if planning_notifications %}
        <span class="position-absolute top-0 start-100 translate-middle badge rounded-pill bg-danger">
            {{ planning_notifications | length }}
            <span class="visually-hidden">Avisos sin leer</span>
        </span>
        {% endif %}
    </button>
    {# --- FIN NUEVO BOT√ìN --- #}
    <button type="button" class="btn btn-primary ms-2" id="btn-forzar-auto-planificacion" title="Ejecutar la planificaci√≥n autom√°tica de OPs PENDIENTES ahora">
        <i class="bi bi-robot me-1"></i> Forzar Auto-Planificaci√≥n
    </button>

    <button type="button" class="btn btn-warning ms-2" id="btn-forzar-verificacion-capacidad" title="Verificar capacidad y replanificar conflictos AHORA">
        <i class="bi bi-shield-fill-exclamation me-1"></i> Forzar Verificaci√≥n
    </button>
    
    {# --- FIN: BOT√ìN A√ëADIDO --- #}
    {# --- ¬°NUEVO BOT√ìN DE CONFIGURACI√ìN! --- #}
    {# Asumimos un permiso de 'admin' o 'configurar_planificacion' #}
    <a href="{{ url_for('planificacion.configuracion_lineas') }}" class="btn btn-outline-info ms-2" title="Configurar capacidad y bloqueos de l√≠neas">
        <i class="bi bi-gear-fill me-1"></i> Configurar L√≠neas
    </a>
    {# --- FIN NUEVO BOT√ìN --- #}
</div>
<div class="d-flex justify-content-between flex-wrap flex-md-nowrap align-items-center pb-2 mb-4 border-bottom">
    <div>
        <h1 class="h2 mb-1">Centro de Planificaci√≥n</h1>
        <p class="text-muted mb-0">Planifique OPs pendientes, vea la semana y gestione el tablero.</p>
    </div>
</div>

{# --- ¬°NUEVO PANEL DE ISSUES DE PLANIFICACI√ìN! --- #}
{# --- {% if planning_issues and 'admin' is has_permission %}  ---#}
<div class="accordion mb-4" id="accordionIssues">
    <div class="accordion-item border-danger">
        <h2 class="accordion-header" id="headingIssues">
            <button class="accordion-button bg-danger-subtle text-danger-emphasis" type="button" data-bs-toggle="collapse" data-bs-target="#collapseIssues" aria-expanded="true" aria-controls="collapseIssues">
                <div class="d-flex align-items-center w-100">
                    <i class="bi bi-exclamation-triangle-fill fs-5 me-3"></i>
                    <div class="flex-grow-1">
                        <span class="fw-semibold">Planificaci√≥n (Atenci√≥n Requerida)</span>
                        <small class="d-block">OPs que fallaron en la planificaci√≥n autom√°tica.</small>
                    </div>
                    <div class="badge bg-danger rounded-pill">
                        {{ planning_issues | length }} Issue{% if planning_issues | length != 1 %}s{% endif %}
                    </div>
                </div>
            </button>
        </h2>
        <div id="collapseIssues" class="accordion-collapse collapse show" aria-labelledby="headingIssues" data-bs-parent="#accordionIssues">
            <div class="accordion-body p-0">
                <table class="table table-sm table-hover align-middle mb-0">
                    <thead class="table-light">
                        <tr>
                            <th>OP</th>
                            <th>Producto</th>
                            <th class="text-center">Cant.</th>
                            <th class="text-center">Fecha Meta</th>
                            <th>Error Detectado</th>
                            <th class="text-center">Acci√≥n</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for issue in planning_issues %}
                        <tr>
                            <td><code>{{ issue.op_codigo }}</code></td>
                            <td>{{ issue.op_producto_nombre }}</td>
                            <td class="text-center">{{ issue.op_cantidad | round(1) }}</td>
                            <td class="text-center text-danger fw-bold">
                                {{ issue.op_fecha_meta.split('T')[0].split(' ')[0] }}
                            </td>
                            <td class="text-warning-emphasis">
                                <i class="bi bi-exclamation-triangle me-1"></i>
                                
                                {# --- INICIO DE LA CORRECCI√ìN --- #}
                                {# Traducimos la clave de error al espa√±ol #}
                                {% set error_key = issue.tipo_error %}
                                {% if error_key == 'LATE_CONFIRM' %}
                                    <strong>RETRASO CONFIRMADO:</strong>
                                {% elif error_key == 'SOBRECARGA_CAPACIDAD' %}
                                    <strong>SOBRECARGA DE CAPACIDAD:</strong>
                                {# --- ¬°A√ëADE ESTE BLOQUE! --- #}
                                {% elif error_key == 'REPLAN_AUTO_AUSENCIA' %}
                                <strong class="text-info"><i class="bi bi-arrow-right-circle-fill me-1"></i>RE-PLANIFICADO (AUTO):</strong>
                                {% elif error_key == 'SOBRECARGA_INMINENTE' %}
                                <strong class="text-danger"><i class="bi bi-shield-fill-exclamation me-1"></i>ERROR DE CAPACIDAD:</strong>
                                {# --- FIN DEL BLOQUE --- #}
                                {% else %}
                                    {# Fallback por si hay otros errores #}
                                    <strong>{{ error_key.replace('_', ' ') }}:</strong>
                                {% endif %}
                                {# --- FIN DE LA CORRECCI√ìN --- #}
                                
                                <span class="text-muted">{{ issue.mensaje }}</span>
                            </td>
                            <td class="text-center">
                                <button class="btn btn-sm btn-outline-primary w-100 btn-open-replan-modal" data-op-id='{{ issue.orden_produccion_id }}'
                                    data-op-codigo='{{ issue.op_codigo }}' data-op-producto='{{ issue.op_producto_nombre | e }}'
                                    data-op-cantidad='{{ issue.op_cantidad }}'
                                    data-op-linea='{{ issue.datos_snapshot.get("asignaciones_confirmar", {}).get("linea_asignada") | default(issue.op_linea_sugerida, true) }}'
                                    data-op-fecha-inicio='{{ issue.sugerencias_jit.sugerencia_fecha_inicio_jit | default(issue.datos_snapshot.get("fecha_nueva")) | default(issue.datos_snapshot.get("asignaciones_confirmar", {}).get("fecha_inicio")) }}'
                                    data-op-supervisor='' data-op-operario='' {# --- ¬°VERIFICA ESTAS L√çNEAS! --- #}
                                    data-sug-t-prod-dias='{{ issue.sugerencias_jit.sugerencia_t_prod_dias | default(0) }}'
                                    data-sug-t-proc-dias='{{ issue.sugerencias_jit.sugerencia_t_proc_dias | default(0) }}'
                                    data-sug-stock-ok='{{ 1 if issue.sugerencias_jit.sugerencia_stock_ok else 0 }}'
                                    data-sug-fecha-jit='{{ issue.sugerencias_jit.sugerencia_fecha_inicio_jit | default("") }}'>
                                    <i class="bi bi-calendar-range me-1"></i> Re-Planificar
                                </button>
                            </td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
        </div>
    </div>
</div>
{# --- {% endif %} --- #}
{# --- FIN NUEVO PANEL --- #}


<ul class="nav nav-tabs" id="planificacionTab" role="tablist">
    <li class="nav-item" role="presentation">
        <button class="nav-link active" id="semanal-crp-tab" data-bs-toggle="tab" data-bs-target="#semanal-crp-pane" type="button" role="tab" aria-controls="semanal-crp-pane" aria-selected="true">
            <i class="bi bi-calendar-week me-1"></i> Planificaci√≥n Semanal y CRP
        </button>
    </li>
    {% if current_user.rol != 'OPERARIO' and current_user.rol != 'SUPERVISOR_CALIDAD' %}
    <li class="nav-item" role="presentation">
        <button class="nav-link" id="maestro-tab" data-bs-toggle="tab" data-bs-target="#maestro-pane" type="button" role="tab" aria-controls="maestro-pane" aria-selected="false">
            <i class="bi bi-clipboard-data me-1"></i> Plan Maestro (Pendientes)
        </button>
    </li>
    {% endif %}
</ul>

<div class="tab-content" id="planificacionTabContent">
    
    <div class="tab-pane fade show active" id="semanal-crp-pane" role="tabpanel" aria-labelledby="semanal-crp-tab" tabindex="0">
        
        <div class="navegacion-semanal-separada mt-3"> <div class="d-flex align-items-center">
                <a href="{{ url_for('planificacion.index', horizonte=mps_data.dias_horizonte, semana=semana_anterior_str) if semana_anterior_str else '#' }}" 
                   class="btn btn-sm btn-outline-secondary me-2 {{ 'disabled' if not semana_anterior_str }}">
                    <i class="bi bi-chevron-left"></i> Semana Anterior
                </a>
                <span class="fw-bold fs-5 text-primary">Semana {{ semana_actual_str }}</span>
                <a href="{{ url_for('planificacion.index', horizonte=mps_data.dias_horizonte, semana=semana_siguiente_str) if semana_siguiente_str else '#' }}" 
                   class="btn btn-sm btn-outline-secondary ms-2 {{ 'disabled' if not semana_siguiente_str }}">
                    Pr√≥xima Semana <i class="bi bi-chevron-right"></i>
                </a>
            </div>
            <div class="text-muted small">
                <i class="bi bi-info-circle me-1"></i>Visualizando planificaci√≥n semanal
            </div>
        </div>

        {% set dias_lista = ['Lun', 'Mar', 'Mi√©', 'Jue', 'Vie', 'S√°b', 'Dom'] %}
        {% set semana_definida = False %}
        {% if inicio_semana and fin_semana %}
            {% set fecha_inicio = date.fromisoformat(inicio_semana) %}
            {% set fecha_fin = date.fromisoformat(fin_semana) %}
            {% set num_dias = (fecha_fin - fecha_inicio).days + 1 %}
            {% set semana_definida = True %}
        {% endif %}

        <div class="accordion mb-4" id="accordionSemanal"> <div class="accordion-item">
                <h2 class="accordion-header" id="headingSemanal">
                    <button class="accordion-button collapsed bg-primary-subtle" type="button" data-bs-toggle="collapse" data-bs-target="#collapseSemanal" aria-expanded="false" aria-controls="collapseSemanal">
                        <div class="d-flex align-items-center w-100">
                            <i class="bi bi-calendar-week fs-5 me-3 text-primary-emphasis"></i>
                            <div class="flex-grow-1">
                                <span class="fw-semibold">Planificaci√≥n Semanal - Vista Detallada</span>
                                <small class="text-muted d-block">Distribuci√≥n de √ìrdenes de Producci√≥n por d√≠a de la semana</small>
                            </div>
                            <div class="badge bg-primary rounded-pill">
                                {{ ordenes_por_dia.values() | map('length') | sum }} OPs totales
                            </div>
                        </div>
                    </button>
                </h2>
                <div id="collapseSemanal" class="accordion-collapse collapse" aria-labelledby="headingSemanal" data-bs-parent="#accordionSemanal">
                    <div class="accordion-body p-0">
                        <div class="bg-light py-2 px-3 border-bottom">
                            <div class="row align-items-center">
                                <div class="col">
                                    <small class="text-muted">
                                        <i class="bi bi-lightbulb me-1"></i>
                                        Haga clic en cualquier OP para ver detalles
                                    </small>
                                </div>
                                <div class="col-auto">
                                    <span class="badge bg-success me-2">
                                        <i class="bi bi-check-circle me-1"></i>L√≠nea Asignada
                                    </span>
                                    <span class="badge bg-warning me-2">
                                        <i class="bi bi-person me-1"></i>Operario Asignado
                                    </span>
                                </div>
                            </div>
                        </div>
                        
                        <div class="row g-2 m-2">
                            {% if not semana_definida or not ordenes_por_dia %}
                            <div class="col-12">
                                <div class="text-center py-5">
                                    <i class="bi bi-inbox display-4 text-muted"></i>
                                    <h5 class="text-muted mt-3">No hay OPs programadas para esta semana</h5>
                                    <p class="text-muted">Las √≥rdenes de producci√≥n aparecer√°n aqu√≠ cuando sean planificadas.</p>
                                </div>
                            </div>
                            {% else %}
                                {% for i in range(num_dias) %}
                                    {% set fecha_dia = fecha_inicio + timedelta(days=i) %}
                                    {% set dia_num = fecha_dia.weekday() %}
                                    {% set dia_display = dias_lista[dia_num] + " " + fecha_dia.strftime('%d/%m') %}
                                    {% set fecha_iso_key = fecha_dia.isoformat() %}
                                    {% set ops_del_dia = ordenes_por_dia.get(fecha_iso_key, []) %}
                                    {% set cap_data_dia = capacidad_crp.get(1, {}).get(fecha_iso_key, {'neta': 480, 'motivo_bloqueo': None}) %}
                                    {% set motivo_dia = cap_data_dia.motivo_bloqueo %}
                            
                                    <div class="col-lg col-md-4 col-sm-6 mb-3">
                                        <div class="day-column h-100 shadow-sm {% if motivo_dia %}bg-light-subtle{% endif %}">
                                            <div class="day-header d-flex justify-content-between align-items-center">
                                                <span class="fw-bold">{{ dia_display }}</span>
                                                <span class="badge {% if ops_del_dia %}bg-primary{% else %}bg-secondary{% endif %} rounded-pill">
                                                    {{ ops_del_dia | length }} OP{% if ops_del_dia | length != 1 %}s{% endif %}
                                                </span>
                                            </div>
                                            <div class="day-content">
                                                {% if not ops_del_dia %}
                                                    {% if motivo_dia and 'Fin de Semana' in motivo_dia %}
                                                        <div class="text-center text-muted py-4 opacity-75">
                                                            <i class="bi bi-cup-hot-fill display-6"></i>
                                                            <p class="small fw-bold mt-2 mb-0">Fin de Semana</p>
                                                        </div>
                                                    {% elif motivo_dia %}
                                                        <div class="text-center text-muted py-4 opacity-75">
                                                            <i class="bi bi-flag-fill display-6"></i>
                                                            <p class="small fw-bold mt-2 mb-0">{{ motivo_dia }}</p>
                                                        </div>
                                                    {% else %}
                                                        <div class="text-center text-muted py-4 opacity-25">
                                                            <i class="bi bi-calendar-check display-6"></i>
                                                            <p class="small mt-2 mb-0">D√≠a libre</p>
                                                        </div>
                                                    {% endif %}
                                                {% endif %}
                                                
                                                {% for op in ops_del_dia %}
                                                
                                                {% set popover_content %}
                                                    <dl class='row mb-0' style='font-size: 0.85rem; min-width: 300px;'>
                                                        <dt class='col-5'><i class='bi bi-box-seam me-1'></i>Producto:</dt>
                                                        <dd class='col-7'>{{ op.producto_nombre or 'N/A' }}</dd>
                                                        
                                                        <dt class='col-5'><i class='bi bi-hash me-1'></i>Cantidad:</dt>
                                                        <dd class='col-7'>{{ op.cantidad_planificada }}</dd>
                                                        
                                                        <dt class='col-5'><i class='bi bi-diagram-3-fill me-1 text-primary'></i>L√≠nea:</dt>
                                                        <dd class='col-7'>{% if op.linea_asignada %}L√≠nea {{ op.linea_asignada }}{% else %} <span class="text-muted">N/A</span> {% endif %}</dd>
                                                        
                                                        <dt class='col-5'><i class='bi bi-calendar-check-fill me-1 text-danger'></i>F. Meta:</dt>
                                                        <dd class='col-7'>{% if op.fecha_meta %}{{ op.fecha_meta }}{% else %} <span class="text-muted">N/D</span> {% endif %}</dd>
                                                        
                                                        <dt class='col-12 border-top pt-2 mt-2'><i class='bi bi-people-fill me-1'></i>Asignaciones</dt>
                                                        <dt class='col-5'><i class='bi bi-person-badge-fill me-1 text-info'></i>Sup:</dt>
                                                        <dd class='col-7'>{{ op.supervisor_nombre or 'No asignado' }}</dd>
                                                        
                                                        <dt class='col-5'><i class='bi bi-person-fill me-1 text-secondary'></i>Op:</dt>
                                                        <dd class='col-7'>{{ op.operario_nombre or 'No asignado' }}</dd>
                                                        
                                                        <dt class='col-12 border-top pt-2 mt-2'><i class='bi bi-clock-history me-1'></i>Inicio Plan.:</dt>
                                                        <dd class='col-12'>{{ op.fecha_inicio_planificada or 'N/P' }}</dd>
                                                    </dl>
                                                    <div class='border-top pt-2 mt-2'>
                                                        <button class='btn btn-sm btn-outline-primary w-100 btn-open-replan-modal'
                                                                data-op-id='{{ op.id }}'
                                                                data-op-codigo='{{ op.codigo }}'
                                                                data-op-producto='{{ op.producto_nombre | e }}'
                                                                data-op-cantidad='{{ op.cantidad_planificada }}'
                                                                data-op-linea='{{ op.linea_asignada }}'
                                                                data-op-fecha-inicio='{{ op.fecha_inicio_planificada }}'
                                                                data-op-supervisor='{{ op.supervisor_responsable_id }}'
                                                                data-op-operario='{{ op.operario_asignado_id }}'
                                                                data-sug-t-prod-dias='{{ op.sugerencias_jit.sugerencia_t_prod_dias | default(0) }}'
                                                                data-sug-t-proc-dias='{{ op.sugerencias_jit.sugerencia_t_proc_dias | default(0) }}'
                                                                data-sug-stock-ok='{{ 1 if op.sugerencias_jit.sugerencia_stock_ok else 0 }}'
                                                                data-sug-fecha-jit='{{ op.sugerencias_jit.sugerencia_fecha_inicio_jit | default("") }}'
                                                                >
                                                            <i class='bi bi-calendar-range me-1'></i> Re-Planificar esta OP
                                                        </button>
                                                    </div>
                                                {% endset %}
                
                                                <div class="op-card-mini-wrapper d-block mb-2" 
                                                     tabindex="0" 
                                                     data-bs-toggle="popover" 
                                                     data-bs-html="true" 
                                                     title="<i class='bi bi-info-circle me-2'></i>Detalle R√°pido: {{ op.codigo }}"
                                                     data-bs-content="{{ popover_content | e }}"
                                                     style="cursor: pointer;"
                                                     data-op-id="{{ op.id }}"
                                                >
                                                    <div class="op-card-mini position-relative {% if op.linea_asignada %}border-start border-3 border-primary{% else %}border-start border-3 border-secondary{% endif %}"
                                                        style="padding-left: 0.75rem;">
                                                
                                                        {% if op.linea_asignada %}
                                                        <span class="position-absolute top-0 start-0 translate-middle badge bg-primary rounded-pill"
                                                            style="font-size: 0.6em; margin-left: 10px;">
                                                            L{{ op.linea_asignada }}
                                                        </span>
                                                        {% endif %}
                                                
                                                        <div class="d-flex justify-content-between align-items-start pt-2">
                                                            <strong class="flex-grow-1 me-2" style="font-size: 0.9rem;">{{ op.producto_nombre or 'N/A' }}</strong>
                                                            <small class="text-muted text-nowrap fw-bold">{{ op.cantidad_planificada | round(1) }} {{
                                                                op.producto_unidad_medida or 'und' }}</small>
                                                        </div>
                                                
                                                        <div class="op-details small mt-1">
                                                            <div class="mb-1">
                                                                <i class="bi bi-upc-scan text-secondary me-1"></i>
                                                                <code class="small">{{ op.codigo }}</code>
                                                            </div>
                                                            {% if op.operario_nombre %}
                                                            <div class="text-success">
                                                                <i class="bi bi-person-fill me-1"></i>
                                                                <small>{{ op.operario_nombre.split()[0] }}</small>
                                                            </div>
                                                            {% elif op.supervisor_nombre %}
                                                            <div class="text-info">
                                                                <i class="bi bi-person-badge-fill me-1"></i>
                                                                <small>{{ op.supervisor_nombre.split()[0] }}</small>
                                                            </div>
                                                            {% endif %}
                                                        </div>
                                                
                                                        {% if op.fecha_inicio_planificada %}
                                                        <div class="mt-2 pt-1 border-top">
                                                            <small class="text-primary fw-bold">
                                                                <i class="bi bi-clock-history"></i> Inicia: {{ op.fecha_inicio_planificada }}
                                                            </small>
                                                        </div>
                                                        {% endif %}
                                                    </div>
                                                </div>
                                                {% endfor %}
                                            </div>
                                        </div>
                                    </div>
                                {% endfor %}
                            {% endif %}
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <div class="accordion mb-4" id="accordionCRP">
            <div class="accordion-item">
                <h2 class="accordion-header" id="headingCRP">
                    <button class="accordion-button collapsed bg-info-subtle" type="button" data-bs-toggle="collapse" data-bs-target="#collapseCRP" aria-expanded="false" aria-controls="collapseCRP">
                        <div class="d-flex align-items-center w-100">
                            <i class="bi bi-speedometer2 fs-5 me-3 text-info-emphasis"></i>
                            <div class="flex-grow-1">
                                <span class="fw-semibold">An√°lisis de Capacidad vs Carga (CRP)</span>
                                <small class="text-muted d-block">Balance de recursos - Capacidad disponible vs trabajo planificado</small>
                            </div>
                            <div class="badge bg-info rounded-pill">An√°lisis Semanal</div>
                        </div>
                    </button>
                </h2>
                <div id="collapseCRP" class="accordion-collapse collapse" aria-labelledby="headingCRP" data-bs-parent="#accordionCRP">
                    <div class="accordion-body">
                        {# Leyenda de colores #}
                        <div class="row mb-3">
                            <div class="col-12">
                                <div class="card bg-light">
                                    <div class="card-body py-2">
                                        <div class="row text-center">
                                            <div class="col-md-3 mb-1">
                                                <span class="badge bg-success-soft text-success">
                                                    <i class="bi bi-check-circle"></i> √ìptimo (‚â§85%)
                                                </span>
                                            </div>
                                            <div class="col-md-3 mb-1">
                                                <span class="badge bg-warning-soft text-warning">
                                                    <i class="bi bi-exclamation-triangle"></i> Alerta (86-100%)
                                                </span>
                                            </div>
                                            <div class="col-md-3 mb-1">
                                                <span class="badge bg-danger-soft text-danger">
                                                    <i class="bi bi-x-circle"></i> Sobrecarga (>100%)
                                                </span>
                                            </div>
                                            <div class="col-md-3 mb-1">
                                                <span class="badge bg-secondary">
                                                    <i class="bi bi-dash-circle"></i> Sin Carga (0%)
                                                </span>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>

                        {% if carga_crp and capacidad_crp and inicio_semana and fin_semana %}
                            {% set fecha_inicio = date.fromisoformat(inicio_semana) %}
                            {% set fecha_fin = date.fromisoformat(fin_semana) %}
                            {% set num_dias = (fecha_fin - fecha_inicio).days + 1 %}
                            {% set dias_lista = ['Lun', 'Mar', 'Mi√©', 'Jue', 'Vie', 'S√°b', 'Dom'] %}

                            {# Resumen semanal #}
                            <div class="row mb-3">
                                <div class="col-12">
                                    <div class="card">
                                        <div class="card-header bg-light py-2">
                                            <h6 class="mb-0"><i class="bi bi-graph-up"></i> Resumen Semanal de Utilizaci√≥n</h6>
                                        </div>
                                        <div class="card-body">
                                            {% for centro_id, nombre_centro in {1: 'L√≠nea 1', 2: 'L√≠nea 2'}.items() %}
                                            <div class="row mb-2 align-items-center">
                                                <div class="col-sm-3">
                                                    <strong>{{ nombre_centro }}</strong>
                                                </div>
                                                <div class="col-sm-9">
                                                    {% set centro_capacidad_dict = capacidad_crp.get(centro_id, {}) %}
                                                    {% set centro_carga_dict = carga_crp.get(centro_id, {}) %}
                                                    {% set total_capacidad = centro_capacidad_dict.values() | map(attribute='neta') | sum %}
                                                    {% set total_carga = centro_carga_dict.values() | select('number') | sum %}
                                                    {% set utilizacion_promedio = (total_carga / total_capacidad * 100) if total_capacidad > 0 else 0 %}
                                        
                                                    <div class="progress" style="height: 20px;"
                                                        title="Carga: {{ total_carga | round(0) }}min / Cap. Neta: {{ total_capacidad | round(0) }}min">
                                                        {% set bg_class = 'bg-danger' if utilizacion_promedio > 100 else ('bg-warning' if utilizacion_promedio >
                                                        85 else ('bg-success' if utilizacion_promedio > 0 else 'bg-secondary')) %}
                                        
                                                        <div class="progress-bar {{ bg_class }}" role="progressbar"
                                                            style="width: {% if utilizacion_promedio > 100 %}100{% else %}{{ utilizacion_promedio }}{% endif %}%"
                                                            aria-valuenow="{{ utilizacion_promedio | round(1) }}" aria-valuemin="0" aria-valuemax="100">
                                                            {{ utilizacion_promedio | round(1) }}%
                                                        </div>
                                                    </div>
                                                    <small class="text-muted d-block mt-1">
                                                        Carga: {{ total_carga | round(0) }}min / Cap. Neta: {{ total_capacidad | round(0) }}min
                                                    </small>
                                                </div>
                                            </div>
                                            {% if not loop.last %}<hr class="my-1">{% endif %}
                                            {% endfor %}
                                        </div>
                                    </div>
                                </div>
                            </div>
                            
                            {# --- TABLA DETALLADA CRP (NUEVO DISE√ëO) --- #}
                            <div class="table-responsive">
                                <table class="table table-sm text-center crp-tabla">
                                    <thead>
                                        <tr>
                                            <th class="text-start" style="width: 12%;">Centro / M√©trica</th>
                                            {% for i in range(num_dias) %}
                                            {% set fecha_dia = fecha_inicio + timedelta(days=i) %}
                                            {% set dia_num = fecha_dia.weekday() %}
                                            <th class="{% if fecha_dia.weekday() >= 5 %}weekend-header text-center{% endif %}">
                                                {{ dias_lista[dia_num] }}<br>
                                                <small class="text-muted">{{ fecha_dia.strftime('%d/%m') }}</small>
                                            </th>
                                            {% endfor %}
                                        </tr>
                                    </thead>
                                    <tbody>
                                        {% for centro_id, nombre_centro in {1: 'L√≠nea 1', 2: 'L√≠nea 2'}.items() %}
                                        <tr class="crp-capacidad">
                                            <td class="text-start fw-bold metric-label">
                                                <div>{{ nombre_centro }}</div>
                                                <span class="text-muted fw-normal">Cap. Neta</span>
                                            </td>
                                            {% for i in range(num_dias) %}
                                            {% set fecha_dia = fecha_inicio + timedelta(days=i) %}
                                            {% set fecha_iso = fecha_dia.isoformat() %}
                                            {% set cap_data = capacidad_crp.get(centro_id, {}).get(fecha_iso, {'neta': 0, 'motivo_bloqueo': None}) %}
                                            {% set motivo = cap_data.motivo_bloqueo %}
                                            <td class="
                                                {% if fecha_dia.weekday() >= 5 %}weekend-cell{% endif %} 
                                                {% if motivo %}bg-light-subtle non-working-day{% endif %}
                                            "
                                            {% if motivo %}
                                                data-bs-toggle="tooltip" data-bs-placement="top" title="{{ motivo | e }}"
                                            {% endif %}
                                            >
                                                {% if motivo and 'Fin de Semana' in motivo %}
                                                    <span class="fs-4 text-muted" style="line-height: 1;">üò¥</span>
                                                    <small class="text-muted d-block" style="margin-top: 1px;">{{ motivo }}</small>
                                                {% elif motivo %}
                                                    <span class="fs-4" style="line-height: 1;">üéâ</span>
                                                    <small class="text-muted d-block" style="margin-top: 1px; font-size: 0.75em;">{{ motivo }}</small>
                                                {% else %}
                                                    <span class="fw-bold text-primary">{{ cap_data.neta | round(0) }}</span>
                                                    <small class="text-muted d-block">min</small>
                                                {% endif %}
                                            </td>
                                            {% endfor %}
                                        </tr>
                            
                                        <tr class="crp-bloqueo">
                                            <td class="text-start metric-label">
                                                <span class="text-muted">Bloqueos</span>
                                            </td>
                                            {% for i in range(num_dias) %}
                                                {% set fecha_dia = fecha_inicio + timedelta(days=i) %}
                                                {% set fecha_iso = fecha_dia.isoformat() %}
                                                {% set cap_data = capacidad_crp.get(centro_id, {}).get(fecha_iso, {'bloqueado': 0, 'motivo_bloqueo': None, 'hora_inicio': None, 'hora_fin': None}) %}
                                                {% set bloqueo = cap_data.bloqueado %}
                                                {% set motivo = cap_data.motivo_bloqueo %}
                                                {% set hora_inicio = cap_data.hora_inicio %}
                                                {% set hora_fin = cap_data.hora_fin %}
                                                {% set bloqueo_class = '' %}
                                                {% if bloqueo >= 240 %}
                                                    {% set bloqueo_class = 'bg-danger-soft text-danger-emphasis' %}
                                                {% elif bloqueo > 60 %}
                                                    {% set bloqueo_class = 'bg-warning-soft text-warning-emphasis' %}
                                                {% elif bloqueo > 0 %}
                                                    {% set bloqueo_class = 'bg-light text-muted-emphasis' %}
                                                {% endif %}
                                                {% set tooltip_text = motivo or 'Bloqueo' %}
                                                {% if hora_inicio and hora_fin %}
                                                    {% set tooltip_text = tooltip_text + ' (' + hora_inicio + ' - ' + hora_fin + ')' %}
                                                {% endif %}
                                                <td
                                                    class="{% if fecha_dia.weekday() >= 5 %}weekend-cell{% endif %} {{ bloqueo_class }}"
                                                    {% if bloqueo > 0 %}
                                                        title="{{ tooltip_text | e }}"
                                                        data-bs-toggle="tooltip" 
                                                        data-bs-placement="top"
                                                    {% endif %}
                                                >
                                                    {% if bloqueo > 0 %}
                                                    <span class="fw-bold">{{ bloqueo | round(0) }}</span> 
                                                    <small class="text-muted d-block">min</small>
                                                    {% else %}
                                                    <span class="text-muted">-</span>
                                                    {% endif %}
                                                </td>
                                            {% endfor %}
                                        </tr>
                            
                                        <tr class="crp-carga">
                                            <td class="text-start metric-label">
                                                <span class="text-muted">Carga Planif.</span>
                                            </td>
                                            {% for i in range(num_dias) %}
                                            {% set fecha_dia = fecha_inicio + timedelta(days=i) %}
                                            {% set fecha_iso = fecha_dia.isoformat() %}
                                            {% set carga = carga_crp.get(centro_id, {}).get(fecha_iso, 0) %}
                                            <td class="{% if fecha_dia.weekday() >= 5 %}weekend-cell{% endif %}">
                                                <span class="fw-bold text-danger">{{ carga | round(0) }}</span>
                                                <small class="text-muted d-block">min</small>
                                            </td>
                                            {% endfor %}
                                        </tr>
                                        <tr class="crp-utilizacion">
                                            <td class="text-start metric-label">
                                                <span class="text-muted">Utilizaci√≥n</span>
                                            </td>
                                            {% for i in range(num_dias) %}
                                            {% set fecha_dia = fecha_inicio + timedelta(days=i) %}
                                            {% set fecha_iso = fecha_dia.isoformat() %}
                                            {% set cap_data = capacidad_crp.get(centro_id, {}).get(fecha_iso, {'neta': 0}) %}
                                            {% set carga = carga_crp.get(centro_id, {}).get(fecha_iso, 0) %}
                                            {% set utilizacion = (carga / cap_data.neta * 100) if cap_data.neta > 0 else 0 %}
                                            {% set bg_color = 'bg-danger-soft text-danger' if utilizacion > 100 else ('bg-warning-soft text-warning'
                                            if utilizacion > 85 else ('bg-success-soft text-success' if utilizacion > 0 else 'bg-light text-muted'))
                                            %}
                                            <td class="{{ bg_color }} {% if fecha_dia.weekday() >= 5 %}weekend-cell{% endif %}">
                                                <span class="fw-bold fs-6">{{ utilizacion | round(0) }}%</span>
                                                {% if utilizacion > 100 %}<i class="bi bi-exclamation-triangle-fill small ms-1"
                                                    title="Sobrecarga"></i>
                                                {% elif utilizacion > 85 %}<i class="bi bi-exclamation-circle-fill small ms-1"
                                                    title="Alta utilizaci√≥n"></i>
                                                {% elif utilizacion > 0 %}<i class="bi bi-check-circle-fill small ms-1" title="√ìptimo"></i>
                                                {% endif %}
                                            </td>
                                            {% endfor %}
                                        </tr>
                                        {% if not loop.last %}
                                        <tr class="row-spacer">
                                            <td colspan="{{ num_dias + 1 }}"></td>
                                        </tr>
                                        {% endif %}
                                        {% endfor %}
                                    </tbody>
                                </table>
                            </div>
                            
                            <div class="mt-3">
                                <div class="card bg-light">
                                    <div class="card-body">
                                        <h6 class="card-title"><i class="bi bi-info-circle me-1"></i>¬øC√≥mo interpretar esta tabla?</h6>
                                        <div class="row">
                                            <div class="col-md-4">
                                                <strong>Cap. Neta:</strong> Capacidad Neta (minutos)
                                            </div>
                                            <div class="col-md-4">
                                                <strong>Bloqueos:</strong> Minutos no disponibles (Mantenimiento, etc.)
                                            </div>
                                            <div class="col-md-4">
                                                <strong>Carga Planificada:</strong> Trabajo asignado (minutos)
                                            </div>
                                            <div class="col-md-4">
                                                <strong>Utilizaci√≥n:</strong> Porcentaje de uso (Carga / Cap. Neta)
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                
                        {% else %}
                            <div class="text-center py-4">
                                <i class="bi bi-clipboard-x display-4 text-muted"></i>
                                <h5 class="text-muted mt-3">No hay datos de CRP disponibles</h5>
                                <p class="text-muted">Los datos de capacidad y carga aparecer√°n cuando existan OPs planificadas.</p>
                            </div>
                        {% endif %}
                    </div>
                </div>
            </div>
        </div>
    </div> {% if current_user.rol != 'OPERARIO' and current_user.rol != 'SUPERVISOR_CALIDAD' %}
    <div class="tab-pane fade" id="maestro-pane" role="tabpanel" aria-labelledby="maestro-tab" tabindex="0">
        
        <div id="planificador-pendientes" class="mt-3"> <div class="planificador-header d-flex justify-content-between align-items-center">
                <span>Plan Maestro (Pr√≥ximos {{ mps_data.dias_horizonte }} d√≠as: {{ mps_data.inicio_horizonte }} al {{ mps_data.fin_horizonte }})</span>
                <div class="btn-group btn-group-sm">
                    <a href="{{ url_for('planificacion.index', horizonte=7, semana=semana_actual_str) }}" class="btn btn-outline-secondary {% if mps_data.dias_horizonte == 7 %}active{% endif %}">7 D√≠as</a>
                    <a href="{{ url_for('planificacion.index', horizonte=14, semana=semana_actual_str) }}" class="btn btn-outline-secondary {% if mps_data.dias_horizonte == 14 %}active{% endif %}">14 D√≠as</a>
                    <a href="{{ url_for('planificacion.index', horizonte=30, semana=semana_actual_str) }}" class="btn btn-outline-secondary {% if mps_data.dias_horizonte == 30 %}active{% endif %}">30 D√≠as</a>
                </div>
            </div>
            <div class="planificador-body">
                {% set mps_items = mps_data.get('mps_agrupado', []) %}
                {% if not mps_items %}
                    <div class="alert alert-success text-center">¬°Excelente! No hay OPs pendientes en el horizonte.</div>
                {% else %}
                    <table class="table table-sm table-hover planificador-tabla align-middle">
                        <thead>
                            <tr>
                                <th>Producto</th>
                                <th class="text-center">Cant. Total Req.</th>
                                <th class="text-center">Fecha Meta Pr√≥x.</th>
                                <th style="width: 25%;">Sugerencia Agregada</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for item_mps in mps_items %}
                            <tr class="fila-producto-mps">
                                <td><strong>{{ item_mps.producto_nombre }}</strong></td>
                                <td class="text-center fs-5"><b>{{ item_mps.cantidad_total }}</b></td>
                                <td class="text-center text-danger"><strong>{{ item_mps.fecha_meta_mas_proxima|format_datetime('%d %b %Y') if item_mps.fecha_meta_mas_proxima else 'N/D' }}</strong></td>
                                <td class="celda-sugerencia-agregada">
                                     {% set plazo_total_agg = item_mps.sugerencia_t_prod_dias + item_mps.sugerencia_t_proc_dias %}
                                     {% if plazo_total_agg > 0 %}
                                        <div class="resultado-sugerencia sugerencia-calculada {% if item_mps.sugerencia_t_proc_dias > 0 %}alert alert-warning{% else %}alert alert-success{% endif %}" style="display: block; font-size: 0.85rem; padding: 8px; margin: -5px -5px -5px 0;">
                                            L√≠nea Sugerida: <b>{{ item_mps.sugerencia_linea or 'N/D' }}</b><hr class="my-1">
                                            Plazo Total: <b>{{ plazo_total_agg }} d√≠as</b>
                                            <ul class="mb-0 ps-3 mt-1" style="font-size: 0.8rem;">
                                                <li>Producci√≥n: {{ item_mps.sugerencia_t_prod_dias }} d√≠as</li>
                                                <li>Compras: {{ item_mps.sugerencia_t_proc_dias }} d√≠as {% if item_mps.sugerencia_t_proc_dias > 0 %}(Stock Faltante){% else %}(Stock OK){% endif %}</li>
                                            </ul>
                                        </div>
                                     {% else %} <span class="text-muted">Error c√°lculo</span> {% endif %}
                                </td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                {% endif %}
            </div>
        </div>
        
    </div> {% endif %}

</div>
{# --- REUSABLE FEEDBACK MODAL --- #}
<div class="modal fade" id="feedbackModal" tabindex="-1" aria-labelledby="feedbackModalLabel" aria-hidden="true">
  <div class="modal-dialog modal-dialog-centered"> {# Centered vertically #}
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="feedbackModalLabel">
            <i class="bi bi-info-circle me-2" id="feedbackModalIcon"></i> {# Icon changes based on type #}
            <span id="feedbackModalTitle">T√≠tulo</span> {# Dynamic title #}
        </h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Cerrar"></button>
      </div>
      <div class="modal-body" id="feedbackModalBody">
        Mensaje del modal. {# Dynamic message #}
      </div>
      <div class="modal-footer">
        {# Button for simple alerts or Cancel #}
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal" id="feedbackModalCancelBtn">Cerrar</button> 
        {# Button for confirmations #}
        <button type="button" class="btn btn-primary" id="feedbackModalConfirmBtn">Confirmar</button> 
      </div>
    </div>
  </div>
</div>
{# --- END FEEDBACK MODAL --- #}

{# --- ¬°NUEVO! MODAL DE CARGA GLOBAL --- #}
<div class="modal fade" id="globalLoadingModal" 
     data-bs-backdrop="static" data-bs-keyboard="false" 
     tabindex="-1" aria-labelledby="globalLoadingModalLabel" aria-hidden="true">
  <div class="modal-dialog modal-dialog-centered">
    <div class="modal-content" style="background-color: transparent; border: none;">
      <div class="modal-body text-center p-4">
        <div class="spinner-border text-primary" role="status" style="width: 3rem; height: 3rem;">
          <span class="visually-hidden">Cargando...</span>
        </div>
        <h5 class="text-white mt-3 mb-0" id="globalLoadingModalLabel">Procesando...</h5>
      </div>
    </div>
  </div>
</div>
{# --- FIN MODAL DE CARGA --- #}

{# --- MODAL DE RE-PLANIFICACI√ìN (NUEVO) --- #}
<div class="modal fade" id="replanModal" tabindex="-1" aria-labelledby="replanModalLabel" aria-hidden="true">
  <div class="modal-dialog modal-lg">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="replanModalLabel">Re-Planificar Orden de Producci√≥n</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Cerrar"></button>
      </div>
      <div class="modal-body">
        <form id="replanForm">
            <input type="hidden" id="replan_op_id" name="op_id">
            
            {# Info de la OP #}
            <div class="card bg-light p-3 mb-3">
                <div class="row">
                    <div class="col-md-6">
                        <strong>Producto:</strong> <span id="replan_producto_nombre"></span>
                    </div>
                    <div class="col-md-6">
                        <strong>C√≥digo:</strong> <code id="replan_op_codigo"></code>
                    </div>
                    <div class="col-md-6">
                        <strong>Cantidad:</strong> <span id="replan_cantidad"></span>
                    </div>
                </div>
            </div>

            {# --- INICIO: NUEVA SECCI√ìN DE SUGERENCIA --- #}
            <div id="replan_sugerencia_container" class="mb-3" style="display: none;"> 
                <h6 class="mb-2">Sugerencia de Plazos (Justo A Tiempo)</h6>
                <div id="replan_sugerencia_box" class="alert alert-success" style="font-size: 0.85rem; padding: 10px;">
                    Fecha de Inicio Sugerida (Justo A Tiempo): <b id="replan_sug_fecha_jit"></b>
                    <hr class="my-1">
                    Plazo Total Estimado: <b id="replan_sug_plazo_total"></b> d√≠as
                    <ul class="mb-0 ps-3 mt-1" style="font-size: 0.8rem;">
                        <li id="replan_sug_t_prod">Producci√≥n: <b></b> d√≠as</li>
                        <li id="replan_sug_t_proc">Compras: <b></b> d√≠as (<span id="replan_sug_stock_status"></span>)</li>
                    </ul>
                </div>
            </div>
            {# --- FIN: NUEVA SECCI√ìN DE SUGERENCIA --- #}

            <hr>
            <h5 class="mb-3">Nuevos Par√°metros de Planificaci√≥n</h5>
            
            {# Inputs (copiados del modal de Plan Maestro) #}
            <div class="row g-3">
                <input type="hidden" id="replan_select_linea" name="linea_asignada">
                <div class="col-md-12">
                    <label class="form-label form-label-sm fw-bold">Nueva Fecha de Inicio <span class="text-danger">*</span></label>
                    <input type="date" 
                           class="form-control form-control-sm mb-1" 
                           id="replan_input_fecha_inicio" 
                           name="fecha_inicio"
                           min="{{ now.date().isoformat() }}">
                </div>
                <input type="hidden" id="replan_select_supervisor" name="supervisor_id">
                <input type="hidden" id="replan_select_operario" name="operario_id">
            </div>
        </form>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
        <button type="button" class="btn btn-primary" id="btn-confirm-replan"><i class="bi bi-check-lg"></i> Confirmar Re-planificaci√≥n</button>
      </div>
    </div>
  </div>
</div>
{# --- FIN MODAL RE-PLANIFICACI√ìN --- #}

{# --- ¬°NUEVO! PANEL LATERAL (OFFCANVAS) DE NOTIFICACIONES --- #}
<div class="offcanvas offcanvas-end" tabindex="-1" id="notificationOffcanvas" aria-labelledby="notificationOffcanvasLabel">
  <div class="offcanvas-header bg-light">
    <h5 class="offcanvas-title" id="notificationOffcanvasLabel">
        <i class="bi bi-bell-fill text-info me-2"></i>Notificaciones del Sistema
    </h5>
    <button type="button" class="btn-close" data-bs-dismiss="offcanvas" aria-label="Close"></button>
  </div>
  <div class="offcanvas-body p-0">
    
    {% if not planning_notifications %}
        <div class="text-center text-muted p-5">
            <i class="bi bi-check-circle display-4"></i>
            <p class="mt-3 mb-0">No hay avisos nuevos.</p>
        </div>
    {% else %}
        <div class="list-group list-group-flush">
            {% for issue in planning_notifications %}
            <div class="list-group-item list-group-item-action py-3">
                <div class="d-flex w-100 justify-content-between">
                    <h6 class="mb-1 text-info-emphasis">
                        <i class="bi bi-arrow-right-circle-fill me-1"></i>RE-PLANIFICADO (AUTO)
                    </h6>
                    <small class="text-muted">{{ issue.updated_at | format_datetime('%d/%m %H:%M') }}</small>
                </div>
                <p class="mb-2 small text-muted">{{ issue.mensaje }}</p>
                <div class="d-flex justify-content-between align-items-center">
                    <code class="small">{{ issue.op_codigo }} ({{ issue.op_producto_nombre }})</code>
                    <button class="btn btn-sm btn-outline-success btn-marcar-visto" 
                            data-issue-id='{{ issue.id }}' 
                            title="Marcar este aviso como le√≠do">
                        <i class="bi bi-check-lg me-1"></i> Visto
                    </button>
                </div>
            </div>
            {% endfor %}
        </div>
    {% endif %}

  </div>
</div>
{# --- FIN PANEL LATERAL (OFFCANVAS) --- #}

{% endblock %}

{% block extra_js %}
    
    {# --- DATOS JINJA PARA JS --- #}
    <script>
        const listaSupervisores = {{ supervisores | tojson }};
        const listaOperarios = {{ operarios | tojson }};
        const IS_OPERARIO = {{ is_operario | tojson | safe }};
        const IS_SUPERVISOR_CALIDAD = {{ is_supervisor_calidad | tojson | safe }};
        // --- ¬°A√ëADIR ESTAS L√çNEAS! ---
        window.API_CONSOLIDAR_URL = "{{ url_for('planificacion.consolidar_y_aprobar_api') }}";
        window.CSRF_TOKEN = "{{ csrf_token() }}";
        // -----------------------------
    </script>

    {# --- INICIO: A√ëADIR INICIALIZADOR DE TOOLTIP --- #}
    <script>
        document.addEventListener('DOMContentLoaded', function () {
            // Inicializar los nuevos tooltips de bloqueo
            // Es necesario para que data-bs-toggle="tooltip" funcione
            const tooltipTriggerList = [].slice.call(document.querySelectorAll('[data-bs-toggle="tooltip"]'));
            tooltipTriggerList.map(function (tooltipTriggerEl) {
                return new bootstrap.Tooltip(tooltipTriggerEl);
            });
        });
    </script>
    {# --- FIN: INICIALIZADOR DE TOOLTIP --- #}
    
    {# --- SCRIPT DE PLANIFICACI√ìN (AHORA CONTIENE EL INICIALIZADOR DE POPOVER) --- #}
    <script src="{{ url_for('static', filename='js/planificacion/planificacion.js') }}"></script>

{% endblock %}