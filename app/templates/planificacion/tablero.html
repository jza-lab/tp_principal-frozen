{% extends 'layouts/base.html' %}

{% block title %}Centro de Planificación - Sistema Frozen{% endblock %}

{% block extra_css %}
    <link rel="stylesheet" href="{{ url_for('static', filename='css/planificacion/planificacion.css') }}">
    <style>
        /* Estilo adicional para la navegación separada */
        .navegacion-semanal-separada {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 0; /* Sin margen inferior, se pega al acordeón */
            padding: 0.5rem 1rem;
            background-color: #f8f9fa; /* Fondo similar al header */
            border: 1px solid #dee2e6;
            border-bottom: none; /* Quitar borde inferior */
            border-top-left-radius: 0.75rem; /* Redondear esquinas superiores */
            border-top-right-radius: 0.75rem;
        }
         /* Ajustar borde superior del acordeón */
        #accordionSemanal .accordion-item:first-of-type .accordion-button {
             border-top-left-radius: 0;
             border-top-right-radius: 0;
        }
         /* Asegurar que el botón del acordeón no tenga margen superior */
         #accordionSemanal .accordion-header {
             margin-top: 0;
         }
         /* Estilos para Kanban (asegurar visibilidad data-attribute) */
        .card-assignment-details { font-size: 0.8rem; }
        .card-assignment-details span { display: inline-block; margin-right: 0.5rem; }
    </style>
{% endblock %}

{% block content %}
<div class="d-flex justify-content-between flex-wrap flex-md-nowrap align-items-center pb-2 mb-4 border-bottom">
    <div>
        <h1 class="h2 mb-1">Centro de Planificación</h1>
        <p class="text-muted mb-0">Planifique OPs pendientes, vea la semana y gestione el tablero.</p>
    </div>
</div>

<div id="planificador-pendientes">
    <div class="planificador-header">
        Bandeja de Entrada: Órdenes Pendientes de Planificar ({{ ops_pendientes|length }})
    </div>
    <div class="planificador-body">
        <table class="table table-hover planificador-tabla">
            <thead>
                <tr>
                    <th>OP</th>
                    <th>Producto</th>
                    <th>Cantidad</th>
                    <th>Fecha Meta (del Pedido)</th>
                    <th style="width: 30%;">Sugerencia del Sistema</th>
                    <th style="width: 20%;">Acciones</th>
                </tr>
            </thead>
            <tbody>
                {% if not ops_pendientes %}
                <tr>
                    <td colspan="6" class="text-center text-muted">¡Genial! No hay Órdenes de Producción pendientes de planificar.</td>
                </tr>
                {% endif %}
                {% for op in ops_pendientes %}
                <tr data-op-id="{{ op.id }}">
                    <td><code>{{ op.codigo }}</code></td>
                    <td>{{ op.producto_nombre }}</td>
                    <td>{{ op.cantidad_planificada }}</td>
                    <td><strong class="text-danger">{{ op.fecha_meta }}</strong></td>
                    <td class="celda-sugerencia">
                        {% if op.sugerencia_fecha_inicio %}
                        <div class="resultado-sugerencia sugerencia-calculada {% if op.sugerencia_t_aprovisionamiento_dias > 0 %}alert alert-warning{% else %}alert alert-success{% endif %}" style="display: block;">
                            <strong>Inicio Sugerido: <span class="fs-6">{{ op.sugerencia_fecha_inicio }}</span></strong>
                            (Línea Sug.: <b>{{ op.sugerencia_linea }}</b>)
                            <hr class="my-1">
                            Plazo Total: <b>{{ op.sugerencia_plazo_total_dias }} días</b><br>
                            <ul>
                                <li>Producción: {{ op.sugerencia_t_produccion_dias }} días</li>
                                <li>Compras: {{ op.sugerencia_t_aprovisionamiento_dias }} días {% if op.sugerencia_t_aprovisionamiento_dias > 0 %}(Stock Faltante){% else %}(Stock OK){% endif %}</li>
                            </ul>
                        </div>
                        {% else %}
                        <div class="resultado-sugerencia" style="display: none;"></div>
                        {% endif %}
                    </td>
                    <td class="celda-acciones">
                        {% if op.sugerencia_fecha_inicio %}
                        <select class="form-select form-select-sm mb-1 select-linea" title="Seleccionar Línea">
                            <option value="1" {% if op.sugerencia_linea == 1 %}selected{% endif %}>Línea 1</option>
                            <option value="2" {% if op.sugerencia_linea == 2 %}selected{% endif %}>Línea 2</option>
                        </select>
                        <select class="form-select form-select-sm mb-1 select-supervisor" title="Asignar Supervisor">
                            <option value="">Supervisor (Opcional)</option>
                            {% for sup in supervisores %}
                            <option value="{{ sup.id }}">{{ sup.nombre }} {{ sup.apellido or '' }}</option>
                            {% endfor %}
                        </select>
                        <select class="form-select form-select-sm mb-1 select-operario" title="Asignar Operario">
                            <option value="">Operario (Opcional)</option>
                            {% for op_user in operarios %}
                            <option value="{{ op_user.id }}">{{ op_user.nombre }} {{ op_user.apellido or '' }}</option>
                            {% endfor %}
                        </select>
                         <label for="fecha-inicio-{{ op.id }}" class="form-label form-label-sm visually-hidden">Inicio Confirmado:</label>
                         <input type="date" id="fecha-inicio-{{ op.id }}" class="form-control form-control-sm mb-1 input-fecha-inicio" value="{{ op.sugerencia_fecha_inicio }}" title="Confirmar Fecha de Inicio">
                         <button class="btn btn-success btn-sm btn-confirmar-inicio w-100" data-op-id="{{ op.id }}">Confirmar Inicio y Aprobar</button>
                        {% else %}
                        <button class="btn btn-primary btn-sm btn-calcular" title="Calcular Fecha de Inicio">
                            <i class="bi bi-calculator-fill"></i> Calcular
                        </button>
                        {% endif %}
                    </td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
    </div>
</div>

<div class="navegacion-semanal-separada">
    <a href="{{ url_for('planificacion.index', semana=semana_anterior_str) if semana_anterior_str else '#' }}"
       class="btn btn-sm btn-outline-secondary me-1 {{ 'disabled' if not semana_anterior_str }}">
        &lt; Ant
    </a>
    <span class="fw-bold">Semana {{ semana_actual_str }}</span>
    <a href="{{ url_for('planificacion.index', semana=semana_siguiente_str) if semana_siguiente_str else '#' }}"
       class="btn btn-sm btn-outline-secondary {{ 'disabled' if not semana_siguiente_str }}">
        Sig &gt;
    </a>
</div>

<div class="accordion mb-4" id="accordionSemanal">
    <div class="accordion-item">
        <h2 class="accordion-header" id="headingSemanal">
            <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#collapseSemanal" aria-expanded="false" aria-controls="collapseSemanal">
                <i class="bi bi-calendar-week me-2"></i>
                Ver/Ocultar Planificación Semanal (Inicio de OPs)
            </button>
        </h2>
        <div id="collapseSemanal" class="accordion-collapse collapse" aria-labelledby="headingSemanal" data-bs-parent="#accordionSemanal">
            <div class="accordion-body">
                <div class="row">
                    {% if not ordenes_por_dia %}<p class="text-center text-muted">No hay OPs programadas para esta semana.</p>{% endif %}
                    {% for dia_display, ops_del_dia in ordenes_por_dia.items() %}
                    <div class="col-lg col-md-4 col-sm-6 mb-3">
                        <div class="day-column h-100">
                            <div class="day-header">{{ dia_display }}</div>
                            <div class="day-content">
                                {% if not ops_del_dia %}<p class="text-center text-muted small fst-italic mt-3">Vacío</p>{% endif %}
                                {% for op in ops_del_dia %}
                                <a href="{{ url_for('orden_produccion.detalle', id=op.id) }}" class="text-decoration-none text-dark" title="Ver detalle OP {{ op.codigo }}">
                                    <div class="op-card-mini">
                                        <strong>{{ op.producto_nombre or 'N/A' }}</strong>
                                        <div class="op-details">
                                            <span><i class="bi bi-upc-scan"></i> {{ op.codigo }}</span><br>
                                            <span><i class="bi bi-box-seam"></i> {{ op.cantidad_planificada }}</span>
                                            {% if op.linea_asignada %}<span><i class="bi bi-diagram-3-fill"></i> L{{ op.linea_asignada }}</span>{% endif %}
                                            {% if op.operario_nombre %}<span><i class="bi bi-person-fill"></i> {{ op.operario_nombre.split()[0] }}</span>{% endif %}
                                        </div>
                                    </div>
                                </a>
                                {% endfor %}
                            </div>
                        </div>
                    </div>
                    {% endfor %}
                </div>
            </div>
        </div>
    </div>
</div>

<h3 class="h4 mb-3">Tablero Kanban (Producción en Curso)</h3>
<div class="row">
    {% for estado_key, titulo_columna in columnas.items() %}
    {# --- CAMBIO: Añadir clases de columna responsivas --- #}
    {# col-12: Ancho completo en extra pequeño #}
    {# col-sm-6: Medio ancho en pequeño (2 columnas) #}
    {# col-md-4: Un tercio en mediano (3 columnas) #}
    {# col-lg-3: Un cuarto en grande (4 columnas) - Ajusta según prefieras #}
    {# col-xl-2: Un sexto en extra grande (6 columnas) - Ajusta según prefieras #}
    <div class="col-12 col-sm-6 col-md-4 col-lg-3 col-xl-2 mb-4 kanban-column-wrapper"> {# Añadido mb-4 para espacio inferior #}
        {# Mantenemos un div interno para aplicar estilos de columna originales si es necesario #}
        <div class="kanban-column h-100" data-estado="{{ estado_key }}">
             <div class="column-header">
                 <span>{{ titulo_columna }}</span>
                 <span class="badge bg-secondary rounded-pill">{{ ordenes_por_estado.get(estado_key, [])|length }}</span>
             </div>
             <div class="kanban-cards">
                 {% if estado_key == 'LISTA PARA PRODUCIR' %}
                 <div class="d-grid"><button id="btn-consolidar" class="btn btn-success mb-2" disabled><i class="bi bi-plus-slash-minus"></i> Consolidar</button></div>
                 {% endif %}
                 {% for orden in ordenes_por_estado.get(estado_key, []) %}
                 <div class="card insumo-card kanban-card"
                      data-op-id="{{ orden.id }}"
                      data-producto-id="{{ orden.producto_id }}"
                      data-linea-asignada="{{ orden.linea_asignada or '' }}">
                     {% if estado_key == 'LISTA PARA PRODUCIR' %}
                     <div class="form-check card-checkbox"><input class="form-check-input op-checkbox" type="checkbox" value="{{ orden.id }}"></div>
                     {% endif %}
                     <div class="card-body">
                         {# ... (Contenido de la tarjeta sin cambios) ... #}
                          <h5 class="card-title mb-1">{{ orden.producto_nombre or 'N/A' }}</h5>
                          <div class="card-secondary-details">
                              <span><i class="bi bi-upc-scan"></i> <code>{{ orden.codigo }}</code></span>
                              <span><i class="bi bi-box-seam"></i> <b>{{ orden.cantidad_planificada }}</b></span>
                              <span><i class="bi bi-calendar-event"></i> {{ orden.fecha_planificada }}</span>
                              {% if orden.fecha_inicio_planificada %}
                              <br><span class="text-primary"><i class="bi bi-play-circle-fill"></i> Inicia: {{ orden.fecha_inicio_planificada }}</span>
                              {% endif %}
                          </div>
                          {% if orden.supervisor_nombre or orden.linea_asignada or orden.operario_nombre %}
                          <hr class="my-1">
                          <div class="card-assignment-details">
                              {% if orden.linea_asignada %}<span class="me-2"><i class="bi bi-diagram-3-fill text-primary"></i> L{{ orden.linea_asignada }}</span>{% endif %}
                              {% if orden.supervisor_nombre %}<span class="me-2"><i class="bi bi-person-badge-fill text-info"></i> S:{{ orden.supervisor_nombre }}</span>{% endif %}
                              {% if orden.operario_nombre %}<span><i class="bi bi-person-fill text-secondary"></i> O:{{ orden.operario_nombre }}</span>{% endif %}
                          </div>
                          {% endif %}
                     </div>
                 </div>
                 {% endfor %}
             </div>
        </div>
    </div>
    {% endfor %}
</div> {# Fin de .row #}
{% endblock %}

{% block extra_js %}
    <script src="https://cdn.jsdelivr.net/npm/sortablejs@latest/Sortable.min.js"></script>

    <script>
        const listaSupervisores = {{ supervisores | tojson }};
        const listaOperarios = {{ operarios | tojson }};
    </script>

    <script src="{{ url_for('static', filename='js/planificacion/planificacion.js') }}"></script>
{% endblock %}