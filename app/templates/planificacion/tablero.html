{% extends 'layouts/app_layout.html' %}

{% block title %}Centro de Planificación - Sistema Frozen{% endblock %}

{% block extra_css %}
    <link rel="stylesheet" href="{{ url_for('static', filename='css/planificacion/planificacion.css') }}">
    
    {# --- ESTILOS MOVIDOS DE VUELTA AQUÍ --- #}
    <style>
        /* Estilos generales (navegación, cards, etc.) */
        .navegacion-semanal-separada { display: flex; justify-content: space-between; align-items: center; margin-bottom: 0; padding: 0.5rem 1rem; background-color: #f8f9fa; border: 1px solid #dee2e6; border-bottom: none; border-top-left-radius: 0.75rem; border-top-right-radius: 0.75rem; }
        #accordionSemanal .accordion-item:first-of-type .accordion-button,
        #accordionCRP .accordion-item:first-of-type .accordion-button { border-top-left-radius: 0; border-top-right-radius: 0; }
        #accordionSemanal .accordion-header,
        #accordionCRP .accordion-header { margin-top: 0; }
        .card-assignment-details { font-size: 0.8rem; }
        .card-assignment-details span { display: inline-block; margin-right: 0.5rem; }
        .celda-sugerencia-agregada { white-space: normal; line-height: 1.4; }
        .tabla-detalle-op-revision { font-size: 0.9em; background-color: #fdfdfd; }
    </style>
{% endblock %}

{% block app_content %}
<div class="btn-toolbar mb-2">
    <a href="#" onclick="history.back();" class="btn btn-outline-secondary me-2" title="Volver a la página anterior">
        <i class="bi bi-arrow-left"></i> Volver
    </a>
</div>
<div class="d-flex justify-content-between flex-wrap flex-md-nowrap align-items-center pb-2 mb-4 border-bottom">
    <div>
        <h1 class="h2 mb-1">Centro de Planificación</h1>
        <p class="text-muted mb-0">Planifique OPs pendientes, vea la semana y gestione el tablero.</p>
    </div>
</div>

{# --- PLAN MAESTRO --- #}
{# CORRECTO #}
{% if current_user.rol != 'OPERARIO' and current_user.rol != 'SUPERVISOR_CALIDAD'  %}
<div id="planificador-pendientes">
    <div class="planificador-header d-flex justify-content-between align-items-center">
        <span>Plan Maestro (Próximos {{ mps_data.dias_horizonte }} días: {{ mps_data.inicio_horizonte }} al {{ mps_data.fin_horizonte }})</span>
        <div class="btn-group btn-group-sm">
            <a href="{{ url_for('planificacion.index', horizonte=7, semana=semana_actual_str) }}" class="btn btn-outline-secondary {% if mps_data.dias_horizonte == 7 %}active{% endif %}">7 Días</a>
            <a href="{{ url_for('planificacion.index', horizonte=14, semana=semana_actual_str) }}" class="btn btn-outline-secondary {% if mps_data.dias_horizonte == 14 %}active{% endif %}">14 Días</a>
            <a href="{{ url_for('planificacion.index', horizonte=30, semana=semana_actual_str) }}" class="btn btn-outline-secondary {% if mps_data.dias_horizonte == 30 %}active{% endif %}">30 Días</a>
        </div>
    </div>
    <div class="planificador-body">
        {% set mps_items = mps_data.get('mps_agrupado', []) %}
        {% if not mps_items %}
            <div class="alert alert-success text-center">¡Excelente! No hay OPs pendientes en el horizonte.</div>
        {% else %}
            <table class="table table-sm table-hover planificador-tabla align-middle"> {# Añadido align-middle #}
                <thead>
                    <tr>
                        <th>Producto</th>
                        <th class="text-center">Cant. Total Req.</th>
                        <th class="text-center">Fecha Meta Próx.</th>
                        <th style="width: 25%;">Sugerencia Agregada</th>
                        <th style="width: 15%;" class="text-center">Acciones</th>
                    </tr>
                </thead>
                <tbody>
                    {% for item_mps in mps_items %}
                    <tr class="fila-producto-mps" data-bs-toggle="modal" data-bs-target="#modal-producto-{{ item_mps.producto_id }}" style="cursor: pointer;" title="Clic para planificar lote semanal">
                        <td><strong>{{ item_mps.producto_nombre }}</strong></td>
                        <td class="text-center fs-5"><b>{{ item_mps.cantidad_total }}</b></td>
                        <td class="text-center text-danger"><strong>{{ item_mps.fecha_meta_mas_proxima }}</strong></td>
                        <td class="celda-sugerencia-agregada">
                             {% set plazo_total_agg = item_mps.sugerencia_t_prod_dias + item_mps.sugerencia_t_proc_dias %}
                             {% if plazo_total_agg > 0 %}
                                <div class="resultado-sugerencia sugerencia-calculada {% if item_mps.sugerencia_t_proc_dias > 0 %}alert alert-warning{% else %}alert alert-success{% endif %}" style="display: block; font-size: 0.85rem; padding: 8px; margin: -5px -5px -5px 0;">
                                    Línea Sugerida: <b>{{ item_mps.sugerencia_linea or 'N/D' }}</b><hr class="my-1">
                                    Plazo Total: <b>{{ plazo_total_agg }} días</b>
                                    <ul class="mb-0 ps-3 mt-1" style="font-size: 0.8rem;">
                                        <li>Producción: {{ item_mps.sugerencia_t_prod_dias }} días</li>
                                        <li>Compras: {{ item_mps.sugerencia_t_proc_dias }} días {% if item_mps.sugerencia_t_proc_dias > 0 %}(Stock Faltante){% else %}(Stock OK){% endif %}</li>
                                    </ul>
                                </div>
                             {% else %} <span class="text-muted">Error cálculo</span> {% endif %}
                        </td>
                        <td class="text-center">

                            {% if 'crear_orden_de_produccion' is has_permission and not is_operario %}
                            <button class="btn btn-sm btn-primary">
                                <i class="bi bi-calendar-check me-1"></i> Planificar Lote
                            </button>
                            {% endif %}

                        </td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        {% endif %}
    </div>
</div>
{% endif %}

{# --- NAVEGACIÓN SEMANAL MEJORADA --- #}
<div class="navegacion-semanal-separada mt-4">
    <div class="d-flex align-items-center">
        <a href="{{ url_for('planificacion.index', horizonte=mps_data.dias_horizonte, semana=semana_anterior_str) if semana_anterior_str else '#' }}" 
           class="btn btn-sm btn-outline-secondary me-2 {{ 'disabled' if not semana_anterior_str }}">
            <i class="bi bi-chevron-left"></i> Semana Anterior
        </a>
        <span class="fw-bold fs-5 text-primary">Semana {{ semana_actual_str }}</span>
        <a href="{{ url_for('planificacion.index', horizonte=mps_data.dias_horizonte, semana=semana_siguiente_str) if semana_siguiente_str else '#' }}" 
           class="btn btn-sm btn-outline-secondary ms-2 {{ 'disabled' if not semana_siguiente_str }}">
            Próxima Semana <i class="bi bi-chevron-right"></i>
        </a>
    </div>
    <div class="text-muted small">
        <i class="bi bi-info-circle me-1"></i>Visualizando planificación semanal

    </div>
</div>

{# --- [NUEVO] DEFINICIÓN DE LA SEMANA (para Planificación y CRP) --- #}
{# CORRECCIÓN DE LOCALE: Mapa numérico (infalible) #}
{% set dias_lista = ['Lun', 'Mar', 'Mié', 'Jue', 'Vie', 'Sáb', 'Dom'] %}
{% set semana_definida = False %}
{# Usamos las variables que vienen del backend (inicio_semana y fin_semana) #}
{% if inicio_semana and fin_semana %}
    {# date.fromisoformat y timedelta son pasados desde el backend #}
    {% set fecha_inicio = date.fromisoformat(inicio_semana) %}
    {% set fecha_fin = date.fromisoformat(fin_semana) %}
    {% set num_dias = (fecha_fin - fecha_inicio).days + 1 %}
    {% set semana_definida = True %}
{% endif %}
{# --- FIN NUEVO BLOQUE --- #}


{# --- ACORDEÓN: PLANIFICACIÓN SEMANAL MEJORADA --- #}
<div class="accordion mb-4" id="accordionSemanal">
    <div class="accordion-item">
        <h2 class="accordion-header" id="headingSemanal">
            <button class="accordion-button collapsed bg-primary-subtle" type="button" data-bs-toggle="collapse" data-bs-target="#collapseSemanal" aria-expanded="false" aria-controls="collapseSemanal">
                <div class="d-flex align-items-center w-100">
                    <i class="bi bi-calendar-week fs-5 me-3 text-primary-emphasis"></i>
                    <div class="flex-grow-1">
                        <span class="fw-semibold">Planificación Semanal - Vista Detallada</span>
                        <small class="text-muted d-block">Distribución de Órdenes de Producción por día de la semana</small>
                    </div>
                    <div class="badge bg-primary rounded-pill">
                        {# Calcula la suma de las longitudes de todas las listas en el diccionario #}
                        {{ ordenes_por_dia.values() | map('length') | sum }} OPs totales
                    </div>
                </div>
            </button>
        </h2>
        <div id="collapseSemanal" class="accordion-collapse collapse" aria-labelledby="headingSemanal" data-bs-parent="#accordionSemanal">
            <div class="accordion-body p-0">
                <div class="bg-light py-2 px-3 border-bottom">
                    <div class="row align-items-center">
                        <div class="col">
                            <small class="text-muted">
                                <i class="bi bi-lightbulb me-1"></i>
                                Haga clic en cualquier OP para ver detalles
                            </small>
                        </div>
                        <div class="col-auto">
                            <span class="badge bg-success me-2">
                                <i class="bi bi-check-circle me-1"></i>Línea Asignada
                            </span>
                            <span class="badge bg-warning me-2">
                                <i class="bi bi-person me-1"></i>Operario Asignado
                            </span>
                        </div>
                    </div>
                </div>
                
                <div class="row g-2 m-2">
                    {# --- BUCLE MODIFICADO --- #}
                    {% if not semana_definida or not ordenes_por_dia %}
                    <div class="col-12">
                        <div class="text-center py-5">
                            <i class="bi bi-inbox display-4 text-muted"></i>
                            <h5 class="text-muted mt-3">No hay OPs programadas para esta semana</h5>
                            <p class="text-muted">Las órdenes de producción aparecerán aquí cuando sean planificadas.</p>
                        </div>
                    </div>
                    {% else %}
                        {# --- NUEVO BUCLE (COMO CRP) --- #}
                        {% for i in range(num_dias) %}
                            {% set fecha_dia = fecha_inicio + timedelta(days=i) %}
                            {% set fecha_iso = fecha_dia.isoformat() %}
                            {% set dia_num = fecha_dia.weekday() %}
                            
                            {# 1. Definir las listas de claves (del debug) y display (visual) #}
                            {% set dias_lista_display = ['Lun', 'Mar', 'Mié', 'Jue', 'Vie', 'Sáb', 'Dom'] %}
                            {% set dias_lista_key = ['lu.', 'ma.', 'mi.', 'ju.', 'vi.', 'sÃ¡.', 'do.'] %}
                            
                            {# 2. Generar el string de display (para mostrar en la UI) #}
                            {% set dia_display = dias_lista_display[dia_num] + " " + fecha_dia.strftime('%d/%m') %}

                            {# 3. Generar el string de KEY (para buscar en el dict) #}
                            {# Nota: El 'sÃ¡.' del debug es 'sá.' (con tilde) #}
                            {% set dia_key = dias_lista_key[dia_num] + " " + fecha_dia.strftime('%d/%m') %}
                            
                            {# 4. Usar 'dia_key' para obtener las OPs #}
                            {% set ops_del_dia = ordenes_por_dia.get(dia_key, []) %}
                    
                            <div class="col-lg col-md-4 col-sm-6 mb-3">
                                <div class="day-column h-100 shadow-sm">
                                    <div class="day-header d-flex justify-content-between align-items-center">
                                        <span class="fw-bold">{{ dia_display }}</span> {# <-- ¡Cambiado! #}
                                        <span class="badge {% if ops_del_dia %}bg-primary{% else %}bg-secondary{% endif %} rounded-pill">
                                            {{ ops_del_dia | length }} OP{% if ops_del_dia | length != 1 %}s{% endif %}
                                        </span>
                                    </div>
                                    <div class="day-content">
                                        {% if not ops_del_dia %}
                                        <div class="text-center text-muted py-4">
                                            <i class="bi bi-calendar-x display-6"></i>
                                            <p class="small mt-2 mb-0">Sin órdenes programadas</p>
                                        </div>
                                        {% endif %}
                                        
                                        {% for op in ops_del_dia %}
                                        
                                        {# --- DEFINIR CONTENIDO DEL POPOVER --- #}
                                        {% set popover_content %}
                                            <dl class='row mb-0' style='font-size: 0.85rem; min-width: 300px;'>
                                                <dt class='col-5'><i class='bi bi-box-seam me-1'></i>Producto:</dt>
                                                <dd class='col-7'>{{ op.producto_nombre or 'N/A' }}</dd>
                                                
                                                <dt class='col-5'><i class='bi bi-hash me-1'></i>Cantidad:</dt>
                                                <dd class='col-7'>{{ op.cantidad_planificada }}</dd>
                                                
                                                <dt class='col-5'><i class='bi bi-diagram-3-fill me-1 text-primary'></i>Línea:</dt>
                                                <dd class='col-7'>{% if op.linea_asignada %}Línea {{ op.linea_asignada }}{% else %} <span class="text-muted">N/A</span> {% endif %}</dd>
                                                
                                                <dt class='col-5'><i class='bi bi-calendar-check-fill me-1 text-danger'></i>F. Meta:</dt>
                                                <dd class='col-7'>{% if op.fecha_meta %}{{ op.fecha_meta }}{% else %} <span class="text-muted">N/D</span> {% endif %}</dd>
                                                
                                                <dt class='col-12 border-top pt-2 mt-2'><i class='bi bi-people-fill me-1'></i>Asignaciones</dt>
                                                <dt class='col-5'><i class='bi bi-person-badge-fill me-1 text-info'></i>Sup:</dt>
                                                <dd class='col-7'>{{ op.supervisor_nombre or 'No asignado' }}</dd>
                                                
                                                <dt class='col-5'><i class='bi bi-person-fill me-1 text-secondary'></i>Op:</dt>
                                                <dd class='col-7'>{{ op.operario_nombre or 'No asignado' }}</dd>
                                                
                                                <dt class='col-12 border-top pt-2 mt-2'><i class='bi bi-clock-history me-1'></i>Inicio Plan.:</dt>
                                                <dd class='col-12'>{{ op.fecha_inicio_planificada or 'N/P' }}</dd>
                                            </dl>
                                        {% endset %}
        
                                        {# --- INICIO CAMBIO: Wrapper ahora activa POPOVER --- #}
                                        <div class="op-card-mini-wrapper d-block mb-2" 
                                             tabindex="0" 
                                             data-bs-toggle="popover" 
                                             data-bs-trigger="focus" 
                                             data-bs-html="true" 
                                             title="<i class='bi bi-info-circle me-2'></i>Detalle Rápido: {{ op.codigo }}"
                                             data-bs-content="{{ popover_content | e }}"
                                             style="cursor: pointer;"
                                        >
                                        
                                            {# --- CONTENIDO VISUAL DE LA TARJETA (SIN CAMBIOS) --- #}
                                            <div class="op-card-mini position-relative {% if op.linea_asignada %}border-start border-3 border-primary{% else %}border-start border-3 border-secondary{% endif %}"
                                                style="padding-left: 0.75rem;">
                                        
                                                {# Badge de Línea Asignada #}
                                                {% if op.linea_asignada %}
                                                <span class="position-absolute top-0 start-0 translate-middle badge bg-primary rounded-pill"
                                                    style="font-size: 0.6em; margin-left: 10px;">
                                                    L{{ op.linea_asignada }}
                                                </span>
                                                {% endif %}
                                        
                                                {# Título (Producto) y Cantidad #}
                                                <div class="d-flex justify-content-between align-items-start pt-2">
                                                    <strong class="flex-grow-1 me-2" style="font-size: 0.9rem;">{{ op.producto_nombre or 'N/A' }}</strong>
                                                    <small class="text-muted text-nowrap fw-bold">{{ op.cantidad_planificada | round(1) }} {{
                                                        op.producto_unidad_medida or 'und' }}</small>
                                                </div>
                                        
                                                {# Detalles (Código y Operario/Supervisor) #}
                                                <div class="op-details small mt-1">
                                                    <div class="mb-1">
                                                        <i class="bi bi-upc-scan text-secondary me-1"></i>
                                                        <code class="small">{{ op.codigo }}</code>
                                                    </div>
                                                    {% if op.operario_nombre %}
                                                    <div class="text-success">
                                                        <i class="bi bi-person-fill me-1"></i>
                                                        <small>{{ op.operario_nombre.split()[0] }}</small>
                                                    </div>
                                                    {% elif op.supervisor_nombre %}
                                                    <div class="text-info">
                                                        <i class="bi bi-person-badge-fill me-1"></i>
                                                        <small>{{ op.supervisor_nombre.split()[0] }}</small>
                                                    </div>
                                                    {% endif %}
                                                </div>
                                        
                                                {# Fecha de Inicio #}
                                                {% if op.fecha_inicio_planificada %}
                                                <div class="mt-2 pt-1 border-top">
                                                    <small class="text-primary fw-bold">
                                                        <i class="bi bi-clock-history"></i> Inicia: {{ op.fecha_inicio_planificada }}
                                                    </small>
                                                </div>
                                                {% endif %}
                                            </div>
                                            {# --- FIN: CONTENIDO VISUAL --- #}
                                        </div>
                                        {# --- FIN CAMBIO --- #}
                                        {% endfor %}
                                    </div>
                                </div>
                            </div>
                        {% endfor %}
                        {# --- FIN NUEVO BUCLE --- #}
                    {% endif %}
                </div>
            </div>
        </div>
    </div>
</div>

{# --- ACORDEÓN: CRP MEJORADO --- #}
<div class="accordion mb-4" id="accordionCRP">
    <div class="accordion-item">
        <h2 class="accordion-header" id="headingCRP">
            <button class="accordion-button collapsed bg-info-subtle" type="button" data-bs-toggle="collapse" data-bs-target="#collapseCRP" aria-expanded="false" aria-controls="collapseCRP">
                <div class="d-flex align-items-center w-100">
                    <i class="bi bi-speedometer2 fs-5 me-3 text-info-emphasis"></i>
                    <div class="flex-grow-1">
                        <span class="fw-semibold">Análisis de Capacidad vs Carga (CRP)</span>
                        <small class="text-muted d-block">Balance de recursos - Capacidad disponible vs trabajo planificado</small>
                    </div>
                    <div class="badge bg-info rounded-pill">Análisis Semanal</div>
                </div>
            </button>
        </h2>
        <div id="collapseCRP" class="accordion-collapse collapse" aria-labelledby="headingCRP" data-bs-parent="#accordionCRP">
            <div class="accordion-body">
                {# Leyenda de colores #}
                <div class="row mb-3">
                    <div class="col-12">
                        <div class="card bg-light">
                            <div class="card-body py-2">
                                <div class="row text-center">
                                    <div class="col-md-3 mb-1">
                                        <span class="badge bg-success-soft text-success">
                                            <i class="bi bi-check-circle"></i> Óptimo (≤85%)
                                        </span>
                                    </div>
                                    <div class="col-md-3 mb-1">
                                        <span class="badge bg-warning-soft text-warning">
                                            <i class="bi bi-exclamation-triangle"></i> Alerta (86-100%)
                                        </span>
                                    </div>
                                    <div class="col-md-3 mb-1">
                                        <span class="badge bg-danger-soft text-danger">
                                            <i class="bi bi-x-circle"></i> Sobrecarga (>100%)
                                        </span>
                                    </div>
                                    <div class="col-md-3 mb-1">
                                        <span class="badge bg-secondary">
                                            <i class="bi bi-dash-circle"></i> Sin Carga (0%)
                                        </span>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                {% if carga_crp and capacidad_crp and inicio_semana_crp and fin_semana_crp %}
                    {% set fecha_inicio = date.fromisoformat(inicio_semana_crp) %}
                    {% set fecha_fin = date.fromisoformat(fin_semana_crp) %}
                    {% set num_dias = (fecha_fin - fecha_inicio).days + 1 %}
                    
                    {# --- CORRECCIÓN DE LOCALE: Mapa numérico (infalible) --- #}
                    {% set dias_lista = ['Lun', 'Mar', 'Mié', 'Jue', 'Vie', 'Sáb', 'Dom'] %}

                    {# Resumen semanal #}
                    <div class="row mb-3">
                        <div class="col-12">
                            <div class="card">
                                <div class="card-header bg-light py-2">
                                    <h6 class="mb-0"><i class="bi bi-graph-up"></i> Resumen Semanal de Utilización</h6>
                                </div>
                                <div class="card-body">
                                    {% for centro_id, nombre_centro in {1: 'Línea 1', 2: 'Línea 2'}.items() %}
                                    <div class="row mb-2 align-items-center"> {# Añadido align-items-center #}
                                        <div class="col-sm-3">
                                            <strong>{{ nombre_centro }}</strong>
                                        </div>
                                        <div class="col-sm-9">
                                            {# --- NUEVA LÓGICA DE SUMA DIRECTA --- #}
                                            {# 1. Obtener los diccionarios de capacidad y carga para esta línea #}
                                            {% set centro_capacidad_dict = capacidad_crp.get(centro_id, {}) %}
                                            {% set centro_carga_dict = carga_crp.get(centro_id, {}) %}

                                            {# 2. Sumar todos los valores numéricos usando filtros Jinja #}
                                            {#    select('number') es una salvaguarda por si llega algo no numérico #}
                                            {% set total_capacidad = centro_capacidad_dict.values() | select('number') | sum %}
                                            {% set total_carga = centro_carga_dict.values() | select('number') | sum %}

                                            {# 3. Calcular utilización (sin cambios) #}
                                            {% set utilizacion_promedio = (total_carga / total_capacidad * 100) if total_capacidad > 0 else 0 %}
                                            {# --- FIN NUEVA LÓGICA DE SUMA --- #}

                                            <div class="progress" style="height: 20px;" title="Carga: {{ total_carga | round(0) }}min / Cap: {{ total_capacidad | round(0) }}min"> {# Añadido title #}
                                                {% set bg_class = 'bg-danger' if utilizacion_promedio > 100 else ('bg-warning' if utilizacion_promedio > 85 else ('bg-success' if utilizacion_promedio > 0 else 'bg-secondary')) %} {# Añadido bg-secondary para 0% #}

                                                <div class="progress-bar {{ bg_class }}"
                                                     role="progressbar"
                                                     style="width: {% if utilizacion_promedio > 100 %}100{% else %}{{ utilizacion_promedio }}{% endif %}%"
                                                     aria-valuenow="{{ utilizacion_promedio | round(1) }}"
                                                     aria-valuemin="0"
                                                     aria-valuemax="100">
                                                    {{ utilizacion_promedio | round(1) }}%
                                                </div>
                                            </div>
                                            {# Mostrar totales debajo de la barra #}
                                            <small class="text-muted d-block mt-1"> {# Añadido d-block y mt-1 #}
                                                Carga: {{ total_carga | round(0) }}min / Capacidad: {{ total_capacidad | round(0) }}min
                                            </small>
                                        </div>
                                    </div>
                                    {% if not loop.last %}<hr class="my-1">{% endif %} {# Separador entre líneas #}
                                    {% endfor %}
                                </div>
                            </div>
                        </div>
                    </div>
                    {# --- TABLA DETALLADA CRP (NUEVO DISEÑO) --- #}
                    <div class="table-responsive">
                        <table class="table table-sm text-center crp-tabla">
                            <thead>
                                <tr>
                                    <th class="text-start" style="width: 12%;">Centro / Métrica</th> {# Título ajustado #}
                                    {% for i in range(num_dias) %}
                                    {% set fecha_dia = fecha_inicio + timedelta(days=i) %}

                                    {% set dia_num = fecha_dia.weekday() %}

                                    <th class="{% if fecha_dia.weekday() >= 5 %}weekend-header text-center{% endif %}">
                                        {# Usar la lista numérica para obtener la abreviatura #}
                                        {{ dias_lista[dia_num] }}<br>
                                        <small class="text-muted">{{ fecha_dia.strftime('%d/%m') }}</small>
                                    </th>
                                    {% endfor %}
                                </tr>
                            </thead>
                            <tbody>
                                {% for centro_id, nombre_centro in {1: 'Línea 1', 2: 'Línea 2'}.items() %}
                                    {# Fila Capacidad #}
                                    <tr class="crp-capacidad">
                                        <td class="text-start fw-bold metric-label">
                                            <div>{{ nombre_centro }}</div>
                                            <span class="text-muted fw-normal">Capacidad</span>
                                        </td>
                                        {% for i in range(num_dias) %}
                                            {% set fecha_dia = fecha_inicio + timedelta(days=i) %}
                                            {% set fecha_iso = fecha_dia.isoformat() %}
                                            {% set cap = capacidad_crp.get(centro_id, {}).get(fecha_iso, 0) %}
                                            <td class="{% if fecha_dia.weekday() >= 5 %}weekend-cell{% endif %}">
                                                <span class="fw-bold text-primary">{{ cap | round(0) }}</span>
                                                <small class="text-muted d-block">min</small>
                                            </td>
                                        {% endfor %}
                                    </tr>
                                    {# Fila Carga #}
                                    <tr class="crp-carga">
                                        <td class="text-start metric-label">
                                            <span class="text-muted">Carga Planif.</span>
                                        </td>
                                        {% for i in range(num_dias) %}
                                            {% set fecha_dia = fecha_inicio + timedelta(days=i) %}
                                            {% set fecha_iso = fecha_dia.isoformat() %}
                                            {# Obtener el dato de la carga #}
                                            {% set carga = carga_crp.get(centro_id, {}).get(fecha_iso, 0) %}
                                            
                                            {# Esta es la celda de DATOS correcta (td) #}
                                            <td class="{% if fecha_dia.weekday() >= 5 %}weekend-cell{% endif %}">
                                                <span class="fw-bold text-danger">{{ carga | round(0) }}</span>
                                                <small class="text-muted d-block">min</small>
                                            </td>
                                        {% endfor %}
                                    </tr>
                                    {# Fila Utilización #}
                                    <tr class="crp-utilizacion">
                                        <td class="text-start metric-label">
                                            <span class="text-muted">Utilización</span>
                                        </td>
                                        {% for i in range(num_dias) %}
                                            {% set fecha_dia = fecha_inicio + timedelta(days=i) %}
                                            {% set fecha_iso = fecha_dia.isoformat() %}
                                            {% set cap = capacidad_crp.get(centro_id, {}).get(fecha_iso, 0) %}
                                            {% set carga = carga_crp.get(centro_id, {}).get(fecha_iso, 0) %}
                                            {% set utilizacion = (carga / cap * 100) if cap > 0 else 0 %}
                                            {# Colores y clases #}
                                            {% set bg_color = 'bg-danger-soft text-danger' if utilizacion > 100 else ('bg-warning-soft text-warning' if utilizacion > 85 else ('bg-success-soft text-success' if utilizacion > 0 else 'bg-light text-muted')) %}
                                            <td class="{{ bg_color }} {% if fecha_dia.weekday() >= 5 %}weekend-cell{% endif %}">
                                                <span class="fw-bold fs-6">{{ utilizacion | round(0) }}%</span>
                                                {# Iconos #}
                                                {% if utilizacion > 100 %}<i class="bi bi-exclamation-triangle-fill small ms-1" title="Sobrecarga"></i>
                                                {% elif utilizacion > 85 %}<i class="bi bi-exclamation-circle-fill small ms-1" title="Alta utilización"></i>
                                                {% elif utilizacion > 0 %}<i class="bi bi-check-circle-fill small ms-1" title="Óptimo"></i>
                                                {% endif %}
                                            </td>
                                        {% endfor %}
                                    </tr>
                                    {# Espaciador visual si no es la última línea #}
                                    {% if not loop.last %}
                                    <tr class="row-spacer"><td colspan="{{ num_dias + 1 }}"></td></tr>
                                    {% endif %}
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>
                    {# --- FIN TABLA DETALLADA --- #}
                    
                    {# Explicación de métricas #}
                    <div class="mt-3">
                        <div class="card bg-light">
                            <div class="card-body">
                                <h6 class="card-title"><i class="bi bi-info-circle me-1"></i>¿Cómo interpretar esta tabla?</h6>
                                <div class="row">
                                    <div class="col-md-4">
                                        <strong>Capacidad:</strong> Tiempo disponible de la línea (minutos)
                                    </div>
                                    <div class="col-md-4">
                                        <strong>Carga Planificada:</strong> Tiempo asignado a OPs (minutos)
                                    </div>
                                    <div class="col-md-4">
                                        <strong>Utilización:</strong> Porcentaje de uso (Carga/Capacidad)
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                {% else %}
                    <div class="text-center py-4">
                        <i class="bi bi-clipboard-x display-4 text-muted"></i>
                        <h5 class="text-muted mt-3">No hay datos de CRP disponibles</h5>
                        <p class="text-muted">Los datos de capacidad y carga aparecerán cuando existan OPs planificadas.</p>
                    </div>
                {% endif %}
            </div>
        </div>
    </div>
</div>

{# --- TABLERO KANBAN --- #}
<div class="d-flex justify-content-between align-items-center mb-3">
    <h3 class="h4 mb-0">Tablero Kanban (Producción en Curso)</h3>
    
    {# --- NUEVO BOTÓN PARA OCULTAR COLUMNAS --- #}
    <div class="dropdown">
        <button class="btn btn-sm btn-outline-secondary" type="button" id="dropdownMenuColumnas" data-bs-toggle="dropdown" aria-expanded="false" data-bs-auto-close="outside">
            <i class="bi bi-eye-slash me-1"></i> Ver Columnas
        </button>
        <ul class="dropdown-menu dropdown-menu-end p-2" aria-labelledby="dropdownMenuColumnas" id="kanbanColumnToggleList">
            {% for estado_key, titulo_columna in columnas.items() %}
            <li>
                <div class="form-check">
                    <input class="form-check-input kanban-column-toggle" type="checkbox" value="{{ estado_key }}" id="toggle-{{ estado_key }}" checked>
                    <label class="form-check-label small" for="toggle-{{ estado_key }}">
                        {{ titulo_columna }}
                    </label>
                </div>
            </li>
            {% endfor %}
        </ul>
    </div>
</div>
<div class="table-responsive">
    <div class="row flex-nowrap g-3">
        {% for estado_key, titulo_columna in columnas.items() %}
        <div class="col mb-4 kanban-column-wrapper" data-estado="{{ estado_key }}" style="min-width: 250px;">
            <div class="kanban-column h-100" data-estado="{{ estado_key }}">
                <div class="column-header">
                    
                    <span class="kanban-title-text" 
                        data-bs-toggle="collapse" 
                        data-bs-target="#kanban-cards-{{ estado_key }}" 
                        aria-expanded="true" 
                        aria-controls="kanban-cards-{{ estado_key }}"
                        style="cursor: pointer; flex-grow: 1;"
                        title="Clic para expandir/comprimir tarjetas">
                        {{ titulo_columna }}
                    </span>

                    <div class="column-header-controls d-flex align-items-center ms-2">
                        <span class="badge bg-secondary rounded-pill me-2">{{ ordenes_por_estado.get(estado_key, [])|length }}</span>
                        
                        <button class="btn btn-sm btn-light p-0 kanban-compress-toggle" 
                                type="button" 
                                title="Comprimir columna"
                                data-estado-key="{{ estado_key }}">
                            <i class="bi bi-chevron-bar-left"></i>
                            <i class="bi bi-chevron-bar-right" style="display: none;"></i>
                        </button>
                    </div>
                </div>
                <div class="kanban-cards collapse show" id="kanban-cards-{{ estado_key }}">
                    {% for orden in ordenes_por_estado.get(estado_key, []) %}
                    <div class="card insumo-card kanban-card mb-2" data-op-id="{{ orden.id }}" data-producto-id="{{ orden.producto_id }}" data-linea-asignada="{{ orden.linea_asignada or '' }}"> {# Añadido mb-2 #}
                        <div class="card-body py-2 px-3"> {# Padding reducido #}
                            <h6 class="card-title mb-1 fw-bold">{{ orden.producto_nombre or 'N/A' }}</h6> {# Título h6 y bold #}
                            <div class="card-secondary-details small mb-1"> {# Texto más pequeño #}
                                <span><i class="bi bi-upc-scan"></i> <code>{{ orden.codigo }}</code></span>
                                <span class="ms-2"><i class="bi bi-box-seam"></i> <b>{{ orden.cantidad_planificada }}</b></span>
                                <span class="ms-2"><i class="bi bi-calendar-event"></i> {{ orden.fecha_planificada }}</span>
                                {% if orden.fecha_inicio_planificada %}
                                <br><span class="text-primary small"><i class="bi bi-play-circle-fill"></i> Inicia: {{ orden.fecha_inicio_planificada }}</span>
                                {% endif %}
                            </div>
                            {% if orden.supervisor_nombre or orden.linea_asignada or orden.operario_nombre %}
                            <hr class="my-1">
                            <div class="card-assignment-details small"> {# Texto más pequeño #}
                                {% if orden.linea_asignada %}<span class="me-2"><i class="bi bi-diagram-3-fill text-primary"></i> L{{ orden.linea_asignada }}</span>{% endif %}
                                {% if orden.supervisor_nombre %}<span class="me-2"><i class="bi bi-person-badge-fill text-info"></i> S:{{ orden.supervisor_nombre }}</span>{% endif %}
                                {% if orden.operario_nombre %}<span><i class="bi bi-person-fill text-secondary"></i> O:{{ orden.operario_nombre }}</span>{% endif %}
                            </div>
                            {% endif %}
                        </div>
                    </div>
                    {% else %} {# Mensaje si no hay órdenes en la columna #}
                        {% if loop.first and estado_key != 'LISTA PARA PRODUCIR' %} {# Solo mostrar si no es la columna de consolidar #}
                        <p class="text-center text-muted small fst-italic mt-3">Vacío</p>
                        {% endif %}
                    {% endfor %}
                </div>
            </div>
        </div>
    {% endfor %}
    </div>
</div>

{# --- MODALES DE PLANIFICACIÓN (SIN CAMBIOS) --- #}
{% if mps_items %}
    {% for item_mps in mps_items %}
    {% set op_ids_list = item_mps.ordenes | map(attribute='id') | list %}
    <div class="modal fade" id="modal-producto-{{ item_mps.producto_id }}" tabindex="-1" aria-labelledby="modalLabel-{{ item_mps.producto_id }}" aria-hidden="true" data-op-ids="{{ op_ids_list | tojson }}">
      <div class="modal-dialog modal-xl modal-dialog-scrollable">
        <div class="modal-content">
          <div class="modal-header">
            <h5 class="modal-title" id="modalLabel-{{ item_mps.producto_id }}">Planificar Lote Semanal: <strong>{{ item_mps.producto_nombre }}</strong></h5>
            <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Cerrar"></button>
          </div>
          <div class="modal-body">
            <h6>Órdenes Individuales a Consolidar:</h6>
          {# --- MOSTRAR UNIDAD DE MEDIDA --- #}
          <p>Total Requerido: <b>{{ item_mps.cantidad_total }} {{ item_mps.unidad_medida or 'unidades' }}</b> | Fecha Meta Próxima: <b>{{ item_mps.fecha_meta_mas_proxima }}</b></p>
            <table class="table table-sm table-bordered tabla-detalle-op-revision mb-4">
                <thead class="table-light"><tr><th style="width: 15%;">OP</th><th class="text-center" style="width: 15%;">Cantidad</th><th class="text-center" style="width: 15%;">Fecha Meta</th></thead>
                <tbody>
                    {% for op in item_mps.ordenes %}
                    <tr class="detalle-op-row" data-op-id="{{ op.id }}">
                        <td><small><code>{{ op.codigo }}</code></small></td><td class="text-center"><small>{{ op.cantidad_planificada }}</small></td><td class="text-center"><small>{{ op.fecha_meta }}</small></td>
                        {% endfor %}</tbody></table><hr><h5 class="mb-3">Planificar Lote Consolidado</h5>
            {% set plazo_total_agg = item_mps.sugerencia_t_prod_dias + item_mps.sugerencia_t_proc_dias %}
            {% set fecha_inicio_sugerida = (now.date() + timedelta(days=plazo_total_agg)).strftime('%Y-%m-%d') if plazo_total_agg > 0 else now.date().strftime('%Y-%m-%d') %}
            <div class="row g-3"><div class="col-md-6"><div class="resultado-sugerencia sugerencia-calculada {% if item_mps.sugerencia_t_proc_dias > 0 %}alert alert-warning{% else %}alert alert-success{% endif %}" style="display: block; font-size: 0.85rem; padding: 8px;">Línea Sugerida: <b>{{ item_mps.sugerencia_linea or 'N/D' }}</b><hr class="my-1">Plazo Total: <b>{{ plazo_total_agg }} días</b><ul class="mb-0 ps-3 mt-1" style="font-size: 0.8rem;"><li>Producción: {{ item_mps.sugerencia_t_prod_dias }} días</li><li>Compras: {{ item_mps.sugerencia_t_proc_dias }} días {% if item_mps.sugerencia_t_proc_dias > 0 %}(Stock Faltante){% else %}(Stock OK){% endif %}</li></ul></div></div>
                <div class="col-md-6"><div class="card p-3"><div class="mb-2"><label class="form-label form-label-sm fw-bold">Línea <span class="text-danger">*</span></label><select class="form-select form-select-sm mb-1 modal-select-linea" title="Línea"><option value="1" {% if item_mps.sugerencia_linea == 1 %}selected{% endif %}>L1</option><option value="2" {% if item_mps.sugerencia_linea == 2 %}selected{% endif %}>L2</option></select>{# --- MOSTRAR LÍNEAS COMPATIBLES --- #}
                        {% if item_mps.linea_compatible %}
                        <div class="form-text small text-info mt-0">
                            <i class="bi bi-info-circle me-1"></i>Producto compatible solo con: 
                            {% set lineas = item_mps.linea_compatible.split(',') %}
                            {% for linea in lineas %}
                                <strong>Línea {{ linea.strip() }}</strong>{% if not loop.last %}, {% endif %}
                            {% endfor %}
                        </div>
                        {% endif %}
                        {# ----------------------------------- #}</div>
                        <div class="mb-2">
                            <label class="form-label form-label-sm fw-bold">Fecha de Inicio Planificada <span class="text-danger">*</span></label>
                            {# --- AÑADIR ATRIBUTO min --- #}
                            <input type="date" 
                                   class="form-control form-control-sm mb-1 modal-input-fecha-inicio" 
                                   value="{{ fecha_inicio_sugerida }}" 
                                   title="Fecha Inicio"
                                   min="{{ now.date().isoformat() }}"> {# <-- Añadido aquí #}
                            {# ------------------------- #}
                        </div>
                        <div class="mb-2"><label class="form-label form-label-sm">Supervisor (Opc)</label><select
                                class="form-select form-select-sm mb-1 modal-select-supervisor" title="Supervisor">
                                <option value="">Seleccionar...</option> {% for sup in supervisores %}<option value="{{ sup.id }}">{{ sup.nombre
                                    }}</option>{% endfor %}
                            </select></div>
                        <div class="mb-2"><label class="form-label form-label-sm">Operario (Opc)</label><select
                                class="form-select form-select-sm mb-1 modal-select-operario" title="Operario">
                                <option value="">Seleccionar...</option> {% for op_user in operarios %}<option value="{{ op_user.id }}">{{
                                    op_user.nombre }}</option>{% endfor %}
                            </select></div>
                        </div>
                        </div>
                        </div>
                        </div>
          <div class="modal-footer"><button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button><button type="button" class="btn btn-success btn-lg btn-consolidar-y-aprobar"><i class="bi bi-check-lg"></i> Planificar ordenes consolidadas</button></div></div></div></div>
    {% endfor %}
{% endif %}

{# --- REUSABLE FEEDBACK MODAL --- #}
<div class="modal fade" id="feedbackModal" tabindex="-1" aria-labelledby="feedbackModalLabel" aria-hidden="true">
  <div class="modal-dialog modal-dialog-centered"> {# Centered vertically #}
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="feedbackModalLabel">
            <i class="bi bi-info-circle me-2" id="feedbackModalIcon"></i> {# Icon changes based on type #}
            <span id="feedbackModalTitle">Título</span> {# Dynamic title #}
        </h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Cerrar"></button>
      </div>
      <div class="modal-body" id="feedbackModalBody">
        Mensaje del modal. {# Dynamic message #}
      </div>
      <div class="modal-footer">
        {# Button for simple alerts or Cancel #}
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal" id="feedbackModalCancelBtn">Cerrar</button> 
        {# Button for confirmations #}
        <button type="button" class="btn btn-primary" id="feedbackModalConfirmBtn">Confirmar</button> 
      </div>
    </div>
  </div>
</div>
{# --- END FEEDBACK MODAL --- #}

{% endblock %}

{% block extra_js %}
    
    {# --- SCRIPT DE KANBAN (SORTABLE) --- #}
    <script src="https://cdn.jsdelivr.net/npm/sortablejs@latest/Sortable.min.js"></script>
    
    {# --- DATOS JINJA PARA JS --- #}
    <script>
        const listaSupervisores = {{ supervisores | tojson }};
        const listaOperarios = {{ operarios | tojson }};
        const IS_OPERARIO = {{ is_operario | tojson | safe }};
        const IS_SUPERVISOR_CALIDAD = {{ is_supervisor_calidad | tojson | safe }};
    </script>
    
    {# --- SCRIPT DE PLANIFICACIÓN (AHORA CONTIENE EL INICIALIZADOR DE POPOVER) --- #}
    <script src="{{ url_for('static', filename='js/planificacion/planificacion.js') }}"></script>

    {# --- SCRIPT PARA KANBAN (COLUMNAS COMPRIMIBLES / OCULTAR) --- #}
    <script>
    document.addEventListener('DOMContentLoaded', function () {
        
        // --- LÓGICA PARA COMPRIMIR COLUMNAS (NUEVO) ---
        document.querySelectorAll('.kanban-compress-toggle').forEach(button => {
            button.addEventListener('click', function (e) {
                // Evita que el clic en el botón dispare el colapso vertical del título
                e.stopPropagation(); 
                
                const estado = this.dataset.estadoKey;
                const columnWrapper = document.querySelector(`.kanban-column-wrapper[data-estado="${estado}"]`);
                
                if (columnWrapper) {
                    // Alterna el estado comprimido
                    columnWrapper.classList.toggle('kanban-column-compressed');
                    
                    // Alterna el título del botón (para accesibilidad)
                    const isCompressed = columnWrapper.classList.contains('kanban-column-compressed');
                    this.title = isCompressed ? 'Expandir columna' : 'Comprimir columna';
                }
            });
        });

        // --- LÓGICA PARA OCULTAR COLUMNAS (DEL MENÚ SUPERIOR) ---
        const columnToggles = document.querySelectorAll('.kanban-column-toggle');
        
        // Evitar que el menú se cierre al hacer clic en un checkbox
        const columnToggleList = document.getElementById('kanbanColumnToggleList');
        if (columnToggleList) {
            columnToggleList.addEventListener('click', function (e) {
                e.stopPropagation();
            });
        }

        // Lógica para ocultar/mostrar (display: none) columnas
        columnToggles.forEach(checkbox => {
            checkbox.addEventListener('change', function () {
                const estado = this.value;
                const columnWrapper = document.querySelector(`.kanban-column-wrapper[data-estado="${estado}"]`);
                
                if (columnWrapper) {
                    if (this.checked) {
                        columnWrapper.style.display = ''; // Mostrar
                    } else {
                        columnWrapper.style.display = 'none'; // Ocultar
                    }
                }
            });
        });
    });
    </script>
    {# --- FIN DEL NUEVO SCRIPT --- #}

{% endblock %}