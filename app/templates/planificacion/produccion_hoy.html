{% extends "layouts/app_layout.html" %}

{% block app_content %}
{# --- TABLERO KANBAN --- #}
<div class="d-flex justify-content-between align-items-center mb-3">
    <h3 class="h4 mb-0">Tablero Kanban (Producción en Curso)</h3>
    
    {# --- NUEVO BOTÓN PARA OCULTAR COLUMNAS --- #}
    <div class="dropdown">
        <button class="btn btn-sm btn-outline-secondary" type="button" id="dropdownMenuColumnas" data-bs-toggle="dropdown" aria-expanded="false" data-bs-auto-close="outside">
            <i class="bi bi-eye-slash me-1"></i> Ver Columnas
        </button>
        <ul class="dropdown-menu dropdown-menu-end p-2" aria-labelledby="dropdownMenuColumnas" id="kanbanColumnToggleList">
            {% for estado_key, titulo_columna in columnas.items() %}
            <li>
                <div class="form-check">
                    <input class="form-check-input kanban-column-toggle" type="checkbox" value="{{ estado_key }}" id="toggle-{{ estado_key }}" checked>
                    <label class="form-check-label small" for="toggle-{{ estado_key }}">
                        {{ titulo_columna }}
                    </label>
                </div>
            </li>
            {% endfor %}
        </ul>
    </div>
</div>
<div class="table-responsive">
    <div class="row flex-nowrap g-3">
        {% for estado_key, titulo_columna in columnas.items() %}
        <div class="col mb-4 kanban-column-wrapper" data-estado="{{ estado_key }}" style="min-width: 250px;">
            <div class="kanban-column h-100" data-estado="{{ estado_key }}">
                <div class="column-header">
                    
                    <span class="kanban-title-text" 
                        data-bs-toggle="collapse" 
                        data-bs-target="#kanban-cards-{{ estado_key }}" 
                        aria-expanded="true" 
                        aria-controls="kanban-cards-{{ estado_key }}"
                        style="cursor: pointer; flex-grow: 1;"
                        title="Clic para expandir/comprimir tarjetas">
                        {{ titulo_columna }}
                    </span>

                    <div class="column-header-controls d-flex align-items-center ms-2">
                        <span class="badge bg-secondary rounded-pill me-2">{{ ordenes_por_estado.get(estado_key, [])|length }}</span>
                        
                        <button class="btn btn-sm btn-light p-0 kanban-compress-toggle" 
                                type="button" 
                                title="Comprimir columna"
                                data-estado-key="{{ estado_key }}">
                            <i class="bi bi-chevron-bar-left"></i>
                            <i class="bi bi-chevron-bar-right" style="display: none;"></i>
                        </button>
                    </div>
                </div>
                <div class="kanban-cards collapse show" id="kanban-cards-{{ estado_key }}">
                    {% for orden in ordenes_por_estado.get(estado_key, []) %}
                    <div class="card insumo-card kanban-card mb-2" data-op-id="{{ orden.id }}" data-producto-id="{{ orden.producto_id }}" data-linea-asignada="{{ orden.linea_asignada or '' }}"> {# Añadido mb-2 #}
                        <div class="card-body py-2 px-3"> {# Padding reducido #}
                            <h6 class="card-title mb-1 fw-bold">{{ orden.producto_nombre or 'N/A' }}</h6> {# Título h6 y bold #}
                            <div class="card-secondary-details small mb-1"> {# Texto más pequeño #}
                                <span><i class="bi bi-upc-scan"></i> <code>{{ orden.codigo }}</code></span>
                                <span class="ms-2"><i class="bi bi-box-seam"></i> <b>{{ orden.cantidad_planificada }}</b></span>
                                <span class="ms-2"><i class="bi bi-calendar-event"></i> {{ orden.fecha_planificada }}</span>
                                {% if orden.fecha_inicio_planificada %}
                                <br><span class="text-primary small"><i class="bi bi-play-circle-fill"></i> Inicia: {{ orden.fecha_inicio_planificada }}</span>
                                {% endif %}
                            </div>
                            {% if orden.supervisor_nombre or orden.linea_asignada or orden.operario_nombre %}
                            <hr class="my-1">
                            <div class="card-assignment-details small"> {# Texto más pequeño #}
                                {% if orden.linea_asignada %}<span class="me-2"><i class="bi bi-diagram-3-fill text-primary"></i> L{{ orden.linea_asignada }}</span>{% endif %}
                                {% if orden.supervisor_nombre %}<span class="me-2"><i class="bi bi-person-badge-fill text-info"></i> S:{{ orden.supervisor_nombre }}</span>{% endif %}
                                {% if orden.operario_nombre %}<span><i class="bi bi-person-fill text-secondary"></i> O:{{ orden.operario_nombre }}</span>{% endif %}
                            </div>
                            {% endif %}
                        </div>
                    </div>
                    {% else %} {# Mensaje si no hay órdenes en la columna #}
                        {% if loop.first and estado_key != 'LISTA PARA PRODUCIR' %} {# Solo mostrar si no es la columna de consolidar #}
                        <p class="text-center text-muted small fst-italic mt-3">Vacío</p>
                        {% endif %}
                    {% endfor %}
                </div>
            </div>
        </div>
    {% endfor %}
    </div>
</div>

{# --- MODALES DE PLANIFICACIÓN (SIN CAMBIOS) --- #}
{% if mps_items %}
    {% for item_mps in mps_items %}
    {% set op_ids_list = item_mps.ordenes | map(attribute='id') | list %}
    <div class="modal fade" id="modal-producto-{{ item_mps.producto_id }}" tabindex="-1" aria-labelledby="modalLabel-{{ item_mps.producto_id }}" aria-hidden="true" data-op-ids="{{ op_ids_list | tojson }}">
      <div class="modal-dialog modal-xl modal-dialog-scrollable">
        <div class="modal-content">
          <div class="modal-header">
            <h5 class="modal-title" id="modalLabel-{{ item_mps.producto_id }}">Planificar Lote Semanal: <strong>{{ item_mps.producto_nombre }}</strong></h5>
            <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Cerrar"></button>
          </div>
          <div class="modal-body">
            <h6>Órdenes Individuales a Consolidar:</h6>
          {# --- MOSTRAR UNIDAD DE MEDIDA --- #}
          <p>Total Requerido: <b>{{ item_mps.cantidad_total }} {{ item_mps.unidad_medida or 'unidades' }}</b> | Fecha Meta Próxima: <b>{{ item_mps.fecha_meta_mas_proxima }}</b></p>
            <table class="table table-sm table-bordered tabla-detalle-op-revision mb-4">
                <thead class="table-light"><tr><th style="width: 15%;">OP</th><th class="text-center" style="width: 15%;">Cantidad</th><th class="text-center" style="width: 15%;">Fecha Meta</th></thead>
                <tbody>
                    {% for op in item_mps.ordenes %}
                    <tr class="detalle-op-row" data-op-id="{{ op.id }}">
                        <td><small><code>{{ op.codigo }}</code></small></td><td class="text-center"><small>{{ op.cantidad_planificada }}</small></td><td class="text-center"><small>{{ op.fecha_meta }}</small></td>
                        {% endfor %}</tbody></table><hr><h5 class="mb-3">Planificar Lote Consolidado</h5>
            {% set plazo_total_agg = item_mps.sugerencia_t_prod_dias + item_mps.sugerencia_t_proc_dias %}
            {% set fecha_inicio_sugerida = (now.date() + timedelta(days=plazo_total_agg)).strftime('%Y-%m-%d') if plazo_total_agg > 0 else now.date().strftime('%Y-%m-%d') %}
            <div class="row g-3"><div class="col-md-6"><div class="resultado-sugerencia sugerencia-calculada {% if item_mps.sugerencia_t_proc_dias > 0 %}alert alert-warning{% else %}alert alert-success{% endif %}" style="display: block; font-size: 0.85rem; padding: 8px;">Línea Sugerida: <b>{{ item_mps.sugerencia_linea or 'N/D' }}</b><hr class="my-1">Plazo Total: <b>{{ plazo_total_agg }} días</b><ul class="mb-0 ps-3 mt-1" style="font-size: 0.8rem;"><li>Producción: {{ item_mps.sugerencia_t_prod_dias }} días</li><li>Compras: {{ item_mps.sugerencia_t_proc_dias }} días {% if item_mps.sugerencia_t_proc_dias > 0 %}(Stock Faltante){% else %}(Stock OK){% endif %}</li></ul></div></div>
                <div class="col-md-6"><div class="card p-3"><div class="mb-2"><label class="form-label form-label-sm fw-bold">Línea <span class="text-danger">*</span></label><select class="form-select form-select-sm mb-1 modal-select-linea" title="Línea"><option value="1" {% if item_mps.sugerencia_linea == 1 %}selected{% endif %}>L1</option><option value="2" {% if item_mps.sugerencia_linea == 2 %}selected{% endif %}>L2</option></select>{# --- MOSTRAR LÍNEAS COMPATIBLES --- #}
                        {% if item_mps.linea_compatible %}
                        <div class="form-text small text-info mt-0">
                            <i class="bi bi-info-circle me-1"></i>Producto compatible solo con: 
                            {% set lineas = item_mps.linea_compatible.split(',') %}
                            {% for linea in lineas %}
                                <strong>Línea {{ linea.strip() }}</strong>{% if not loop.last %}, {% endif %}
                            {% endfor %}
                        </div>
                        {% endif %}
                        {# ----------------------------------- #}</div>
                        <div class="mb-2">
                            <label class="form-label form-label-sm fw-bold">Fecha de Inicio Planificada <span class="text-danger">*</span></label>
                            {# --- AÑADIR ATRIBUTO min --- #}
                            <input type="date" 
                                   class="form-control form-control-sm mb-1 modal-input-fecha-inicio" 
                                   value="{{ fecha_inicio_sugerida }}" 
                                   title="Fecha Inicio"
                                   min="{{ now.date().isoformat() }}"> {# <-- Añadido aquí #}
                            {# ------------------------- #}
                        </div>
                        <div class="mb-2"><label class="form-label form-label-sm">Supervisor (Opc)</label><select
                                class="form-select form-select-sm mb-1 modal-select-supervisor" title="Supervisor">
                                <option value="">Seleccionar...</option> {% for sup in supervisores %}<option value="{{ sup.id }}">{{ sup.nombre
                                    }}</option>{% endfor %}
                            </select></div>
                        <div class="mb-2"><label class="form-label form-label-sm">Operario (Opc)</label><select
                                class="form-select form-select-sm mb-1 modal-select-operario" title="Operario">
                                <option value="">Seleccionar...</option> {% for op_user in operarios %}<option value="{{ op_user.id }}">{{
                                    op_user.nombre }}</option>{% endfor %}
                            </select></div>
                        </div>
                        </div>
                        </div>
                        </div>
          <div class="modal-footer"><button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button><button type="button" class="btn btn-success btn-lg btn-consolidar-y-aprobar"><i class="bi bi-check-lg"></i> Planificar ordenes consolidadas</button></div></div></div></div>
    {% endfor %}
{% endif %}

{# --- REUSABLE FEEDBACK MODAL --- #}
<div class="modal fade" id="feedbackModal" tabindex="-1" aria-labelledby="feedbackModalLabel" aria-hidden="true">
  <div class="modal-dialog modal-dialog-centered"> {# Centered vertically #}
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="feedbackModalLabel">
            <i class="bi bi-info-circle me-2" id="feedbackModalIcon"></i> {# Icon changes based on type #}
            <span id="feedbackModalTitle">Título</span> {# Dynamic title #}
        </h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Cerrar"></button>
      </div>
      <div class="modal-body" id="feedbackModalBody">
        Mensaje del modal. {# Dynamic message #}
      </div>
      <div class="modal-footer">
        {# Button for simple alerts or Cancel #}
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal" id="feedbackModalCancelBtn">Cerrar</button> 
        {# Button for confirmations #}
        <button type="button" class="btn btn-primary" id="feedbackModalConfirmBtn">Confirmar</button> 
      </div>
    </div>
  </div>
</div>
{# --- END FEEDBACK MODAL --- #}

{% endblock %}

{% block extra_js %}
    
    {# --- SCRIPT DE KANBAN (SORTABLE) --- #}
    <script src="https://cdn.jsdelivr.net/npm/sortablejs@latest/Sortable.min.js"></script>
    
    {# --- DATOS JINJA PARA JS --- #}
    <script>
        const listaSupervisores = {{ supervisores | tojson }};
        const listaOperarios = {{ operarios | tojson }};
        const IS_OPERARIO = {{ is_operario | tojson | safe }};
        const IS_SUPERVISOR_CALIDAD = {{ is_supervisor_calidad | tojson | safe }};
    </script>
    
    {# --- SCRIPT DE PLANIFICACIÓN (AHORA CONTIENE EL INICIALIZADOR DE POPOVER) --- #}
    <script src="{{ url_for('static', filename='js/planificacion/planificacion.js') }}"></script>

    {# --- SCRIPT PARA KANBAN (COLUMNAS COMPRIMIBLES / OCULTAR) --- #}
    <script>
    document.addEventListener('DOMContentLoaded', function () {
        
        // --- LÓGICA PARA COMPRIMIR COLUMNAS (NUEVO) ---
        document.querySelectorAll('.kanban-compress-toggle').forEach(button => {
            button.addEventListener('click', function (e) {
                // Evita que el clic en el botón dispare el colapso vertical del título
                e.stopPropagation(); 
                
                const estado = this.dataset.estadoKey;
                const columnWrapper = document.querySelector(`.kanban-column-wrapper[data-estado="${estado}"]`);
                
                if (columnWrapper) {
                    // Alterna el estado comprimido
                    columnWrapper.classList.toggle('kanban-column-compressed');
                    
                    // Alterna el título del botón (para accesibilidad)
                    const isCompressed = columnWrapper.classList.contains('kanban-column-compressed');
                    this.title = isCompressed ? 'Expandir columna' : 'Comprimir columna';
                }
            });
        });

        // --- LÓGICA PARA OCULTAR COLUMNAS (DEL MENÚ SUPERIOR) ---
        const columnToggles = document.querySelectorAll('.kanban-column-toggle');
        
        // Evitar que el menú se cierre al hacer clic en un checkbox
        const columnToggleList = document.getElementById('kanbanColumnToggleList');
        if (columnToggleList) {
            columnToggleList.addEventListener('click', function (e) {
                e.stopPropagation();
            });
        }

        // Lógica para ocultar/mostrar (display: none) columnas
        columnToggles.forEach(checkbox => {
            checkbox.addEventListener('change', function () {
                const estado = this.value;
                const columnWrapper = document.querySelector(`.kanban-column-wrapper[data-estado="${estado}"]`);
                
                if (columnWrapper) {
                    if (this.checked) {
                        columnWrapper.style.display = ''; // Mostrar
                    } else {
                        columnWrapper.style.display = 'none'; // Ocultar
                    }
                }
            });
        });
    });
    </script>
    {# --- FIN DEL NUEVO SCRIPT --- #}

{% endblock %}
