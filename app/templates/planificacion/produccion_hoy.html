{% extends "layouts/app_layout.html" %}

{% block extra_css %}
    <link rel="stylesheet" href="{{ url_for('static', filename='css/planificacion/kanban.css') }}">
{% endblock %}

{% block app_content %}

{# --- FILTROS R√ÅPIDOS --- #}
<div class="quick-filters">
    <span class="filter-label">üîç Filtrar:</span>
    <button class="filter-btn active" data-filter="todas">Todas</button>
    <button class="filter-btn" data-filter="mis-ordenes">Mis √ìrdenes</button>
    <button class="filter-btn" data-filter="linea-1">L√≠nea 1</button>
    <button class="filter-btn" data-filter="linea-2">L√≠nea 2</button>
    <button class="filter-btn" data-filter="alta-prioridad">Alta Prioridad</button>
</div>

{# --- TABLERO KANBAN --- #}
<div class="d-flex justify-content-between align-items-center mb-3">
    <h3 class="h4 mb-0">Tablero Kanban (Producci√≥n en Curso)</h3>
    
    {# --- BOT√ìN PARA OCULTAR COLUMNAS --- #}
    <div class="dropdown">
        <button class="btn btn-sm btn-outline-secondary" type="button" id="dropdownMenuColumnas" data-bs-toggle="dropdown" aria-expanded="false" data-bs-auto-close="outside">
            <i class="bi bi-eye-slash me-1"></i> Ver Columnas
        </button>
        <ul class="dropdown-menu dropdown-menu-end p-2" aria-labelledby="dropdownMenuColumnas" id="kanbanColumnToggleList">
            {% for estado_key, titulo_columna in columnas.items() %}
            <li>
                <div class="form-check">
                    <input class="form-check-input kanban-column-toggle" type="checkbox" value="{{ estado_key }}" id="toggle-{{ estado_key }}" checked>
                    <label class="form-check-label small" for="toggle-{{ estado_key }}">
                        {{ titulo_columna }}
                    </label>
                </div>
            </li>
            {% endfor %}
        </ul>
    </div>
</div>

<div class="table-responsive">
    <div class="row flex-nowrap g-3">
        {% for estado_key, titulo_columna in columnas.items() %}
        <div class="col mb-4 kanban-column-wrapper" data-estado="{{ estado_key }}" style="min-width: 320px;">
            <div class="kanban-column h-100" data-estado="{{ estado_key }}">
                <div class="column-header">
                    <span class="kanban-title-text" 
                        data-bs-toggle="collapse" 
                        data-bs-target="#kanban-cards-{{ estado_key }}" 
                        aria-expanded="true" 
                        aria-controls="kanban-cards-{{ estado_key }}"
                        style="cursor: pointer; flex-grow: 1;"
                        title="Clic para expandir/comprimir tarjetas">
                        {{ titulo_columna }}
                    </span>

                    <div class="column-header-controls d-flex align-items-center ms-2">
                        <span class="badge bg-secondary rounded-pill me-2">{{ ordenes_por_estado.get(estado_key, [])|length }}</span>
                        
                        <button class="btn btn-sm btn-light p-0 kanban-compress-toggle" 
                                type="button" 
                                title="Comprimir columna"
                                data-estado-key="{{ estado_key }}">
                            <i class="bi bi-chevron-bar-left"></i>
                            <i class="bi bi-chevron-bar-right" style="display: none;"></i>
                        </button>
                    </div>
                </div>
                
                <div class="kanban-cards collapse show" id="kanban-cards-{{ estado_key }}">
                    {% for orden in ordenes_por_estado.get(estado_key, []) %}
                    {% set prioridad = orden.get('prioridad', 'BAJA') %}
                    {% set prioridad_class = 'borde-baja' %}
                    {% if prioridad == 'ALTA' %}
                        {% set prioridad_class = 'borde-alta' %}
                    {% elif prioridad == 'MEDIA' %}
                        {% set prioridad_class = 'borde-media' %}
                    {% endif %}
                    
                    <div class="card kanban-card mb-2 {{ prioridad_class }}" 
                         data-op-id="{{ orden.id }}"
                         data-linea="{{ orden.linea_asignada or '' }}"
                         data-prioridad="{{ prioridad }}">
                        <div class="card-body">
                            <div class="d-flex justify-content-between align-items-start mb-2">
                                <h6 class="card-title mb-0">{{ orden.producto_nombre or 'N/A' }}</h6>
                                <span class="badge {{ 'bg-danger' if prioridad == 'ALTA' else ('bg-warning text-dark' if prioridad == 'MEDIA' else 'bg-success') }}">
                                    {{ prioridad }}
                                </span>
                            </div>
                            
                            <p class="card-text mb-2">
                                <i class="bi bi-upc-scan me-1"></i> <code>OP-{{ orden.codigo }}</code>
                            </p>
                            
                            <div class="d-flex flex-column small">
                                <span class="mb-1">
                                    <i class="bi bi-box-seam me-2"></i>
                                    <strong>Cantidad:</strong> {{ orden.cantidad_planificada }} kg
                                </span>
                                
                                {% if estado_key in ['EN ESPERA', 'LISTA PARA PRODUCIR'] %}
                                <span class="mb-1">
                                    <i class="bi bi-diagram-3 me-2"></i>
                                    <strong>L√≠nea:</strong> 
                                    {% if orden.linea_asignada %}
                                        L√≠nea {{ orden.linea_asignada }}
                                    {% else %}
                                        <span class="text-muted">Sin asignar</span>
                                    {% endif %}
                                </span>
                                {% endif %}
                                
                                <span class="mb-1">
                                    <i class="bi bi-calendar-event me-2"></i>
                                    <strong>Inicio:</strong> {{ orden.fecha_inicio_planificada or 'Sin asignar' }}
                                </span>
                                
                                {% if estado_key == 'LISTA PARA PRODUCIR' and orden.sugerencia_t_prod_dias is not none %}
                                <span class="mb-1">
                                    <i class="bi bi-clock me-2"></i>
                                    <strong>Tiempo Est.:</strong> {{ orden.sugerencia_t_prod_dias }} d√≠as
                                </span>
                                {% endif %}
                                
                                {# Para √≥rdenes en proceso - Mostrar progreso #}
                                {% if estado_key.startswith('EN_LINEA') and orden.cantidad_producida is not none %}
                                <span class="mb-1">
                                    <i class="bi bi-activity me-2"></i>
                                    <strong>Progreso:</strong> {{ orden.cantidad_producida }} / {{ orden.cantidad_planificada }} kg
                                </span>
                                <div class="progress-bar-kanban">
                                    <div class="progress-fill-kanban" style="width: {{ (orden.cantidad_producida / orden.cantidad_planificada * 100) | round }}%"></div>
                                </div>
                                
                                {# Timer activo #}
                                <div class="active-timer">
                                    <div class="timer-pulse"></div>
                                    <span class="timer-text">‚è±Ô∏è En proceso</span>
                                </div>
                                {% endif %}
                                
                                {# Mostrar operario si est√° asignado #}
                                {% if orden.operario_nombre %}
                                <span class="mb-1">
                                    <i class="bi bi-person-fill me-2"></i>
                                    <strong>Operario:</strong> {{ orden.operario_nombre }}
                                </span>
                                {% endif %}
                            </div>
                            
                            {# Botones de acci√≥n seg√∫n el estado #}
                            {% if estado_key == 'LISTA PARA PRODUCIR' %}
                                <div class="d-grid mt-3">
                                    <button class="btn btn-primary btn-sm btn-iniciar-op" 
                                            data-op-id="{{ orden.id }}" 
                                            data-op-sugerencia-linea="{{ orden.linea_asignada or '' }}">
                                        <i class="bi bi-play-fill me-1"></i> Iniciar Trabajo
                                    </button>
                                </div>
                            {% elif estado_key.startswith('EN_LINEA') %}
                                <div class="card-actions mt-2">
                                    <button class="btn btn-pause btn-sm" onclick="pauseOrder({{ orden.id }})">
                                        ‚è∏Ô∏è Pausar
                                    </button>
                                    <button class="btn btn-complete btn-sm" onclick="reportProgress({{ orden.id }})">
                                        ‚úÖ Reportar
                                    </button>
                                </div>
                            {% endif %}
                        </div>
                    </div>
                    {% else %}
                        {# Mensaje si no hay √≥rdenes en la columna #}
                        <p class="text-center text-muted fst-italic mt-3">
                            <i class="bi bi-inbox" style="font-size: 32px; display: block; margin-bottom: 8px; opacity: 0.5;"></i>
                            Sin √≥rdenes
                        </p>
                    {% endfor %}
                </div>
            </div>
        </div>
        {% endfor %}
    </div>
</div>

{# --- MODAL: INICIAR ORDEN DE PRODUCCI√ìN --- #}
<div class="modal fade" id="modalIniciarOp" tabindex="-1" aria-labelledby="modalIniciarOpLabel" aria-hidden="true">
  <div class="modal-dialog">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="modalIniciarOpLabel">
            <i class="bi bi-play-circle-fill me-2"></i>Iniciar Orden de Producci√≥n
        </h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body">
        <p>Est√° a punto de iniciar la OP <strong id="modal-op-codigo"></strong>.</p>
        <form id="formIniciarOp">
          <input type="hidden" id="modal-op-id" name="op_id">
          
          <div class="mb-3">
            <label for="modal-linea-produccion" class="form-label">
                Confirmar l√≠nea de producci√≥n <span class="text-danger">*</span>
            </label>
            <select class="form-select" id="modal-linea-produccion" name="linea_produccion" required>
              <option value="1">L√≠nea 1</option>
              <option value="2">L√≠nea 2</option>
            </select>
            <div class="form-text" id="modal-linea-sugerida-text"></div>
          </div>
          
          <div class="mb-3">
            <label class="form-label">Verificaci√≥n de operario</label>
            <div class="form-check">
              <input class="form-check-input" type="checkbox" id="check-materiales" required>
              <label class="form-check-label" for="check-materiales">
                Materias primas disponibles
              </label>
            </div>
            <div class="form-check">
              <input class="form-check-input" type="checkbox" id="check-limpieza" required>
              <label class="form-check-label" for="check-limpieza">
                L√≠nea limpia y sanitizada
              </label>
            </div>
            <div class="form-check">
              <input class="form-check-input" type="checkbox" id="check-equipos" required>
              <label class="form-check-label" for="check-equipos">
                Equipos funcionando correctamente
              </label>
            </div>
          </div>
        </form>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
        <button type="submit" class="btn btn-primary" form="formIniciarOp">
            <i class="bi bi-play-fill me-1"></i>Iniciar Trabajo
        </button>
      </div>
    </div>
  </div>
</div>

{# --- MODAL: REPORTAR AVANCE --- #}
<div class="modal fade" id="modalReportarAvance" tabindex="-1">
  <div class="modal-dialog">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title">
            <i class="bi bi-clipboard-data me-2"></i>Reportar Avance de Producci√≥n
        </h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
      </div>
      <div class="modal-body">
        <form id="formReportarAvance">
          <input type="hidden" id="modal-report-op-id">
          
          <div class="mb-3">
            <label for="cantidad-producida" class="form-label">
                Cantidad Producida (Buena) <span class="text-danger">*</span>
            </label>
            <input type="number" class="form-control" id="cantidad-producida" 
                   placeholder="Ej: 40.0" step="0.1" required>
          </div>
          
          <div class="mb-3">
            <label for="cantidad-desperdicio" class="form-label">
                Cantidad Desperdicio (Mala)
            </label>
            <input type="number" class="form-control" id="cantidad-desperdicio" 
                   placeholder="Ej: 2.0" step="0.1" value="0">
          </div>
          
          <div class="mb-3">
            <label for="motivo-desperdicio" class="form-label">
                Motivo de Desperdicio (si aplica)
            </label>
            <select class="form-select" id="motivo-desperdicio">
              <option value="">Sin desperdicio</option>
              <option value="falla_empaque">Falla de empaque</option>
              <option value="materia_prima">Materia prima defectuosa</option>
              <option value="temperatura">Error de temperatura</option>
              <option value="proceso">Error de proceso</option>
              <option value="contaminacion">Contaminaci√≥n cruzada</option>
            </select>
          </div>
          
          <div class="mb-3">
            <label for="observaciones" class="form-label">Observaciones adicionales</label>
            <textarea class="form-control" id="observaciones" rows="3" 
                      placeholder="Comentarios opcionales sobre el proceso..."></textarea>
          </div>
        </form>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
        <button type="submit" class="btn btn-success" form="formReportarAvance">
            <i class="bi bi-check-lg me-1"></i>Confirmar Reporte
        </button>
      </div>
    </div>
  </div>
</div>

{# --- MODAL: PAUSAR ORDEN --- #}
<div class="modal fade" id="modalPausarOrden" tabindex="-1">
  <div class="modal-dialog">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title">
            <i class="bi bi-pause-circle-fill me-2"></i>Pausar Orden de Producci√≥n
        </h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
      </div>
      <div class="modal-body">
        <form id="formPausarOrden">
          <input type="hidden" id="modal-pause-op-id">
          
          <div class="mb-3">
            <label for="motivo-pausa" class="form-label">
                Motivo de la pausa <span class="text-danger">*</span>
            </label>
            <select class="form-select" id="motivo-pausa" required>
              <option value="">Seleccionar motivo...</option>
              <option value="averia">Aver√≠a de m√°quina</option>
              <option value="mantenimiento">Mantenimiento programado</option>
              <option value="espera_material">Espera de material/insumo</option>
              <option value="espera_supervisor">Espera de supervisor</option>
              <option value="break">Break/Almuerzo</option>
              <option value="cambio_turno">Cambio de turno</option>
              <option value="calidad">Problema de calidad</option>
              <option value="otro">Otro</option>
            </select>
          </div>
          
          <div class="mb-3">
            <label for="detalles-pausa" class="form-label">Detalles adicionales</label>
            <textarea class="form-control" id="detalles-pausa" rows="3" 
                      placeholder="Describe el motivo de la pausa..."></textarea>
          </div>
        </form>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
        <button type="submit" class="btn btn-warning" form="formPausarOrden">
            <i class="bi bi-pause-fill me-1"></i>Confirmar Pausa
        </button>
      </div>
    </div>
  </div>
</div>

{% endblock %}

{% block extra_js %}
    {# --- SCRIPT DE KANBAN (SORTABLE) --- #}
    <script src="https://cdn.jsdelivr.net/npm/sortablejs@latest/Sortable.min.js"></script>
    
    {# --- SCRIPT PRINCIPAL DE PRODUCCI√ìN HOY --- #}
    <script src="{{ url_for('static', filename='js/planificacion/produccion_hoy.js') }}"></script>
{% endblock %}