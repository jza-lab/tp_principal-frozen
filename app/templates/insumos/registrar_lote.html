{% extends 'layouts/base.html' %}

{% set is_edit = lote and lote.id_lote %}
{% set form_title = 'Editar Lote' if is_edit else 'Registrar Nuevo Lote' %}

{% block title %}{{ form_title }} - {{ insumo.nombre }}{% endblock %}

{% block page_title %}{{ form_title }}{% endblock %}
{% block page_subtitle %}
<strong>Insumo:</strong> {{ insumo.nombre }}
<span class="text-muted">({{ insumo.codigo_interno }})</span>
{% if is_edit and lote %}
<br><small class="text-muted">Lote: {{ lote.numero_lote_proveedor }}</small>
{% endif %}
{% endblock %}
{% block page_actions %}
<a href="{{ url_for('insumos_api.obtener_insumo_por_id', id_insumo=insumo.id_insumo) }}" class="btn btn-outline-secondary">
    <i class="bi bi-arrow-left me-1"></i>Volver al Insumo
</a>
{% endblock %}

{% block content %}
<div class="row">
    <div class="col-lg-8">
        <div class="card">
            <div class="card-header">
                <h5 class="mb-0">Información del Lote</h5>
            </div>
            <div class="card-body">
                <form id="form-lote" method="post"
                      data-is-edit="{{ 'true' if is_edit else 'false' }}"
                      data-create-url="{{ url_for('insumos_api.crear_lote', id_insumo=insumo.id_insumo) }}"
                      data-edit-url="{{ url_for('insumos_api.actualizar_lote_api', id_insumo=insumo.id_insumo, id_lote=lote.id_lote) if is_edit }}"
                      data-redirect-url="{{ url_for('insumos_api.obtener_insumo_por_id', id_insumo=insumo.id_insumo) }}">

                    <input type="hidden" id="id_insumo" name="id_insumo" value="{{ insumo.id_insumo }}">
                    {% if is_edit %}
                    <input type="hidden" id="id_lote" name="id_lote" value="{{ lote.id_lote }}">
                    {% endif %}

                    <div class="row g-3">
                        <div class="col-md-6">
                            <label for="proveedor_id" class="form-label">Proveedor <span class="text-danger">*</span></label>
                            <select class="form-select" id="proveedor_id" name="proveedor_id" required {{ 'disabled' if is_edit }}>
                                <option value="">Seleccionar proveedor...</option>
                                {% for p in proveedores %}
                                <option value="{{ p.id_proveedor }}" {{ 'selected' if is_edit and lote.id_proveedor == p.id_proveedor }}>
                                    {{ p.nombre }}
                                </option>
                                {% endfor %}
                            </select>
                        </div>
                        
                        <div class="col-md-6">
                            <label for="fecha_ingreso" class="form-label">Fecha de Ingreso <span class="text-danger">*</span></label>
                            <input type="date" class="form-control" id="fecha_ingreso" name="fecha_ingreso"
                                   value="{{ lote.f_ingreso if is_edit else today }}" required {{ 'readonly' if is_edit }}>
                        </div>

                        {% if is_edit %}
                        <div class="col-md-6">
                            <label for="cantidad_inicial" class="form-label">Cantidad Inicial</label>
                            <div class="input-group">
                                <input type="number" min="1 max="10000" step="0.1" class="form-control" id="cantidad_inicial" name="cantidad_inicial"
                                       value="{{ lote.get('cantidad_inicial', '') }}" readonly>
                                <span class="input-group-text">{{ insumo.unidad_medida }}</span>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <label for="cantidad_actual" class="form-label">Cantidad Actual <span class="text-danger">*</span></label>
                            <div class="input-group">
                                <input type="number" min="0" step="0.1"class="form-control" id="cantidad_actual" name="cantidad_actual"
                                       value="{{ lote.get('cantidad_actual', '') }}" required>
                                <span class="input-group-text">{{ insumo.unidad_medida }}</span>
                            </div>
                        </div>
                        {% else %}
                        <div class="col-md-6">
                            <label for="cantidad_inicial" class="form-label">Cantidad Inicial <span class="text-danger">*</span></label>
                            <div class="input-group">
                                <input type="number" min="1" step="0.1" class="form-control" id="cantidad_inicial" name="cantidad_inicial" required>
                                <span class="input-group-text">{{ insumo.unidad_medida }}</span>
                            </div>
                        </div>
                        {% endif %}

                        <div class="col-md-6">
                            <label for="fecha_vencimiento" class="form-label">Fecha de Vencimiento <span class="text-danger">*</span></label>
                            <input type="date" class="form-control" id="fecha_vencimiento" name="fecha_vencimiento"
                                   value="{{ lote.f_vencimiento if is_edit else '' }}" required>
                        </div>
                        
                        <div class="col-12">
                            <hr class="my-4">
                            <h6 class="mb-3">Información Adicional (Opcional)</h6>
                        </div>

                        <div class="col-md-6">
                            <label for="documento_ingreso" class="form-label">Orden de Compra</label>
                            <select class="form-select" id="documento_ingreso" name="documento_ingreso" {{ 'disabled' if is_edit }}>
                                <option value="">Seleccionar Orden de Compra...</option>
                                {% for item in ordenes %}
                                <option value="{{ item.codigo_oc }}" data-precio="{{ item.precio_unitario }}"
                                        {{ 'selected' if is_edit and lote.documento_ingreso == item.codigo_oc }}>
                                    {{ item.codigo_oc }} - {{ item.precio_unitario }}
                                </option>
                                {% endfor %}
                            </select>
                        </div>

                        <div class="col-md-6">
                            <label for="precio_unitario" class="form-label">Precio Unitario</label>
                            <div class="input-group">
                                <span class="input-group-text">$</span>
                                <input type="number" step="0.01" min= "1" class="form-control" id="precio_unitario" name="precio_unitario"
                                       value="{{ lote.get('precio_unitario', '') }}">
                            </div>
                        </div>

                        <div class="col-12">
                            <label for="observaciones" class="form-label">Observaciones</label>
                            <textarea class="form-control" id="observaciones" name="observaciones" rows="3">{{ lote.get('observaciones', '') }}</textarea>
                        </div>
                    </div>

                    <div class="d-flex justify-content-end gap-2 mt-4">
                        <a href="{{ url_for('insumos_api.obtener_insumo_por_id', id_insumo=insumo.id_insumo) }}" class="btn btn-outline-secondary">
                            Cancelar
                        </a>
                        <button type="submit" class="btn btn-primary" id="submit-lote">
                            <i class="bi bi-check-circle me-1"></i>
                            {% if is_edit %}Guardar Cambios{% else %}Registrar Lote{% endif %}
                        </button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <div class="col-lg-4">
        <div class="card">
            <div class="card-header">
                <h6 class="mb-0">Información del Insumo</h6>
            </div>
            <div class="card-body">
                <div class="row g-3">
                    <div class="col-6">
                        <div class="text-muted small">Stock Actual</div>
                        <div class="fw-bold">{{ insumo.stock_actual }} {{ insumo.unidad_medida }}</div>
                    </div>
                    <div class="col-6">
                        <div class="text-muted small">Stock Mínimo</div>
                        <div class="fw-bold">{{ insumo.stock_min }} {{ insumo.unidad_medida }}</div>
                    </div>
                    <div class="col-12">
                        <div class="text-muted small">Categoría</div>
                        <div class="fw-bold">{{ insumo.categoria }}</div>
                    </div>
                </div>
            </div>
        </div>

        <div class="card mt-3">
            <div class="card-body">
                <div class="alert alert-light border mb-0">
                    <div class="small">
                        <i class="bi bi-info-circle me-1"></i>
                        <strong>Nota:</strong> Al registrar este lote, se actualizará automáticamente el stock actual
                        del insumo.
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
{% block scripts %}
<script>
    document.addEventListener('DOMContentLoaded', function () {
  // 1. Obtener referencias a los elementos
        const ordenCompraSelect = document.getElementById("numero_factura");
        const precioUnitarioInput = document.getElementById("precio_unitario");

        // 2. Agregar el event listener para detectar el cambio en la selección
        ordenCompraSelect.addEventListener('change', function () {
            
            // Obtener el elemento <option> actualmente seleccionado
            const selectedOption = this.options[this.selectedIndex];

            // Obtener el valor del atributo data-precio.
            // Si no hay opción seleccionada o el atributo no existe, será null.
            const precio = selectedOption.getAttribute('data-precio');

            // 3. Actualizar el campo de Precio Unitario
            if (precio !== null) {
                // Establecer el valor, asegurando que sea un número flotante para el input
                precioUnitarioInput.value = parseFloat(precio).toFixed(2);
            } else {
                // Limpiar el campo si no se selecciona una opción válida (ej. "Seleccionar Orden...")
                precioUnitarioInput.value = "";
            }
        });
        
        // Opcional: Ejecutar la lógica al cargar la página si ya hay una opción seleccionada (útil para errores de formulario)
        ordenCompraSelect.dispatchEvent(new Event('change'));
    });

</script>
<script src="{{ url_for('static', filename='js/formularioLote.js') }}" defer></script>
{% endblock %}

{% endblock %}