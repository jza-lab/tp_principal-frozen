{% extends "base.html" %}

{% block content %}
<div class="row">
    <div class="col-md-12">
        <div class="card">
            <div class="card-header bg-primary text-white">
                <h2 class="card-title mb-0"><i class="bi bi-speedometer2 me-2"></i>Detalles del Indicador OEE (Overall Equipment Effectiveness)</h2>
                <p class="card-text mb-0">Eficiencia General de los Equipos por Turno</p>
            </div>
            <div class="card-body">
                <!-- Resumen de métricas OEE -->
                <div class="row mb-4">
                    <div class="col-md-3">
                        <div class="card text-center border-primary">
                            <div class="card-header bg-primary text-white">
                                <h5 class="mb-0">OEE General</h5>
                            </div>
                            <div class="card-body">
                                <h2 class="card-title {% if oee_promedio * 100 >= 85 %}text-success{% elif oee_promedio * 100 >= 65 %}text-warning{% else %}text-danger{% endif %}">
                                    {{ "%.1f"|format(oee_promedio * 100) }}%
                                </h2>
                                <div class="progress mb-2">
                                    <div class="progress-bar {% if oee_promedio * 100 >= 85 %}bg-success{% elif oee_promedio * 100 >= 65 %}bg-warning{% else %}bg-danger{% endif %}" 
                                         role="progressbar" style="width: {{ oee_promedio * 100 }}%;" 
                                         aria-valuenow="{{ oee_promedio * 100 }}" aria-valuemin="0" aria-valuemax="100">
                                    </div>
                                </div>
                                <p class="card-text small">
                                    {% if oee_promedio * 100 >= 85 %}
                                        <span class="text-success"><i class="bi bi-check-circle"></i> Excelente - Nivel mundial</span>
                                    {% elif oee_promedio * 100 >= 65 %}
                                        <span class="text-warning"><i class="bi bi-exclamation-triangle"></i> Aceptable - Puede mejorar</span>
                                    {% else %}
                                        <span class="text-danger"><i class="bi bi-x-circle"></i> Crítico - Necesita atención</span>
                                    {% endif %}
                                </p>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-3">
                        <div class="card text-center border-info">
                            <div class="card-header bg-info text-white">
                                <h5 class="mb-0">Disponibilidad</h5>
                            </div>
                            <div class="card-body">
                                <h2 class="card-title text-info">{{ "%.1f"|format(disponibilidad_promedio * 100) }}%</h2>
                                <div class="progress mb-2">
                                    <div class="progress-bar bg-info" role="progressbar" style="width: {{ disponibilidad_promedio * 100 }}%;" 
                                         aria-valuenow="{{ disponibilidad_promedio * 100 }}" aria-valuemin="0" aria-valuemax="100">
                                    </div>
                                </div>
                                <p class="card-text small">Tiempo operativo vs tiempo planificado</p>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-3">
                        <div class="card text-center border-success">
                            <div class="card-header bg-success text-white">
                                <h5 class="mb-0">Rendimiento</h5>
                            </div>
                            <div class="card-body">
                                <h2 class="card-title text-success">{{ "%.1f"|format(rendimiento_promedio * 100) }}%</h2>
                                <div class="progress mb-2">
                                    <div class="progress-bar bg-success" role="progressbar" style="width: {{ rendimiento_promedio * 100 }}%;" 
                                         aria-valuenow="{{ rendimiento_promedio * 100 }}" aria-valuemin="0" aria-valuemax="100">
                                    </div>
                                </div>
                                <p class="card-text small">Velocidad real vs velocidad ideal</p>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-3">
                        <div class="card text-center border-warning">
                            <div class="card-header bg-warning text-white">
                                <h5 class="mb-0">Calidad</h5>
                            </div>
                            <div class="card-body">
                                <h2 class="card-title text-warning">{{ "%.1f"|format(calidad_promedio * 100) }}%</h2>
                                <div class="progress mb-2">
                                    <div class="progress-bar bg-warning" role="progressbar" style="width: {{ calidad_promedio * 100 }}%;" 
                                         aria-valuenow="{{ calidad_promedio * 100 }}" aria-valuemin="0" aria-valuemax="100">
                                    </div>
                                </div>
                                <p class="card-text small">Unidades buenas vs unidades totales</p>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Gráfico principal -->
                <div class="row mb-4">
                    <div class="col-md-12">
                        <div class="card">
                            <div class="card-header bg-primary text-white">
                                <h4 class="mb-0"><i class="bi bi-bar-chart me-2"></i>Indicador OEE por Turno</h4>
                            </div>
                            <div class="card-body">
                                <img src="data:image/png;base64,{{ plot_url }}" class="img-fluid rounded" alt="Gráfico OEE">
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Estadísticas por turno -->
                <div class="row mb-4">
                    <div class="col-md-12">
                        <div class="card">
                            <div class="card-header">
                                <h4 class="mb-0"><i class="bi bi-table me-2"></i>Estadísticas Promedio por Turno</h4>
                            </div>
                            <div class="card-body">
                                <div class="table-responsive">
                                    <table class="table table-striped table-hover">
                                        <thead class="table-dark">
                                            <tr>
                                                <th>Turno</th>
                                                <th>OEE Promedio</th>
                                                <th>Disponibilidad</th>
                                                <th>Rendimiento</th>
                                                <th>Calidad</th>
                                                <th>Unidades Producidas</th>
                                                <th>Unidades Defectuosas</th>
                                                <th>Tiempo Parada (min)</th>
                                            </tr>
                                        </thead>
                                        <tbody>
                                            {% for item in stats_por_turno %}
                                            <tr>
                                                <td><strong>{{ item.turno }}</strong></td>
                                                <td>
                                                    <span class="badge {% if item.OEE * 100 >= 85 %}bg-success{% elif item.OEE * 100 >= 65 %}bg-warning{% else %}bg-danger{% endif %}">
                                                        {{ "%.1f"|format(item.OEE * 100) }}%
                                                    </span>
                                                </td>
                                                <td>{{ "%.1f"|format(item.Disponibilidad * 100) }}%</td>
                                                <td>{{ "%.1f"|format(item.Rendimiento * 100) }}%</td>
                                                <td>{{ "%.1f"|format(item.Calidad * 100) }}%</td>
                                                <td>{{ "%.0f"|format(item.unidades_producidas) }}</td>
                                                <td>{{ "%.0f"|format(item.unidades_defectuosas) }}</td>
                                                <td>{{ "%.1f"|format(item.tiempo_parada_min) }}</td>
                                            </tr>
                                            {% endfor %}
                                        </tbody>
                                    </table>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Gráficos de componentes del OEE -->
                <div class="row mb-4">
                    <div class="col-md-6">
                        <div class="card h-100">
                            <div class="card-header bg-info text-white">
                                <h4 class="mb-0"><i class="bi bi-clock me-2"></i>Disponibilidad por Turno</h4>
                            </div>
                            <div class="card-body">
                                <img src="data:image/png;base64,{{ plot_disponibilidad }}" class="img-fluid rounded" alt="Gráfico Disponibilidad">
                            </div>
                        </div>
                    </div>
                    <div class="col-md-6">
                        <div class="card h-100">
                            <div class="card-header bg-success text-white">
                                <h4 class="mb-0"><i class="bi bi-graph-up me-2"></i>Rendimiento por Turno</h4>
                            </div>
                            <div class="card-body">
                                <img src="data:image/png;base64,{{ plot_rendimiento }}" class="img-fluid rounded" alt="Gráfico Rendimiento">
                            </div>
                        </div>
                    </div>
                </div>

                <div class="row mb-4">
                    <div class="col-md-6">
                        <div class="card h-100">
                            <div class="card-header bg-warning text-white">
                                <h4 class="mb-0"><i class="bi bi-check-circle me-2"></i>Calidad por Turno</h4>
                            </div>
                            <div class="card-body">
                                <img src="data:image/png;base64,{{ plot_calidad }}" class="img-fluid rounded" alt="Gráfico Calidad">
                            </div>
                        </div>
                    </div>
                    <div class="col-md-6">
                        <div class="card h-100">
                            <div class="card-header bg-primary text-white">
                                <h4 class="mb-0"><i class="bi bi-trending-up me-2"></i>Evolución del OEE</h4>
                            </div>
                            <div class="card-body">
                                <img src="data:image/png;base64,{{ plot_evolucion }}" class="img-fluid rounded" alt="Gráfico Evolución OEE">
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Análisis de causas y defectos -->
                {% if plot_causas and plot_defectos %}
                <div class="row mb-4">
                    <div class="col-md-6">
                        <div class="card h-100">
                            <div class="card-header bg-danger text-white">
                                <h4 class="mb-0"><i class="bi bi-exclamation-triangle me-2"></i>Análisis de Paradas</h4>
                            </div>
                            <div class="card-body">
                                <img src="data:image/png;base64,{{ plot_causas }}" class="img-fluid rounded" alt="Causas de Parada">
                                {% if causas_parada %}
                                <div class="mt-3">
                                    <h6>Principales Causas:</h6>
                                    <ul class="list-group">
                                        {% for causa, frecuencia in causas_parada.items() %}
                                        <li class="list-group-item d-flex justify-content-between align-items-center">
                                            {{ causa }}
                                            <span class="badge bg-danger rounded-pill">{{ frecuencia }}</span>
                                        </li>
                                        {% endfor %}
                                    </ul>
                                </div>
                                {% endif %}
                            </div>
                        </div>
                    </div>
                    <div class="col-md-6">
                        <div class="card h-100">
                            <div class="card-header bg-warning text-white">
                                <h4 class="mb-0"><i class="bi bi-bug me-2"></i>Análisis de Defectos</h4>
                            </div>
                            <div class="card-body">
                                <img src="data:image/png;base64,{{ plot_defectos }}" class="img-fluid rounded" alt="Tipos de Defectos">
                                {% if tipos_defecto %}
                                <div class="mt-3">
                                    <h6>Principales Defectos:</h6>
                                    <ul class="list-group">
                                        {% for defecto, frecuencia in tipos_defecto.items() %}
                                        <li class="list-group-item d-flex justify-content-between align-items-center">
                                            {{ defecto }}
                                            <span class="badge bg-warning rounded-pill">{{ frecuencia }}</span>
                                        </li>
                                        {% endfor %}
                                    </ul>
                                </div>
                                {% endif %}
                            </div>
                        </div>
                    </div>
                </div>
                {% endif %}

                <!-- Tabla de datos completa -->
                <div class="row mb-4">
                    <div class="col-md-12">
                        <div class="card">
                            <div class="card-header">
                                <h4 class="mb-0"><i class="bi bi-list-check me-2"></i>Detalles Completos por Turno</h4>
                            </div>
                            <div class="card-body">
                                <div class="table-responsive">
                                    <table class="table table-striped table-hover">
                                        <thead class="table-dark">
                                            <tr>
                                                <th>Fecha</th>
                                                <th>Turno</th>
                                                <th>Disponibilidad</th>
                                                <th>Rendimiento</th>
                                                <th>Calidad</th>
                                                <th>OEE</th>
                                                <th>Unidades Prod.</th>
                                                <th>Unidades Def.</th>
                                                <th>Tiempo Parada</th>
                                                <th>Acciones</th>
                                            </tr>
                                        </thead>
                                        <tbody>
                                            {% for item in tabla_oee %}
                                            <tr>
                                                <td>{{ item.fecha.strftime('%d/%m/%Y') }}</td>
                                                <td><strong>{{ item.turno }}</strong></td>
                                                <td>{{ "%.1f"|format(item.Disponibilidad * 100) }}%</td>
                                                <td>{{ "%.1f"|format(item.Rendimiento * 100) }}%</td>
                                                <td>{{ "%.1f"|format(item.Calidad * 100) }}%</td>
                                                <td>
                                                    <span class="badge {% if item.OEE * 100 >= 85 %}bg-success{% elif item.OEE * 100 >= 65 %}bg-warning{% else %}bg-danger{% endif %}">
                                                        {{ "%.1f"|format(item.OEE * 100) }}%
                                                    </span>
                                                </td>
                                                <td>{{ item.unidades_producidas }}</td>
                                                <td>{{ item.unidades_defectuosas }}</td>
                                                <td>{{ item.tiempo_parada_min }} min</td>
                                                <td>
                                                    <button class="btn btn-sm btn-info" data-bs-toggle="modal" data-bs-target="#detalleModal{{ loop.index }}">
                                                        <i class="bi bi-info-circle"></i> Detalles
                                                    </button>
                                                </td>
                                            </tr>
                                            {% endfor %}
                                        </tbody>
                                    </table>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Estadísticas por producto -->
                {% if productos_stats %}
                <div class="row mb-4">
                    <div class="col-md-12">
                        <div class="card">
                            <div class="card-header">
                                <h4 class="mb-0"><i class="bi bi-box me-2"></i>Estadísticas por Producto</h4>
                            </div>
                            <div class="card-body">
                                <div class="table-responsive">
                                    <table class="table table-striped table-hover">
                                        <thead class="table-dark">
                                            <tr>
                                                <th>Producto</th>
                                                <th>OEE Promedio</th>
                                                <th>Unidades Producidas</th>
                                                <th>Unidades Defectuosas</th>
                                                <th>Tasa de Defectos</th>
                                            </tr>
                                        </thead>
                                        <tbody>
                                            {% for item in productos_stats %}
                                            <tr>
                                                <td><strong>{{ item.producto }}</strong></td>
                                                <td>
                                                    <span class="badge {% if item.OEE * 100 >= 85 %}bg-success{% elif item.OEE * 100 >= 65 %}bg-warning{% else %}bg-danger{% endif %}">
                                                        {{ "%.1f"|format(item.OEE * 100) }}%
                                                    </span>
                                                </td>
                                                <td>{{ item.unidades_producidas }}</td>
                                                <td>{{ item.unidades_defectuosas }}</td>
                                                <td>
                                                    <span class="badge {% if item.tasa_defectos <= 1 %}bg-success{% elif item.tasa_defectos <= 3 %}bg-warning{% else %}bg-danger{% endif %}">
                                                        {{ "%.2f"|format(item.tasa_defectos) }}%
                                                    </span>
                                                </td>
                                            </tr>
                                            {% endfor %}
                                        </tbody>
                                    </table>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                {% endif %}

                <!-- Botones de acción -->
                <div class="row">
                    <div class="col-md-12">
                        <div class="d-grid gap-2 d-md-flex justify-content-md-center">
                            <a href="/" class="btn btn-primary me-md-2">
                                <i class="bi bi-house me-2"></i> Volver al Dashboard
                            </a>
                            <button class="btn btn-success me-md-2" onclick="window.print()">
                                <i class="bi bi-printer me-2"></i> Imprimir Reporte
                            </button>
                            <button class="btn btn-info" data-bs-toggle="collapse" data-bs-target="#infoOEE">
                                <i class="bi bi-question-circle me-2"></i> Acerca del OEE
                            </button>
                        </div>
                    </div>
                </div>

                <!-- Información sobre OEE -->
                <div class="collapse mt-3" id="infoOEE">
                    <div class="card card-body">
                        <h5><i class="bi bi-info-circle me-2"></i>¿Qué es el OEE?</h5>
                        <p>El OEE (Overall Equipment Effectiveness) es una métrica que mide la eficiencia general de los equipos de producción. Se calcula como el producto de tres factores:</p>
                        <ul>
                            <li><strong>Disponibilidad</strong>: Tiempo de operación real vs tiempo planificado</li>
                            <li><strong>Rendimiento</strong>: Velocidad real de producción vs velocidad ideal</li>
                            <li><strong>Calidad</strong>: Unidades buenas producidas vs unidades totales</li>
                        </ul>
                        <p class="mb-0"><strong>Interpretación:</strong> 
                            <span class="badge bg-success">≥85% Excelente (Nivel mundial)</span>
                            <span class="badge bg-warning">65-84% Aceptable</span>
                            <span class="badge bg-danger">&lt;65% Necesita mejora</span>
                        </p>
                    </div>
                </div>

                <!-- Modales para detalles -->
                {% for item in tabla_oee %}
                <div class="modal fade" id="detalleModal{{ loop.index }}" tabindex="-1" aria-labelledby="detalleModalLabel{{ loop.index }}" aria-hidden="true">
                    <div class="modal-dialog modal-lg">
                        <div class="modal-content">
                            <div class="modal-header bg-primary text-white">
                                <h5 class="modal-title" id="detalleModalLabel{{ loop.index }}">
                                    <i class="bi bi-info-circle me-2"></i>Detalles del Turno - {{ item.turno }} ({{ item.fecha.strftime('%d/%m/%Y') }})
                                </h5>
                                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
                            </div>
                            <div class="modal-body">
                                <div class="row">
                                    <div class="col-md-6">
                                        <div class="card mb-3">
                                            <div class="card-header bg-info text-white">
                                                <h6 class="mb-0">Métricas de Tiempo</h6>
                                            </div>
                                            <div class="card-body">
                                                <ul class="list-group list-group-flush">
                                                    <li class="list-group-item d-flex justify-content-between align-items-center">
                                                        Tiempo planificado
                                                        <span class="badge bg-primary rounded-pill">{{ item.tiempo_planificado_min }} min</span>
                                                    </li>
                                                    <li class="list-group-item d-flex justify-content-between align-items-center">
                                                        Tiempo operativo
                                                        <span class="badge bg-primary rounded-pill">{{ item.tiempo_operativo_min }} min</span>
                                                    </li>
                                                    <li class="list-group-item d-flex justify-content-between align-items-center">
                                                        Tiempo de parada
                                                        <span class="badge bg-danger rounded-pill">{{ item.tiempo_parada_min }} min</span>
                                                    </li>
                                                    {% if item.causa_parada %}
                                                    <li class="list-group-item">
                                                        <strong>Causa de parada:</strong> {{ item.causa_parada }}
                                                    </li>
                                                    {% endif %}
                                                </ul>
                                            </div>
                                        </div>
                                    </div>
                                    <div class="col-md-6">
                                        <div class="card mb-3">
                                            <div class="card-header bg-success text-white">
                                                <h6 class="mb-0">Métricas de Producción</h6>
                                            </div>
                                            <div class="card-body">
                                                <ul class="list-group list-group-flush">
                                                    <li class="list-group-item d-flex justify-content-between align-items-center">
                                                        Velocidad ideal
                                                        <span class="badge bg-info rounded-pill">{{ item.velocidad_ideal_upm }} UPM</span>
                                                    </li>
                                                    <li class="list-group-item d-flex justify-content-between align-items-center">
                                                        Velocidad real
                                                        <span class="badge bg-info rounded-pill">{{ "%.1f"|format(item.velocidad_real_upm) }} UPM</span>
                                                    </li>
                                                    <li class="list-group-item d-flex justify-content-between align-items-center">
                                                        Unidades producidas
                                                        <span class="badge bg-success rounded-pill">{{ item.unidades_producidas }}</span>
                                                    </li>
                                                    {% if item.producto %}
                                                    <li class="list-group-item">
                                                        <strong>Producto:</strong> {{ item.producto }}
                                                    </li>
                                                    {% endif %}
                                                </ul>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                                <div class="row">
                                    <div class="col-md-6">
                                        <div class="card mb-3">
                                            <div class="card-header bg-warning text-white">
                                                <h6 class="mb-0">Métricas de Calidad</h6>
                                            </div>
                                            <div class="card-body">
                                                <ul class="list-group list-group-flush">
                                                    <li class="list-group-item d-flex justify-content-between align-items-center">
                                                        Unidades totales
                                                        <span class="badge bg-info rounded-pill">{{ item.unidades_totales }}</span>
                                                    </li>
                                                    <li class="list-group-item d-flex justify-content-between align-items-center">
                                                        Unidades defectuosas
                                                        <span class="badge bg-danger rounded-pill">{{ item.unidades_defectuosas }}</span>
                                                    </li>
                                                    <li class="list-group-item d-flex justify-content-between align-items-center">
                                                        Tasa de defectos
                                                        <span class="badge {% if (item.unidades_defectuosas/item.unidades_totales*100) <= 1 %}bg-success{% elif (item.unidades_defectuosas/item.unidades_totales*100) <= 3 %}bg-warning{% else %}bg-danger{% endif %} rounded-pill">
                                                            {{ "%.2f"|format(item.unidades_defectuosas/item.unidades_totales*100) }}%
                                                        </span>
                                                    </li>
                                                    {% if item.tipo_defecto %}
                                                    <li class="list-group-item">
                                                        <strong>Tipo de defecto principal:</strong> {{ item.tipo_defecto }}
                                                    </li>
                                                    {% endif %}
                                                </ul>
                                            </div>
                                        </div>
                                    </div>
                                    <div class="col-md-6">
                                        <div class="card mb-3">
                                            <div class="card-header bg-primary text-white">
                                                <h6 class="mb-0">Indicadores Clave</h6>
                                            </div>
                                            <div class="card-body">
                                                <div class="mb-2">
                                                    <strong>Disponibilidad:</strong>
                                                    <div class="progress" style="height: 20px;">
                                                        <div class="progress-bar bg-info" role="progressbar" style="width: {{ item.Disponibilidad * 100 }}%;" 
                                                             aria-valuenow="{{ item.Disponibilidad * 100 }}" aria-valuemin="0" aria-valuemax="100">
                                                            {{ "%.1f"|format(item.Disponibilidad * 100) }}%
                                                        </div>
                                                    </div>
                                                </div>
                                                <div class="mb-2">
                                                    <strong>Rendimiento:</strong>
                                                    <div class="progress" style="height: 20px;">
                                                        <div class="progress-bar bg-success" role="progressbar" style="width: {{ item.Rendimiento * 100 }}%;" 
                                                             aria-valuenow="{{ item.Rendimiento * 100 }}" aria-valuemin="0" aria-valuemax="100">
                                                            {{ "%.1f"|format(item.Rendimiento * 100) }}%
                                                        </div>
                                                    </div>
                                                </div>
                                                <div class="mb-2">
                                                    <strong>Calidad:</strong>
                                                    <div class="progress" style="height: 20px;">
                                                        <div class="progress-bar bg-warning" role="progressbar" style="width: {{ item.Calidad * 100 }}%;" 
                                                             aria-valuenow="{{ item.Calidad * 100 }}" aria-valuemin="0" aria-valuemax="100">
                                                            {{ "%.1f"|format(item.Calidad * 100) }}%
                                                        </div>
                                                    </div>
                                                </div>
                                                <div class="mb-2">
                                                    <strong>OEE Total:</strong>
                                                    <div class="progress" style="height: 25px;">
                                                        <div class="progress-bar {% if item.OEE * 100 >= 85 %}bg-success{% elif item.OEE * 100 >= 65 %}bg-warning{% else %}bg-danger{% endif %}" 
                                                             role="progressbar" style="width: {{ item.OEE * 100 }}%;" 
                                                             aria-valuenow="{{ item.OEE * 100 }}" aria-valuemin="0" aria-valuemax="100">
                                                            {{ "%.1f"|format(item.OEE * 100) }}%
                                                        </div>
                                                    </div>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            <div class="modal-footer">
                                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cerrar</button>
                            </div>
                        </div>
                    </div>
                </div>
                {% endfor %}
            </div>
        </div>
    </div>
</div>
{% endblock %}