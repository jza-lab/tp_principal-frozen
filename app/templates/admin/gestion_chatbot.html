{% extends 'layouts/app_layout.html' %}

{% block title %}Gestión de Chatbot{% endblock %}

{% block app_content %}
<div class="card card-table">
    <div class="card-header d-flex justify-content-between align-items-center">
        <h3 class="card-title mb-0">Gestión de Preguntas y Respuestas del Chatbot</h3>
        <div class="card-tools">
            <button type="button" class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#chatbotQAModal" data-action="create">
                <i class="bi bi-plus-lg"></i> Añadir Nueva
            </button>
        </div>
    </div>
    <div class="card-body">
        <div class="table-responsive">
            <table class="table table-striped table-hover" id="chatbotQATable">
                <thead>
                    <tr>
                        <th scope="col">#</th>
                        <th scope="col">Pregunta</th>
                        <th scope="col">Respuesta</th>
                        <th scope="col">Estado</th>
                        <th scope="col" class="text-end">Acciones</th>
                    </tr>
                </thead>
                <tbody id="chatbotQATableBody">
                    <!-- Las filas se cargarán dinámicamente -->
                </tbody>
            </table>
        </div>
    </div>
</div>

<!-- Modal para Crear y Editar -->
<div class="modal fade" id="chatbotQAModal" tabindex="-1" aria-labelledby="chatbotQAModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="chatbotQAModalLabel">Añadir Nueva Pregunta y Respuesta</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <form id="chatbotQAForm">
                    {{ csrf_form.csrf_token }}
                    <input type="hidden" id="qaId" name="id">
                    <div class="mb-3">
                        <label for="pregunta" class="form-label">Pregunta</label>
                        <input type="text" class="form-control" id="pregunta" name="pregunta" required>
                    </div>
                    <div class="mb-3">
                        <label for="respuesta" class="form-label">Respuesta</label>
                        <textarea class="form-control" id="respuesta" name="respuesta" rows="4" required></textarea>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
                <button type="button" class="btn btn-primary" id="saveChatbotQAButton">Guardar</button>
            </div>
        </div>
    </div>
</div>

<style>
/* Estilos para el switch toggle */
.form-switch-custom {
    display: inline-block;
    position: relative;
}

.form-switch-custom input[type="checkbox"] {
    position: absolute;
    opacity: 0;
    width: 0;
    height: 0;
}

.switch-slider {
    position: relative;
    display: inline-block;
    width: 44px;
    height: 24px;
    background-color: #dc3545;
    border-radius: 24px;
    cursor: pointer;
    transition: background-color 0.3s;
}

.switch-slider:before {
    content: "";
    position: absolute;
    width: 18px;
    height: 18px;
    left: 3px;
    top: 3px;
    background-color: white;
    border-radius: 50%;
    transition: transform 0.3s;
}

.form-switch-custom input[type="checkbox"]:checked + .switch-slider {
    background-color: #198754;
}

.form-switch-custom input[type="checkbox"]:checked + .switch-slider:before {
    transform: translateX(20px);
}

.switch-slider:hover {
    opacity: 0.8;
}
</style>

<script>
(function() {
    'use strict';
    console.log('=== SCRIPT CARGADO ===');
    
    document.addEventListener('DOMContentLoaded', function() {
        console.log('DOM cargado');
        loadQAs();
        setupEventListeners();
    });

    function setupEventListeners() {
        console.log('Configurando event listeners');
        
        // Delegación de eventos global
        document.addEventListener('click', function(event) {
            const target = event.target.closest('button, [data-action]');
            
            if (!target) return;
            
            console.log('Click detectado:', target.id || target.dataset.action);

            // Botón Guardar
            if (target.id === 'saveChatbotQAButton') {
                console.log('¡GUARDANDO!');
                event.preventDefault();
                event.stopPropagation();
                handleFormSubmit();
                return;
            }

            // Botones de acción
            const action = target.dataset.action;
            const id = target.dataset.id;

            switch (action) {
                case 'create':
                    prepareCreateForm();
                    break;
                case 'edit':
                    prepareEditForm(parseInt(id, 10));
                    break;
                case 'delete':
                    deleteQA(parseInt(id, 10));
                    break;
            }
        });

        // Event listener para los switches
        document.addEventListener('change', function(event) {
            if (event.target.classList.contains('toggle-activo')) {
                const id = parseInt(event.target.dataset.id, 10);
                const nuevoEstado = event.target.checked;
                toggleActivoState(id, nuevoEstado);
            }
        });
    }

    async function loadQAs() {
        console.log('Cargando QAs...');
        try {
            const response = await fetch('/admin/chatbot/qas');
            if (!response.ok) throw new Error('Error al cargar los datos.');
            
            const result = await response.json();
            console.log('QAs recibidas:', result);
            
            if (result.success && Array.isArray(result.data)) {
                const tableBody = document.getElementById('chatbotQATableBody');
                tableBody.innerHTML = '';
                
                if (result.data.length === 0) {
                    tableBody.innerHTML = '<tr><td colspan="5" class="text-center text-muted">No hay registros. Haz clic en "Añadir Nueva" para crear uno.</td></tr>';
                    return;
                }
                
                result.data.forEach((qa, index) => {
                    const row = `
                        <tr>
                            <td>${index + 1}</td>
                            <td>${escapeHTML(qa.pregunta)}</td>
                            <td>${escapeHTML(qa.respuesta)}</td>
                            <td>
                                <div class="form-switch-custom">
                                    <input type="checkbox" 
                                           class="toggle-activo" 
                                           data-id="${qa.id}" 
                                           ${qa.activo ? 'checked' : ''}>
                                    <span class="switch-slider"></span>
                                </div>
                            </td>
                            <td class="text-end">
                                <button class="btn btn-sm btn-outline-primary" data-action="edit" data-id="${qa.id}" title="Editar">
                                    <i class="bi bi-pencil"></i>
                                </button>
                                <button class="btn btn-sm btn-outline-danger" data-action="delete" data-id="${qa.id}" title="Deshabilitar">
    <i class="bi bi-x-circle"></i>
</button>
                            </td>
                        </tr>
                    `;
                    tableBody.innerHTML += row;
                });
            }
        } catch (error) {
            console.error('Error en loadQAs:', error);
            alert('No se pudieron cargar los datos.');
        }
    }

    function prepareCreateForm() {
        console.log('Preparando formulario de creación');
        document.getElementById('chatbotQAForm').reset();
        document.getElementById('qaId').value = '';
        document.getElementById('chatbotQAModalLabel').textContent = 'Añadir Nueva Pregunta y Respuesta';
    }

    async function prepareEditForm(id) {
        console.log('Preparando edición ID:', id);
        try {
            const response = await fetch(`/admin/chatbot/qas`);
            if (!response.ok) throw new Error('Error al obtener el registro.');
            
            const result = await response.json();
            const qa = result.data.find(item => item.id === id);

            if (qa) {
                document.getElementById('qaId').value = qa.id;
                document.getElementById('pregunta').value = qa.pregunta;
                document.getElementById('respuesta').value = qa.respuesta;
                document.getElementById('chatbotQAModalLabel').textContent = 'Editar Pregunta y Respuesta';
                new bootstrap.Modal(document.getElementById('chatbotQAModal')).show();
            } else {
                alert('Registro no encontrado.');
            }
        } catch (error) {
            console.error('Error en prepareEditForm:', error);
            alert('No se pudo cargar el registro.');
        }
    }

    async function handleFormSubmit() {
        console.log('=== GUARDANDO ===');
        
        const form = document.getElementById('chatbotQAForm');
        if (!form) {
            console.error('Formulario no encontrado');
            alert('Error: Formulario no encontrado');
            return;
        }
        
        const id = document.getElementById('qaId').value;
        const url = id ? `/admin/chatbot/qas/${id}` : '/admin/chatbot/qas';
        const method = id ? 'PUT' : 'POST';
        
        const csrfTokenEl = form.querySelector('input[name="csrf_token"]');
        if (!csrfTokenEl) {
            console.error('CSRF token no encontrado');
            alert('Error: Token de seguridad no encontrado');
            return;
        }
        
        const csrfToken = csrfTokenEl.value;
        const preguntaValue = form.pregunta.value.trim();
        const respuestaValue = form.respuesta.value.trim();
        
        console.log('Datos a enviar:', { url, method, preguntaValue, respuestaValue });

        if (!preguntaValue || !respuestaValue) {
            alert('Por favor completa todos los campos requeridos');
            return;
        }

        const formData = new URLSearchParams();
        formData.append('csrf_token', csrfToken);
        formData.append('pregunta', preguntaValue);
        formData.append('respuesta', respuestaValue);
        // Cuando se crea, por defecto activo = 'on'
        if (!id) {
            formData.append('activo', 'on');
        }

        console.log('FormData:', formData.toString());

        try {
            console.log('Enviando petición a:', url);
            const response = await fetch(url, {
                method: method,
                headers: {
                    'Content-Type': 'application/x-www-form-urlencoded',
                    'X-CSRF-TOKEN': csrfToken
                },
                body: formData
            });

            console.log('Respuesta status:', response.status);
            
            const responseText = await response.text();
            console.log('Respuesta texto:', responseText);

            let result;
            try {
                result = JSON.parse(responseText);
                console.log('Respuesta JSON:', result);
            } catch (e) {
                console.error('No es JSON válido:', responseText);
                throw new Error('Respuesta inválida del servidor');
            }

            if (!response.ok) {
                throw new Error(result.error || `Error ${response.status}`);
            }
            
            console.log('¡Guardado exitoso!');
            
            const modalEl = document.getElementById('chatbotQAModal');
            const modalInstance = bootstrap.Modal.getInstance(modalEl);
            if (modalInstance) {
                modalInstance.hide();
            }
            
            await loadQAs();
            
            // Mostrar mensaje de éxito
            alert('¡Guardado exitosamente!');

        } catch (error) {
            console.error('Error completo:', error);
            alert(`Error al guardar: ${error.message}`);
        }
    }

    async function toggleActivoState(id, nuevoEstado) {
        console.log(`Cambiando estado de QA ${id} a ${nuevoEstado}`);
        
        const csrfToken = document.querySelector('input[name="csrf_token"]').value;
        
        const formData = new URLSearchParams();
        formData.append('csrf_token', csrfToken);
        formData.append('activo', nuevoEstado ? 'on' : 'off');

        try {
            const response = await fetch(`/admin/chatbot/qas/${id}/toggle`, {
                method: 'PATCH',
                headers: {
                    'Content-Type': 'application/x-www-form-urlencoded',
                    'X-CSRF-TOKEN': csrfToken
                },
                body: formData
            });

            if (!response.ok) {
                const errorData = await response.json();
                throw new Error(errorData.error || 'Error al cambiar el estado');
            }

            const result = await response.json();
            console.log('Estado cambiado exitosamente:', result);
            
            // Recargar la tabla para reflejar cambios
            await loadQAs();

        } catch (error) {
            console.error('Error al cambiar estado:', error);
            alert(`Error: ${error.message}`);
            // Recargar para revertir el switch visualmente
            await loadQAs();
        }
    }

async function deleteQA(id) {
    if (!confirm('¿Estás seguro de que quieres deshabilitar esta pregunta?')) return;

    const csrfToken = document.querySelector('input[name="csrf_token"]').value;

    try {
        const response = await fetch(`/admin/chatbot/qas/${id}`, {
            method: 'DELETE',
            headers: {
                'X-CSRF-TOKEN': csrfToken
            }
        });
        
        if (!response.ok) throw new Error('Error al deshabilitar el registro.');
        
        alert('Deshabilitada exitosamente');
        await loadQAs();
    } catch (error) {
        console.error('Error en deleteQA:', error);
        alert('No se pudo deshabilitar el registro.');
    }
}

    function escapeHTML(str) {
        if (typeof str !== 'string') return '';
        const p = document.createElement('p');
        p.appendChild(document.createTextNode(str));
        return p.innerHTML;
    }
    
    console.log('=== SCRIPT INICIALIZADO ===');
})();
</script>

{% endblock %}