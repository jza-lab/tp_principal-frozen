{% extends 'layouts/app_layout.html' %}

{% block title %}Trazabilidad de Reservas - Sistema Frozen{% endblock %}

{% block app_content %}
<div class="btn-toolbar mb-2">
    <a href="#" onclick="history.back();" class="btn btn-outline-secondary me-2" title="Volver a la página anterior">
        <i class="bi bi-arrow-left"></i> Volver
    </a>
</div>
<div class="d-flex justify-content-between flex-wrap flex-md-nowrap align-items-center pb-2 mb-4 border-bottom">
    <div>
        <h1 class="h2 mb-1">Trazabilidad de Reservas</h1>
        <p class="text-muted mb-0">Historial unificado de reservas de stock para productos e insumos.</p>
    </div>
</div>

<div class="card">
    <div class="card-body">
        <div class="d-flex justify-content-end mb-3">
            <div class="btn-group" role="group" aria-label="Filtros de tipo">
                <button type="button" class="btn btn-sm btn-outline-secondary active" data-filter="todos">Todos</button>
                <button type="button" class="btn btn-sm btn-outline-secondary" data-filter="PRODUCTO">Productos</button>
                <button type="button" class="btn btn-sm btn-outline-secondary" data-filter="INSUMO">Insumos</button>
            </div>
        </div>

        <div class="table-responsive">
            <table class="table table-hover align-middle">
                <thead class="table-light">
                    <tr>
                        <th>Tipo</th>
                        <th>Fecha</th>
                        <th>Ítem Reservado</th>
                        <th>Cantidad</th>
                        <th>Lote</th>
                        <th>Documento Origen</th>
                        <th>Estado</th>
                    </tr>
                </thead>
                <tbody>
                    {% for reserva in reservas %}
                    <tr data-tipo="{{ reserva.tipo }}">
                        <td>
                            {% if reserva.tipo == 'PRODUCTO' %}
                                <span class="badge bg-primary">Producto</span>
                            {% else %}
                                <span class="badge bg-info">Insumo</span>
                            {% endif %}
                        </td>
                        <td>{{ reserva.fecha.strftime('%Y-%m-%d %H:%M') if reserva.fecha else 'N/A' }}</td>
                        <td><strong>{{ reserva.item_nombre }}</strong></td>
                        <td>{{ reserva.cantidad }}</td>
                        <td><code>{{ reserva.lote }}</code></td>
                        <td>
                            <a href="{{ reserva.origen_url }}">{{ reserva.origen }}</a>
                        </td>
                        <td>
                            <span class="badge rounded-pill text-bg-secondary">{{ reserva.estado }}</span>
                        </td>
                    </tr>
                    {% else %}
                    <tr id="no-results-row">
                        <td colspan="7" class="text-center text-muted py-4">No se encontraron registros de reservas.</td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
document.addEventListener('DOMContentLoaded', function () {
    const filterButtons = document.querySelectorAll('.btn-group[role="group"] .btn');
    const tableBody = document.querySelector('table tbody');
    const allRows = Array.from(tableBody.querySelectorAll('tr'));
    const dataRows = allRows.filter(row => row.hasAttribute('data-tipo'));
    const noResultsRow = document.getElementById('no-results-row');

    function filterTable() {
        const activeFilter = document.querySelector('.btn-group[role="group"] .btn.active').getAttribute('data-filter');
        let visibleRowCount = 0;

        dataRows.forEach(row => {
            const rowType = row.getAttribute('data-tipo').toUpperCase();
            if (activeFilter === 'todos' || rowType === activeFilter) {
                row.style.display = '';
                visibleRowCount++;
            } else {
                row.style.display = 'none';
            }
        });

        if (noResultsRow) {
            if (visibleRowCount === 0 && dataRows.length > 0) {
                 // Si hay filas de datos pero ninguna coincide con el filtro, muestra un mensaje dinámico
                noResultsRow.innerHTML = `<td colspan="7" class="text-center text-muted py-4">No se encontraron registros para el tipo '${activeFilter}'.</td>`;
                noResultsRow.style.display = '';
            } else if (dataRows.length === 0) {
                // Si no hay datos desde el servidor, muestra el mensaje original
                noResultsRow.innerHTML = `<td colspan="7" class="text-center text-muted py-4">No se encontraron registros de reservas.</td>`;
                noResultsRow.style.display = '';
            }
            else {
                noResultsRow.style.display = 'none';
            }
        }
    }

    filterButtons.forEach(button => {
        button.addEventListener('click', function () {
            filterButtons.forEach(btn => btn.classList.remove('active'));
            this.classList.add('active');
            filterTable();
        });
    });

    // Initial filter call in case there are no results from the start
    filterTable();
});
</script>
{% endblock %}