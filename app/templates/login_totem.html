{% extends "base.html" %}

{% block content %}
<div class="row justify-content-center">
    <div class="col-md-8">
        <div class="card">
            <div class="card-header bg-primary text-white">
                <h4 class="mb-0">üì∑ T√≥tem - Reconocimiento Facial</h4>
            </div>
            <div class="card-body text-center">
                <div class="alert alert-info">
                    <strong>Instrucciones:</strong> Mire a la c√°mara y haga clic en "Capturar Rostro"
                </div>
                
                <div class="camera-container">
                    <video id="video" autoplay playsinline></video>
                </div>
                
                <div class="mt-3">
                    <button id="captureBtn" class="btn btn-success btn-lg">
                        üì∏ Capturar Rostro
                    </button>
                    <button id="retryBtn" class="btn btn-warning btn-lg" style="display:none;">
                        üîÑ Reintentar
                    </button>
                </div>

                <div id="result" class="mt-3"></div>

                <div class="mt-4 border-top pt-3">
                    <!-- CORREGIDO: Usar facial.login_totem -->
                    <a href="{{ url_for('facial.login_totem') }}" class="btn btn-outline-secondary">
                        ‚Üê Volver al Inicio
                    </a>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
class FaceLogin {
    constructor() {
        this.video = document.getElementById('video');
        this.captureBtn = document.getElementById('captureBtn');
        this.retryBtn = document.getElementById('retryBtn');
        this.resultDiv = document.getElementById('result');
        this.stream = null;
        
        this.init();
    }

    async init() {
        try {
            this.stream = await navigator.mediaDevices.getUserMedia({ 
                video: { width: 640, height: 480 } 
            });
            this.video.srcObject = this.stream;
        } catch (err) {
            this.showResult('Error al acceder a la c√°mara: ' + err.message, 'error');
        }

        this.captureBtn.addEventListener('click', () => this.captureFace());
        this.retryBtn.addEventListener('click', () => this.retryCapture());
    }

    captureFace() {
        const canvas = document.createElement('canvas');
        canvas.width = this.video.videoWidth;
        canvas.height = this.video.videoHeight;
        const ctx = canvas.getContext('2d');
        ctx.drawImage(this.video, 0, 0);
        
        const imageData = canvas.toDataURL('image/jpeg');
        this.sendFaceData(imageData);
        
        this.captureBtn.style.display = 'none';
        this.retryBtn.style.display = 'inline-block';
        this.showResult('Procesando rostro...', 'info');
    }

    async sendFaceData(imageData) {
        try {
            // CORREGIDO: Usar /auth/facial/login_face
            const response = await fetch('/auth/facial/login_face', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ image: imageData })
            });

            const result = await response.json();
            
            if (result.success) {
                this.showResult(`‚úÖ ${result.message}`, 'success');
                setTimeout(() => {
                    // CORREGIDO: Usar la URL de redirecci√≥n del resultado o la predeterminada
                    const redirectUrl = result.redirect_url || '/auth/facial/panel_totem';
                    window.location.href = redirectUrl;
                }, 1500);
            } else {
                this.showResult(`‚ùå ${result.message}`, 'error');
            }
        } catch (error) {
            this.showResult('Error de conexi√≥n: ' + error.message, 'error');
        }
    }

    retryCapture() {
        this.resultDiv.innerHTML = '';
        this.captureBtn.style.display = 'inline-block';
        this.retryBtn.style.display = 'none';
    }

    showResult(message, type) {
        const alertClass = type === 'success' ? 'alert-success' : 
                          type === 'error' ? 'alert-danger' : 'alert-info';
        this.resultDiv.innerHTML = `
            <div class="alert ${alertClass} alert-dismissible fade show">
                ${message}
            </div>
        `;
    }
}

document.addEventListener('DOMContentLoaded', () => {
    new FaceLogin();
});
</script>
{% endblock %}