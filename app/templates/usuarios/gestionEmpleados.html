{% extends "layouts/app_layout.html" %}

{% block title %}Gestión de Empleados - Sistema Frozen{% endblock %}

{% block app_content %}
<div class="btn-toolbar mb-2">
    <a href="#" onclick="history.back();" class="btn btn-outline-secondary me-2" title="Volver a la página anterior">
        <i class="bi bi-arrow-left"></i> Volver
    </a>
</div>

<div class="usuarios-container">
    <!-- Header Principal -->
    <div class="d-flex justify-content-between align-items-center pb-2 mb-4 border-bottom">
        <div>
            <h1 class="h2 mb-1">Gestión de Empleados</h1>
            <p class="text-muted mb-0">Administración de personal y roles del sistema</p>
        </div>
    </div>

    <!-- Navegación por Pestañas -->
    <ul class="nav nav-tabs-custom mb-4" id="userTabs" role="tablist">
        <li class="nav-item" role="presentation">
            <button class="nav-link-custom active" id="users-tab" data-bs-toggle="tab" data-bs-target="#users-panel" type="button" role="tab">
                <i class="bi bi-people me-2"></i>
                <span>Todos los Empleados</span>
                <span class="tab-indicator"></span>
            </button>
        </li>
        {% if 'admin_gestion_personal' is has_permission or current_user.roles.codigo == 'ADMIN' %}
        <li class="nav-item" role="presentation">
            <button class="nav-link-custom" id="activity-tab" data-bs-toggle="tab" data-bs-target="#activity-panel" type="button" role="tab">
                <i class="bi bi-activity me-2"></i>
                <span>Actividad de todo el tiempo</span>
                <span class="tab-indicator"></span>
            </button>
        </li>
        {% endif %}
        {% if has_permission('gestionar_autorizaciones') %}
        <li class="nav-item" role="presentation">
            <button class="nav-link-custom" id="authorizations-tab" data-bs-toggle="tab" data-bs-target="#authorizations-panel" type="button" role="tab">
                <i class="bi bi-patch-check me-2"></i>
                <span>Autorizaciones</span>
                <span class="tab-indicator"></span>
            </button>
        </li>
        {% endif %}
    </ul>

    <!-- Contenido de las Pestañas -->
    <div class="tab-content" id="userTabsContent">
        <div id="flash-container"></div>
        
        <!-- Panel de Todos los Empleados -->
        <div class="tab-pane fade show active" id="users-panel" role="tabpanel">
            {% include 'usuarios/panel_empleados.html' %}
        </div>
        
        <!-- Panel de Actividad -->
        {% if has_permission('admin_configuracion_sistema') %}
        <div class="tab-pane fade" id="activity-panel" role="tabpanel">
            {% include 'usuarios/panel_actividad.html' %}
        </div>
        {% endif %}
        
        <!-- Panel de Autorizaciones -->
        {% if has_permission('gestionar_autorizaciones') %}
        <div class="tab-pane fade" id="authorizations-panel" role="tabpanel">
            {% include 'usuarios/panel_autorizaciones.html' %}
        </div>
        {% endif %}
    </div>
</div>

<!-- Modal de Confirmación de Autorización -->
<div class="modal fade" id="confirmationModal" tabindex="-1" aria-labelledby="confirmationModalLabel" aria-hidden="true">
  <div class="modal-dialog modal-dialog-centered">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="confirmationModalLabel">Confirmar Acción</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body">
        <p id="confirmationModalText">¿Estás seguro de que quieres realizar esta acción?</p>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
        <button type="button" class="btn btn-primary" id="confirmActionBtn">Confirmar</button>
      </div>
    </div>
  </div>
</div>


<script>
    const URL_UNIFIED_ACTIVITY = "{{ url_for('api.obtener_actividad_unificada') }}";
    const CAN_MANAGE_AUTHORIZATIONS = {{ has_permission('gestionar_autorizaciones') | tojson }};
</script>

<script src="{{ url_for('static', filename='js/usuarios/gestionEmpleados.js') }}"></script>
<script src="{{ url_for('static', filename='js/usuarios/panelActividad.js') }}"></script>
<script src="{{ url_for('static', filename='js/usuarios/panelAutorizaciones.js') }}"></script>
<script src="{{ url_for('static', filename='js/usuarios/panelEmpleados.js') }}"></script>
<link rel="stylesheet" href="{{ url_for('static', filename='css/usuarios/listarUsuarios.css') }}">
<link rel="stylesheet" href="{{ url_for('static', filename='css/usuarios/autorizaciones.css') }}">

<script>
// Activar pestaña según parámetro URL y cargar datos del panel correspondiente
document.addEventListener('DOMContentLoaded', function() {
    const urlParams = new URLSearchParams(window.location.search);
    const tabParam = urlParams.get('tab');
    
    if (tabParam === 'authorizations') {
        // Desactivar pestaña activa
        const activeTab = document.querySelector('#userTabs .nav-link-custom.active');
        const activePanel = document.querySelector('.tab-pane.show.active');
        if (activeTab) activeTab.classList.remove('active');
        if (activePanel) {
            activePanel.classList.remove('show', 'active');
        }
        
        // Activar pestaña de Autorizaciones
        const authTab = document.getElementById('authorizations-tab');
        const authPanel = document.getElementById('authorizations-panel');
        if (authTab && authPanel) {
            authTab.classList.add('active');
            authPanel.classList.add('show', 'active');
        }
    }
    
    // Escuchar eventos de cambio de pestaña para inicializar paneles bajo demanda
    const tabButtons = document.querySelectorAll('#userTabs button[data-bs-toggle="tab"]');
    tabButtons.forEach(button => {
        button.addEventListener('shown.bs.tab', function(event) {
            const targetId = event.target.getAttribute('data-bs-target');
            
            // Cargar datos según la pestaña activada
            if (targetId === '#activity-panel' && typeof ActividadPanel !== 'undefined') {
                // Reinicializar el panel de actividad si es necesario
                if (ActividadPanel.init) {
                    ActividadPanel.init();
                }
            } else if (targetId === '#authorizations-panel' && typeof AutorizacionesPanel !== 'undefined') {
                // Reinicializar el panel de autorizaciones si es necesario
                if (AutorizacionesPanel.init) {
                    AutorizacionesPanel.init();
                }
            }
        });
    });
    
    // Si se activó la pestaña de autorizaciones por URL, forzar la carga
    if (tabParam === 'authorizations') {
        setTimeout(function() {
            if (typeof AutorizacionesPanel !== 'undefined' && AutorizacionesPanel.init) {
                AutorizacionesPanel.init();
            }
        }, 100);
    }
});
</script>

{% endblock %}
