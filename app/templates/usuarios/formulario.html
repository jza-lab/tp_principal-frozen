{% extends "layouts/base.html" %}

{% block title %}
{% if is_new %}Nuevo Empleado{% else %}Editar Empleado{% endif %} - Sistema Frozen
{% endblock %}

{% block extra_css %}
<link rel="stylesheet" href="{{ url_for('static', filename='css/usuarios/crearUsuario.css') }}">
{% endblock %}

{% block content %}
<div class="form-container">
    <div class="form-card">
        <div class="form-header">
            <i class="bi bi-person-badge fs-1 mb-3"></i>
            <h2 class="mb-1">
                {% if is_new %}Crear Nuevo Empleado{% else %}Editar Empleado{% endif %}
            </h2>
            <p class="mb-0 opacity-75">
                {% if is_new %}Complete la información en 3 simples pasos{% else %}Modificar información del empleado {% endif %}
            </p>
        </div>
        <div class="form-body">
            <!-- Indicador de pasos (solo para empleados nuevos) -->
            {% if is_new %}
            <div class="step-indicator">
                <div class="step-item">
                    <div class="step active" id="step1">
                        <i class="bi bi-person-fill"></i>
                    </div>
                    <span class="step-label">Datos Personales</span>
                </div>
                <div class="step-connector"></div>
                <div class="step-item">
                    <div class="step" id="step2">
                        <i class="bi bi-geo-alt-fill"></i>
                    </div>
                    <span class="step-label">Dirección</span>
                </div>
                <div class="step-connector"></div>
                <div class="step-item">
                    <div class="step" id="step3">
                        <i class="bi bi-camera-fill"></i>
                    </div>
                    <span class="step-label">Registro Facial</span>
                </div>
            </div>
            {% endif %}

            <form method="POST"
                action="{{ url_for('admin_usuario.nuevo_usuario') if is_new else url_for('admin_usuario.editar_usuario', id=usuario.id) }}"
                enctype="multipart/form-data" id="userForm" novalidate>

                <!-- Paso 1: Información Personal -->
                <div id="personalInfo" class="form-section">
                    <div class="form-subsection">
                        <h6 class="subsection-title">
                            <i class="bi bi-person me-2"></i>Datos Básicos
                        </h6>
                        <div class="row g-3">
                            <div class="col-md-6">
                                <div class="form-floating">
                                    <input type="text" class="form-control" id="nombre" name="nombre"
                                        value="{{ usuario.nombre or '' }}" required placeholder="Nombre">
                                    <label for="nombre">
                                        <i class="bi bi-person me-1"></i>Nombre
                                    </label>
                                </div>
                                <div class="invalid-feedback"></div>
                            </div>

                            <div class="col-md-6">
                                <div class="form-floating">
                                    <input type="text" class="form-control" id="apellido" name="apellido"
                                        value="{{ usuario.apellido or '' }}" required placeholder="Apellido">
                                    <label for="apellido">
                                        <i class="bi bi-person me-1"></i>Apellido
                                    </label>
                                </div>
                                <div class="invalid-feedback"></div>
                            </div>

                            <div class="col-md-6">
                                <div class="form-floating">
                                    <input type="text" class="form-control" id="legajo" name="legajo"
                                        value="{{ usuario.legajo or '' }}" required placeholder="Número de legajo">
                                    <label for="legajo">
                                        <i class="bi bi-hash me-1"></i>Legajo
                                    </label>
                                </div>
                                <div class="invalid-feedback"></div>
                            </div>

                            <div class="col-md-6">
                                <div class="form-floating">
                                    <input type="text" class="form-control" id="cuil_cuit" name="cuil_cuit"
                                        value="{{ usuario.cuil_cuit or '' }}" placeholder="CUIL/CUIT (11 dígitos)"
                                        pattern="\\d{11}" title="Debe contener 11 dígitos numéricos." required>
                                    <label for="cuil_cuit">
                                        <i class="bi bi-person-vcard me-1"></i>CUIL/CUIT
                                    </label>
                                </div>
                                <small id="cuil-helper" class="form-text text-muted ms-2"></small>
                                <div class="invalid-feedback"></div>
                            </div>

                            <div class="col-12">
                                <div class="form-floating">
                                    <input type="email" class="form-control" id="email" name="email"
                                        value="{{ usuario.email or '' }}" required placeholder="nombre@empresa.com">
                                    <label for="email">
                                        <i class="bi bi-envelope me-1"></i>Correo Electrónico
                                    </label>
                                </div>
                                <div class="invalid-feedback"></div>
                            </div>

                            <div class="col-md-6">
                                <div class="form-floating">
                                    <input type="text" class="form-control" id="telefono" name="telefono"
                                        value="{{ usuario.telefono or '' }}" placeholder="Ej: +541122334455" required>
                                    <label for="telefono">
                                        <i class="bi bi-telephone me-1"></i>Teléfono
                                    </label>
                                </div>
                                <div class="invalid-feedback"></div>
                            </div>

                            {% if is_new %}
                            <div class="col-md-6">
                                <div class="form-floating">
                                    <input type="password" class="form-control" id="password" name="password" required
                                        placeholder="Contraseña">
                                    <label for="password">
                                        <i class="bi bi-key me-1"></i>Contraseña (mínimo 8 caracteres)
                                    </label>
                                </div>
                                <div class="invalid-feedback"></div>
                            </div>
                            {% endif %}
                        </div>
                    </div>

                    <div class="form-subsection mt-4">
                        <h6 class="subsection-title">
                            <i class="bi bi-briefcase me-2"></i>Información Laboral
                        </h6>
                        <div class="row g-3">
                            <!-- Selector de Rol Interactivo -->
                            <div class="col-12">
                                <label class="form-label fw-bold">
                                    <i class="bi bi-shield-check me-1"></i>Rol del Empleado
                                </label>
                                <div class="roles-grid" id="rolesGrid">
                                    {% for rol in roles %}
                                    <div class="rol-card" data-rol-id="{{ rol.id }}"
                                         {% if usuario and usuario.role_id == rol.id %}data-selected="true"{% endif %}>
                                        <div class="rol-icon">
                                            <i class="bi bi-{% if 'admin' in rol.nombre.lower() %}shield-fill-check{% elif 'supervisor' in rol.nombre.lower() %}person-badge{% elif 'operario' in rol.nombre.lower() %}person-gear{% elif 'rrhh' in rol.nombre.lower() or 'recursos' in rol.nombre.lower() %}people-fill{% else %}person-circle{% endif %}"></i>
                                        </div>
                                        <p class="rol-nombre">{{ rol.nombre }}</p>
                                        <div class="rol-check">
                                            <i class="bi bi-check-lg"></i>
                                        </div>
                                    </div>
                                    {% endfor %}
                                </div>
                                <input type="hidden" id="role_id" name="role_id" value="{{ usuario.role_id or '' }}" required>
                                <div class="invalid-feedback"></div>
                            </div>

                            <!-- Selector de Turno Interactivo -->
                            <div class="col-12">
                                <label class="form-label fw-bold">
                                    <i class="bi bi-clock-history me-1"></i>Turno de Trabajo
                                </label>
                                <div class="turno-grid" id="turnoGrid">
                                    {% for turno in turnos %}
                                    <div class="turno-card" data-turno-id="{{ turno.id }}" 
                                         {% if usuario and usuario.turno_id == turno.id %}data-selected="true"{% endif %}>
                                        <div class="turno-header">
                                            <div class="turno-nombre">
                                                <i class="bi bi-{% if 'mañana' in turno.nombre.lower() or 'manana' in turno.nombre.lower() %}sunrise{% elif 'tarde' in turno.nombre.lower() %}sun{% elif 'noche' in turno.nombre.lower() %}moon-stars{% else %}clock{% endif %}"></i>
                                                {{ turno.nombre }}
                                            </div>
                                            <div class="turno-check">
                                                <i class="bi bi-check-lg"></i>
                                            </div>
                                        </div>
                                        <div class="turno-horario">
                                            <i class="bi bi-clock"></i>
                                            <span class="turno-time">{{ turno.hora_inicio[:5] }} - {{ turno.hora_fin[:5] }}</span>
                                        </div>
                                    </div>
                                    {% endfor %}
                                </div>
                                <input type="hidden" id="turno_id" name="turno_id" value="{{ usuario.turno_id or '' }}">
                            </div>

                            <!-- Selector de Sectores Interactivo -->
                            <div class="col-12 mt-4">
                                <label class="form-label fw-bold">
                                    <i class="bi bi-diagram-3 me-1"></i>Sectores Asignados
                                </label>
                                <div class="sectores-info">
                                    <i class="bi bi-info-circle-fill"></i>
                                    <div class="sectores-info-text">
                                        <strong>Seleccione hasta 2 sectores</strong> a los que tendrá acceso el empleado
                                    </div>
                                    <div class="sectores-counter" id="sectoresCounter">
                                        <i class="bi bi-check-circle-fill me-1"></i>
                                        <span id="counterText">0/2</span>
                                    </div>
                                </div>
                                <div class="sectores-grid" id="sectoresGrid">
                                    {% for sector in sectores %}
                                    <div class="sector-card" data-sector-id="{{ sector.id }}"
                                         {% if sector.id in usuario_sectores_ids %}data-selected="true"{% endif %}>
                                        <div class="sector-icon">
                                            <i class="bi bi-{% if 'produccion' in sector.nombre.lower() or 'producción' in sector.nombre.lower() %}gear-fill{% elif 'almacen' in sector.nombre.lower() or 'almacén' in sector.nombre.lower() %}box-seam{% elif 'logistica' in sector.nombre.lower() or 'logística' in sector.nombre.lower() %}truck{% elif 'administracion' in sector.nombre.lower() or 'administración' in sector.nombre.lower() %}building{% elif 'calidad' in sector.nombre.lower() %}clipboard-check{% elif 'mantenimiento' in sector.nombre.lower() %}tools{% else %}grid-3x3-gap{% endif %}"></i>
                                        </div>
                                        <p class="sector-nombre">{{ sector.nombre }}</p>
                                        <div class="sector-badge">1</div>
                                    </div>
                                    {% endfor %}
                                </div>
                                <input type="hidden" id="sectores" name="sectores" value="">
                            </div>
                        </div>
                    </div>
                </div>

               <!-- PASO 2: Dirección -->
                <div id="addressInfo" class="form-section" {% if is_new %}style="display: none;" {% else %}
                    style="margin-top: 2rem;" {% endif %}>
                    <div class="section-title">
                        <i class="bi bi-geo-alt me-2"></i>
                        <h5 class="mb-0">Dirección de Residencia</h5>
                    </div>
                    <div id="address-feedback" class="form-text my-2"></div>

                    <div class="form-subsection">
                        <div class="row g-3">
                            <div class="col-md-8">
                                <div class="form-floating">
                                    <input type="text" class="form-control" id="calle" name="calle" placeholder="Calle"
                                        value="{{ (usuario.get('direccion') or {}).get('calle', '') }}" required>
                                    <label for="calle">
                                        <i class="bi bi-signpost me-1"></i>Calle
                                    </label>
                                </div>
                                <div class="invalid-feedback"></div>
                            </div>

                            <div class="col-md-4">
                                <div class="form-floating">
                                    <input type="number" class="form-control" id="altura" name="altura"
                                        placeholder="Altura" value="{{ (usuario.get('direccion') or {}).get('altura', '') }}" required>
                                    <label for="altura">
                                        <i class="bi bi-123 me-1"></i>Altura
                                    </label>
                                </div>
                                <div class="invalid-feedback"></div>
                            </div>

                            <div class="col-md-6">
                                <div class="form-floating">
                                    <select class="form-select" id="provincia" name="provincia" required>
                                        <option value="">Seleccionar provincia...</option>
                                        {% set provincias = ["Buenos Aires", "CABA", "Catamarca", "Chaco", "Chubut",
                                        "Córdoba", "Corrientes", "Entre Ríos", "Formosa", "Jujuy", "La Pampa", "La
                                        Rioja", "Mendoza", "Misiones", "Neuquén", "Río Negro", "Salta", "San Juan",
                                        "San Luis", "Santa Cruz", "Santa Fe", "Santiago del Estero", "Tierra del Fuego",
                                        "Tucumán"] %}
                                        {% for p in provincias %}
                                        <option value="{{ p }}" {% if (usuario.get('direccion') or {}).get('provincia') == p %}selected{% endif %}>{{ p }}</option>
                                        {% endfor %}
                                    </select>
                                    <label for="provincia">
                                        <i class="bi bi-map me-1"></i>Provincia
                                    </label>
                                </div>
                                <div class="invalid-feedback"></div>
                            </div>

                            <div class="col-md-6">
                                <div class="form-floating">
                                    <input type="text" class="form-control" id="localidad" name="localidad"
                                        placeholder="Localidad" value="{{ (usuario.get('direccion') or {}).get('localidad', '') }}"
                                        required>
                                    <label for="localidad">
                                        <i class="bi bi-pin-map me-1"></i>Localidad
                                    </label>
                                </div>
                                <div class="invalid-feedback"></div>
                            </div>

                            <div class="col-md-4">
                                <div class="form-floating">
                                    <input type="text" class="form-control" id="piso" name="piso"
                                        placeholder="Piso (Opcional)" value="{{ (usuario.get('direccion') or {}).get('piso', '') }}">
                                    <label for="piso">
                                        <i class="bi bi-building me-1"></i>Piso (Opcional)
                                    </label>
                                </div>
                            </div>

                            <div class="col-md-4">
                                <div class="form-floating">
                                    <input type="text" class="form-control" id="depto" name="depto"
                                        placeholder="Dto (Opcional)" value="{{ (usuario.get('direccion') or {}).get('depto', '') }}">
                                    <label for="depto">
                                        <i class="bi bi-door-closed me-1"></i>Dto (Opcional)
                                    </label>
                                </div>
                            </div>

                            <div class="col-md-4">
                                <div class="form-floating">
                                    <input type="text" class="form-control" id="codigo_postal" name="codigo_postal"
                                        placeholder="Código Postal"
                                        value="{{ (usuario.get('direccion') or {}).get('codigo_postal', '') }}">
                                    <label for="codigo_postal">
                                        <i class="bi bi-mailbox me-1"></i>Código Postal
                                    </label>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>


                <!-- Paso 3: Registro de rostro (solo para empleados nuevos) -->
                {% if is_new %}
                <div id="faceRegistration" class="form-section" style="display: none;">
                    <div class="section-title">
                        <i class="bi bi-shield-lock me-2"></i>
                        <h5 class="mb-0">Registro Biométrico</h5>
                    </div>

                    <div class="camera-section" id="cameraSection">
                        <div id="cameraInactive">
                            <div class="camera-icon-container">
                                <i class="bi bi-camera fs-1 mb-3"></i>
                            </div>
                            <h6 class="fw-bold">Verificación de Identidad</h6>
                            <p class="text-muted mb-4">
                                Para completar el registro, necesitamos una foto de su rostro para garantizar<br>
                                la seguridad del sistema de acceso biométrico.
                            </p>
                            <div class="camera-tips mb-4">
                                <p class="mb-2 fw-semibold">
                                    <i class="bi bi-lightbulb text-warning me-2"></i>Consejos para una buena captura:
                                </p>
                                <ul class="text-start text-muted small">
                                    <li>Asegúrese de tener buena iluminación</li>
                                    <li>Retire gafas, gorras u otros accesorios</li>
                                    <li>Mire directamente a la cámara</li>
                                    <li>Mantenga una expresión neutral</li>
                                </ul>
                            </div>
                            <button type="button" class="btn btn-camera btn-lg" id="startCamera">
                                <i class="bi bi-camera-video me-2"></i>
                                Activar Cámara
                            </button>
                        </div>

                        <div id="cameraActive" style="display: none;">
                            <div class="video-container">
                                <video id="videoElement" autoplay playsinline></video>
                                <div class="face-outline"></div>
                            </div>
                            <canvas id="canvasElement" style="display: none;"></canvas>

                            <div class="capture-controls">
                                <button type="button" class="btn btn-camera btn-lg" id="capturePhoto">
                                    <i class="bi bi-camera me-2"></i>
                                    Capturar Foto
                                </button>
                                <button type="button" class="btn btn-outline-secondary ms-2" id="retakePhoto"
                                    style="display: none;">
                                    <i class="bi bi-arrow-clockwise me-2"></i>
                                    Tomar Otra
                                </button>
                            </div>
                        </div>

                        <div id="photoPreview" style="display: none;">
                            <h6 class="mb-3 fw-bold">Vista previa de la captura:</h6>
                            <div class="preview-container">
                                <img id="capturedImage" class="preview-image" alt="Foto capturada">
                            </div>
                            <input type="hidden" id="faceData" name="face_data">
                            <div class="mt-4">
                                <button type="button" class="btn btn-success btn-lg" id="confirmPhoto">
                                    <i class="bi bi-check-circle me-2"></i>
                                    Confirmar Foto
                                </button>
                                <button type="button" class="btn btn-outline-secondary ms-2" id="retakePhoto2">
                                    <i class="bi bi-arrow-clockwise me-2"></i>
                                    Tomar Otra
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
                {% endif %}

                <!-- Botones de acción -->
                <div class="d-flex justify-content-between mt-4 form-actions">
                    <div>
                        <button type="button" class="btn btn-outline-secondary" id="prevStep" style="display: none;">
                            <i class="bi bi-arrow-left me-1"></i>Anterior
                        </button>
                        <a href="{{ url_for('admin_usuario.listar_usuarios') }}" class="btn btn-outline-secondary"
                            id="cancelBtn">
                            <i class="bi bi-x-lg me-1"></i>Cancelar
                        </a>
                    </div>

                    <div>
                        {% if is_new %}
                        <button type="button" class="btn btn-primary" id="nextStep" disabled>
                            Siguiente <i class="bi bi-arrow-right ms-1"></i>
                        </button>
                        <button type="submit" class="btn btn-success" id="submitForm" style="display: none;">
                            <i class="bi bi-check-circle me-1"></i>Crear Empleado
                        </button>
                        {% else %}
                        <button type="submit" class="btn btn-primary">
                            <i class="bi bi-check-circle me-1"></i>Guardar Cambios
                        </button>
                        {% endif %}
                    </div>
                </div>
            </form>
        </div>
    </div>
</div>

<script>
    // Inyecta la variable 'is_new' de Jinja2 a JavaScript
    const IS_NEW = {{ is_new|tojson }};
</script>
<script src="{{ url_for('static', filename='js/usuarios/formularioCrearUsuario.js') }}"></script>

{% endblock %}