{% extends "layouts/base.html" %}

{% block title %}
{% if is_new %}Nuevo Usuario{% else %}Editar Usuario{% endif %} - Sistema Frozen
{% endblock %}

{% block content %}
<div class="form-container">
    <div class="form-card">
        <div class="form-header">
            <i class="bi bi-person-badge fs-1 mb-3"></i>
            <h2 class="mb-1">
                {% if is_new %}Crear Nuevo Usuario{% else %}Editar Usuario{% endif %}
            </h2>
            <p class="mb-0 opacity-75">
                {% if is_new %}Complete la información y registre el rostro{% else %}Modificar información del usuario{%
                endif %}
            </p>
        </div>
        <div class="form-body">
            <!-- Flash Messages -->
            {% with messages = get_flashed_messages(with_categories=true) %}
            {% if messages %}
            <div class="alert-container mb-4">
                {% for category, message in messages %}
                <div
                    class="alert alert-{{ 'danger' if category == 'error' else category }} alert-dismissible fade show">
                    {{ message }}
                    <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
                </div>
                {% endfor %}
            </div>
            {% endif %}
            {% endwith %}
            <!-- Indicador de pasos (solo para usuarios nuevos) -->
            {% if is_new %}
            <div class="step-indicator">
                <div class="step active" id="step1">1</div>
                <div class="step" id="step2">2</div>
            </div>
            {% endif %}

            <form method="POST"
                action="{{ url_for('admin_usuario.nuevo_usuario') if is_new else url_for('admin_usuario.editar_usuario', id=usuario.id) }}"
                enctype="multipart/form-data" id="userForm">

                <!-- Paso 1: Información básica -->
                <div id="basicInfo" class="form-section">
                    <h5 class="mb-4">
                        <i class="bi bi-person me-2"></i>
                        Información Personal
                    </h5>

                    <div class="row g-3">
                        <div class="col-md-6">
                            <div class="form-floating">
                                <input type="text" class="form-control" id="legajo" name="legajo"
                                    value="{{ usuario.legajo or '' }}" required placeholder="Número de legajo">
                                <label for="legajo">
                                    <i class="bi bi-hash me-1"></i>Legajo
                                </label>
                            </div>
                            <div class="invalid-feedback"></div>
                        </div>

                        <div class="col-md-6">
                            <div class="form-floating">
                                <select class="form-select" id="rol" name="rol" required>
                                    <option value="">Seleccionar rol...</option>
                                    <option value="OPERARIO" {% if usuario.rol=='OPERARIO' %}selected{% endif %}>
                                        Operario
                                    </option>
                                    <option value="SUPERVISOR" {% if usuario.rol=='SUPERVISOR' %}selected{% endif %}>
                                        Supervisor
                                    </option>
                                    <option value="ADMIN" {% if usuario.rol=='ADMIN' %}selected{% endif %}>
                                        Administrador
                                    </option>
                                </select>
                                <label for="rol">
                                    <i class="bi bi-shield-check me-1"></i>Rol
                                </label>
                            </div>
                        </div>

                        <div class="col-md-6">
                            <div class="form-floating">
                                <input type="text" class="form-control" id="nombre" name="nombre"
                                    value="{{ usuario.nombre or '' }}" required placeholder="Nombre">
                                <label for="nombre">
                                    <i class="bi bi-person me-1"></i>Nombre
                                </label>
                            </div>
                        </div>

                        <div class="col-md-6">
                            <div class="form-floating">
                                <input type="text" class="form-control" id="apellido" name="apellido"
                                    value="{{ usuario.apellido or '' }}" required placeholder="Apellido">
                                <label for="apellido">
                                    <i class="bi bi-person me-1"></i>Apellido
                                </label>
                            </div>
                        </div>

                        <div class="col-12">
                            <div class="form-floating">
                                <input type="email" class="form-control" id="email" name="email"
                                    value="{{ usuario.email or '' }}" required placeholder="nombre@empresa.com">
                                <label for="email">
                                    <i class="bi bi-envelope me-1"></i>Correo Electrónico
                                </label>
                            </div>
                            <div class="invalid-feedback"></div>
                        </div>

                        {% if is_new %}
                        <div class="col-12">
                            <div class="form-floating">
                                <input type="password" class="form-control" id="password" name="password" required
                                    placeholder="Contraseña">
                                <label for="password">
                                    <i class="bi bi-key me-1"></i>Contraseña (mínimo 8 caracteres)
                                </label>
                            </div>
                            <div class="invalid-feedback"></div>
                        </div>
                        {% endif %}
                    </div>
                </div>

                <!-- Paso 2: Registro de rostro (solo para usuarios nuevos) -->
                {% if is_new %}
                <div id="faceRegistration" class="form-section mt-5" style="display: none;">
                    <h5 class="mb-4">
                        <i class="bi bi-camera me-2"></i>
                        Registro de Rostro
                    </h5>

                    <div class="camera-section" id="cameraSection">
                        <div id="cameraInactive">
                            <i class="bi bi-camera fs-1 text-muted mb-3"></i>
                            <h6>Registro Biométrico</h6>
                            <p class="text-muted mb-3">
                                Para mayor seguridad, registre su rostro para el acceso al sistema
                            </p>
                            <button type="button" class="btn btn-camera" id="startCamera">
                                <i class="bi bi-camera-video me-2"></i>
                                Activar Cámara
                            </button>
                        </div>

                        <div id="cameraActive" style="display: none;">
                            <video id="videoElement" autoplay playsinline></video>
                            <canvas id="canvasElement" style="display: none;"></canvas>

                            <div class="capture-controls">
                                <button type="button" class="btn btn-camera" id="capturePhoto">
                                    <i class="bi bi-camera me-2"></i>
                                    Capturar Foto
                                </button>
                                <button type="button" class="btn btn-outline-secondary ms-2" id="retakePhoto"
                                    style="display: none;">
                                    <i class="bi bi-arrow-clockwise me-2"></i>
                                    Tomar Otra
                                </button>
                            </div>
                        </div>

                        <div id="photoPreview" style="display: none;">
                            <h6 class="mb-3">Vista previa:</h6>
                            <img id="capturedImage" class="preview-image" alt="Foto capturada">
                            <input type="hidden" id="faceData" name="face_data">
                            <div class="mt-3">
                                <button type="button" class="btn btn-camera" id="confirmPhoto">
                                    <i class="bi bi-check-circle me-2"></i>
                                    Confirmar Foto
                                </button>
                                <button type="button" class="btn btn-outline-secondary ms-2" id="retakePhoto2">
                                    <i class="bi bi-arrow-clockwise me-2"></i>
                                    Tomar Otra
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
                {% endif %}

                <!-- Botones de acción -->
                <div class="d-flex justify-content-between mt-4">
                    <div>
                        <button type="button" class="btn btn-secondary" id="prevStep" style="display: none;">
                            <i class="bi bi-arrow-left me-1"></i>Volver
                        </button>
                        <a href="{{ url_for('admin_usuario.listar_usuarios') }}" class="btn btn-outline-secondary" id="cancelBtn">
                            <i class="bi bi-x-lg me-1"></i>Cancelar
                        </a>
                    </div>

                    <div>
                        {% if is_new %}
                        <button type="button" class="btn btn-primary" id="nextStep" disabled>
                            Siguiente <i class="bi bi-arrow-right ms-1"></i>
                        </button>
                        <button type="submit" class="btn btn-success" id="submitForm" style="display: none;">
                            <i class="bi bi-check-circle me-1"></i>Crear Usuario
                        </button>
                        {% else %}
                        <button type="submit" class="btn btn-primary">
                            <i class="bi bi-check-circle me-1"></i>Guardar Cambios
                        </button>
                        {% endif %}
                    </div>
                </div>
            </form>
        </div>
    </div>
</div>
<script src="{{ url_for('static', filename='js/formularioCrearUsuario.js') }}"></script>

{% endblock %}